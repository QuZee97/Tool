<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard – VISO Media</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23d4cc2e'/><text x='16' y='23' text-anchor='middle' font-size='20' font-family='Helvetica Neue,Arial,sans-serif' font-weight='700' fill='%23111'>V</text></svg>">
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#1e1f22;--surface:#27282c;--surface2:#2f3035;--surface3:#383a40;
  --border:#3d3f45;--border2:#4a4c54;
  --text:#e2e3e8;--text2:#9a9ca5;--text3:#5c5f6b;
  --accent:#d4cc2e;--accent-dim:#a8a325;--accent-bg:rgba(212,204,46,0.08);
  --red:#e05555;--green:#4ade80;--blue:#60a5fa;--orange:#fb923c;
  --radius:8px;--radius-sm:5px;
  --font:'Helvetica Neue',Arial,sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--font);font-size:13px;color:var(--text);background:var(--bg);min-height:100vh;}

/* ── SHARED TOPNAV (identisch mit tool.html) ── */
#nav{
  height:52px;background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 16px;gap:4px;
  position:sticky;top:0;z-index:50;flex-shrink:0;
}
.nav-logo{font-size:14px;font-weight:700;color:var(--text);letter-spacing:-.2px;margin-right:8px;}
.nav-logo span{color:var(--text2);font-weight:300;}
.nav-sep{width:1px;height:20px;background:var(--border);margin:0 6px;}
.nav-btn{
  height:32px;padding:0 10px;border:none;background:none;
  color:var(--text3);cursor:pointer;border-radius:var(--radius-sm);
  display:inline-flex;align-items:center;gap:6px;
  font-size:12px;font-weight:500;font-family:var(--font);
  transition:background .15s,color .15s;white-space:nowrap;text-decoration:none;
}
.nav-btn:hover{background:var(--surface3);color:var(--text);}
.nav-btn.active{background:var(--accent-bg);color:var(--accent);}
.nav-btn svg{width:14px;height:14px;stroke-width:1.8;flex-shrink:0;}
.nav-spacer{flex:1;}
.nav-icon-btn{
  width:32px;height:32px;padding:0;border:none;background:none;
  color:var(--text3);cursor:pointer;border-radius:var(--radius-sm);
  display:inline-flex;align-items:center;justify-content:center;
  transition:background .15s,color .15s;text-decoration:none;
}
.nav-icon-btn:hover{background:var(--surface3);color:var(--text);}
.nav-icon-btn svg{width:15px;height:15px;stroke-width:1.8;}

/* ── LAYOUT ── */
#content{max-width:1200px;margin:0 auto;padding:28px 24px;}

/* ── UMSATZ-TOGGLE ── */
.toggle-bar{
  display:flex;gap:3px;background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:3px;
}
.toggle-bar button{
  padding:4px 12px;border:none;border-radius:4px;background:transparent;
  color:var(--text3);font-size:11px;font-weight:600;cursor:pointer;
  font-family:var(--font);transition:.12s;
}
.toggle-bar button.active{background:var(--accent);color:#111;}

/* ── DATE RANGE BAR ── */
.date-range-bar{
  display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap;
}
.date-range-bar label{font-size:11px;color:var(--text3);white-space:nowrap;}
.date-range-bar input[type=date]{
  background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);
  color:var(--text);font-size:11px;padding:5px 9px;outline:none;font-family:var(--font);
  cursor:pointer;
}
.date-range-bar input[type=date]:focus{border-color:var(--accent);}
.range-sep{font-size:11px;color:var(--text3);}
.quick-range-btns{display:flex;gap:3px;flex-wrap:wrap;}
.qr-btn{
  padding:4px 9px;border:1px solid var(--border2);border-radius:var(--radius-sm);
  background:transparent;color:var(--text3);font-size:10px;font-weight:600;
  cursor:pointer;font-family:var(--font);transition:.12s;white-space:nowrap;
}
.qr-btn:hover{background:var(--surface3);color:var(--text);}
.qr-btn.active{background:var(--accent-bg);border-color:var(--accent);color:var(--accent);}
.date-range-bar .range-label{font-size:11px;color:var(--text2);font-weight:600;white-space:nowrap;}

/* ── KPI CARDS ── */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:28px;}
@media(max-width:900px){.kpi-grid{grid-template-columns:repeat(2,1fr);}}
.kpi-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:16px 18px;
}
.kpi-label{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.7px;margin-bottom:8px;}
.kpi-value{font-size:24px;font-weight:700;line-height:1;}
.kpi-sub{font-size:11px;color:var(--text3);margin-top:6px;}
.kpi-accent{color:var(--accent);}
.kpi-green{color:var(--green);}
.kpi-orange{color:var(--orange);}
.kpi-blue{color:var(--blue);}

/* ── SECTION ── */
.section-hd{
  font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;
  letter-spacing:.7px;margin-bottom:14px;display:flex;align-items:center;gap:8px;
}
.section-hd::after{content:'';flex:1;height:1px;background:var(--border);}
.section-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.section-row .section-hd{margin-bottom:0;}
.section-row .section-hd::after{display:none;}

/* ── CHARTS ── */
.chart-grid{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-bottom:28px;}
@media(max-width:800px){.chart-grid{grid-template-columns:1fr;}}
.chart-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:18px;
}
.chart-title-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.chart-title{font-size:12px;font-weight:600;color:var(--text2);}
.chart-wrap{position:relative;height:180px;}

/* ── TOP KUNDEN ── */
.top-list{display:flex;flex-direction:column;gap:9px;margin-top:4px;}
.top-item{display:flex;align-items:center;gap:10px;}
.top-bar-wrap{flex:1;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;}
.top-bar{height:100%;background:var(--accent);border-radius:3px;transition:width .4s;}
.top-name{font-size:11px;color:var(--text2);min-width:110px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.top-val{font-size:11px;color:var(--text);min-width:80px;text-align:right;white-space:nowrap;}

/* ── TABELLE ── */
.doc-table-wrap{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  overflow:hidden;margin-bottom:28px;
}
.filter-bar{
  display:flex;gap:8px;align-items:center;padding:12px 16px;
  border-bottom:1px solid var(--border);overflow-x:auto;
}
.filter-bar::-webkit-scrollbar{height:3px;}
.filter-bar::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.filter-bar input,.filter-bar select{
  background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);
  color:var(--text);font-size:11px;padding:5px 9px;outline:none;font-family:var(--font);
  transition:border-color .12s;
}
.filter-bar select{cursor:pointer;appearance:none;-webkit-appearance:none;padding-right:24px;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%235c5f6b' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 7px center;}
.filter-bar input:focus,.filter-bar select:focus{border-color:var(--accent);}
.filter-bar input{min-width:180px;}
.filter-spacer{flex:1;}
.filter-count{font-size:11px;color:var(--text3);}

table.dash-table{width:100%;border-collapse:collapse;}
table.dash-table thead tr{background:var(--surface2);}
table.dash-table thead th{
  padding:9px 14px;text-align:left;font-size:10px;font-weight:600;
  color:var(--text3);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;
}
table.dash-table thead th.r{text-align:right;}
table.dash-table tbody tr{border-top:1px solid var(--border);transition:background .1s;}
table.dash-table tbody tr:hover{background:var(--surface2);}
table.dash-table tbody td{padding:10px 14px;font-size:12px;}
table.dash-table tbody td.r{text-align:right;}
.table-empty{padding:32px;text-align:center;color:var(--text3);font-size:12px;}
.table-footer{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;border-top:1px solid var(--border2);background:var(--surface2);
  font-size:11px;color:var(--text3);
}
.table-footer strong{color:var(--text);}

/* Badges */
.badge{display:inline-flex;align-items:center;font-size:9px;padding:2px 7px;border-radius:3px;font-weight:700;letter-spacing:.3px;}
.badge-ang{background:#3a2a0a;color:#fbbf24;}
.badge-re{background:#0a2a1a;color:var(--green);}

.chip-sm{
  display:inline-flex;align-items:center;justify-content:center;
  font-size:9px;padding:2px 7px;border-radius:10px;border:1px solid;
  font-family:var(--font);line-height:1;white-space:nowrap;
}
.chip-sm.sent{background:#1a2a3f;border-color:var(--blue);color:var(--blue);}
.chip-sm.accepted{background:#0f2a1a;border-color:var(--green);color:var(--green);}
.chip-sm.declined{background:#2a1515;border-color:var(--red);color:var(--red);}
.chip-sm.paid{background:#0f2a1a;border-color:var(--green);color:var(--green);}
.chip-sm.open{background:var(--surface3);border-color:var(--border2);color:var(--text3);}

.row-actions{display:flex;gap:4px;justify-content:flex-end;}
.btn-row{
  width:26px;height:26px;border:none;background:transparent;color:var(--text3);
  cursor:pointer;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;
  transition:.12s;
}
.btn-row:hover{background:var(--surface3);color:var(--text);}
.btn-row svg{width:13px;height:13px;stroke-width:1.8;}

/* ── DOC PREVIEW MODAL ── */
#preview-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:200;
  display:none;align-items:center;justify-content:center;
  padding:24px 16px;
}
#preview-overlay.open{display:flex;}
#preview-modal{
  background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius);
  width:100%;max-width:860px;height:95vh;position:relative;
  box-shadow:0 20px 60px rgba(0,0,0,.6);display:flex;flex-direction:column;
}
#preview-topbar{
  display:flex;align-items:center;gap:8px;padding:12px 16px;
  border-bottom:1px solid var(--border);background:var(--surface2);
  border-radius:var(--radius) var(--radius) 0 0;flex-shrink:0;
}
#preview-topbar .preview-title{flex:1;font-size:13px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.preview-action-btn{
  height:32px;padding:0 12px;border:1px solid var(--border2);background:var(--surface3);
  color:var(--text2);cursor:pointer;border-radius:var(--radius-sm);
  display:inline-flex;align-items:center;gap:6px;font-size:11px;font-weight:600;
  font-family:var(--font);transition:background .12s,color .12s;white-space:nowrap;
}
.preview-action-btn:hover{background:var(--border2);color:var(--text);}
.preview-action-btn.primary{background:var(--accent);color:#111;border-color:var(--accent);}
.preview-action-btn.primary:hover{background:var(--accent-dim);border-color:var(--accent-dim);}
.preview-close{
  width:32px;height:32px;border:none;background:transparent;color:var(--text3);
  cursor:pointer;border-radius:var(--radius-sm);font-size:18px;line-height:1;
  display:inline-flex;align-items:center;justify-content:center;transition:.12s;
}
.preview-close:hover{background:var(--surface3);color:var(--text);}
#preview-content{flex:1;min-height:0;position:relative;border-radius:0 0 var(--radius) var(--radius);overflow:hidden;}
#preview-iframe{width:100%;height:100%;border:none;display:none;background:#fff;}
#preview-loading{
  position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:10px;background:var(--surface2);
  border-radius:0 0 var(--radius) var(--radius);
}

/* The document sheet inside the preview */
.doc-sheet{
  background:#fff;max-width:740px;margin:0 auto;padding:30px 36px;
  font-family:'Helvetica Neue',Arial,sans-serif;font-size:12px;color:#222;
  line-height:1.5;box-shadow:0 2px 20px rgba(0,0,0,.15);
}
.ds-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;}
.ds-logo{font-size:18px;font-weight:800;color:#111;letter-spacing:-.5px;}
.ds-logo span{color:#888;font-weight:300;}
.ds-meta{text-align:right;font-size:11px;color:#555;line-height:1.7;}
.ds-meta h1{font-size:15px;font-weight:800;color:#111;letter-spacing:.5px;margin-bottom:4px;}
.ds-meta-row{display:flex;justify-content:flex-end;gap:6px;}
.ds-meta-label{color:#888;min-width:80px;text-align:left;}
.ds-sender{font-size:9px;color:#888;padding:5px 0;border-top:1px solid #eee;border-bottom:1px solid #eee;margin-bottom:14px;}
.ds-recipient{font-size:11px;color:#222;margin-bottom:14px;min-height:60px;line-height:1.6;}
.ds-recipient strong{font-size:12px;}
.ds-subject{font-size:13px;font-weight:700;color:#111;margin:14px 0 10px;}
.ds-subject .ds-sub-prefix{font-weight:400;color:#888;font-size:11px;}
.ds-intro{font-size:11.5px;color:#333;margin-bottom:12px;line-height:1.6;}
.ds-table{width:100%;border-collapse:collapse;margin-bottom:12px;font-size:11px;}
.ds-table thead tr{border-bottom:2px solid #111;}
.ds-table thead th{padding:6px 8px;font-weight:700;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:.4px;color:#555;}
.ds-table thead th.r{text-align:right;}
.ds-table tbody tr{border-bottom:1px solid #eee;}
.ds-table tbody td{padding:7px 8px;vertical-align:top;}
.ds-table tbody td.r{text-align:right;white-space:nowrap;}
.ds-pos-num{color:#888;font-size:10px;}
.ds-pos-desc{font-weight:600;color:#111;}
.ds-pos-detail{font-size:10px;color:#666;margin-top:2px;line-height:1.5;}
.ds-totals{margin-left:auto;width:260px;margin-bottom:16px;}
.ds-totals table{width:100%;border-collapse:collapse;font-size:11.5px;}
.ds-totals td{padding:4px 6px;}
.ds-totals td:last-child{text-align:right;white-space:nowrap;}
.ds-totals .ds-total-final td{font-weight:700;font-size:13px;border-top:2px solid #111;padding-top:6px;}
.ds-infobox{background:#f8f8f8;border-left:3px solid #ddd;padding:8px 12px;font-size:10.5px;color:#444;margin-bottom:10px;line-height:1.6;}
.ds-infobox strong{display:block;margin-bottom:2px;color:#111;}
.ds-sign{font-size:11px;color:#555;margin:12px 0;}
.ds-footer{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;border-top:1px solid #ddd;padding-top:10px;margin-top:14px;font-size:9.5px;color:#666;line-height:1.6;}
.ds-footer strong{display:block;font-size:10px;color:#111;margin-bottom:2px;}

/* ── TOAST / LOADING ── */
#toast{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:var(--surface3);color:var(--text);border:1px solid var(--border2);
  padding:9px 18px;border-radius:var(--radius);font-size:12px;
  opacity:0;transition:.25s;pointer-events:none;z-index:999;
  box-shadow:0 4px 20px rgba(0,0,0,.4);
}
#toast.show{opacity:1;}
#loading{
  position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;
  justify-content:center;flex-direction:column;gap:12px;z-index:100;
}
.spinner-lg{
  width:32px;height:32px;border:3px solid var(--border2);
  border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>

<div id="loading">
  <div class="spinner-lg"></div>
  <span style="font-size:12px;color:var(--text3);">Lade Dashboard …</span>
</div>

<!-- ── TOPNAV (identisch mit tool.html) ── -->
<nav id="nav">
  <span class="nav-logo">VISO <span>Media</span></span>
  <div class="nav-sep"></div>
  <a class="nav-btn active" href="/dashboard">
    <i data-lucide="layout-dashboard"></i> Dashboard
  </a>
  <a class="nav-btn" href="/tool">
    <i data-lucide="file-text"></i> Angebote & Rechnungen
  </a>
  <a class="nav-btn" href="/steuer">
    <i data-lucide="calculator"></i> Steuer
  </a>

  <div class="nav-spacer"></div>
  <button class="nav-btn" style="background:var(--accent);color:#111;" onclick="goNew()">
    <i data-lucide="plus"></i> Neues Dokument
  </button>
  <div class="nav-sep"></div>
  <span style="font-size:11px;color:var(--text3);padding:0 6px;" id="nav-user-email"></span>
  <button class="nav-icon-btn" onclick="doSignOut()" title="Abmelden">
    <i data-lucide="log-out"></i>
  </button>
</nav>

<!-- ── CONTENT ── -->
<div id="content">

  <!-- KPI Header Row -->
  <div class="section-row" style="margin-bottom:10px;">
    <div class="section-hd">Übersicht</div>
    <div class="toggle-bar" id="kpi-toggle">
      <button class="active" onclick="setMode('netto',this)">Netto</button>
      <button onclick="setMode('brutto',this)">Brutto</button>
    </div>
  </div>

  <!-- Date Range Bar -->
  <div class="date-range-bar">
    <div class="quick-range-btns">
      <button class="qr-btn active" id="qr-year" onclick="setQuickRange('year',this)">Dieses Jahr</button>
      <button class="qr-btn" id="qr-lastyear" onclick="setQuickRange('lastyear',this)">Letztes Jahr</button>
      <button class="qr-btn" id="qr-q1" onclick="setQuickRange('q1',this)">Q1</button>
      <button class="qr-btn" id="qr-q2" onclick="setQuickRange('q2',this)">Q2</button>
      <button class="qr-btn" id="qr-q3" onclick="setQuickRange('q3',this)">Q3</button>
      <button class="qr-btn" id="qr-q4" onclick="setQuickRange('q4',this)">Q4</button>
      <button class="qr-btn" id="qr-all" onclick="setQuickRange('all',this)">Gesamt</button>
    </div>
    <div style="flex:1;"></div>
    <label>Von</label>
    <input type="date" id="range-from" onchange="onRangeChange()">
    <span class="range-sep">–</span>
    <label>Bis</label>
    <input type="date" id="range-to" onchange="onRangeChange()">
  </div>

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-label" id="lbl-year">Einnahmen (Netto)</div>
      <div class="kpi-value kpi-accent" id="kpi-year">–</div>
      <div class="kpi-sub" id="kpi-year-sub">–</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label" id="lbl-ausgaben">Ausgaben (Brutto)</div>
      <div class="kpi-value kpi-orange" id="kpi-ausgaben">–</div>
      <div class="kpi-sub" id="kpi-ausgaben-sub">–</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label" id="lbl-gewinn">Gewinn / Verlust</div>
      <div class="kpi-value" id="kpi-gewinn" style="color:var(--green);">–</div>
      <div class="kpi-sub" id="kpi-gewinn-sub">Einnahmen − Ausgaben</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Offene Angebote</div>
      <div class="kpi-value kpi-blue" id="kpi-open">–</div>
      <div class="kpi-sub" id="kpi-open-sub">–</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="chart-grid">
    <div class="chart-card">
      <div class="chart-title-row">
        <span class="chart-title" id="chart-title">Einnahmen & Ausgaben pro Monat</span>
      </div>
      <div class="chart-wrap">
        <canvas id="chart-monthly"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title-row">
        <span class="chart-title" id="top-title">Top Kunden – Netto gesamt</span>
      </div>
      <div class="top-list" id="top-customers">
        <div style="color:var(--text3);font-size:11px;">Lade …</div>
      </div>
    </div>
  </div>

  <!-- Ausgaben nach Kategorien -->
  <div class="chart-grid" style="grid-template-columns:1fr 1fr;margin-top:0;">
    <div class="chart-card">
      <div class="chart-title-row">
        <span class="chart-title" id="kat-title">Ausgaben nach Kategorie</span>
      </div>
      <div class="top-list" id="ausgaben-by-kat" style="margin-top:4px;">
        <div style="color:var(--text3);font-size:11px;">Keine Buchungen vorhanden.</div>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title-row">
        <span class="chart-title">Offene Angebote</span>
      </div>
      <div class="top-list" id="open-angebote-list" style="margin-top:4px;">
        <div style="color:var(--text3);font-size:11px;">Keine offenen Angebote.</div>
      </div>
    </div>
  </div>

  <!-- Dokumentenübersicht -->
  <div class="section-row">
    <div class="section-hd">Alle Dokumente</div>
  </div>

  <div class="doc-table-wrap">
    <div class="filter-bar">
      <input type="text" id="f-search" placeholder="Suche nach Kunde, Betreff, Nr. …" oninput="applyFilter()">
      <select id="f-typ" onchange="applyFilter()">
        <option value="">Alle Typen</option>
        <option value="angebot">Angebote</option>
        <option value="rechnung">Rechnungen</option>
      </select>
      <select id="f-status" onchange="applyFilter()">
        <option value="">Alle Status</option>
        <option value="open">Offen</option>
        <option value="sent">Abgeschickt</option>
        <option value="accepted">Angenommen</option>
        <option value="declined">Abgelehnt</option>
        <option value="paid">Bezahlt</option>
      </select>
      <select id="f-year" onchange="applyFilter()">
        <option value="">Alle Jahre</option>
      </select>
      <label style="display:inline-flex;align-items:center;gap:5px;font-size:11px;color:var(--text3);cursor:pointer;white-space:nowrap;flex-shrink:0;">
        <input type="checkbox" id="f-dedup" onchange="applyFilter()" style="accent-color:var(--accent);width:13px;height:13px;margin:0;padding:0;flex-shrink:0;cursor:pointer;">
        Angebote mit RE ausblenden
      </label>
      <div class="filter-spacer"></div>
      <span class="filter-count" id="filter-count"></span>
    </div>

    <table class="dash-table">
      <thead>
        <tr>
          <th>Typ</th>
          <th>Nummer</th>
          <th>Kunde</th>
          <th>Betreff</th>
          <th class="r">Netto</th>
          <th class="r">Brutto</th>
          <th>Datum</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="doc-tbody">
        <tr><td colspan="9" class="table-empty">Lade …</td></tr>
      </tbody>
    </table>

    <div class="table-footer">
      <span id="table-footer-left">–</span>
      <span>Summe: <strong id="footer-netto">–</strong> Netto &nbsp;·&nbsp; <strong id="footer-brutto">–</strong> Brutto</span>
    </div>
  </div>

</div><!-- /content -->
<div id="toast"></div>

<!-- ── DOC PREVIEW MODAL ── -->
<div id="preview-overlay" onclick="closePreview(event)">
  <div id="preview-modal">
    <div id="preview-topbar">
      <span class="preview-title" id="preview-modal-title">Vorschau</span>
      <button class="preview-action-btn primary" id="preview-edit-btn" onclick="previewEdit()">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        Bearbeiten
      </button>
      <button class="preview-action-btn" id="preview-dl-btn" onclick="previewDownload()">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Herunterladen
      </button>
      <button class="preview-close" onclick="closePreview()" title="Schließen">✕</button>
    </div>
    <div id="preview-content">
      <iframe id="preview-iframe" src="about:blank"></iframe>
      <div id="preview-loading">
        <div class="spinner-lg"></div>
        <span style="font-size:12px;color:var(--text3);">PDF wird geladen …</span>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="supabase.js"></script>
<script>
lucide.createIcons();

// ── STATE ─────────────────────────────────────────────────
let allDocs = [];
let allMatches = []; // Alle kategorisierten Buchungen (aus Steuer-Tool)
let filteredDocs = [];
let viewMode = 'netto'; // 'netto' | 'brutto'
let monthChart = null;
let rangeFrom = null; // 'YYYY-MM-DD' or null = unbounded
let rangeTo   = null;
let rangeYear = new Date().getFullYear(); // which year to show in the bar chart

// Kategorie-Labels für Ausgaben
const KAT_LABELS = {
  betriebseinnahmen:'Betriebseinnahmen', betriebsausgaben:'Betriebsausgaben',
  werbung_marketing:'Werbung & Marketing', reisekosten:'Reise & Fahrt',
  bueromaterial:'Büromaterial', software_abo:'Software & Abos',
  versicherungen:'Versicherungen', beratung:'Beratung & Honorare',
  personal:'Personal', miete:'Miete & Raum', fahrzeug:'Fahrzeug',
  telekommunikation:'Telekommunikation', bewirtung:'Bewirtung',
  weiterbildung:'Weiterbildung', bank:'Bank & Gebühren',
  steuern:'Steuern & Abgaben', sonstiges:'Sonstiges',
};

const fmt = n => n.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+'\u00a0€';
const fmtDate = v => {if(!v)return'–';const[y,m,d]=v.split('-');return`${d}.${m}.${y}`;};
const toast = msg => {const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2400);};
const $ = id => document.getElementById(id);

function parsePreis(s){
  if(!s)return 0;s=String(s).trim();
  if(/^\d{1,3}(\.\d{3})*(,\d+)?$/.test(s)){return parseFloat(s.replace(/\./g,'').replace(',','.'));}
  return parseFloat(s.replace(',','.').replace(/[^\d.]/g,''))||0;
}
function docNetto(doc){
  if(!doc.positionen?.length)return 0;
  return doc.positionen.reduce((s,p)=>s+parsePreis(p.menge)*parsePreis(p.preis),0);
}
function docBrutto(doc){const n=docNetto(doc);return doc.tax==='de'?n*1.19:n;}
function docVal(doc){return viewMode==='brutto'?docBrutto(doc):docNetto(doc);}

// ── MODUS-TOGGLE ──────────────────────────────────────────
function setMode(mode, btn){
  viewMode = mode;
  document.querySelectorAll('#kpi-toggle button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  refreshKPILabels();
  buildKPIs(); updateMonthChart(); buildTopCustomers(); buildAusgabenByKategorie(); buildOpenAngebote();
}

// ── DATE RANGE ─────────────────────────────────────────────
function setQuickRange(key, btn){
  document.querySelectorAll('.qr-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth()+1;
  // Determine quarter for current month
  const curQ = Math.ceil(m/3);
  let from, to;
  if(key==='year'){
    from=`${y}-01-01`; to=`${y}-12-31`; rangeYear=y;
  } else if(key==='lastyear'){
    from=`${y-1}-01-01`; to=`${y-1}-12-31`; rangeYear=y-1;
  } else if(key==='q1'){
    from=`${y}-01-01`; to=`${y}-03-31`; rangeYear=y;
  } else if(key==='q2'){
    from=`${y}-04-01`; to=`${y}-06-30`; rangeYear=y;
  } else if(key==='q3'){
    from=`${y}-07-01`; to=`${y}-09-30`; rangeYear=y;
  } else if(key==='q4'){
    from=`${y}-10-01`; to=`${y}-12-31`; rangeYear=y;
  } else { // all
    from=null; to=null; rangeYear=y;
  }
  rangeFrom=from; rangeTo=to;
  $('range-from').value=from||'';
  $('range-to').value=to||'';
  refreshKPILabels();
  buildKPIs(); updateMonthChart(); buildTopCustomers(); buildAusgabenByKategorie(); buildOpenAngebote();
}
function onRangeChange(){
  // Custom date range – deactivate quick buttons
  document.querySelectorAll('.qr-btn').forEach(b=>b.classList.remove('active'));
  rangeFrom=$('range-from').value||null;
  rangeTo=$('range-to').value||null;
  // Determine chart year from rangeFrom
  if(rangeFrom) rangeYear=parseInt(rangeFrom.slice(0,4));
  refreshKPILabels();
  buildKPIs(); updateMonthChart(); buildTopCustomers(); buildAusgabenByKategorie(); buildOpenAngebote();
}
function inRange(datum){
  if(!datum) return false;
  if(rangeFrom && datum < rangeFrom) return false;
  if(rangeTo   && datum > rangeTo)   return false;
  return true;
}
function rangeLabel(){
  if(!rangeFrom && !rangeTo) return 'Gesamt';
  const fd=rangeFrom?fmtDate(rangeFrom):'';
  const td=rangeTo?fmtDate(rangeTo):'';
  if(fd&&td) return `${fd} – ${td}`;
  if(fd) return `ab ${fd}`;
  return `bis ${td}`;
}
function refreshKPILabels(){
  const label=viewMode==='brutto'?'Brutto':'Netto';
  const rl=rangeLabel();
  $('lbl-year').textContent=`Einnahmen (${rl}, ${label})`;
  $('lbl-ausgaben').textContent=`Ausgaben (${rl}, Brutto)`;
  $('lbl-gewinn').textContent=`Gewinn / Verlust (${rl})`;
  $('chart-title').textContent=`Einnahmen & Ausgaben pro Monat (${rangeYear})`;
  $('top-title').textContent=`Top Kunden – ${label} (${rl})`;
  $('kat-title').textContent=`Ausgaben nach Kategorie (${rl})`;
}

// ── STATUS ─────────────────────────────────────────────────
// Priority order: höchster Status gewinnt
const STATUS_PRIORITY=['paid','accepted','declined','sent'];
function getActiveStatus(doc){
  if(!doc.status)return null;
  // Höchste Priorität zurückgeben
  for(const k of STATUS_PRIORITY){if(doc.status[k])return k;}
  return null;
}
function statusChip(doc){
  const s=getActiveStatus(doc);
  const map={sent:{cls:'sent',label:'Abgeschickt'},accepted:{cls:'accepted',label:'Angenommen'},declined:{cls:'declined',label:'Abgelehnt'},paid:{cls:'paid',label:'Bezahlt'}};
  if(!s)return`<span class="chip-sm open">Offen</span>`;
  const m=map[s]||{cls:'open',label:s};
  return`<span class="chip-sm ${m.cls}">${m.label}</span>`;
}

// ── FILTER & TABLE ─────────────────────────────────────────
// Ermittelt Angebote, zu denen bereits eine Rechnung existiert (gleiche Firma + Betreff)
function getConvertedAngebotIds(){
  const reSet=new Set(
    allDocs.filter(d=>d.typ==='rechnung'&&d.firma&&d.betreff)
           .map(d=>`${(d.firma||'').trim().toLowerCase()}||${(d.betreff||'').trim().toLowerCase()}`)
  );
  return new Set(
    allDocs.filter(d=>d.typ==='angebot'&&d.firma&&d.betreff&&
      reSet.has(`${(d.firma||'').trim().toLowerCase()}||${(d.betreff||'').trim().toLowerCase()}`))
    .map(d=>d.id)
  );
}

function applyFilter(){
  const search=($('f-search').value||'').toLowerCase();
  const typ=$('f-typ').value;
  const status=$('f-status').value;
  const year=$('f-year').value;
  const dedup=$('f-dedup').checked;
  const convertedIds=dedup?getConvertedAngebotIds():new Set();
  filteredDocs=allDocs.filter(d=>{
    if(dedup&&convertedIds.has(d.id))return false;
    if(typ&&d.typ!==typ)return false;
    if(year&&(!d.datum||!d.datum.startsWith(year)))return false;
    if(status){const active=getActiveStatus(d)||'open';if(active!==status)return false;}
    if(search){const h=`${d.nr||''} ${d.firma||''} ${d.betreff||''}`.toLowerCase();if(!h.includes(search))return false;}
    return true;
  });
  renderTable();
}

function renderTable(){
  const tbody=$('doc-tbody');
  $('filter-count').textContent=`${filteredDocs.length} Dokument${filteredDocs.length!==1?'e':''}`;
  if(!filteredDocs.length){
    tbody.innerHTML=`<tr><td colspan="9" class="table-empty">Keine Dokumente gefunden.</td></tr>`;
    $('table-footer-left').textContent='–';$('footer-netto').textContent='–';$('footer-brutto').textContent='–';
    return;
  }
  // Zeige kleinen Hinweis bei Angeboten, zu denen eine Rechnung existiert
  const convertedIds=getConvertedAngebotIds();
  let sumN=0,sumB=0;
  tbody.innerHTML=filteredDocs.map((d,i)=>{
    const n=docNetto(d),b=docBrutto(d);sumN+=n;sumB+=b;
    const isConverted=d.typ==='angebot'&&convertedIds.has(d.id);
    const nrCell=isConverted
      ?`<span style="font-weight:600;">${d.nr||'–'}</span> <span title="Rechnung wurde erstellt" style="font-size:9px;color:var(--green);vertical-align:middle;">→ RE</span>`
      :`<span style="font-weight:600;">${d.nr||'–'}</span>`;
    return`<tr${isConverted?' style="opacity:.65;cursor:pointer;"':' style="cursor:pointer;"'} onclick="openDoc(${i})" title="Vorschau öffnen">
      <td><span class="badge ${d.typ==='rechnung'?'badge-re':'badge-ang'}">${d.typ==='rechnung'?'RE':'ANG'}</span></td>
      <td>${nrCell}</td>
      <td style="color:var(--text2);">${d.firma||'–'}</td>
      <td style="color:var(--text3);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${d.betreff||'–'}</td>
      <td class="r" style="font-variant-numeric:tabular-nums;">${n?fmt(n):'–'}</td>
      <td class="r" style="font-variant-numeric:tabular-nums;font-weight:600;">${b?fmt(b):'–'}</td>
      <td style="color:var(--text3);white-space:nowrap;">${fmtDate(d.datum)}</td>
      <td>${statusChip(d)}</td>
      <td><div class="row-actions"><button class="btn-row" onclick="event.stopPropagation();previewEdit_id('${d.id}')" title="Bearbeiten"><i data-lucide="external-link"></i></button></div></td>
    </tr>`;
  }).join('');
  $('table-footer-left').textContent=`${filteredDocs.length} Dokumente`;
  $('footer-netto').textContent=fmt(sumN);
  $('footer-brutto').textContent=fmt(sumB);
  lucide.createIcons();
}

// ── DOC PREVIEW ────────────────────────────────────────────
let previewDocId = null;

function openDoc(i){
  openPreview(filteredDocs[i]);
}

async function openPreview(doc){
  previewDocId = doc.id;
  const isRe = doc.typ === 'rechnung';
  const firma = doc.firma || doc.ansprechpartner || '';
  $('preview-modal-title').textContent = `${isRe?'Rechnung':'Angebot'} ${doc.nr||''}${firma?' – '+firma:''}`;

  const iframe = $('preview-iframe');
  const loading = $('preview-loading');

  // Reset iframe
  iframe.removeAttribute('srcdoc');
  if(iframe._blobUrl){ URL.revokeObjectURL(iframe._blobUrl); iframe._blobUrl=null; }
  iframe.src='about:blank';
  iframe.style.display='none';
  loading.style.display='flex';
  loading.innerHTML='<div class="spinner-lg"></div><span style="font-size:12px;color:var(--text3);margin-top:4px;">PDF wird geladen …</span>';

  $('preview-overlay').classList.add('open');
  document.body.style.overflow='hidden';

  try{
    const blob = await generateDocPDFBlob(doc);
    const blobUrl = URL.createObjectURL(blob);
    iframe._blobUrl = blobUrl;
    iframe.src = blobUrl;
    iframe.style.display='block';
    loading.style.display='none';
  }catch(e){
    loading.innerHTML=`<div style="color:var(--text3);font-size:12px;text-align:center;">Fehler beim Laden:<br>${e.message}</div>`;
  }
}

function closePreview(e){
  if(e && e.target !== $('preview-overlay') && !e.target.classList.contains('preview-close')) return;
  $('preview-overlay').classList.remove('open');
  document.body.style.overflow='';
  const iframe=$('preview-iframe');
  if(iframe){ if(iframe._blobUrl){URL.revokeObjectURL(iframe._blobUrl);iframe._blobUrl=null;} iframe.src='about:blank'; }
}

function previewEdit(){
  if(!previewDocId) return;
  sessionStorage.setItem('loadDocId', previewDocId);
  window.location.href = '/tool';
}
function previewEdit_id(id){
  sessionStorage.setItem('loadDocId', id);
  window.location.href = '/tool';
}
// Escape key closes preview
document.addEventListener('keydown', e => { if(e.key==='Escape') { $('preview-overlay').classList.remove('open'); document.body.style.overflow=''; } });

async function generateDocPDFBlob(doc){
  const isRe = doc.typ==='rechnung';
  const lang = doc.lang||'de';
  const tax  = doc.tax||'de';
  const firma = doc.firma||doc.ansprechpartner||'';
  const filename = firma ? `${doc.nr||'Dokument'} – ${firma}` : (doc.nr||'Dokument');
  let p1html='', p2html='', css='';
  if(doc.pdf_html){
    try{ const snap=JSON.parse(doc.pdf_html); p1html=snap.p1||''; p2html=snap.p2||''; css=snap.css||''; }catch{}
  }
  if(!p1html){
    const tmpDiv=document.createElement('div');
    tmpDiv.style.cssText='position:absolute;left:-9999px;top:0;width:794px;';
    tmpDiv.innerHTML=buildDocHTMLForPDF(doc,lang,tax,isRe);
    document.body.appendChild(tmpDiv);
    p1html=(tmpDiv.querySelector('#pdf-page1')||{}).innerHTML||'';
    p2html=(!isRe?(tmpDiv.querySelector('#pdf-page2')||{}).innerHTML:'')||'';
    document.body.removeChild(tmpDiv);
    try{css=Array.from(document.styleSheets).reduce((a,ss)=>{try{return a+Array.from(ss.cssRules).map(r=>r.cssText).join('\n');}catch{return a;}},'')}catch{}
  }
  const resp=await fetch('/api/pdf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({page1:p1html,page2:p2html,css,filename})});
  if(!resp.ok){const e=await resp.json();throw new Error(e.error||resp.statusText);}
  return await resp.blob();
}

async function previewDownload(){
  const doc=allDocs.find(d=>d.id===previewDocId);
  if(!doc)return;
  const btn=$('preview-dl-btn');
  const origHTML=btn.innerHTML;
  btn.textContent='…'; btn.disabled=true;
  try{
    toast('PDF wird erstellt …');
    const blob=await generateDocPDFBlob(doc);
    const firma=doc.firma||doc.ansprechpartner||'';
    const filename=(firma?`${doc.nr||'Dokument'} – ${firma}`:(doc.nr||'Dokument'))+'.pdf';
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),10000);
    toast('PDF heruntergeladen ✓');
    // Rechnung automatisch als Beleg speichern
    if(doc.typ==='rechnung' && doc.id){
      DB.saveGeneratedReceipt(blob, doc)
        .then(r=>{if(r)toast('Rechnung als Beleg gespeichert ✓');})
        .catch(e=>console.warn('Beleg-Speichern fehlgeschlagen:',e));
    }
  }catch(e){
    console.error('PDF-Fehler:',e); toast('PDF-Fehler: '+e.message);
  }finally{
    btn.innerHTML=origHTML; btn.disabled=false;
  }
}

// ── RENDER DOC HTML FOR PREVIEW ────────────────────────────
function parsePreisNum(s){
  if(!s) return 0;
  s = String(s).trim();
  if(/^\d{1,3}(\.\d{3})*(,\d+)?$/.test(s)) return parseFloat(s.replace(/\./g,'').replace(',','.'));
  return parseFloat(s.replace(',','.').replace(/[^\d.-]/g,''))||0;
}
function fmtMoney(n){ return n.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+'\u00a0€'; }
function fmtDateStr(v){ if(!v)return'–'; const[y,m,d]=(v||'').split('-'); return`${d}.${m}.${y}`; }

const UNIT_MAP = {
  pauschal:{de:'pauschal',en:'flat rate'},
  stunde:{de:'Stunde',en:'hour'},
  tag:{de:'Tag',en:'day'},
  stueck:{de:'Stück',en:'unit'},
  monat:{de:'Monat',en:'month'},
  wort:{de:'Wort',en:'word'},
};

function buildDocHTML(doc, lang, tax, isRe){
  const l = lang === 'en';
  const pos = doc.positionen || [];
  const netto = pos.reduce((s,p)=>s + parsePreisNum(p.menge)*parsePreisNum(p.preis), 0);
  const mwstRate = tax === 'de' ? 0.19 : 0;
  const mwst = netto * mwstRate;
  const brutto = netto + mwst;

  const zahlung = doc.zahlung || 'voll';

  // Tax note text
  let taxNoteHtml = '';
  if(tax === 'eu'){
    taxNoteHtml = `<div class="ds-infobox">${l?'VAT is not charged due to the reverse charge procedure (§ 13b UStG). The recipient is liable for tax.':'Die Umsatzsteuer wird nicht berechnet, da das Reverse-Charge-Verfahren (§ 13b UStG) angewendet wird. Steuerschuldner ist der Leistungsempfänger.'}</div>`;
  } else if(tax === 'int'){
    taxNoteHtml = `<div class="ds-infobox">${l?'This service is exempt from VAT as per § 4 No. 1a UStG (export delivery / third country).':'Diese Leistung ist nach § 4 Nr. 1a UStG umsatzsteuerfrei (Ausfuhrlieferung / Drittland).'}</div>`;
  }

  // Payment text
  let zahlungText = '';
  if(isRe){
    if(zahlung === 'voll'){
      zahlungText = l ? 'Payment is due within 14 days of receipt without deduction.' : 'Zahlung ist innerhalb von 14 Tagen nach Erhalt ohne Abzug fällig.';
    } else {
      zahlungText = l ? '50% advance payment due upon receipt. Remainder due on completion.' : '50% Anzahlung bei Auftragserteilung. Restbetrag nach Fertigstellung.';
    }
  } else {
    zahlungText = l ? 'Payment due within 14 days of order confirmation.' : 'Zahlung 14 Tage nach Auftragsbestätigung.';
  }

  // Intro text
  let intro = '';
  if(isRe){
    intro = l ? `Thank you for your order. Please find below our invoice for services rendered:` : `Vielen Dank für Ihren Auftrag. Für die erbrachten Leistungen stelle ich Ihnen folgendes in Rechnung:`;
  } else {
    intro = l ? `Thank you for your interest. Please find our quote for the described services below:` : `vielen Dank für Ihr Interesse. Gerne unterbreite ich Ihnen folgendes Angebot für die beschriebenen Leistungen:`;
  }

  // Positions rows
  const posRows = pos.map((p,i) => {
    const menge = parsePreisNum(p.menge);
    const preis = parsePreisNum(p.preis);
    const gesamt = menge * preis;
    const unitKey = p.einheit || 'pauschal';
    const unitLabel = (UNIT_MAP[unitKey] || {})[lang] || unitKey;
    const detailHtml = p.beschreibung ? `<div class="ds-pos-detail">${p.beschreibung.replace(/\n/g,'<br>')}</div>` : '';
    return `<tr>
      <td class="ds-pos-num">${i+1}</td>
      <td><div class="ds-pos-desc">${p.bezeichnung||''}</div>${detailHtml}</td>
      <td class="r">${menge.toLocaleString('de-DE')}</td>
      <td class="r">${unitLabel}</td>
      <td class="r">${fmtMoney(preis)}</td>
      <td class="r">${fmtMoney(gesamt)}</td>
    </tr>`;
  }).join('');

  // Totals
  let totalsHtml = '';
  if(tax === 'de'){
    totalsHtml = `
      <tr><td>${l?'Net amount':'Nettobetrag'}</td><td>${fmtMoney(netto)}</td></tr>
      <tr><td>${l?'plus 19% VAT':'zzgl. 19% MwSt.'}</td><td>${fmtMoney(mwst)}</td></tr>
      <tr class="ds-total-final"><td><strong>${l?'Total':'Gesamtbetrag'}</strong></td><td><strong>${fmtMoney(brutto)}</strong></td></tr>`;
  } else {
    totalsHtml = `
      <tr class="ds-total-final"><td><strong>${l?'Total (net)':'Gesamtbetrag (netto)'}</strong></td><td><strong>${fmtMoney(netto)}</strong></td></tr>`;
  }

  // Validity / period row
  const extraLabel = isRe ? (l?'Service period:':'Leistungszeitraum:') : (l?'Valid until:':'Gültig bis:');
  const extraVal   = isRe ? (doc.von ? fmtDateStr(doc.von) : '–') : (doc.gueltig ? fmtDateStr(doc.gueltig) : '–');

  // Notes
  const notesHtml = doc.hinweise ? `<div class="ds-infobox"><strong>${l?'Notes':'Hinweise'}</strong>${doc.hinweise}</div>` : '';

  // Sign block
  const signHtml = `<div class="ds-sign">Mit freundlichen Grüßen,<br><strong>David Stiehler</strong> · VISO Media</div>`;

  // UID
  const uidRow = (tax !== 'de' && doc.uid) ? `<div class="ds-meta-row"><span class="ds-meta-label">${l?'VAT ID Client:':'USt-IdNr. Kunde:'}</span><span>${doc.uid}</span></div>` : '';

  return `<div class="doc-sheet">
    <div class="ds-header">
      <div>
        <div class="ds-logo">VISO <span>Media</span></div>
        <div style="font-size:10px;color:#888;margin-top:2px;">David Stiehler</div>
      </div>
      <div class="ds-meta">
        <h1>${isRe ? (l?'INVOICE':'RECHNUNG') : (l?'QUOTE':'ANGEBOT')}</h1>
        <div class="ds-meta-row"><span class="ds-meta-label">${isRe?(l?'Invoice No.:':'Rechnungs-Nr.:'):(l?'Quote No.:':'Angebots-Nr.:')}</span><span style="font-weight:700;">${doc.nr||'–'}</span></div>
        <div class="ds-meta-row"><span class="ds-meta-label">${l?'Date:':'Datum:'}</span><span>${fmtDateStr(doc.datum)}</span></div>
        <div class="ds-meta-row"><span class="ds-meta-label">${extraLabel}</span><span>${extraVal}</span></div>
        ${uidRow}
      </div>
    </div>
    <div class="ds-sender">David Stiehler · Schiffenberger Weg 28A · 35394 Gießen · Germany</div>
    <div class="ds-recipient">
      <strong>${doc.firma||''}</strong><br>
      ${doc.ansprechpartner ? doc.ansprechpartner+'<br>' : ''}
      ${doc.strasse ? doc.strasse+'<br>' : ''}
      ${doc.ort ? doc.ort+'<br>' : ''}
      ${doc.land ? doc.land : ''}
    </div>
    <div class="ds-subject">
      <span class="ds-sub-prefix">${isRe?(l?'Re: ':'Betr.: '):(l?'Re: ':'Betr.: ')}</span>
      ${doc.betreff||''}
    </div>
    <div class="ds-intro">${intro}</div>
    <table class="ds-table">
      <thead><tr>
        <th style="width:4%">${l?'Pos.':'Pos.'}</th>
        <th>${l?'Description':'Leistungsbeschreibung'}</th>
        <th class="r" style="width:8%">${l?'Qty':'Menge'}</th>
        <th class="r" style="width:10%">${l?'Unit':'Einheit'}</th>
        <th class="r" style="width:13%">${l?'Unit price':'Einzelpreis'}</th>
        <th class="r" style="width:13%">${l?'Total':'Gesamt'}</th>
      </tr></thead>
      <tbody>${posRows||'<tr><td colspan="6" style="color:#aaa;text-align:center;padding:14px;">–</td></tr>'}</tbody>
    </table>
    <div class="ds-totals"><table>${totalsHtml}</table></div>
    ${taxNoteHtml}
    ${notesHtml}
    <div class="ds-infobox">
      <strong>${l?'Payment terms:':'Zahlungsbedingungen:'}</strong>
      ${zahlungText}
    </div>
    ${signHtml}
    <div class="ds-footer">
      <div><strong>${l?'Contact':'Kontakt'}</strong>David Stiehler<br>Schiffenberger Weg 28A<br>35394 Gießen · Germany<br>015735386155<br>rechnungen@viso.media</div>
      <div><strong>${l?'Tax':'Steuer'}</strong>Steuernummer: 02087201058<br>USt-IdNr.: DE354878347</div>
      <div><strong>${l?'Bank details':'Bankverbindung'}</strong>Kontoinhaber: David Stiehler<br>Bank: Kontist<br>IBAN: DE02 1101 0101 5262 3588 06<br>BIC: SOBKDEB2XXX</div>
    </div>
  </div>`;
}

// Lightweight wrapper for PDF API (reuses same structure as tool.html)
function buildDocHTMLForPDF(doc, lang, tax, isRe){
  // Return the inner HTML wrapped in page divs so api/pdf can render it
  const inner = buildDocHTML(doc, lang, tax, isRe);
  return `<div id="pdf-page1" class="doc-page">${inner}</div><div id="pdf-page2" class="doc-page" style="display:none;"></div>`;
}
function goNew(){sessionStorage.removeItem('loadDocId');window.location.href='/tool';}
async function doSignOut(){await signOut();}

// ── JAHRES-FILTER ──────────────────────────────────────────
function buildYearFilter(){
  const years=[...new Set(allDocs.map(d=>d.datum?d.datum.slice(0,4):null).filter(Boolean))].sort().reverse();
  const sel=$('f-year');
  years.forEach(y=>{const o=document.createElement('option');o.value=y;o.textContent=y;sel.appendChild(o);});
  const cur=String(new Date().getFullYear());
  if(years.includes(cur))sel.value=cur;
}

// ── KPIs ──────────────────────────────────────────────────
function buildKPIs(){
  const re=allDocs.filter(d=>d.typ==='rechnung');
  const ang=allDocs.filter(d=>d.typ==='angebot');

  // Einnahmen: Rechnungen aus dem Tool + CSV-Eingänge (allMatches is_einnahme=true)
  const reRange=re.filter(d=>inRange(d.datum));
  const invoiceIncome=reRange.reduce((s,d)=>s+docVal(d),0);
  const csvIncomeMatches=allMatches.filter(m=>!!m.is_einnahme&&m.datum&&inRange(m.datum));
  const csvIncomeTotal=csvIncomeMatches.reduce((s,m)=>s+Math.abs(m.betrag_brutto||0),0);
  const totalEinnahmen=invoiceIncome+csvIncomeTotal;
  $('kpi-year').textContent=fmt(totalEinnahmen);
  const einSubParts=[];
  if(reRange.length) einSubParts.push(`${reRange.length} Rechnung${reRange.length!==1?'en':''}`);
  if(csvIncomeMatches.length) einSubParts.push(`${csvIncomeMatches.length} CSV-Eingänge`);
  $('kpi-year-sub').textContent=einSubParts.join(' · ')||'–';

  // Ausgaben im gewählten Zeitraum (aus kategorisierten Buchungen)
  const expenses=allMatches.filter(m=>!m.is_einnahme&&m.datum&&inRange(m.datum));
  const totalAusgaben=expenses.reduce((s,m)=>s+Math.abs(m.betrag_brutto||0),0);
  $('kpi-ausgaben').textContent=fmt(totalAusgaben);
  $('kpi-ausgaben-sub').textContent=expenses.length
    ? `${expenses.length} Buchung${expenses.length!==1?'en':''}`
    : 'Keine Buchungen importiert';

  // Gewinn / Verlust — immer Netto
  const invoiceNetto=reRange.reduce((s,d)=>s+docNetto(d),0);
  const csvIncomeNetto=csvIncomeMatches.reduce((s,m)=>s+Math.abs(m.betrag_netto||m.betrag_brutto||0),0);
  const expenseNetto=expenses.reduce((s,m)=>s+Math.abs(m.betrag_netto||m.betrag_brutto||0),0);
  const totalEinnahmenNetto=invoiceNetto+csvIncomeNetto;
  const gewinn=totalEinnahmenNetto-expenseNetto;
  const gwEl=$('kpi-gewinn');
  gwEl.textContent=fmt(Math.abs(gewinn));
  gwEl.style.color=gewinn>=0?'var(--green)':'var(--red)';
  $('kpi-gewinn-sub').textContent=gewinn>=0
    ? `${fmt(totalEinnahmenNetto)} Netto − ${fmt(expenseNetto)} Ausg.`
    : `Verlust: Ausgaben übersteigen Einnahmen`;

  // Offene Angebote (zeitraumunabhängig – immer aktuell)
  const openAng=ang.filter(d=>{const s=getActiveStatus(d);return!s||s==='sent';});
  const openVol=openAng.reduce((s,d)=>s+docBrutto(d),0);
  $('kpi-open').textContent=String(openAng.length);
  $('kpi-open-sub').textContent=openVol?`Volumen: ${fmt(openVol)}`:'Kein Volumen';
}

// ── MONATS-CHART ──────────────────────────────────────────
function buildMonthChart(){
  const months=['Jan','Feb','Mär','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
  const ctx=$('chart-monthly').getContext('2d');
  monthChart=new Chart(ctx,{
    type:'bar',
    data:{labels:months,datasets:[
      {
        label:'Einnahmen',data:getIncomeChartValues(),
        backgroundColor:'rgba(212,204,46,0.5)',borderColor:'rgba(212,204,46,0.9)',
        borderWidth:1.5,borderRadius:4,borderSkipped:false,
      },
      {
        label:'Ausgaben',data:getExpenseChartValues(),
        backgroundColor:'rgba(224,85,85,0.35)',borderColor:'rgba(224,85,85,0.75)',
        borderWidth:1.5,borderRadius:4,borderSkipped:false,
      }
    ]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{
        legend:{display:true,labels:{color:'#9a9ca5',font:{size:10},boxWidth:12,padding:10}},
        tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${c.parsed.y.toLocaleString('de-DE',{minimumFractionDigits:2})} €`},
          backgroundColor:'#27282c',borderColor:'#3d3f45',borderWidth:1,titleColor:'#9a9ca5',bodyColor:'#e2e3e8'}
      },
      scales:{
        x:{grid:{color:'rgba(61,63,69,.5)'},ticks:{color:'#5c5f6b',font:{size:10}}},
        y:{grid:{color:'rgba(61,63,69,.5)'},ticks:{color:'#5c5f6b',font:{size:10},
          callback:v=>v>=1000?`${(v/1000).toFixed(0)}k €`:v+' €'}}
      }
    }
  });
}

function getIncomeChartValues(){
  return Array.from({length:12},(_,m)=>{
    const mStr=`${rangeYear}-${String(m+1).padStart(2,'0')}`;
    const invoiceInc=allDocs.filter(d=>d.typ==='rechnung'&&d.datum&&d.datum.startsWith(mStr)&&inRange(d.datum))
      .reduce((s,d)=>s+docVal(d),0);
    const csvInc=allMatches.filter(x=>!!x.is_einnahme&&x.datum&&x.datum.startsWith(mStr)&&inRange(x.datum))
      .reduce((s,x)=>s+Math.abs(x.betrag_brutto||0),0);
    return invoiceInc+csvInc;
  });
}
function getExpenseChartValues(){
  return Array.from({length:12},(_,m)=>{
    const mStr=`${rangeYear}-${String(m+1).padStart(2,'0')}`;
    return allMatches.filter(x=>!x.is_einnahme&&x.datum&&x.datum.startsWith(mStr)&&inRange(x.datum))
      .reduce((s,x)=>s+Math.abs(x.betrag_brutto||0),0);
  });
}

function updateMonthChart(){
  if(!monthChart)return;
  monthChart.data.datasets[0].data=getIncomeChartValues();
  monthChart.data.datasets[1].data=getExpenseChartValues();
  monthChart.update('active');
}

// ── TOP KUNDEN ─────────────────────────────────────────────
function buildTopCustomers(){
  const map={};
  allDocs.filter(d=>d.typ==='rechnung'&&d.firma&&((!rangeFrom&&!rangeTo)?d.datum?.startsWith(String(rangeYear)):inRange(d.datum))).forEach(d=>{
    map[d.firma]=(map[d.firma]||0)+docVal(d);
  });
  const sorted=Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const max=sorted[0]?.[1]||1;
  const el=$('top-customers');
  if(!sorted.length){el.innerHTML='<div style="color:var(--text3);font-size:11px;">Noch keine Rechnungen.</div>';return;}
  el.innerHTML=sorted.map(([name,val])=>`
    <div class="top-item">
      <span class="top-name" title="${name}">${name}</span>
      <div class="top-bar-wrap"><div class="top-bar" style="width:${Math.round(val/max*100)}%"></div></div>
      <span class="top-val">${fmt(val)}</span>
    </div>`).join('');
}

// ── AUSGABEN NACH KATEGORIE ────────────────────────────────
function buildAusgabenByKategorie(){
  const expenses=allMatches.filter(m=>!m.is_einnahme&&m.datum&&inRange(m.datum));
  const map={};
  expenses.forEach(m=>{
    const cat=m.kategorie||'sonstiges';
    map[cat]=(map[cat]||0)+Math.abs(m.betrag_brutto||0);
  });
  const sorted=Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,7);
  const max=sorted[0]?.[1]||1;
  const el=$('ausgaben-by-kat');
  if(!sorted.length){
    el.innerHTML='<div style="color:var(--text3);font-size:11px;">Keine Buchungen im Zeitraum.<br><span style="font-size:10px;">CSV in Steuer → Schritt 1 importieren.</span></div>';
    return;
  }
  el.innerHTML=sorted.map(([cat,val])=>`
    <div class="top-item">
      <span class="top-name" title="${KAT_LABELS[cat]||cat}">${KAT_LABELS[cat]||cat}</span>
      <div class="top-bar-wrap"><div class="top-bar" style="width:${Math.round(val/max*100)}%;background:var(--orange);opacity:.8;"></div></div>
      <span class="top-val">${fmt(val)}</span>
    </div>`).join('');
}

// ── OFFENE ANGEBOTE LISTE ──────────────────────────────────
function buildOpenAngebote(){
  const open=allDocs.filter(d=>d.typ==='angebot'&&(!getActiveStatus(d)||getActiveStatus(d)==='sent'))
    .sort((a,b)=>(b.datum||'').localeCompare(a.datum||'')).slice(0,6);
  const el=$('open-angebote-list');
  if(!open.length){el.innerHTML='<div style="color:var(--text3);font-size:11px;">Keine offenen Angebote.</div>';return;}
  el.innerHTML=open.map(d=>{
    const val=docBrutto(d);
    return`<div class="top-item" style="cursor:pointer;" onclick="previewEdit_id('${d.id}')">
      <span class="top-name" title="${d.firma||''}">${d.firma||'–'}</span>
      <div class="top-bar-wrap"><div class="top-bar" style="width:100%;opacity:.4;"></div></div>
      <span class="top-val">${val?fmt(val):'–'} <span style="color:var(--text3);font-size:10px;">${fmtDate(d.datum)}</span></span>
    </div>`;
  }).join('');
}

// ── INIT ──────────────────────────────────────────────────
async function init(){
  const user=await getUser();
  if(!user){window.location.href='/';return;}
  $('nav-user-email').textContent=user.email||'';

  // Daten parallel laden
  const [docs,matches]=await Promise.allSettled([
    DB.getDocuments(),
    DB.getAllMatches(),
  ]);
  allDocs   = docs.status==='fulfilled'   ? docs.value   : [];
  allMatches= matches.status==='fulfilled' ? matches.value : [];
  if(docs.status==='rejected') console.error('Dokumente nicht geladen:',docs.reason);

  buildYearFilter();
  applyFilter();
  // Init date range to current year
  const y=new Date().getFullYear();
  rangeFrom=`${y}-01-01`; rangeTo=`${y}-12-31`; rangeYear=y;
  $('range-from').value=rangeFrom; $('range-to').value=rangeTo;
  refreshKPILabels();
  buildKPIs();
  buildMonthChart();
  buildTopCustomers();
  buildAusgabenByKategorie();
  buildOpenAngebote();
  $('loading').style.display='none';
  lucide.createIcons();
}
init();
</script>
</body>
</html>
