<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VISO Media – Dokumente</title>
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<style>
/* ── TOKENS ─────────────────────────────────────────── */
:root{
  /* Backgrounds: warm grays statt reines Schwarz */
  --bg:#1e1f22;
  --surface:#27282c;
  --surface2:#2f3035;
  --surface3:#383a40;
  --border:#3d3f45;
  --border2:#4a4c54;
  --text:#e2e3e8;
  --text2:#9a9ca5;
  --text3:#5c5f6b;
  /* Weniger saturiertes Gelb */
  --accent:#d4cc2e;
  --accent-dim:#a8a325;
  --accent-bg:rgba(212,204,46,0.08);
  --red:#e05555;
  --green:#4ade80;
  --blue:#60a5fa;
  --radius:8px;
  --radius-sm:5px;
  --sidebar-w:300px;
  --nav-w:52px;
  --font:'Helvetica Neue',Arial,sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--font);font-size:13px;color:var(--text);background:var(--bg);display:flex;height:100vh;overflow:hidden;}

/* ── NAV ────────────────────────────────────────────── */
#nav{
  width:var(--nav-w);flex-shrink:0;
  background:var(--surface);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;
  padding:10px 0;gap:2px;
  z-index:20;
}
.nav-btn{
  width:36px;height:36px;border:none;background:none;
  color:var(--text3);cursor:pointer;border-radius:var(--radius-sm);
  display:flex;align-items:center;justify-content:center;
  transition:background .15s,color .15s;position:relative;
}
.nav-btn:hover{background:var(--surface3);color:var(--text);}
.nav-btn.active{background:var(--surface3);color:var(--accent);}
.nav-btn svg{width:16px;height:16px;stroke-width:1.8;}
.nav-sep{width:24px;height:1px;background:var(--border);margin:4px 0;}
.nav-logo{font-size:11px;font-weight:700;color:var(--text2);letter-spacing:.5px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border);width:100%;text-align:center;}

/* ── SIDEBAR ────────────────────────────────────────── */
#sidebar{
  width:var(--sidebar-w);flex-shrink:0;
  background:var(--surface);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  overflow:hidden;
  position:relative;
}
#sidebar-content{flex:1;overflow-y:auto;padding:16px;}
#sidebar-content::-webkit-scrollbar{width:4px;}
#sidebar-content::-webkit-scrollbar-track{background:transparent;}
#sidebar-content::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* Resize handle */
#resize-handle{
  position:absolute;right:0;top:0;bottom:0;width:4px;
  cursor:col-resize;z-index:10;
  background:transparent;transition:background .15s;
}
#resize-handle:hover,#resize-handle.dragging{background:var(--accent);}

/* Sidebar panels */
.panel{display:none;}
.panel.active{display:block;}
.panel-title{
  font-size:11px;font-weight:600;color:var(--text2);
  text-transform:uppercase;letter-spacing:.8px;
  margin-bottom:16px;
}

/* Form elements – nur im Sidebar anwenden, NICHT im doc-page */
.field-group{margin-bottom:14px;}
.field-label{font-size:11px;color:var(--text3);margin-bottom:5px;display:block;}
#sidebar .field-input,
#sidebar input[type=text],#sidebar input[type=email],
#sidebar input[type=number],#sidebar input[type=date],
#sidebar textarea,#sidebar select,
#topbar input[type=text],#topbar input[type=email]{
  width:100%;background:var(--surface2);
  border:1px solid var(--border2);border-radius:var(--radius-sm);
  color:var(--text);font-size:12px;padding:7px 10px;
  outline:none;font-family:var(--font);
  transition:border-color .15s,background .15s;
  -webkit-appearance:none;
}
#sidebar input:focus,#sidebar textarea:focus,#sidebar select:focus{
  border-color:var(--accent);
  background:var(--surface3);
}
#sidebar textarea{resize:vertical;min-height:56px;line-height:1.6;}
#sidebar select{cursor:pointer;appearance:none;-webkit-appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%235c5f6b' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 9px center;
  padding-right:28px;}
#sidebar select option{background:var(--surface2);color:var(--text);}

/* Section header */
.section-hd{
  font-size:10px;font-weight:600;color:var(--text3);
  text-transform:uppercase;letter-spacing:.7px;
  margin:18px 0 8px;
  display:flex;align-items:center;gap:6px;
}
.section-hd::after{content:'';flex:1;height:1px;background:var(--border);}

/* Buttons */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
  padding:7px 12px;border:none;border-radius:var(--radius-sm);
  font-size:12px;font-weight:500;cursor:pointer;font-family:var(--font);
  transition:opacity .15s,background .15s;white-space:nowrap;
}
.btn:hover{opacity:.85;}
.btn-primary{background:var(--accent);color:#111;}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border2);}
.btn-ghost:hover{background:var(--surface3);opacity:1;}
.btn-danger{background:transparent;color:var(--red);border:1px solid var(--border2);}
.btn-danger:hover{background:#2a1515;opacity:1;}
.btn-full{width:100%;margin-top:6px;}
.btn svg{width:14px;height:14px;stroke-width:2;}
.btn-icon{
  width:28px;height:28px;padding:0;background:transparent;
  border:none;color:var(--text3);cursor:pointer;border-radius:4px;
  display:inline-flex;align-items:center;justify-content:center;
  transition:background .15s,color .15s;
}
.btn-icon:hover{background:var(--surface3);color:var(--text);}
.btn-icon svg{width:14px;height:14px;stroke-width:1.8;}

/* Cards */
.card{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--radius);padding:10px 12px;margin-bottom:8px;
  position:relative;
}
.card:hover{border-color:var(--border2);}
.card-title{font-size:12px;font-weight:600;color:var(--text);margin-bottom:3px;}
.card-sub{font-size:11px;color:var(--text3);line-height:1.5;}
.card-actions{display:flex;gap:6px;margin-top:8px;align-items:center;}
.card-del{position:absolute;top:8px;right:8px;}

/* Status chips */
.status-row{display:flex;gap:5px;flex-wrap:wrap;margin-top:8px;}
.chip{
  font-size:10px;padding:3px 8px;border-radius:20px;cursor:pointer;
  border:1px solid var(--border2);color:var(--text3);background:none;
  font-family:var(--font);transition:.15s;user-select:none;
}
.chip:hover{border-color:var(--text3);color:var(--text2);}
.chip.sent{background:#1a2a3f;border-color:var(--blue);color:var(--blue);}
.chip.accepted{background:#0f2a1a;border-color:var(--green);color:var(--green);}
.chip.declined{background:#2a1515;border-color:var(--red);color:var(--red);}
.chip.paid{background:#0f2a1a;border-color:var(--green);color:var(--green);}

/* Toggle row */
.toggle-row{display:flex;gap:6px;}
.toggle-btn{
  flex:1;padding:6px 8px;border:1px solid var(--border2);
  border-radius:var(--radius-sm);background:var(--surface2);
  color:var(--text3);cursor:pointer;font-size:11px;font-weight:500;
  font-family:var(--font);transition:.15s;text-align:center;
}
.toggle-btn:hover{border-color:var(--text3);color:var(--text2);}
.toggle-btn.active{background:var(--accent);color:#111;border-color:var(--accent);}

/* Tax pills */
.tax-group{display:flex;flex-direction:column;gap:4px;}
.tax-btn{
  padding:7px 10px;border:1px solid var(--border2);border-radius:var(--radius-sm);
  background:var(--surface2);color:var(--text3);cursor:pointer;
  font-size:11px;font-family:var(--font);text-align:left;transition:.15s;
}
.tax-btn:hover{border-color:var(--text3);color:var(--text2);}
.tax-btn.active{background:var(--surface3);border-color:var(--accent);color:var(--accent);}

/* Hist item */
.hist-item{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--radius);padding:10px 12px;margin-bottom:7px;
  transition:border-color .15s;
}
.hist-item:hover{border-color:var(--border2);}
.hist-badge{
  display:inline-block;font-size:9px;padding:2px 6px;
  border-radius:3px;font-weight:700;margin-bottom:5px;
}
.badge-ang{background:#3a2a0a;color:#fbbf24;}
.badge-re{background:#0a2a1a;color:var(--green);}
.hist-nr{font-size:12px;font-weight:600;color:var(--text);cursor:pointer;}
.hist-nr:hover{color:var(--accent);}
.hist-sub{font-size:10px;color:var(--text3);margin-top:2px;}

/* Toast */
#toast{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:var(--surface3);color:var(--text);border:1px solid var(--border2);
  padding:9px 18px;border-radius:var(--radius);font-size:12px;
  opacity:0;transition:.25s;pointer-events:none;z-index:999;
  box-shadow:0 4px 20px rgba(0,0,0,.4);
}
#toast.show{opacity:1;}

/* ── MAIN / DOCUMENT AREA ───────────────────────────── */
#main{
  flex:1;overflow-y:auto;background:var(--bg);
  padding:24px 32px;
  display:flex;flex-direction:column;align-items:center;gap:0;
}
#main::-webkit-scrollbar{width:6px;}
#main::-webkit-scrollbar-track{background:transparent;}
#main::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

/* Top action bar */
#topbar{
  width:210mm;max-width:100%;
  display:flex;align-items:center;gap:8px;
  margin-bottom:16px;
  flex-shrink:0;
}
#topbar .spacer{flex:1;}
#topbar .doc-type-toggle{display:flex;gap:4px;}
#topbar .doc-type-btn{
  padding:6px 14px;border:1px solid var(--border2);border-radius:var(--radius-sm);
  background:var(--surface2);color:var(--text3);cursor:pointer;
  font-size:12px;font-weight:500;font-family:var(--font);transition:.15s;
}
#topbar .doc-type-btn.active{background:var(--accent);color:#111;border-color:var(--accent);}

/* ── DOCUMENT PAGES ─────────────────────────────────── */
.doc-page{
  width:210mm;max-width:100%;
  background:#fff;color:#1a1a1a;
  padding:20mm 20mm 18mm 22mm;
  box-shadow:0 2px 24px rgba(0,0,0,.35);
  margin-bottom:20px;
  position:relative;
  flex-shrink:0;
}
/* Page 2 starts on new page always */
#page2{display:none;}

/* Doc variables inside white doc */
.doc-page{
  --doc-accent:#5a5a5a;
  --doc-accent-soft:#888;
  --doc-light:#f7f7f7;
  font-family:'Helvetica Neue',Arial,sans-serif;
  font-size:12.5px;
  line-height:1.5;
}

/* ── INLINE EDIT STYLES ────────────────────────────────────
   Alle Inline-Felder im Dokument: einheitlich, kein schwarzer Hintergrund,
   kein gestrichelter Rand – stattdessen dezenter Hover/Focus-Effekt.
   Im PDF werden alle Klassen komplett bereinigt.
──────────────────────────────────────────────────────────── */
.ie,.ie-block,.ie-select,.ie-date{
  font-family:inherit;font-size:inherit;color:inherit;
  background:transparent;
  border:1px solid transparent;
  border-radius:3px;
  outline:none;
  transition:background .12s,border-color .12s;
}
/* Standard: subtiler Rand – immer sichtbar */
.ie,.ie-block,.ie-select,.ie-date{
  border-color:#e8e8e8;
}
/* Hover: etwas deutlicher */
.ie:hover,.ie-block:hover,.ie-select:hover,.ie-date:hover{
  background:rgba(0,0,0,.03);
  border-color:#ccc;
}
/* Focus: klarer Rahmen */
.ie:focus,.ie-block:focus,.ie-select:focus,.ie-date:focus{
  background:#f5f5e8;
  border-color:#999;
}
/* Einzelne Maße */
.ie{padding:1px 3px;width:auto;min-width:40px;}
.ie-block{padding:3px 5px;width:100%;}
.ie-select{
  padding:2px 4px;cursor:pointer;
  -webkit-appearance:none;appearance:none;
}
/* Native date picker – behält Browser-Kalender */
.ie-date{
  padding:2px 4px;cursor:pointer;width:138px;
  -webkit-appearance:auto;appearance:auto;
}
.ie-date::-webkit-calendar-picker-indicator{
  opacity:0.4;cursor:pointer;
}

/* Doc header */
.doc-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:9mm;}
.doc-logo{font-size:20px;font-weight:700;color:#111;letter-spacing:-.3px;}
.doc-logo span{color:var(--doc-accent-soft);font-weight:300;}
.doc-name-sub{font-size:10.5px;color:#888;margin-top:2px;}
.doc-meta{text-align:right;}
/* Typ-Titel kein hartes Schwarz – dunkles Grau */
.doc-meta h1{font-size:21px;font-weight:700;color:#4a4a4a;margin-bottom:5px;}
.doc-meta-row{font-size:11.5px;color:#555;line-height:1.9;display:flex;align-items:center;gap:4px;justify-content:flex-end;}
.doc-meta-label{color:#999;font-size:10.5px;white-space:nowrap;}

.sender-bar{font-size:9px;color:#aaa;margin-bottom:5mm;border-bottom:1px solid #eee;padding-bottom:2mm;}

/* Empfänger + Inline-Kunde */
.recipient-block{margin-bottom:7mm;min-height:24mm;position:relative;}
.recipient-block p{line-height:1.8;font-size:12px;}

/* Kunde-Inline Toolbar */
.recipient-toolbar{
  display:flex;gap:5px;align-items:center;margin-bottom:4px;
}
/* Einheitliche Inline-Steuerelemente im Dokument-Kontext */
.doc-ctrl{
  font-size:10.5px;padding:3px 8px;border-radius:3px;
  background:#f0f0f0;border:1px solid #d0d0d0;color:#555;
  font-family:inherit;cursor:pointer;outline:none;
  transition:background .12s,border-color .12s;
}
.doc-ctrl:hover{background:#e4e4e4;border-color:#aaa;color:#333;}
.doc-ctrl:focus{border-color:#999;outline:none;}
.recipient-toolbar select.rc-sel{
  -webkit-appearance:none;appearance:none;
  padding-right:20px;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 5px center;
  background-color:#f0f0f0;
  max-width:220px;
}
.recipient-toolbar button.rc-btn{
  padding:3px 8px;white-space:nowrap;flex-shrink:0;
}

.doc-subject{
  font-size:13.5px;font-weight:700;color:#111;
  margin-bottom:4mm;
}
.doc-intro{margin-bottom:5mm;line-height:1.75;color:#444;font-size:12px;}

/* Table – gedimmter Header statt Schwarz */
.doc-table{width:100%;border-collapse:collapse;margin-bottom:5mm;font-size:12px;}
.doc-table thead tr{background:var(--doc-accent);color:#fff;}
.doc-table thead th{padding:7px 9px;text-align:left;font-weight:600;font-size:11.5px;}
.doc-table thead th:nth-child(n+3){text-align:right;white-space:nowrap;}
.doc-table tbody tr{border-bottom:1px solid #eee;}
.doc-table tbody tr:nth-child(even){background:var(--doc-light);}
.doc-table tbody td{padding:7px 9px;vertical-align:top;}
.doc-table tbody td:nth-child(n+3){text-align:right;white-space:nowrap;}
.doc-table .add-row-btn{
  display:block;width:100%;padding:6px;margin-top:4px;
  background:none;border:1px dashed #ccc;border-radius:4px;
  color:#aaa;font-size:11px;cursor:pointer;font-family:inherit;
  transition:.15s;
}
.doc-table .add-row-btn:hover{border-color:#999;color:#666;}
.pos-del{
  background:none;border:none;color:#ccc;cursor:pointer;
  font-size:13px;padding:0 2px;vertical-align:middle;
  transition:color .15s;
}
.pos-del:hover{color:#e05555;}
.pos-details-input{
  width:100%;background:transparent;border:none;border-bottom:1px solid transparent;
  font-family:inherit;font-size:11px;color:#555;padding:2px 3px;
  outline:none;margin-top:3px;resize:none;min-height:0;overflow:hidden;
  border-radius:2px;
  transition:background .12s,border-color .12s;
}
.pos-details-input:hover{background:rgba(0,0,0,.03);border-bottom-color:#ddd;}
.pos-details-input:focus{border-bottom-color:#aaa;background:#f5f5f5;}
/* Bullet-Rendering im Editor */
.pos-detail-line{
  display:block;padding-left:14px;position:relative;
  font-size:11px;color:#555;line-height:1.6;margin-top:3px;
}
.pos-detail-line::before{
  content:'–';position:absolute;left:0;color:#999;
}

/* Totals */
.totals-wrap{margin-left:auto;width:240px;margin-bottom:6mm;}
.totals-wrap table{width:100%;border-collapse:collapse;}
.totals-wrap td{padding:4px 9px;font-size:12px;}
.totals-wrap tr.total-final{background:var(--doc-accent);color:#fff;font-weight:700;font-size:13px;}
.totals-wrap tr.total-final td{padding:7px 9px;}

/* Info boxes */
.info-box{
  background:#f8f8f8;border-left:3px solid #aaa;
  padding:9px 13px;margin-bottom:5mm;font-size:11.5px;line-height:1.75;color:#333;
}
.sign-block{margin-bottom:10mm;line-height:1.75;color:#444;font-size:12px;}

/* Footer – keep-together per display:table-footer-group trick nicht nötig,
   wir nutzen page-break-inside:avoid im PDF */
.doc-footer{
  border-top:1px solid #e0e0e0;padding-top:4mm;
  display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;
  font-size:10px;color:#555;line-height:1.85;
  page-break-inside:avoid;
  break-inside:avoid;
}
.doc-footer strong{color:#333;font-size:10.5px;display:block;margin-bottom:2px;}

/* AGB */
.agb-section{margin-bottom:5mm;}
.agb-section h3{font-size:11.5px;font-weight:700;color:var(--doc-accent);margin-bottom:2mm;border-bottom:1px solid #eee;padding-bottom:1.5mm;}
.agb-section p{font-size:11px;line-height:1.75;color:#444;}
.sig-block{margin-top:10mm;display:grid;grid-template-columns:1fr 1fr;gap:14mm;}
.sig-field{border-top:1px solid #aaa;padding-top:2.5mm;font-size:9.5px;color:#888;}
.sig-field .sig-line{height:13mm;}
.agb-hint-box{background:#f8f8f8;border-left:3px solid #aaa;padding:9px 13px;font-size:11px;color:#555;}

/* ── PRINT / PDF OVERRIDES ──────────────────────────── */
@media print{
  body{background:#fff;display:block;}
  #nav,#sidebar,#topbar{display:none!important;}
  #main{padding:0;overflow:visible;}
  .doc-page{box-shadow:none;margin:0;width:100%;padding:0;}
  #page1{page-break-after:always;}
  #page2{display:block!important;page-break-before:always;page-break-after:auto;}
  @page{size:A4;margin:25mm;}
  .ie,.ie-block,.ie-select,.ie-date{border:none!important;background:transparent!important;}
  .doc-table .add-row-btn{display:none!important;}
  .pos-del{display:none!important;}
  .doc-footer{page-break-inside:avoid;break-inside:avoid;}
  .recipient-toolbar{display:none!important;}
}
</style>
</head>
<body>

<!-- ── LEFT NAV ──────────────────────────────────────────── -->
<div id="nav">
  <div class="nav-logo">VM</div>
  <button class="nav-btn active" onclick="showPanel('doc',this)" title="Dokument" id="nav-doc">
    <i data-lucide="file-text"></i>
  </button>
  <button class="nav-btn" onclick="newDoc(this)" title="Neues Dokument" id="nav-new">
    <i data-lucide="plus"></i>
  </button>
  <div class="nav-sep"></div>
  <button class="nav-btn" onclick="showPanel('customers',this)" title="Kunden" id="nav-customers">
    <i data-lucide="users"></i>
  </button>
  <button class="nav-btn" onclick="showPanel('library',this)" title="Leistungen" id="nav-library">
    <i data-lucide="package"></i>
  </button>
  <div class="nav-sep"></div>
  <button class="nav-btn" onclick="showPanel('history',this)" title="Verlauf" id="nav-history">
    <i data-lucide="clock"></i>
  </button>
  <button class="nav-btn" onclick="showPanel('email',this)" title="E-Mail" id="nav-email">
    <i data-lucide="mail"></i>
  </button>
  <div class="nav-sep"></div>
  <button class="nav-btn" onclick="showPanel('data',this)" title="Daten" id="nav-data">
    <i data-lucide="database"></i>
  </button>
  <div style="flex:1"></div>
  <button class="nav-btn" id="nav-logout" onclick="signOut()" title="Abmelden">
    <i data-lucide="log-out"></i>
  </button>
</div>

<!-- ── SIDEBAR ───────────────────────────────────────────── -->
<div id="sidebar">
  <div id="resize-handle"></div>
  <div id="sidebar-content">

    <!-- DOC SETTINGS -->
    <div class="panel active" id="panel-doc">
      <div class="panel-title">Einstellungen</div>

      <div class="section-hd">Sprache</div>
      <div class="toggle-row">
        <button class="toggle-btn active" id="lang-de" onclick="setLang('de')">DE</button>
        <button class="toggle-btn" id="lang-en" onclick="setLang('en')">EN</button>
      </div>

      <div class="section-hd">Steuer</div>
      <div class="tax-group">
        <button class="tax-btn active" id="tax-de" onclick="setTax('de')">Standard 19% MwSt.</button>
        <button class="tax-btn" id="tax-eu" onclick="setTax('eu')">EU B2B – Reverse Charge</button>
        <button class="tax-btn" id="tax-int" onclick="setTax('int')">Drittland – steuerbefreit</button>
      </div>
      <div id="wrap_uid" style="display:none;margin-top:8px;">
        <label class="field-label">USt-IdNr. Kunde</label>
        <input type="text" id="f_uid" placeholder="DE123456789" oninput="update()">
      </div>

      <div class="section-hd">Zahlung</div>
      <select id="f_zahlung" onchange="update()">
        <option value="voll">Vollzahlung (14 Tage)</option>
        <option value="50">50% Anzahlung</option>
      </select>

      <div class="section-hd">Aktionen</div>
      <button class="btn btn-ghost btn-full" onclick="convertDoc()">
        <i data-lucide="arrow-left-right"></i> Umwandeln
      </button>
      <button class="btn btn-ghost btn-full" style="margin-top:6px;" onclick="saveDoc()">
        <i data-lucide="save"></i> Speichern
      </button>
      <button class="btn btn-primary btn-full" style="margin-top:6px;" onclick="printPDF()">
        <i data-lucide="download"></i> PDF Download
      </button>
    </div>

    <!-- CUSTOMERS -->
    <div class="panel" id="panel-customers">
      <div class="panel-title">Kundendatenbank</div>
      <div id="customer-list"></div>
      <div class="section-hd">Neu anlegen</div>
      <label class="field-label">Firma / Name *</label>
      <input type="text" id="nc_firma" placeholder="Mustermann GmbH">
      <label class="field-label" style="margin-top:8px;">Ansprechpartner</label>
      <input type="text" id="nc_ansp" placeholder="Max Mustermann">
      <label class="field-label" style="margin-top:8px;">Straße</label>
      <input type="text" id="nc_str" placeholder="Musterstraße 1">
      <label class="field-label" style="margin-top:8px;">PLZ & Ort</label>
      <input type="text" id="nc_ort" placeholder="12345 Berlin">
      <label class="field-label" style="margin-top:8px;">Land</label>
      <input type="text" id="nc_land" placeholder="Deutschland">
      <label class="field-label" style="margin-top:8px;">E-Mail</label>
      <input type="email" id="nc_email" placeholder="kontakt@firma.de">
      <button class="btn btn-primary btn-full" style="margin-top:12px;" onclick="saveCustomer()">
        <i data-lucide="check"></i> Speichern
      </button>
    </div>

    <!-- LIBRARY -->
    <div class="panel" id="panel-library">
      <div class="panel-title">Leistungsbibliothek</div>
      <div id="lib-list"></div>
      <div class="section-hd">Neu anlegen</div>
      <label class="field-label">Bezeichnung *</label>
      <input type="text" id="nl_desc" placeholder="Social Media Betreuung">
      <label class="field-label" style="margin-top:8px;">Beschreibung</label>
      <textarea id="nl_details" placeholder="Details..." style="min-height:50px;"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <div style="flex:1">
          <label class="field-label">Menge</label>
          <input type="text" id="nl_menge" value="1">
        </div>
        <div style="flex:1">
          <label class="field-label">Einheit</label>
          <select id="nl_einheit">
            <option value="pauschal">pauschal</option>
            <option value="stunde">Stunde</option>
            <option value="tag">Tag</option>
            <option value="stueck">Stück</option>
            <option value="monat">Monat</option>
            <option value="wort">Wort</option>
          </select>
        </div>
      </div>
      <label class="field-label" style="margin-top:8px;">Preis (€)</label>
      <input type="text" id="nl_preis" placeholder="0,00">
      <button class="btn btn-primary btn-full" style="margin-top:12px;" onclick="saveLibItem()">
        <i data-lucide="check"></i> Speichern
      </button>
    </div>

    <!-- HISTORY -->
    <div class="panel" id="panel-history">
      <div class="panel-title">Verlauf</div>
      <div id="history-list"><p style="color:var(--text3);font-size:11px;">Keine Dokumente.</p></div>
    </div>

    <!-- EMAIL -->
    <div class="panel" id="panel-email">
      <div class="panel-title">E-Mail-Vorlage</div>
      <label class="field-label">Vorlage</label>
      <select id="email_template" onchange="loadEmailTemplate()">
        <option value="angebot_de">Angebot (DE)</option>
        <option value="angebot_en">Quote (EN)</option>
        <option value="rechnung_de">Rechnung (DE)</option>
        <option value="rechnung_en">Invoice (EN)</option>
        <option value="followup_de">Follow-up (DE)</option>
        <option value="followup_en">Follow-up (EN)</option>
      </select>
      <label class="field-label" style="margin-top:10px;">An</label>
      <input type="email" id="email_to" placeholder="kunde@firma.de">
      <label class="field-label" style="margin-top:8px;">Betreff</label>
      <input type="text" id="email_subject">
      <label class="field-label" style="margin-top:8px;">Text</label>
      <textarea id="email_body" style="min-height:180px;font-size:11px;line-height:1.7;"></textarea>
      <p style="font-size:10px;color:var(--text3);margin-top:6px;line-height:1.6;">
        Platzhalter: <code style="color:var(--text2);">{{name}}</code> <code style="color:var(--text2);">{{nr}}</code> <code style="color:var(--text2);">{{betreff}}</code> <code style="color:var(--text2);">{{betrag}}</code> <code style="color:var(--text2);">{{datum}}</code>
      </p>
      <button class="btn btn-ghost btn-full" style="margin-top:8px;" onclick="saveEmailTemplate()">
        <i data-lucide="save"></i> Vorlage speichern
      </button>
      <button class="btn btn-primary btn-full" style="margin-top:6px;" onclick="openGmail()">
        <i data-lucide="external-link"></i> In Gmail öffnen
      </button>
      <button class="btn btn-ghost btn-full" style="margin-top:6px;" onclick="copyEmail()">
        <i data-lucide="copy"></i> Kopieren
      </button>
    </div>

    <!-- DATA -->
    <div class="panel" id="panel-data">
      <div class="panel-title">Datensicherung</div>
      <button class="btn btn-ghost btn-full" onclick="exportData()">
        <i data-lucide="download"></i> Export (.json)
      </button>
      <div class="section-hd" style="margin-top:14px;">Import</div>
      <input type="file" id="import_file" accept=".json" style="font-size:11px;color:var(--text2);width:100%;" onchange="importData(this)">
      <div class="section-hd" style="margin-top:14px;">Statistik</div>
      <div id="data_stats" style="font-size:11px;color:var(--text3);line-height:2.2;background:var(--surface2);padding:10px 12px;border-radius:var(--radius);border:1px solid var(--border);margin-top:4px;"></div>
      <div class="section-hd" style="margin-top:14px;">Reset</div>
      <button class="btn btn-danger btn-full" onclick="resetData()">
        <i data-lucide="trash-2"></i> Alle Daten löschen
      </button>
    </div>

  </div><!-- /sidebar-content -->
</div><!-- /sidebar -->

<div id="toast"></div>

<!-- ── MAIN ──────────────────────────────────────────────── -->
<div id="main">

  <!-- Top bar -->
  <div id="topbar">
    <div class="doc-type-toggle">
      <button class="doc-type-btn active" id="typ-angebot" onclick="setTyp('angebot',this)">Angebot</button>
      <button class="doc-type-btn" id="typ-rechnung" onclick="setTyp('rechnung',this)">Rechnung</button>
    </div>
    <div class="spacer"></div>
    <button class="btn btn-ghost" onclick="saveDoc()">
      <i data-lucide="save"></i> Speichern
    </button>
    <button class="btn btn-primary" onclick="printPDF()">
      <i data-lucide="download"></i> PDF
    </button>
  </div>

  <!-- PAGE 1 -->
  <div class="doc-page" id="page1">

    <!-- Header -->
    <div class="doc-header">
      <div>
        <div class="doc-logo">VISO <span>Media</span></div>
        <div class="doc-name-sub">David Stiehler</div>
      </div>
      <div class="doc-meta">
        <h1 id="d_typ_title">ANGEBOT</h1>
        <div class="doc-meta-row">
          <span class="doc-meta-label" id="d_nr_label">Angebots-Nr.:</span>
          <input class="ie" id="f_nr" value="ANG-2026-001" oninput="update()" style="font-weight:700;font-size:11.5px;width:120px;">
        </div>
        <div class="doc-meta-row">
          <span class="doc-meta-label" id="d_date_label">Datum:</span>
          <input type="date" class="ie-date" id="f_datum" oninput="update()" style="width:138px;">
        </div>
        <div class="doc-meta-row" id="row_extra" style="display:flex;align-items:center;gap:4px;">
          <span class="doc-meta-label" id="d_extra_label" style="white-space:nowrap;">Gültig bis:</span>
          <input type="date" class="ie-date" id="f_gueltig" oninput="update()" style="width:138px;">
          <input type="date" class="ie-date" id="f_von" oninput="update()" style="display:none;width:138px;">
        </div>
      </div>
    </div>

    <!-- Sender bar -->
    <div class="sender-bar">David Stiehler · Schiffenberger Weg 28A · 35394 Gießen · Germany</div>

    <!-- Recipient (inline editable) + Kunden-Toolbar -->
    <div class="recipient-block">
      <!-- Kunden-Toolbar (nur Editor, nicht PDF) -->
      <div class="recipient-toolbar no-print">
        <select class="rc-sel doc-ctrl" id="f_kunde_inline" onchange="loadCustomerInline()">
          <option value="">Kunde wählen …</option>
        </select>
        <button class="rc-btn doc-ctrl" onclick="saveCurrentAsCustomer()" title="Aktuelle Adresse in Kundendatenbank speichern">+ DB</button>
      </div>
      <p>
        <input class="ie-block" id="f_firma" placeholder="Firma / Company" oninput="update()" style="font-weight:700;margin-bottom:2px;">
        <input class="ie-block" id="f_ansprechpartner" placeholder="Ansprechpartner" oninput="update()" style="margin-top:3px;">
        <input class="ie-block" id="f_strasse" placeholder="Straße" oninput="update()" style="margin-top:3px;">
        <input class="ie-block" id="f_ort" placeholder="PLZ & Ort" oninput="update()" style="margin-top:3px;">
        <input class="ie-block" id="f_land" placeholder="Land (optional)" oninput="update()" style="margin-top:3px;">
      </p>
    </div>

    <!-- Subject -->
    <div class="doc-subject">
      <span id="d_subj_prefix" style="color:#888;font-weight:400;font-size:12px;"></span>
      <input class="ie" id="f_betreff" placeholder="Betreff / Subject" oninput="update()" style="font-size:13px;font-weight:700;width:80%;">
    </div>

    <!-- Intro -->
    <p class="doc-intro" id="d_intro"></p>

    <!-- Positions table -->
    <table class="doc-table">
      <thead>
        <tr>
          <th style="width:5%"><span class="th">Pos.</span></th>
          <th style="width:46%"><span class="th">Leistungsbeschreibung</span></th>
          <th style="width:8%;text-align:right;"><span class="th">Menge</span></th>
          <th style="width:12%;text-align:right;"><span class="th">Einheit</span></th>
          <th style="width:13%;text-align:right;"><span class="th">Einzelpreis</span></th>
          <th style="width:14%;text-align:right;"><span class="th">Gesamt</span></th>
          <th style="width:2%;" class="no-print"></th>
        </tr>
      </thead>
      <tbody id="d_positionen">
        <tr><td colspan="7" style="color:#bbb;font-style:italic;text-align:center;padding:14px;">– Positionen werden hier angezeigt –</td></tr>
      </tbody>
      <tfoot>
        <tr class="no-print">
          <td colspan="7">
            <button class="add-row-btn" onclick="addPos()">+ Position hinzufügen</button>
          </td>
        </tr>
      </tfoot>
    </table>

    <!-- Lib select (inline) -->
    <div class="no-print" style="margin-top:-3mm;margin-bottom:5mm;">
      <select id="f_lib_select" class="doc-ctrl" onchange="addFromLib()" style="font-size:11px;-webkit-appearance:none;appearance:none;padding-right:20px;background-image:url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E&quot;);background-repeat:no-repeat;background-position:right 6px center;">
        <option value="">+ Aus Bibliothek hinzufügen</option>
      </select>
    </div>

    <!-- Totals -->
    <div class="totals-wrap">
      <table>
        <tr id="row_netto"><td id="t_net">Nettobetrag</td><td style="text-align:right;" id="d_netto">0,00 €</td></tr>
        <tr id="row_tax"><td id="t_tax">zzgl. 19% MwSt.</td><td style="text-align:right;" id="d_mwst">0,00 €</td></tr>
        <tr class="total-final"><td><strong id="t_total">Gesamtbetrag</strong></td><td style="text-align:right;"><strong id="d_gesamt">0,00 €</strong></td></tr>
      </table>
    </div>

    <!-- Tax note -->
    <div id="d_tax_note_box" class="info-box" style="display:none;font-size:11px;"></div>

    <!-- Hinweise (inline) -->
    <div style="margin-bottom:5mm;">
      <textarea class="ie-block" id="f_hinweise" placeholder="Hinweise (leer = wird nicht angezeigt)" oninput="update();autoResize(this)" style="min-height:36px;font-size:11.5px;" rows="1"></textarea>
    </div>
    <div id="d_notes_rendered" style="display:none;" class="info-box"></div>

    <!-- Payment -->
    <div class="info-box"><strong id="t_payment_title">Zahlungsbedingungen:</strong><br><span id="d_zahlung_text">–</span></div>

    <!-- Sign -->
    <p class="sign-block" id="d_sign"></p>

    <!-- AGB hint (Angebot only) -->
    <div class="agb-hint-box" id="agb_hint" style="display:none;"></div>

    <!-- Footer -->
    <div class="doc-footer">
      <div><strong id="t_contact">Kontakt</strong>David Stiehler<br>Schiffenberger Weg 28A<br>35394 Gießen · Germany<br>015735386155<br>rechnungen&#64;viso.media</div>
      <div><strong id="t_tax_f">Steuer</strong><span id="t_taxnr_label">Steuernummer:</span> 02087201058<br><span id="t_vatid_label">USt-IdNr.:</span> DE354878347</div>
      <div><strong id="t_bank">Bankverbindung</strong><span id="t_accholder_label">Kontoinhaber:</span> David Stiehler<br>Bank: Kontist<br>IBAN: DE02 1101 0101 5262 3588 06<br>BIC: SOBKDEB2XXX</div>
    </div>
  </div><!-- /page1 -->

  <!-- PAGE 2 (AGB – Angebot only) -->
  <div class="doc-page" id="page2">
    <div class="doc-header">
      <div>
        <div class="doc-logo">VISO <span>Media</span></div>
        <div class="doc-name-sub">David Stiehler</div>
      </div>
      <div class="doc-meta" style="padding-top:4px;">
        <p style="font-size:10.5px;color:#aaa;"><span id="t_annex_label">Anhang zu</span> <span id="d_typ2">Angebots</span>-Nr.: <strong id="d_nr2">–</strong></p>
      </div>
    </div>
    <div class="sender-bar">David Stiehler · Schiffenberger Weg 28A · 35394 Gießen · Germany</div>
    <h2 style="font-size:15px;font-weight:700;margin-bottom:7mm;color:#111;" id="t_agb_title">Allgemeine Geschäftsbedingungen (AGB)</h2>
    <div id="agb_content"></div>
    <div class="info-box" style="margin-top:8mm;">
      <strong id="t_confirm_title">Auftragsbestätigung</strong><br>
      <span id="t_confirm_text"></span>
    </div>
    <div class="sig-block">
      <div class="sig-field"><div class="sig-line"></div><span id="t_sig_date">Ort, Datum</span></div>
      <div class="sig-field"><div class="sig-line"></div><span id="t_sig_sign">Unterschrift Auftraggeber / Stempel</span></div>
    </div>
    <div style="margin-top:8mm;font-size:10px;color:#aaa;text-align:center;" id="t_return">Bitte unterschriebene Seite per E-Mail zurücksenden an: rechnungen&#64;viso.media</div>
    <div class="doc-footer" style="margin-top:7mm;">
      <div><strong id="t_contact2">Kontakt</strong>David Stiehler<br>Schiffenberger Weg 28A<br>35394 Gießen · Germany<br>015735386155<br>rechnungen&#64;viso.media</div>
      <div><strong id="t_tax2">Steuer</strong><span id="t_taxnr_label2">Steuernummer:</span> 02087201058<br><span id="t_vatid_label2">USt-IdNr.:</span> DE354878347</div>
      <div><strong id="t_bank2">Bankverbindung</strong><span id="t_accholder_label2">Kontoinhaber:</span> David Stiehler<br>Bank: Kontist<br>IBAN: DE02 1101 0101 5262 3588 06<br>BIC: SOBKDEB2XXX</div>
    </div>
  </div><!-- /page2 -->

</div><!-- /main -->

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="supabase.js"></script>
<script>

// ── INIT LUCIDE ICONS ──────────────────────────────────────
lucide.createIcons();

// ── STATE ──────────────────────────────────────────────────
let positionen=[];
let lang='de',tax='de',typ='angebot';
let customers=[];
let library=[];
let history=[];
let customEmailTpl={};
// Track current loaded doc id for proper upsert
let currentDocId=null;

const UNITS={
  pauschal:{de:'pauschal',en:'flat rate'},
  stunde:{de:'Std.',en:'hr'},
  tag:{de:'Tag',en:'day'},
  stueck:{de:'Stk.',en:'pcs'},
  monat:{de:'Monat',en:'month'},
  wort:{de:'Wort',en:'word'},
};
function unitLabel(key,l){return(UNITS[key]||{de:key,en:key})[l]||key;}

const STATUS_ANG=[
  {key:'sent',   label_de:'Abgeschickt',label_en:'Sent',    cls:'sent'},
  {key:'accepted',label_de:'Angenommen',label_en:'Accepted',cls:'accepted'},
  {key:'declined',label_de:'Abgelehnt', label_en:'Declined',cls:'declined'},
];
const STATUS_RE=[
  {key:'sent',label_de:'Abgeschickt',label_en:'Sent',cls:'sent'},
  {key:'paid',label_de:'Bezahlt',    label_en:'Paid',cls:'paid'},
];

const T={
  de:{
    doc_q:'ANGEBOT',doc_i:'RECHNUNG',nr_q:'Angebots-Nr.:',nr_i:'Rechnungs-Nr.:',
    date:'Datum:',valid:'Gültig bis:',period:'Lieferdatum:',
    th:['Pos.','Leistungsbeschreibung','Menge','Einheit','Einzelpreis','Gesamt'],
    net:'Nettobetrag',tax19:'zzgl. 19% MwSt.',total_q:'Gesamtbetrag',total_i:'Rechnungsbetrag',
    payment:'Zahlungsbedingungen:',notes:'Hinweise:',contact:'Kontakt',tax_f:'Steuer',bank:'Bankverbindung',
    intro_q:'vielen Dank für Ihr Interesse. Gerne unterbreite ich Ihnen folgendes Angebot für die beschriebenen Leistungen:',
    intro_i:'Vielen Dank für Ihren Auftrag. Für die erbrachten Leistungen stelle ich Ihnen folgendes in Rechnung:',
    sign_q:'Für Rückfragen stehe ich Ihnen gerne zur Verfügung. Ich freue mich auf eine gute Zusammenarbeit.<br><br>Mit freundlichen Grüßen,<br><br><strong>David Stiehler</strong><br>VISO Media',
    sign_i:'Für Rückfragen stehe ich Ihnen jederzeit gerne zur Verfügung.<br><br>Mit freundlichen Grüßen,<br><br><strong>David Stiehler</strong><br>VISO Media',
    pay_full:b=>`Gesamtbetrag von <strong>${b}</strong> zahlbar innerhalb von 14 Tagen nach Rechnungsstellung.`,
    pay_50:h=>`Zahlung in zwei Raten: <strong>1. Rate (50% = ${h})</strong> nach Auftragsbestätigung, <strong>2. Rate (50% = ${h})</strong> nach Projektabschluss – jeweils innerhalb von 14 Tagen.`,
    tax_eu:'Hinweis: Steuerfreie innergemeinschaftliche Leistung gemäß § 3a Abs. 2 UStG. Steuerschuld geht auf den Leistungsempfänger über (Reverse Charge). USt-IdNr. des Empfängers: ',
    tax_int:'Hinweis: Gemäß § 3a Abs. 2 UStG ist diese Leistung nicht im Inland steuerbar. Es wird keine Umsatzsteuer ausgewiesen.',
    agb:'Allgemeine Geschäftsbedingungen (AGB)',
    confirm_title:'Auftragsbestätigung',
    confirm:nr=>`Mit Unterzeichnung bestätigt der Auftraggeber, das Angebot (Nr.: ${nr}) gelesen und akzeptiert zu haben, und erteilt verbindlich den Auftrag. Er erklärt sich mit den vorstehenden AGB einverstanden.`,
    sig_date:'Ort, Datum',sig_sign:'Unterschrift Auftraggeber / Stempel',
    return:'Bitte unterschriebene Seite per E-Mail zurücksenden an: rechnungen@viso.media',
    prefix_q:'Angebot: ',prefix_i:'Rechnung: ',
    empty_sub:'Betreff …',
    annex_label:'Anhang zu',annex_q:'Angebots',annex_i:'Rechnungs',
    taxnr:'Steuernummer:',vatid:'USt-IdNr.:',accholder:'Kontoinhaber:',bank_title:'Bankverbindung',
    agb_hint:'AGB auf der nächsten Seite',
  },
  en:{
    doc_q:'QUOTE',doc_i:'INVOICE',nr_q:'Quote No.:',nr_i:'Invoice No.:',
    date:'Date:',valid:'Valid until:',period:'Delivery date:',
    th:['No.','Description','Qty','Unit','Unit price','Total'],
    net:'Net amount',tax19:'plus 19% VAT',total_q:'Total amount',total_i:'Invoice total',
    payment:'Payment terms:',notes:'Notes:',contact:'Contact',tax_f:'Tax',bank:'Bank details',
    intro_q:'Thank you for your interest. Please find our quote for the described services below:',
    intro_i:'Thank you for your order. Please find below our invoice for services rendered:',
    sign_q:'Please do not hesitate to contact me with any questions. I look forward to working with you.<br><br>Kind regards,<br><br><strong>David Stiehler</strong><br>VISO Media',
    sign_i:'Please do not hesitate to contact me with any questions.<br><br>Kind regards,<br><br><strong>David Stiehler</strong><br>VISO Media',
    pay_full:b=>`Total amount of <strong>${b}</strong> due within 14 days of invoice date.`,
    pay_50:h=>`Payment in two instalments: <strong>1st (50% = ${h})</strong> upon order confirmation, <strong>2nd (50% = ${h})</strong> upon project completion – each due within 14 days.`,
    tax_eu:'Note: VAT-exempt intra-community supply pursuant to § 3a para. 2 German VAT Act. Tax liability transferred to recipient (Reverse Charge). Customer VAT ID: ',
    tax_int:'Note: This service is not subject to German VAT pursuant to § 3a para. 2 German VAT Act. No VAT is charged.',
    agb:'Terms and Conditions (T&C)',
    confirm_title:'Order Confirmation',
    confirm:nr=>`By signing, the client confirms having read and accepted the quote (No.: ${nr}) and hereby places a binding order, agreeing to the Terms and Conditions stated above.`,
    sig_date:'Place, Date',sig_sign:'Signature Client / Stamp',
    return:'Please return the signed page by e-mail to: rechnungen@viso.media',
    prefix_q:'Quote: ',prefix_i:'Invoice: ',
    empty_sub:'Subject …',
    annex_label:'Annex to',annex_q:'Quote',annex_i:'Invoice',
    taxnr:'Tax No.:',vatid:'VAT ID:',accholder:'Account holder:',bank_title:'Bank details',
    agb_hint:'T&C on the next page',
  }
};

const AGB={
  de:`<div class="agb-section"><h3>§ 1 – Geltungsbereich</h3><p>Diese AGB gelten für alle Verträge zwischen David Stiehler, VISO Media, Schiffenberger Weg 28A, 35394 Gießen (nachfolgend „Auftragnehmer") und dem Auftraggeber über Leistungen im Bereich Video-/Fotoproduktion sowie Social Media Management.</p></div>
<div class="agb-section"><h3>§ 2 – Vertragsschluss</h3><p>Angebote sind freibleibend. Ein Vertrag kommt durch schriftliche Auftragsbestätigung oder Unterzeichnung des Angebots zustande. Mit Auftragserteilung erkennt der Auftraggeber diese AGB an.</p></div>
<div class="agb-section"><h3>§ 3 – Korrekturrunden</h3><p>Im Preis inbegriffen sind <strong>zwei Korrekturrunden</strong> je Leistungsposition. Weitere Korrekturen werden nach Aufwand berechnet.</p></div>
<div class="agb-section"><h3>§ 4 – Mitwirkungspflichten</h3><p>Der Auftraggeber stellt Materialien und Freigaben rechtzeitig bereit. Verzögerungen berechtigen zur Terminanpassung; Mehrkosten trägt der Auftraggeber.</p></div>
<div class="agb-section"><h3>§ 5 – Urheberrecht & Nutzungsrechte</h3><p>Alle Werke unterliegen dem Urheberrecht des Auftragnehmers. Mit vollständiger Bezahlung erhält der Auftraggeber ein einfaches Nutzungsrecht für die vereinbarten Zwecke. Rohdaten verbleiben beim Auftragnehmer.</p></div>
<div class="agb-section"><h3>§ 6 – Zahlungsbedingungen</h3><p>Rechnungen sind innerhalb von 14 Tagen netto zu begleichen. Bei Verzug fallen Zinsen von 9 Prozentpunkten über dem Basiszinssatz an (§ 288 BGB).</p></div>
<div class="agb-section"><h3>§ 7 – Stornierung</h3><p>Bei Absage weniger als <strong>7 Tage</strong> vor Leistungsbeginn werden <strong>50% des Nettohonorars</strong> als Ausfallhonorar fällig.</p></div>
<div class="agb-section"><h3>§ 8 – Haftung</h3><p>Haftung nur bei Vorsatz oder grober Fahrlässigkeit. Indirekte Schäden sind ausgeschlossen.</p></div>
<div class="agb-section"><h3>§ 9 – Referenzrecht</h3><p>Der Auftragnehmer darf erstellte Arbeiten zu Referenzzwecken veröffentlichen, sofern nicht widersprochen.</p></div>
<div class="agb-section"><h3>§ 10 – Gerichtsstand</h3><p>Es gilt deutsches Recht. Gerichtsstand ist Gießen, soweit gesetzlich zulässig.</p></div>`,
  en:`<div class="agb-section"><h3>§ 1 – Scope</h3><p>These Terms apply to all contracts between David Stiehler, VISO Media, Schiffenberger Weg 28A, 35394 Gießen, Germany ("Service Provider") and the client for video/photo production and social media management services.</p></div>
<div class="agb-section"><h3>§ 2 – Contract Formation</h3><p>Quotes are non-binding. A contract is formed upon written order confirmation or signature of the quote.</p></div>
<div class="agb-section"><h3>§ 3 – Revision Rounds</h3><p>The price includes <strong>two revision rounds</strong> per deliverable. Additional revisions are charged at the applicable rate.</p></div>
<div class="agb-section"><h3>§ 4 – Client Responsibilities</h3><p>The client shall provide required materials and approvals in a timely manner.</p></div>
<div class="agb-section"><h3>§ 5 – Copyright & Usage Rights</h3><p>All works remain subject to the Service Provider's copyright. Upon full payment, the client receives a simple licence for the agreed purposes.</p></div>
<div class="agb-section"><h3>§ 6 – Payment Terms</h3><p>Invoices are due within 14 days net. Late payment incurs interest of 9 percentage points above the base rate.</p></div>
<div class="agb-section"><h3>§ 7 – Cancellation</h3><p>Cancellations less than <strong>7 days</strong> before the scheduled start incur a cancellation fee of <strong>50% of the net fee</strong>.</p></div>
<div class="agb-section"><h3>§ 8 – Liability</h3><p>Liability is limited to intent or gross negligence. Indirect damages are excluded.</p></div>
<div class="agb-section"><h3>§ 9 – Portfolio Rights</h3><p>The Service Provider may publish completed work for portfolio purposes unless the client objects.</p></div>
<div class="agb-section"><h3>§ 10 – Governing Law</h3><p>German law applies. Place of jurisdiction is Gießen, Germany.</p></div>`
};

const EMAIL_TPL={
  angebot_de:{subject:'Angebot {{nr}} – {{betreff}} | VISO Media',body:`Guten Tag {{name}},\n\nvielen Dank für Ihr Interesse an einer Zusammenarbeit mit VISO Media.\n\nIm Anhang erhalten Sie das Angebot Nr. {{nr}} für „{{betreff}}" über {{betrag}} (brutto inkl. MwSt.).\n\nDas Angebot ist bis zum {{datum}} gültig. Bitte senden Sie die unterschriebene Seite 2 zurück, um den Auftrag verbindlich zu erteilen.\n\nMit freundlichen Grüßen,\nDavid Stiehler · VISO Media\nrechnungen@viso.media · 015735386155`},
  angebot_en:{subject:'Quote {{nr}} – {{betreff}} | VISO Media',body:`Dear {{name}},\n\nThank you for your interest in working with VISO Media.\n\nPlease find attached Quote No. {{nr}} for "{{betreff}}" totalling {{betrag}} (net).\n\nThis quote is valid until {{datum}}. Please sign and return page 2 to confirm your order.\n\nKind regards,\nDavid Stiehler · VISO Media\nrechnungen@viso.media · +49 157 35386155`},
  rechnung_de:{subject:'Rechnung {{nr}} – {{betreff}} | VISO Media',body:`Guten Tag {{name}},\n\nim Anhang erhalten Sie die Rechnung Nr. {{nr}} für „{{betreff}}" über {{betrag}}.\n\nBitte überweisen Sie den Betrag innerhalb von 14 Tagen auf das angegebene Konto.\n\nMit freundlichen Grüßen,\nDavid Stiehler · VISO Media\nrechnungen@viso.media · 015735386155`},
  rechnung_en:{subject:'Invoice {{nr}} – {{betreff}} | VISO Media',body:`Dear {{name}},\n\nPlease find attached Invoice No. {{nr}} for "{{betreff}}" totalling {{betrag}}.\n\nPayment is due within 14 days to the bank account stated on the invoice.\n\nKind regards,\nDavid Stiehler · VISO Media\nrechnungen@viso.media · +49 157 35386155`},
  followup_de:{subject:'Nachfrage: Angebot {{nr}} | VISO Media',body:`Guten Tag {{name}},\n\nich möchte kurz nachfragen, ob Sie das Angebot Nr. {{nr}} für „{{betreff}}" erhalten haben.\n\nDas Angebot ist noch bis zum {{datum}} gültig.\n\nMit freundlichen Grüßen,\nDavid Stiehler · VISO Media`},
  followup_en:{subject:'Follow-up: Quote {{nr}} | VISO Media',body:`Dear {{name}},\n\nI wanted to follow up on Quote No. {{nr}} for "{{betreff}}" and check if you have any questions.\n\nThe quote remains valid until {{datum}}.\n\nKind regards,\nDavid Stiehler · VISO Media`}
};

// Parst Preis-Texteingaben: "1.500,50" → 1500.50 oder "1500.50" → 1500.50
function parsePreis(s){
  if(!s)return 0;
  s=String(s).trim();
  // Wenn Komma als Dezimal (DE-Format: "1.500,50")
  if(/^\d{1,3}(\.\d{3})*(,\d+)?$/.test(s)){
    return parseFloat(s.replace(/\./g,'').replace(',','.'));
  }
  // Fallback: normales Float-Parsing
  return parseFloat(s.replace(',','.').replace(/[^\d.]/g,''))||0;
}

const fmt=n=>n.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+'\u00a0€';
const fmtDate=v=>{if(!v)return'–';const[y,m,d]=v.split('-');return`${d}.${m}.${y}`;};
const pad=n=>String(n).padStart(2,'0');
const toast=msg=>{const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2400);};
const $=id=>document.getElementById(id);
const val=id=>$(id)?$(id).value:'';

function autoResize(el){el.style.height='auto';el.style.height=el.scrollHeight+'px';}

// ── SIDEBAR PANELS ─────────────────────────────────────────
function showPanel(p,btn){
  document.querySelectorAll('.panel').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
  $('panel-'+p).classList.add('active');
  if(btn)btn.classList.add('active');
  if(p==='email')refreshEmailPreview();
  if(p==='data')updateDataStats();
}

// ── RESIZABLE SIDEBAR ──────────────────────────────────────
(function(){
  const handle=$('resize-handle');
  const sidebar=$('sidebar');
  let dragging=false,startX=0,startW=0;
  handle.addEventListener('mousedown',e=>{
    dragging=true;startX=e.clientX;
    startW=parseInt(getComputedStyle(sidebar).width,10);
    handle.classList.add('dragging');
    document.body.style.cursor='col-resize';
    document.body.style.userSelect='none';
  });
  document.addEventListener('mousemove',e=>{
    if(!dragging)return;
    const w=Math.max(200,Math.min(500,startW+(e.clientX-startX)));
    sidebar.style.width=w+'px';
  });
  document.addEventListener('mouseup',()=>{
    if(!dragging)return;
    dragging=false;handle.classList.remove('dragging');
    document.body.style.cursor='';document.body.style.userSelect='';
  });
})();

// ── LANG / TAX / TYP ──────────────────────────────────────
function setLang(l){
  lang=l;
  $('lang-de').classList.toggle('active',l==='de');
  $('lang-en').classList.toggle('active',l==='en');
  update();
}
function setTax(t){
  tax=t;
  ['de','eu','int'].forEach(x=>$('tax-'+x).classList.toggle('active',x===t));
  $('wrap_uid').style.display=t==='eu'?'block':'none';
  update();
}
function setTyp(t,btn){
  typ=t;
  // Update topbar buttons
  document.querySelectorAll('.doc-type-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  // Auto-nummer wenn noch altes Präfix
  const nr=val('f_nr');
  if(t==='rechnung'&&nr.startsWith('ANG')){$('f_nr').value=nextDocNr('rechnung');}
  else if(t==='angebot'&&nr.startsWith('RE')){$('f_nr').value=nextDocNr('angebot');}
  update();
}

// ── NUMMERNVERGABE ─────────────────────────────────────────
function nextDocNr(t){
  const year=new Date().getFullYear();
  const prefix=t==='rechnung'?'RE':'ANG';
  const existing=history.filter(h=>h.typ===t&&h.nr&&h.nr.startsWith(prefix+'-'+year));
  const nums=existing.map(h=>{const m=h.nr.match(/(\d+)$/);return m?parseInt(m[1]):0;}).filter(n=>!isNaN(n));
  const next=nums.length?Math.max(...nums)+1:1;
  return`${prefix}-${year}-${String(next).padStart(3,'0')}`;
}

// ── NEUES DOKUMENT ─────────────────────────────────────────
function newDoc(btn){
  if(!confirm('Neues Dokument erstellen? Nicht gespeicherte Änderungen gehen verloren.'))return;
  const today=new Date();
  const inM=new Date(today);inM.setMonth(inM.getMonth()+1);
  ['f_firma','f_ansprechpartner','f_strasse','f_ort','f_land','f_uid','f_betreff','f_hinweise','f_von'].forEach(id=>{if($(id))$(id).value='';});
  $('f_zahlung').value='voll';
  $('f_kunde_inline').value='';
  typ='angebot';
  currentDocId=null;
  $('f_nr').value=nextDocNr('angebot');
  $('f_datum').value=today.getFullYear()+'-'+pad(today.getMonth()+1)+'-'+pad(today.getDate());
  $('f_gueltig').value=inM.getFullYear()+'-'+pad(inM.getMonth()+1)+'-'+pad(inM.getDate());
  // Reset topbar
  document.querySelectorAll('.doc-type-btn').forEach(b=>b.classList.remove('active'));
  $('typ-angebot').classList.add('active');
  setLang('de');setTax('de');
  positionen=[];renderPositionen();addPos();
  showPanel('doc',$('nav-doc'));
  update();toast('Neues Dokument ✓');
}

// ── CONVERT ───────────────────────────────────────────────
function convertDoc(){
  const newTyp=typ==='angebot'?'rechnung':'angebot';
  currentDocId=null; // Umgewandelt = neues Dokument
  setTyp(newTyp, newTyp==='rechnung'?$('typ-rechnung'):$('typ-angebot'));
  toast('Umgewandelt ✓');
}

// ── POSITIONEN ─────────────────────────────────────────────
function addPos(){
  positionen.push({id:Date.now(),desc:'',details:'',menge:'1',einheit:'pauschal',preis:''});
  renderPositionen();update();
}
function removePos(id){
  positionen=positionen.filter(p=>p.id!==id);
  renderPositionen();update();
}
function posUpdate(id,field,v){
  const p=positionen.find(x=>x.id===id);
  if(p){p[field]=v;update();}
}

function unitOptions(selected='pauschal'){
  return Object.keys(UNITS).map(k=>`<option value="${k}"${k===selected?' selected':''}>${UNITS[k].de} / ${UNITS[k].en}</option>`).join('');
}

function renderPositionen(){
  const tbody=$('d_positionen');
  if(!positionen.length){
    tbody.innerHTML='<tr><td colspan="7" style="color:#bbb;font-style:italic;text-align:center;padding:14px;">– Positionen werden hier angezeigt –</td></tr>';
    return;
  }
  tbody.innerHTML=positionen.map((p,i)=>{
    const m=parsePreis(p.menge)||0,pr=parsePreis(p.preis)||0,sum=m*pr;
    return`<tr>
      <td style="color:#888;font-size:11px;vertical-align:top;padding-top:10px;">${i+1}</td>
      <td>
        <input class="ie-block" value="${(p.desc||'').replace(/"/g,'&quot;')}" placeholder="Bezeichnung"
          oninput="posUpdate(${p.id},'desc',this.value)" style="font-weight:600;margin-bottom:3px;">
        <textarea class="pos-details-input" placeholder="Details (optional, eine Zeile = ein Bullet)"
          oninput="posUpdate(${p.id},'details',this.value);autoResize(this)"
          rows="1">${p.details||''}</textarea>
      </td>
      <td style="text-align:right;vertical-align:top;padding-top:10px;">
        <input class="ie" type="text" value="${p.menge}" style="width:44px;text-align:right;"
          oninput="posUpdate(${p.id},'menge',this.value)">
      </td>
      <td style="text-align:right;vertical-align:top;padding-top:10px;">
        <select class="ie-select" onchange="posUpdate(${p.id},'einheit',this.value)" style="font-size:11px;">${unitOptions(p.einheit)}</select>
      </td>
      <td style="text-align:right;vertical-align:top;padding-top:10px;white-space:nowrap;">
        <input class="ie" type="text" value="${p.preis}" placeholder="0,00" style="width:62px;text-align:right;"
          oninput="posUpdate(${p.id},'preis',this.value)"><span style="color:#888;font-size:11px;"> €</span>
      </td>
      <td style="text-align:right;vertical-align:top;padding-top:10px;white-space:nowrap;font-weight:600;">
        ${sum?fmt(sum):(p.preis?fmt(0):'–')}
      </td>
      <td style="vertical-align:top;padding-top:8px;" class="no-print">
        <button class="pos-del" onclick="removePos(${p.id})" title="Löschen">✕</button>
      </td>
    </tr>`;
  }).join('');
}

// ── EMAIL ──────────────────────────────────────────────────
function getDocVals(){
  const netto=positionen.reduce((s,p)=>s+parsePreis(p.menge)*parsePreis(p.preis),0);
  const brutto=tax==='de'?netto*1.19:netto;
  return{
    name:val('f_ansprechpartner')||val('f_firma')||'…',
    nr:val('f_nr')||'–',
    betreff:val('f_betreff')||'–',
    betrag:fmt(brutto),
    datum:fmtDate(val('f_gueltig')||val('f_von'))
  };
}
function fillTpl(tpl,v){return tpl.replace(/\{\{(\w+)\}\}/g,(_,k)=>v[k]||'–');}
function loadEmailTemplate(){
  const key=$('email_template').value;
  const tpl=customEmailTpl[key]||EMAIL_TPL[key];if(!tpl)return;
  const v=getDocVals();
  $('email_subject').value=fillTpl(tpl.subject,v);
  $('email_body').value=fillTpl(tpl.body,v);
  const c=customers.find(x=>x.firma===val('f_firma'));
  if(c&&c.email)$('email_to').value=c.email;
}
function refreshEmailPreview(){loadEmailTemplate();}
function openGmail(){
  const to=encodeURIComponent(val('email_to'));
  const su=encodeURIComponent(val('email_subject'));
  const bo=encodeURIComponent(val('email_body'));
  window.open(`https://mail.google.com/mail/?view=cm&to=${to}&su=${su}&body=${bo}`,'_blank');
}
function copyEmail(){
  navigator.clipboard.writeText(`Betreff: ${val('email_subject')}\n\n${val('email_body')}`).then(()=>toast('Kopiert ✓'));
}

// ── UPDATE (document render) ───────────────────────────────
function update(){
  const isRe=typ==='rechnung';
  const l=T[lang];
  const nr=val('f_nr')||'–';

  // Typ-Title
  $('d_typ_title').textContent=isRe?l.doc_i:l.doc_q;
  $('d_nr_label').textContent=isRe?l.nr_i:l.nr_q;
  $('d_date_label').textContent=l.date;
  $('d_extra_label').textContent=isRe?l.period:l.valid;

  // Datum-Felder ein/ausblenden
  $('f_gueltig').style.display=isRe?'none':'inline-block';
  $('f_von').style.display=isRe?'inline-block':'none';

  // Table headers
  document.querySelectorAll('.th').forEach((th,i)=>th.textContent=l.th[i]);

  // Annex (page 2)
  ['d_nr','d_nr2'].forEach(id=>$(id)&&($(id).textContent=nr));
  $('t_annex_label').textContent=l.annex_label;
  $('d_typ2').textContent=isRe?l.annex_i:l.annex_q;

  // Intro & sign
  $('d_intro').textContent=isRe?l.intro_i:l.intro_q;
  $('d_sign').innerHTML=isRe?l.sign_i:l.sign_q;

  // Subject prefix
  const betreff=val('f_betreff');
  $('d_subj_prefix').textContent=betreff?(isRe?l.prefix_i:l.prefix_q):'';

  // Payment
  $('t_payment_title').textContent=l.payment;
  const netto=positionen.reduce((s,p)=>s+parsePreis(p.menge)*parsePreis(p.preis),0);
  const mwst=tax==='de'?netto*.19:0,brutto=netto+mwst;
  const half=brutto/2;
  $('d_zahlung_text').innerHTML=val('f_zahlung')==='voll'?l.pay_full(fmt(brutto)):l.pay_50(fmt(half));

  // Totals
  $('d_netto').textContent=fmt(netto);
  $('d_mwst').textContent=fmt(mwst);
  $('d_gesamt').textContent=fmt(brutto);
  $('t_net').textContent=l.net;
  $('t_tax').textContent=l.tax19;
  $('t_total').textContent=isRe?l.total_i:l.total_q;

  // Tax row visibility
  const taxRow=$('row_tax');
  const taxNote=$('d_tax_note_box');
  const uid=val('f_uid');
  if(tax==='de'){taxRow.style.display='';taxNote.style.display='none';}
  else{taxRow.style.display='none';taxNote.style.display='block';taxNote.innerHTML=tax==='eu'?l.tax_eu+(uid?`<strong>${uid}</strong>`:'[VAT ID]'):l.tax_int;}

  // Notes
  const notes=val('f_hinweise').trim();
  const nbox=$('d_notes_rendered');
  const ninput=$('f_hinweise');
  if(notes){
    nbox.style.display='block';
    nbox.innerHTML=`<strong>${l.notes}</strong><br>${notes}`;
    ninput.style.display='none';
  }else{
    nbox.style.display='none';
    ninput.style.display='block';
  }

  // Footer labels
  ['t_contact','t_contact2'].forEach(id=>$(id)&&($(id).textContent=l.contact));
  $('t_tax_f').textContent=l.tax_f;
  $('t_bank').textContent=l.bank;
  ['t_taxnr_label','t_taxnr_label2'].forEach(id=>$(id)&&($(id).textContent=l.taxnr));
  ['t_vatid_label','t_vatid_label2'].forEach(id=>$(id)&&($(id).textContent=l.vatid));
  ['t_accholder_label','t_accholder_label2'].forEach(id=>$(id)&&($(id).textContent=l.accholder));
  $('t_bank2')&&($('t_bank2').textContent=l.bank_title);
  $('t_tax2')&&($('t_tax2').textContent=l.tax_f);

  // AGB
  $('agb_content').innerHTML=AGB[lang];
  $('t_agb_title').textContent=l.agb;
  $('t_confirm_title').textContent=l.confirm_title;
  $('t_confirm_text').textContent=l.confirm(nr);
  $('t_sig_date').textContent=l.sig_date;
  $('t_sig_sign').textContent=l.sig_sign;
  $('t_return').textContent=l.return;

  // AGB hint
  const hint=$('agb_hint');
  if(!isRe){hint.textContent=l.agb_hint;hint.style.display='block';}
  else{hint.style.display='none';}

  // Page 2 visibility
  $('page2').style.display=isRe?'none':'block';
}

// ── CUSTOMERS ──────────────────────────────────────────────
async function saveCustomer(){
  const firma=$('nc_firma').value.trim();
  if(!firma){toast('Firma fehlt!');return;}
  const customer={firma,ansp:$('nc_ansp').value.trim(),str:$('nc_str').value.trim(),ort:$('nc_ort').value.trim(),land:$('nc_land').value.trim(),email:$('nc_email').value.trim()};
  try{
    const saved=await DB.saveCustomer(customer);
    customers.unshift(saved);
    ['nc_firma','nc_ansp','nc_str','nc_ort','nc_land','nc_email'].forEach(id=>$(id).value='');
    renderCustomerList();toast('Kunde gespeichert ✓');
  }catch(e){toast('Fehler: '+e.message);}
}

// Aktuell eingetragene Adresse als Kunde in DB speichern
async function saveCurrentAsCustomer(){
  const firma=val('f_firma').trim();
  if(!firma){toast('Firma/Name im Dokument fehlt!');return;}
  // Prüfen ob schon vorhanden
  if(customers.find(c=>c.firma===firma)){toast('Kunde bereits in Datenbank.');return;}
  const customer={
    firma,
    ansp:val('f_ansprechpartner').trim(),
    str:val('f_strasse').trim(),
    ort:val('f_ort').trim(),
    land:val('f_land').trim(),
    email:''
  };
  try{
    const saved=await DB.saveCustomer(customer);
    customers.unshift(saved);
    renderCustomerList();
    toast('Kunde in Datenbank gespeichert ✓');
  }catch(e){toast('Fehler: '+e.message);}
}

async function deleteCustomer(id){
  try{await DB.deleteCustomer(id);customers=customers.filter(c=>c.id!==id);renderCustomerList();toast('Gelöscht');}
  catch(e){toast('Fehler: '+e.message);}
}
function useCustomer(i){
  const c=customers[i];
  $('f_firma').value=c.firma||'';
  $('f_ansprechpartner').value=c.ansp||'';
  $('f_strasse').value=c.str||'';
  $('f_ort').value=c.ort||'';
  $('f_land').value=c.land||'';
  update();showPanel('doc',$('nav-doc'));
  toast('Kunde übernommen ✓');
}
function loadCustomer(){
  const i=$('f_kunde_select')?.value;
  if(i!==''&&i!==undefined&&i!==null)useCustomer(parseInt(i));
}
// Inline Kunden-Dropdown im Dokument
function loadCustomerInline(){
  const i=$('f_kunde_inline').value;
  if(i==='')return;
  useCustomer(parseInt(i));
  $('f_kunde_inline').value='';
}
function renderCustomerList(){
  // Sidebar Kunden-Dropdown (falls noch vorhanden)
  const sel=$('f_kunde_select');
  if(sel){
    sel.innerHTML='<option value="">— Kunde übernehmen —</option>';
    customers.forEach((c,i)=>{const o=document.createElement('option');o.value=i;o.textContent=c.firma;sel.appendChild(o);});
  }
  // Inline Dropdown im Dokument
  const inlineSel=$('f_kunde_inline');
  if(inlineSel){
    inlineSel.innerHTML='<option value="">Kunde aus Datenbank übernehmen …</option>';
    customers.forEach((c,i)=>{const o=document.createElement('option');o.value=i;o.textContent=c.firma+(c.ort?' ('+c.ort+')':'');inlineSel.appendChild(o);});
  }
  // Kunden-Karten in Sidebar
  const el=$('customer-list');
  if(!customers.length){el.innerHTML='<p style="color:var(--text3);font-size:11px;">Noch keine Kunden.</p>';return;}
  el.innerHTML=customers.map((c,i)=>`
    <div class="card">
      <button class="btn-icon card-del" onclick="deleteCustomer('${c.id}')"><i data-lucide="x"></i></button>
      <div class="card-title">${c.firma}</div>
      <div class="card-sub">${[c.ansp,c.str,c.ort,c.land].filter(Boolean).join(' · ')}</div>
      ${c.email?`<div class="card-sub">${c.email}</div>`:''}
      <div class="card-actions">
        <button class="btn btn-ghost" style="font-size:11px;padding:5px 10px;" onclick="useCustomer(${i})">Übernehmen</button>
      </div>
    </div>`).join('');
  lucide.createIcons();
}

// ── LIBRARY ────────────────────────────────────────────────
async function saveLibItem(){
  const desc=$('nl_desc').value.trim();
  if(!desc){toast('Bezeichnung fehlt!');return;}
  const item={desc,details:$('nl_details').value.trim(),menge:$('nl_menge').value||'1',einheit:$('nl_einheit').value||'pauschal',preis:$('nl_preis').value||''};
  try{
    const saved=await DB.saveLibItem(item);
    library.unshift(saved);
    ['nl_desc','nl_details','nl_preis'].forEach(id=>$(id).value='');
    $('nl_menge').value='1';
    renderLibraryList();toast('Leistung gespeichert ✓');
  }catch(e){toast('Fehler: '+e.message);}
}
async function deleteLibItem(id){
  try{await DB.deleteLibItem(id);library=library.filter(l=>l.id!==id);renderLibraryList();toast('Gelöscht');}
  catch(e){toast('Fehler: '+e.message);}
}
function renderLibraryList(){
  const sel=$('f_lib_select');
  sel.innerHTML='<option value="">+ Aus Bibliothek hinzufügen</option>';
  const el=$('lib-list');
  if(!library.length){el.innerHTML='<p style="color:var(--text3);font-size:11px;">Noch keine Leistungen.</p>';return;}
  el.innerHTML=library.map((l,i)=>`
    <div class="card">
      <button class="btn-icon card-del" onclick="deleteLibItem('${l.id}')"><i data-lucide="x"></i></button>
      <div class="card-title">${l.desc}</div>
      <div class="card-sub">${l.menge} ${UNITS[l.einheit]?UNITS[l.einheit].de:l.einheit}${l.preis?' · '+fmt(parsePreis(l.preis)):''}</div>
    </div>`).join('');
  library.forEach((l,i)=>{const o=document.createElement('option');o.value=i;o.textContent=l.desc;sel.appendChild(o);});
  lucide.createIcons();
}
function addFromLib(){
  const i=$('f_lib_select').value;if(i==='')return;
  const l=library[parseInt(i)];
  positionen.push({id:Date.now(),desc:l.desc,details:l.details||'',menge:l.menge,einheit:l.einheit,preis:l.preis});
  renderPositionen();update();$('f_lib_select').value='';toast('Hinzugefügt ✓');
}

// ── DOCUMENTS ─────────────────────────────────────────────
async function saveDoc(){
  const doc={
    typ,nr:val('f_nr'),datum:val('f_datum'),gueltig:val('f_gueltig'),
    von:val('f_von'),bis:'',betreff:val('f_betreff'),zahlung:val('f_zahlung'),
    hinweise:val('f_hinweise'),firma:val('f_firma'),ansp:val('f_ansprechpartner'),
    str:val('f_strasse'),ort:val('f_ort'),land:val('f_land'),uid:val('f_uid'),
    lang,tax,positionen
  };
  // Wenn wir eine bekannte ID haben, Update via ID (kein upsert-Konflikt)
  if(currentDocId){doc.id=currentDocId;}
  try{
    const saved=await DB.saveDocument(doc);
    currentDocId=saved.id; // ID merken für nächstes Speichern
    const idx=history.findIndex(h=>h.id===saved.id);
    if(idx>-1)history[idx]=saved; else history.unshift(saved);
    renderHistory();toast('Gespeichert ✓');
  }catch(e){toast('Fehler: '+e.message);}
}
async function toggleStatus(id,key,e){
  e.stopPropagation();
  const doc=history.find(h=>h.id===id);if(!doc)return;
  if(!doc.status)doc.status={};
  doc.status[key]=!doc.status[key];
  try{await DB.updateDocStatus(id,doc.status);renderHistory();}
  catch(err){toast('Fehler: '+err.message);}
}
async function deleteDoc(id){
  try{await DB.deleteDocument(id);history=history.filter(h=>h.id!==id);renderHistory();toast('Gelöscht');}
  catch(e){toast('Fehler: '+e.message);}
}
function loadDoc(i){
  const d=history[i];
  typ=d.typ||'angebot';
  currentDocId=d.id||null; // ID für Speichern merken
  // Update topbar type buttons
  document.querySelectorAll('.doc-type-btn').forEach(b=>b.classList.remove('active'));
  $(typ==='rechnung'?'typ-rechnung':'typ-angebot').classList.add('active');
  $('f_nr').value=d.nr||'';
  $('f_datum').value=d.datum||'';
  $('f_gueltig').value=d.gueltig||'';
  $('f_von').value=d.von||'';
  $('f_betreff').value=d.betreff||'';
  $('f_zahlung').value=d.zahlung||'voll';
  $('f_hinweise').value=d.hinweise||'';
  $('f_firma').value=d.firma||'';
  $('f_ansprechpartner').value=d.ansp||'';
  $('f_strasse').value=d.str||'';
  $('f_ort').value=d.ort||'';
  $('f_land').value=d.land||'';
  $('f_uid').value=d.uid||'';
  positionen=(d.positionen||[]).map(p=>({...p,id:p.id||Date.now()+Math.random()}));
  setLang(d.lang||'de');setTax(d.tax||'de');
  renderPositionen();update();
  showPanel('doc',$('nav-doc'));
  toast('Geladen ✓');
}
function renderHistory(){
  const el=$('history-list');
  if(!history.length){el.innerHTML='<p style="color:var(--text3);font-size:11px;">Keine Dokumente.</p>';return;}
  el.innerHTML=history.map((h,i)=>{
    const isRe=h.typ==='rechnung';
    const chips=(isRe?STATUS_RE:STATUS_ANG).map(s=>{
      const active=h.status&&h.status[s.key];
      const lbl=lang==='en'?s.label_en:s.label_de;
      return`<button class="chip${active?' '+s.cls:''}" onclick="toggleStatus('${h.id}','${s.key}',event)">${lbl}</button>`;
    }).join('');
    return`<div class="hist-item">
      <div onclick="loadDoc(${i})" style="cursor:pointer;">
        <span class="hist-badge ${isRe?'badge-re':'badge-ang'}">${isRe?'RE':'ANG'}</span>
        ${h.lang==='en'?'<span class="hist-badge" style="background:#1a2a3f;color:var(--blue);margin-left:4px;">EN</span>':''}
        <div class="hist-nr">${h.nr||'–'}</div>
        <div class="hist-sub">${h.firma||'–'} · ${h.betreff||'–'}</div>
      </div>
      <div class="status-row">${chips}</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
        <span style="font-size:10px;color:var(--text3);">${new Date(h.updated_at||h.created_at).toLocaleDateString('de-DE')}</span>
        <button class="btn btn-danger" style="font-size:11px;padding:4px 8px;" onclick="deleteDoc('${h.id}')">
          <i data-lucide="trash-2"></i>
        </button>
      </div>
    </div>`;
  }).join('');
  lucide.createIcons();
}

// ── EMAIL TEMPLATES ────────────────────────────────────────
async function saveEmailTemplate(){
  const key=$('email_template').value;
  try{
    await DB.saveEmailTemplate(key,val('email_subject'),val('email_body'));
    customEmailTpl[key]={subject:val('email_subject'),body:val('email_body')};
    toast('Vorlage gespeichert ✓');
  }catch(e){toast('Fehler: '+e.message);}
}

// ── DATA ──────────────────────────────────────────────────
function exportData(){
  const blob=new Blob([JSON.stringify({customers,library,history,customEmailTpl,exportedAt:new Date().toISOString()},null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`viso-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();toast('Export ✓');
}
async function importData(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const data=JSON.parse(e.target.result);
      let imported=0;
      if(data.customers){for(const c of data.customers){if(!customers.find(x=>x.firma===c.firma)){try{const s=await DB.saveCustomer(c);customers.unshift(s);imported++;}catch{}}}renderCustomerList();}
      if(data.library){for(const l of data.library){if(!library.find(x=>x.desc===l.desc)){try{const s=await DB.saveLibItem(l);library.unshift(s);imported++;}catch{}}}renderLibraryList();}
      if(data.history){for(const h of data.history){if(!history.find(x=>x.nr===h.nr)){try{const s=await DB.saveDocument(h);history.unshift(s);imported++;}catch{}}}renderHistory();}
      updateDataStats();toast(`Import: ${imported} Einträge ✓`);
    }catch{toast('Fehler beim Import!');}
  };
  reader.readAsText(file);input.value='';
}
function resetData(){
  if(!confirm('Wirklich alle lokalen Daten zurücksetzen?'))return;
  customers=[];library=[];history=[];customEmailTpl={};
  renderCustomerList();renderLibraryList();renderHistory();updateDataStats();
  toast('Zurückgesetzt');
}
function updateDataStats(){
  $('data_stats').innerHTML=`Kunden: <strong>${customers.length}</strong><br>Leistungen: <strong>${library.length}</strong><br>Dokumente: <strong>${history.length}</strong>`;
}

// ── PDF ───────────────────────────────────────────────────
async function printPDF(){
  const isRe=typ==='rechnung';
  const nr=val('f_nr')||'–';
  const firma=val('f_firma')||val('f_ansprechpartner')||'';
  const filename=firma?`${nr} – ${firma}`:nr;

  const notes=val('f_hinweise').trim();
  const l=T[lang];

  // Klone die Seiten
  const p1clone=$('page1').cloneNode(true);
  const p2clone=$('page2').cloneNode(true);

  // Alle .no-print Elemente entfernen
  p1clone.querySelectorAll('.no-print').forEach(el=>el.remove());
  p2clone.querySelectorAll('.no-print').forEach(el=>el.remove());

  // ie-inputs durch ihre Werte ersetzen
  function replaceInputs(container){
    // .ie inputs (inkl. type=text/date) → span mit Wert
    container.querySelectorAll('input.ie,input.ie-date').forEach(inp=>{
      const span=document.createElement('span');
      span.style.cssText=inp.style.cssText;
      const raw=inp.value;
      if(inp.type==='date'){span.textContent=fmtDate(raw);}
      else{span.textContent=raw||'';}
      inp.replaceWith(span);
    });
    // .ie-block inputs → div
    container.querySelectorAll('input.ie-block').forEach(inp=>{
      const div=document.createElement('div');
      div.textContent=inp.value||'';
      div.style.cssText=inp.style.cssText;
      // Kein border im PDF
      div.style.border='none';div.style.background='transparent';
      inp.replaceWith(div);
    });
    // ie-select → span
    container.querySelectorAll('select.ie-select').forEach(sel=>{
      const span=document.createElement('span');
      span.textContent=sel.options[sel.selectedIndex]?.text||'';
      sel.replaceWith(span);
    });
    // textareas → div mit Bullet-Liste (Einrückung + Leerzeile zwischen Bullets)
    container.querySelectorAll('textarea.ie-block,textarea.pos-details-input').forEach(ta=>{
      if(!ta.value.trim()){ta.remove();return;}
      const wrap=document.createElement('div');
      wrap.style.marginTop='4px';
      ta.value.trim().split('\n').filter(x=>x.trim()).forEach((line,idx)=>{
        if(idx>0){
          // Leerzeile zwischen Bullets
          const gap=document.createElement('div');gap.style.height='3px';
          wrap.appendChild(gap);
        }
        const d=document.createElement('div');
        d.style.cssText='display:block;padding-left:14px;position:relative;font-size:11px;color:#333;line-height:1.6;font-family:Helvetica Neue,Arial,sans-serif;';
        d.innerHTML=`<span style="position:absolute;left:0;color:#666;">–</span>${line.trim()}`;
        wrap.appendChild(d);
      });
      ta.replaceWith(wrap);
    });
    // Notes textarea
    container.querySelectorAll('#f_hinweise').forEach(ta=>{
      if(!ta.value.trim()){ta.remove();return;}
      const box=document.createElement('div');
      box.className='info-box';
      box.innerHTML=`<strong>${l.notes}</strong><br>${ta.value.trim()}`;
      ta.replaceWith(box);
    });
    const dnr=container.querySelector('#d_notes_rendered');
    if(dnr)dnr.style.display=notes?'block':'none';
  }

  replaceInputs(p1clone);
  if(!isRe)replaceInputs(p2clone);

  // CSS extrahieren
  let css='';
  try{css=Array.from(document.styleSheets).reduce((a,ss)=>{try{return a+Array.from(ss.cssRules).map(r=>r.cssText).join('\n');}catch{return a;}},'')}catch{}

  toast('PDF wird erstellt …');
  try{
    const resp=await fetch('/api/pdf',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        page1:p1clone.innerHTML,
        page2:isRe?'':p2clone.innerHTML,
        css,filename
      })
    });
    if(!resp.ok){const e=await resp.json();throw new Error(e.error||resp.statusText);}
    const blob=await resp.blob();
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=filename+'.pdf';a.click();
    setTimeout(()=>URL.revokeObjectURL(url),10000);
    toast('PDF heruntergeladen ✓');
  }catch(e){
    console.error('PDF-Fehler:',e);
    toast('PDF-Fehler: '+e.message);
  }
}

// ── INIT ──────────────────────────────────────────────────
async function init(){
  const user=await getUser();
  if(!user){window.location.href='index.html';return;}

  try{
    [customers,library,history,customEmailTpl]=await Promise.all([
      DB.getCustomers(),DB.getLibrary(),DB.getDocuments(),DB.getEmailTemplates()
    ]);
  }catch(err){
    console.error('Ladefehler:',err);
    toast('Fehler beim Laden der Daten');
  }

  const today=new Date();
  $('f_datum').value=today.getFullYear()+'-'+pad(today.getMonth()+1)+'-'+pad(today.getDate());
  const inM=new Date(today);inM.setMonth(inM.getMonth()+1);
  $('f_gueltig').value=inM.getFullYear()+'-'+pad(inM.getMonth()+1)+'-'+pad(inM.getDate());
  $('f_nr').value=nextDocNr('angebot');

  renderCustomerList();
  renderLibraryList();
  renderHistory();
  updateDataStats();
  addPos();
  update();
  lucide.createIcons();
}

init();
</script>
</body>
</html>
