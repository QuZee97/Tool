<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Steuertool – VISO Media</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23d4cc2e'/><text x='16' y='23' text-anchor='middle' font-size='20' font-family='Helvetica Neue,Arial,sans-serif' font-weight='700' fill='%23111'>V</text></svg>">
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<style>
:root{
  --bg:#1e1f22;--surface:#27282c;--surface2:#2f3035;--surface3:#383a40;
  --border:#3d3f45;--border2:#4a4c54;
  --text:#e2e3e8;--text2:#9a9ca5;--text3:#5c5f6b;
  --accent:#d4cc2e;--accent-bg:rgba(212,204,46,0.08);
  --red:#e05555;--red-bg:rgba(224,85,85,0.1);
  --green:#4ade80;--green-bg:rgba(74,222,128,0.1);
  --blue:#60a5fa;--blue-bg:rgba(96,165,250,0.1);
  --orange:#fb923c;--orange-bg:rgba(251,146,60,0.1);
  --radius:8px;--radius-sm:5px;--font:'Helvetica Neue',Arial,sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--font);font-size:13px;color:var(--text);background:var(--bg);min-height:100vh;display:flex;flex-direction:column;}

/* NAV */
#nav{height:52px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:4px;position:sticky;top:0;z-index:50;flex-shrink:0;}
.nav-logo{font-size:14px;font-weight:700;color:var(--text);letter-spacing:-.2px;margin-right:8px;}
.nav-logo span{color:var(--text2);font-weight:300;}
.nav-sep{width:1px;height:20px;background:var(--border);margin:0 6px;}
.nav-btn{height:32px;padding:0 10px;border:none;background:none;color:var(--text3);cursor:pointer;border-radius:var(--radius-sm);display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:500;font-family:var(--font);transition:background .15s,color .15s;white-space:nowrap;text-decoration:none;}
.nav-btn:hover{background:var(--surface3);color:var(--text);}
.nav-btn.active{background:var(--accent-bg);color:var(--accent);}
.nav-btn svg{width:14px;height:14px;stroke-width:1.8;flex-shrink:0;}
.nav-spacer{flex:1;}
.nav-icon-btn{width:32px;height:32px;padding:0;border:none;background:none;color:var(--text3);cursor:pointer;border-radius:var(--radius-sm);display:inline-flex;align-items:center;justify-content:center;transition:background .15s,color .15s;}
.nav-icon-btn:hover{background:var(--surface3);color:var(--text);}
.nav-icon-btn svg{width:15px;height:15px;stroke-width:1.8;}

/* LAYOUT */
#app{display:flex;flex:1;overflow:hidden;}
#sidebar{width:240px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;padding:20px 16px;}
#main{flex:1;overflow-y:auto;padding:28px 32px;}
#main>*{max-width:760px;}
#main::-webkit-scrollbar{width:5px;}
#main::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

/* SIDEBAR */
.sb-section{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.7px;margin:18px 0 8px;display:flex;align-items:center;gap:6px;}
.sb-section::after{content:'';flex:1;height:1px;background:var(--border);}
.sb-section:first-child{margin-top:0;}
.step-btn{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:transparent;color:var(--text2);font-family:var(--font);font-size:12px;text-align:left;cursor:pointer;display:flex;align-items:center;gap:8px;transition:.12s;margin-bottom:4px;}
.step-btn:hover{background:var(--surface2);border-color:var(--border2);}
.step-btn.active{background:var(--accent-bg);border-color:var(--accent);color:var(--accent);}
.step-btn.done{border-color:var(--green);color:var(--green);background:var(--green-bg);}
.step-num{width:20px;height:20px;border-radius:50%;background:var(--surface2);font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.step-btn.active .step-num{background:var(--accent);color:#111;}
.step-btn.done .step-num{background:var(--green);color:#111;}
.step-badge{margin-left:auto;font-size:10px;font-weight:700;background:var(--orange-bg);color:var(--orange);border-radius:10px;padding:1px 6px;display:none;}
.step-badge.show{display:inline;}

.quartal-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:4px;}
.q-btn{padding:5px 8px;border:1px solid var(--border);border-radius:var(--radius-sm);background:transparent;color:var(--text3);font-family:var(--font);font-size:11px;cursor:pointer;text-align:center;transition:.12s;}
.q-btn:hover{border-color:var(--border2);color:var(--text2);}
.q-btn.active{background:var(--accent);color:#111;border-color:var(--accent);}
#sidebar select{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:12px;padding:6px 9px;outline:none;font-family:var(--font);cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%235c5f6b' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:26px;}
.sb-stat{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:6px;}
.sb-stat-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;}
.sb-stat-val{font-size:16px;font-weight:700;}
.sb-stat-val.green{color:var(--green);}
.sb-stat-val.red{color:var(--red);}
.sb-stat-val.accent{color:var(--accent);}
.sb-stat-val.blue{color:var(--blue);}

/* PAGES */
.page{display:none;}
.page.active{display:block;}
.page-title{font-size:18px;font-weight:700;margin-bottom:4px;}
.page-sub{font-size:12px;color:var(--text3);margin-bottom:20px;line-height:1.6;}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px;}
.card-title{font-size:13px;font-weight:600;margin-bottom:4px;}
.card-sub{font-size:11px;color:var(--text3);margin-bottom:14px;line-height:1.6;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border:none;border-radius:var(--radius-sm);font-size:12px;font-weight:500;cursor:pointer;font-family:var(--font);transition:.15s;white-space:nowrap;}
.btn svg{width:13px;height:13px;stroke-width:2;}
.btn:hover{opacity:.85;}
.btn-primary{background:var(--accent);color:#111;}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border2);}
.btn-ghost:hover{background:var(--surface2);opacity:1;}
.btn-red{background:var(--red-bg);color:var(--red);border:1px solid var(--red);}
.btn-green{background:var(--green-bg);color:var(--green);border:1px solid var(--green);}
.btn-sm{padding:5px 10px;font-size:11px;}
.btn-lg{padding:12px 20px;font-size:13px;}

/* HINWEIS */
.hinweis{display:flex;gap:10px;align-items:flex-start;background:var(--blue-bg);border:1px solid rgba(96,165,250,.2);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:16px;font-size:11px;color:var(--text2);line-height:1.6;}
.hinweis svg{width:14px;height:14px;color:var(--blue);flex-shrink:0;margin-top:1px;}
.hinweis.warn{background:var(--orange-bg);border-color:rgba(251,146,60,.2);}
.hinweis.warn svg{color:var(--orange);}
.hinweis.ok{background:var(--green-bg);border-color:rgba(74,222,128,.2);}
.hinweis.ok svg{color:var(--green);}

/* UPLOAD ZONE */
.upload-zone{border:2px dashed var(--border2);border-radius:var(--radius);padding:32px 20px;text-align:center;cursor:pointer;transition:.15s;position:relative;margin-bottom:12px;}
.upload-zone:hover,.upload-zone.drag{border-color:var(--accent);background:var(--accent-bg);}
.upload-zone svg.upload-icon{width:32px;height:32px;stroke-width:1.2;color:var(--text3);margin-bottom:10px;}
.upload-zone p{font-size:12px;color:var(--text3);line-height:1.7;}
.upload-zone strong{color:var(--text2);}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}

/* FILE LIST */
.file-list{display:flex;flex-direction:column;gap:4px;margin-bottom:12px;}
.file-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:11px;}
.file-item-icon{width:28px;height:28px;border-radius:5px;background:var(--surface3);color:var(--text3);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;flex-shrink:0;}
.file-item-name{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text2);}
.file-item-size{color:var(--text3);flex-shrink:0;}
.file-item-status{font-size:10px;color:var(--text3);flex-shrink:0;}
.file-item-status.ok{color:var(--green);}
.file-item-status.err{color:var(--red);}
.file-item-status.loading{color:var(--accent);}
.file-item-del{width:22px;height:22px;border:none;background:none;color:var(--text3);cursor:pointer;border-radius:3px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.file-item-del:hover{background:var(--red-bg);color:var(--red);}
.file-item-del svg{width:12px;height:12px;}

/* TRANSACTION LIST */
.tx-list{display:flex;flex-direction:column;}
.tx-row{display:grid;grid-template-columns:80px 1fr auto auto;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid var(--border);font-size:11px;}
.tx-row:last-child{border-bottom:none;}
.tx-row:hover{background:var(--surface2);}
.tx-date{color:var(--text3);font-size:10px;}
.tx-desc{color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.tx-sub{color:var(--text3);font-size:10px;margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.tx-amt{font-weight:600;font-size:12px;text-align:right;white-space:nowrap;}
.tx-amt.income{color:var(--green);}
.tx-amt.expense{color:var(--red);}
.tx-tag{font-size:9px;font-weight:600;padding:2px 6px;border-radius:8px;white-space:nowrap;}
.tx-tag.matched{background:var(--green-bg);color:var(--green);}
.tx-tag.unmatched{background:var(--orange-bg);color:var(--orange);}
.tx-tag.manual{background:var(--blue-bg);color:var(--blue);}

/* MATCH CARD */
.match-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;overflow:hidden;}
.match-card.review{border-color:var(--orange);}
.match-card.confirmed{border-color:var(--green);}
.match-header{padding:12px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
.match-conf{font-size:10px;font-weight:700;padding:2px 7px;border-radius:8px;}
.match-conf.hoch{background:var(--green-bg);color:var(--green);}
.match-conf.mittel{background:var(--orange-bg);color:var(--orange);}
.match-conf.niedrig{background:var(--red-bg);color:var(--red);}
.match-body{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);}
.match-col{background:var(--surface);padding:10px 14px;font-size:11px;}
.match-col-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;}
.match-actions{padding:10px 14px;display:flex;gap:6px;align-items:center;}

/* AI RESULT ROW */
.ai-row{display:grid;grid-template-columns:1fr auto 140px auto;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);font-size:11px;}
.ai-row:last-child{border-bottom:none;}
.ai-desc{color:var(--text2);font-size:12px;}
.ai-sub{color:var(--text3);font-size:10px;margin-top:2px;}
.ai-amt{font-weight:600;font-size:12px;white-space:nowrap;text-align:right;}
.ai-amt.income{color:var(--green);}
.ai-amt.expense{color:var(--red);}
.konfidenz{font-size:9px;font-weight:700;padding:2px 7px;border-radius:8px;}
.konfidenz.hoch{background:var(--green-bg);color:var(--green);}
.konfidenz.mittel{background:var(--orange-bg);color:var(--orange);}
.konfidenz.niedrig,.konfidenz.unklar{background:var(--red-bg);color:var(--red);}
.cat-select{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:10px;padding:3px 6px;outline:none;font-family:var(--font);width:100%;}

/* USTVA GRID */
.ustv-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px;}
.ustv-kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;}
.ustv-kpi-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
.ustv-kpi-val{font-size:22px;font-weight:700;}
.ustv-kpi-val.green{color:var(--green);}
.ustv-kpi-val.red{color:var(--red);}
.ustv-kpi-val.accent{color:var(--accent);}
.ustv-kpi-val.blue{color:var(--blue);}
.detail-table{width:100%;border-collapse:collapse;font-size:11px;}
.detail-table th{padding:8px 14px;text-align:left;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);}
.detail-table td{padding:8px 14px;border-bottom:1px solid var(--border);color:var(--text2);}
.detail-table td:last-child{text-align:right;font-weight:600;color:var(--text);}
.detail-table tr:last-child td{border-bottom:none;}

/* PROGRESS */
.progress-wrap{height:4px;background:var(--surface3);border-radius:2px;overflow:hidden;margin-top:6px;}
.progress-bar{height:4px;background:var(--accent);border-radius:2px;transition:width .3s;}

/* SPINNER */
.spinner{width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0;}
.spinner-lg{width:32px;height:32px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-bar{display:none;align-items:center;gap:10px;padding:14px;background:var(--surface2);border-radius:var(--radius);margin:8px 0;font-size:12px;color:var(--text3);}
.loading-bar.show{display:flex;}

/* TOAST */
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--surface3);color:var(--text);border:1px solid var(--border2);padding:9px 18px;border-radius:var(--radius);font-size:12px;opacity:0;transition:.25s;pointer-events:none;z-index:999;box-shadow:0 4px 20px rgba(0,0,0,.4);}
#toast.show{opacity:1;}

/* LOADING SCREEN */
#loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:100;}

/* ENTRY TABLE */
.entry-table{width:100%;border-collapse:collapse;font-size:11px;}
.entry-table th{padding:7px 10px;text-align:left;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);}
.entry-table td{padding:7px 10px;border-bottom:1px solid var(--border);color:var(--text2);}
.entry-table tr:last-child td{border-bottom:none;}
.entry-del{width:20px;height:20px;border:none;background:none;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;}
.entry-del:hover{color:var(--red);}
.entry-del svg{width:12px;height:12px;}
</style>
</head>
<body>

<div id="loading-screen">
  <div class="spinner-lg"></div>
  <span style="font-size:12px;color:var(--text3);">Lade Steuertool …</span>
</div>

<nav id="nav">
  <span class="nav-logo">VISO <span>Media</span></span>
  <div class="nav-sep"></div>
  <a class="nav-btn" href="/dashboard"><i data-lucide="layout-dashboard"></i> Dashboard</a>
  <a class="nav-btn" href="/tool"><i data-lucide="file-text"></i> Angebote & Rechnungen</a>
  <a class="nav-btn active" href="/steuer"><i data-lucide="calculator"></i> Steuer</a>
  <div class="nav-spacer"></div>
  <span style="font-size:11px;color:var(--text3);padding:0 6px;" id="nav-user"></span>
  <button class="nav-icon-btn" onclick="doSignOut()" title="Abmelden"><i data-lucide="log-out"></i></button>
</nav>

<div id="app">

<div id="sidebar">
  <div class="sb-section">Zeitraum</div>
  <select id="sel-year" onchange="onPeriodChange()">
    <option value="2026">2026</option>
    <option value="2025">2025</option>
    <option value="2024">2024</option>
  </select>
  <div style="margin-top:8px;margin-bottom:4px;font-size:10px;color:var(--text3);">Quartal</div>
  <div class="quartal-grid">
    <button class="q-btn" id="q1" onclick="setQuartal(1)">Q1</button>
    <button class="q-btn" id="q2" onclick="setQuartal(2)">Q2</button>
    <button class="q-btn" id="q3" onclick="setQuartal(3)">Q3</button>
    <button class="q-btn" id="q4" onclick="setQuartal(4)">Q4</button>
  </div>
  <button class="q-btn" id="qjahr" onclick="setQuartal(0)" style="width:100%;margin-top:4px;">Ganzes Jahr</button>

  <div class="sb-section">Schritte</div>
  <button class="step-btn active" id="step-btn-1" onclick="goPage(1)">
    <span class="step-num">1</span> Upload
  </button>
  <button class="step-btn" id="step-btn-2" onclick="goPage(2)">
    <span class="step-num">2</span> KI-Verarbeitung
  </button>
  <button class="step-btn" id="step-btn-3" onclick="goPage(3)">
    <span class="step-num">3</span> Review
    <span class="step-badge" id="badge-review">0</span>
  </button>
  <button class="step-btn" id="step-btn-4" onclick="goPage(4)">
    <span class="step-num">4</span> Ergebnis
  </button>

  <div class="sb-section">Übersicht</div>
  <div class="sb-stat">
    <div class="sb-stat-label">Einnahmen</div>
    <div class="sb-stat-val green" id="sb-einnahmen">–</div>
  </div>
  <div class="sb-stat">
    <div class="sb-stat-label">Ausgaben</div>
    <div class="sb-stat-val red" id="sb-ausgaben">–</div>
  </div>
  <div class="sb-stat">
    <div class="sb-stat-label">Gewinn (EÜR)</div>
    <div class="sb-stat-val accent" id="sb-gewinn">–</div>
  </div>
  <div class="sb-stat">
    <div class="sb-stat-label">USt-Zahllast</div>
    <div class="sb-stat-val blue" id="sb-zahllast">–</div>
  </div>
</div>

<div id="main">

<!-- ═══════════════════════════════════════════════════════
     SEITE 1: UPLOAD
     ═══════════════════════════════════════════════════════ -->
<div class="page active" id="page-1">
  <div class="page-title">Upload</div>
  <div class="page-sub">Lade alle Daten des Zeitraums auf einmal hoch. CSV-Kontoauszug deines Geschäftskontos + alle Belege (Fotos, PDFs, E-Mail-Anhänge). Die KI liest alles aus und ordnet zu.</div>

  <!-- CSV Upload -->
  <div class="card">
    <div class="card-title">Kontoauszug (CSV)</div>
    <div class="card-sub">CSV-Export deines Geschäftskontos – alle Buchungen des Zeitraums. Positiv = Gutschrift, Negativ = Lastschrift.</div>
    <div class="upload-zone" id="csv-zone" ondragover="onCsvDrag(event,true)" ondragleave="onCsvDrag(event,false)" ondrop="onCsvDrop(event)">
      <input type="file" id="csv-input" accept=".csv" onchange="onCsvSelect(this.files)">
      <i data-lucide="table-2" class="upload-icon"></i>
      <p><strong>CSV hier ablegen</strong> oder klicken<br>Unterstützt: Sparkasse, DKB, ING, Commerzbank, N26, Kontist …</p>
    </div>
    <div id="csv-status" style="display:none;"></div>
  </div>

  <!-- Belege Upload -->
  <div class="card">
    <div class="card-title">Belege & Rechnungen</div>
    <div class="card-sub">Alle Belege des Zeitraums – Fotos von Kassenbons, PDFs von Online-Rechnungen, E-Mail-Anhänge. Die KI liest Datum, Betrag und Händler automatisch aus.</div>
    <div class="upload-zone" id="beleg-zone" ondragover="onBelegDrag(event,true)" ondragleave="onBelegDrag(event,false)" ondrop="onBelegDrop(event)">
      <input type="file" id="beleg-input" multiple accept=".pdf,.jpg,.jpeg,.png,.heic,.heif,.webp" onchange="onBelegSelect(this.files)">
      <i data-lucide="upload-cloud" class="upload-icon"></i>
      <p><strong>Dateien hier ablegen</strong> oder klicken<br>PDF · JPG · PNG · HEIC – mehrere auf einmal möglich</p>
    </div>
    <div class="file-list" id="beleg-list" style="display:none;"></div>
  </div>

  <!-- Rechnungen aus dem Tool -->
  <div class="card">
    <div class="card-title">Rechnungen aus dem Tool <span style="font-weight:400;color:var(--text3);font-size:11px;" id="re-count"></span></div>
    <div class="card-sub">Automatisch geladen. Setze Haken für Rechnungen die in den gewählten Zeitraum fallen.</div>
    <div id="re-list">
      <div style="color:var(--text3);font-size:11px;padding:8px 0;">Lade …</div>
    </div>
    <div style="display:flex;gap:6px;margin-top:8px;">
      <button class="btn btn-ghost btn-sm" onclick="selectAllRe(true)"><i data-lucide="check-square"></i> Alle</button>
      <button class="btn btn-ghost btn-sm" onclick="selectAllRe(false)"><i data-lucide="square"></i> Keine</button>
    </div>
  </div>

  <!-- Manuelle Einnahmen -->
  <div class="card">
    <div class="card-title">Manuelle Einnahmen <span style="font-weight:400;color:var(--text3);font-size:11px;">(Bargeschäfte, Nebeneinnahmen)</span></div>
    <div id="manual-income-wrap" style="display:none;margin-bottom:10px;">
      <table class="entry-table"><thead><tr><th>Beschreibung</th><th>Datum</th><th style="text-align:right;">Brutto</th><th></th></tr></thead>
      <tbody id="manual-income-tbody"></tbody></table>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <input id="mi-desc" type="text" placeholder="Beschreibung" style="flex:2;min-width:140px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);">
      <input id="mi-amt" type="text" placeholder="Brutto €" style="width:90px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);">
      <input id="mi-date" type="date" style="background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);">
      <button class="btn btn-ghost btn-sm" onclick="addManualIncome()"><i data-lucide="plus"></i> Hinzufügen</button>
    </div>
  </div>

  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
    <button class="btn btn-primary btn-lg" onclick="goPage(2)"><i data-lucide="arrow-right"></i> Weiter zur KI-Verarbeitung</button>
    <span style="font-size:11px;color:var(--text3);" id="upload-summary"></span>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════
     SEITE 2: KI-VERARBEITUNG
     ═══════════════════════════════════════════════════════ -->
<div class="page" id="page-2">
  <div class="page-title">KI-Verarbeitung</div>
  <div class="page-sub">Die KI liest alle hochgeladenen Belege aus und matcht sie mit den Bankbewegungen. Klare Treffer werden direkt übernommen, unsichere kommen in den Review.</div>

  <div class="hinweis" id="ki-hint-csv" style="display:none;"><i data-lucide="check-circle"></i>
    <div id="ki-hint-csv-text">CSV geladen.</div>
  </div>
  <div class="hinweis warn" id="ki-hint-nocsv" style="display:none;"><i data-lucide="alert-triangle"></i>
    <div>Kein CSV hochgeladen. Die KI kann keine Bankbewegungen matchen. Du kannst trotzdem Belege auslesen lassen.</div>
  </div>

  <div class="card">
    <div class="card-title">Schritt 1 – Belege auslesen</div>
    <div class="card-sub">KI extrahiert Datum, Betrag, Händler und Steuersatz aus jedem Beleg.</div>
    <div id="beleg-status-list" style="margin-bottom:10px;"></div>
    <div class="loading-bar" id="beleg-loading"><div class="spinner"></div><div><div id="beleg-loading-text">KI liest Belege aus …</div><div class="progress-wrap" style="width:180px;"><div class="progress-bar" id="beleg-progress-bar" style="width:0%"></div></div></div></div>
    <button class="btn btn-primary" id="btn-read-belege" onclick="readBelege()"><i data-lucide="sparkles"></i> Belege auslesen</button>
    <span id="beleg-skip-hint" style="font-size:11px;color:var(--text3);margin-left:10px;display:none;">Keine Belege hochgeladen</span>
  </div>

  <div class="card">
    <div class="card-title">Schritt 2 – Matching & Kategorisierung</div>
    <div class="card-sub">KI matcht Belege mit Bankbewegungen und schlägt Kategorien vor. Funktioniert auch ohne Belege (dann nur Bankbewegungen kategorisieren).</div>
    <div class="loading-bar" id="match-loading"><div class="spinner"></div><div><div id="match-loading-text">KI matcht und kategorisiert …</div><div class="progress-wrap" style="width:180px;"><div class="progress-bar" id="match-progress-bar" style="width:0%"></div></div></div></div>
    <button class="btn btn-primary" id="btn-match" onclick="runMatching()" disabled><i data-lucide="git-merge"></i> Matching & Kategorisierung starten</button>
    <div id="match-hint" style="font-size:11px;color:var(--text3);margin-top:8px;">Erst Belege auslesen (oder überspringen) um fortzufahren.</div>
  </div>

  <div style="display:flex;gap:8px;margin-top:4px;">
    <button class="btn btn-ghost" onclick="goPage(1)"><i data-lucide="arrow-left"></i> Zurück</button>
    <button class="btn btn-ghost" id="btn-skip-to-review" onclick="goPage(3)" style="display:none;"><i data-lucide="arrow-right"></i> Weiter zum Review</button>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════
     SEITE 3: REVIEW
     ═══════════════════════════════════════════════════════ -->
<div class="page" id="page-3">
  <div class="page-title">Review</div>
  <div class="page-sub">Nur die Einträge die Aufmerksamkeit brauchen. Bestätige Matches oder korrigiere Kategorien.</div>

  <div id="review-empty" class="hinweis ok" style="display:none;"><i data-lucide="check-circle"></i>
    <div>Alles klar! Die KI hat alle Einträge zugeordnet. Direkt zum Ergebnis.</div>
  </div>

  <!-- Alle kategorisierten Einträge (editierbar) -->
  <div class="card" style="padding:0;overflow:hidden;">
    <div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;">
      <span style="font-size:12px;font-weight:600;">Alle Einträge</span>
      <span style="flex:1;"></span>
      <button class="btn btn-ghost btn-sm" onclick="toggleReasons()"><i data-lucide="eye"></i> Begründungen</button>
      <button class="btn btn-ghost btn-sm" id="btn-filter-review" onclick="toggleFilterReview()"><i data-lucide="alert-triangle"></i> Nur unsichere</button>
    </div>
    <div id="review-list"></div>
  </div>

  <div style="display:flex;gap:8px;margin-top:4px;">
    <button class="btn btn-ghost" onclick="goPage(2)"><i data-lucide="arrow-left"></i> Zurück</button>
    <button class="btn btn-primary" onclick="buildUStVA();goPage(4);"><i data-lucide="calculator"></i> Freigeben & Ergebnis berechnen</button>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════
     SEITE 4: ERGEBNIS
     ═══════════════════════════════════════════════════════ -->
<div class="page" id="page-4">
  <div class="page-title">UStVA-Ergebnis</div>
  <div class="page-sub" id="ustva-period-label"></div>

  <div class="hinweis warn"><i data-lucide="alert-triangle"></i>
    <div><strong>Kein Ersatz für Steuerberatung.</strong> Diese Berechnung ist eine Arbeitshilfe. Bitte von dir oder deinem Steuerberater prüfen lassen.</div>
  </div>

  <div class="ustv-grid" id="ustv-kpi-grid"></div>

  <div class="card" style="padding:0;overflow:hidden;">
    <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-size:12px;font-weight:600;">Detailauswertung</div>
    <table class="detail-table" id="detail-table"><tbody></tbody></table>
  </div>

  <div class="card">
    <div class="card-title">EÜR-Zusammenfassung</div>
    <table class="detail-table" id="euer-table"><tbody></tbody></table>
  </div>

  <div class="card" style="background:var(--accent-bg);border-color:var(--accent);">
    <div class="card-title">Export</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;">
      <button class="btn btn-primary" onclick="exportSummary()"><i data-lucide="copy"></i> Zusammenfassung kopieren</button>
      <button class="btn btn-ghost" onclick="window.print()"><i data-lucide="printer"></i> Drucken</button>
    </div>
  </div>

  <div class="card" style="background:var(--blue-bg);border-color:var(--blue);">
    <div class="card-title" style="color:var(--blue);">ELSTER XML</div>
    <div class="card-sub">UStVA-XML für ELSTER oder deinen Steuerberater.</div>
    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
      <div style="flex:1;min-width:160px;">
        <label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Steuernummer</label>
        <input id="elster-steuernr" type="text" placeholder="02 087 20105 8" style="background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);width:100%;">
      </div>
      <div style="flex:1;min-width:130px;">
        <label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Bundesland</label>
        <select id="elster-bundesland" style="background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);width:100%;appearance:none;">
          <option value="26">Hessen</option><option value="11">Berlin</option><option value="91">Bayern</option>
          <option value="20">Hamburg</option><option value="21">Niedersachsen</option><option value="28">Nordrhein-Westfalen</option>
          <option value="40">Baden-Württemberg</option><option value="30">Rheinland-Pfalz</option><option value="10">Brandenburg</option>
          <option value="31">Saarland</option><option value="22">Sachsen-Anhalt</option><option value="32">Sachsen</option>
          <option value="23">Schleswig-Holstein</option><option value="13">Mecklenburg-Vorpommern</option>
        </select>
      </div>
    </div>
    <button class="btn" style="background:var(--blue);color:#fff;border:none;" onclick="exportElsterXML()"><i data-lucide="file-code-2"></i> ELSTER XML herunterladen</button>
  </div>

  <div style="margin-top:4px;">
    <button class="btn btn-ghost" onclick="goPage(3)"><i data-lucide="arrow-left"></i> Zurück</button>
  </div>
</div>

</div><!-- /main -->
</div><!-- /app -->

<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="supabase.js"></script>
<script>
lucide.createIcons();

// ── KATEGORIEN ─────────────────────────────────────────────
const CATEGORIES = {
  einnahmen_19:{label:'Einnahmen 19% MwSt.',type:'income',vat:0.19},
  einnahmen_7:{label:'Einnahmen 7% MwSt.',type:'income',vat:0.07},
  einnahmen_0:{label:'Einnahmen steuerfrei',type:'income',vat:0},
  software:{label:'Software & Tools',type:'expense',vat:0.19},
  hardware:{label:'Hardware & Technik',type:'expense',vat:0.19},
  buero:{label:'Büro & Arbeitsmittel',type:'expense',vat:0.19},
  marketing:{label:'Marketing & Werbung',type:'expense',vat:0.19},
  reise:{label:'Reise & Fahrtkosten',type:'expense',vat:0.07},
  bewirtung:{label:'Bewirtung (70%)',type:'expense',vat:0.19,limitFactor:0.7},
  telefon:{label:'Telefon & Internet',type:'expense',vat:0.19},
  weiterbildung:{label:'Weiterbildung',type:'expense',vat:0.19},
  freelancer:{label:'Fremdleistungen',type:'expense',vat:0.19},
  versicherung:{label:'Versicherungen',type:'expense',vat:0},
  steuerberatung:{label:'Steuerberatung',type:'expense',vat:0.19},
  miete:{label:'Miete / Raumkosten',type:'expense',vat:0.19},
  bankgebuehr:{label:'Bankgebühren',type:'expense',vat:0},
  sonstiges:{label:'Sonstiges',type:'expense',vat:0.19},
  privat:{label:'Privat (nicht absetzbar)',type:'private',vat:0},
};

// ── STATE ──────────────────────────────────────────────────
let selectedYear    = new Date().getFullYear();
let selectedQuartal = 0;
let allDocs         = [];   // Dokumente aus dem Tool
let reChecked       = {};   // {id: bool} – welche Rechnungen sind angehakt
let manualIncomes   = [];   // {id, desc, datum, brutto}
let csvTransactions = [];   // Rohdaten aus CSV (nach Import)
let belegFiles      = [];   // {file, status, result}
let aiResults       = [];   // nach KI-Analyse
let showReasons     = false;
let filterReview    = false;

// ── HELPERS ────────────────────────────────────────────────
const fmt    = n => n.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+'\u00a0€';
const fmtDate= v=>{if(!v)return'–';try{const[y,m,d]=v.split('-');return`${d}.${m}.${y}`;}catch{return v;}};
const parseAmt=s=>{if(!s)return 0;s=String(s).trim();if(/^\d{1,3}(\.\d{3})*(,\d+)?$/.test(s))return parseFloat(s.replace(/\./g,'').replace(',','.'));return parseFloat(s.replace(',','.').replace(/[^\d.-]/g,''))||0;};
const toast  = msg=>{const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);};
const $      = id=>document.getElementById(id);
const fmtSize= b=>b<1024?b+'B':b<1048576?(b/1024).toFixed(0)+'KB':(b/1048576).toFixed(1)+'MB';

// ── NAVIGATION ─────────────────────────────────────────────
let currentPage=1;
function goPage(n){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  $(`page-${n}`).classList.add('active');
  document.querySelectorAll('.step-btn').forEach((b,i)=>b.classList.toggle('active',i+1===n));
  currentPage=n;
  if(n===1) updateUploadSummary();
  if(n===2) updatePage2Hints();
  if(n===3) renderReview();
  if(n===4) buildUStVA();
  lucide.createIcons();
}

// ── ZEITRAUM ───────────────────────────────────────────────
function setQuartal(q){
  selectedQuartal=q;
  document.querySelectorAll('.q-btn').forEach(b=>b.classList.remove('active'));
  if(q===0)$('qjahr').classList.add('active');
  else $(`q${q}`).classList.add('active');
  refreshReList();
  updateUploadSummary();
  updateSidebar();
}
async function onPeriodChange(){
  selectedYear=parseInt($('sel-year').value);
  // CSV-Transaktionen für das neue Jahr nachladen
  try{
    const txs=await DB.getTransactions(selectedYear);
    if(txs.length){
      csvTransactions=txs.map(t=>({
        id:'tx'+t.id, datum:t.datum||'', empfaenger:t.empfaenger||'',
        verwendungszweck:t.verwendungszweck||'',
        beschreibung:t.beschreibung||(t.empfaenger||'')+(t.verwendungszweck?' – '+t.verwendungszweck:''),
        betrag:parseFloat(t.betrag)||0, isEinnahme:!!t.is_einnahme, quelle:'csv', _fromDB:true
      }));
      const ein=csvTransactions.filter(t=>t.isEinnahme).length;
      const aus=csvTransactions.filter(t=>!t.isEinnahme).length;
      const st=$('csv-status');
      st.style.display='block';
      st.innerHTML=`<div class="hinweis ok"><i data-lucide="check-circle"></i><div><strong>${csvTransactions.length} gespeicherte Buchungen</strong> aus ${selectedYear}: ${ein} Eingänge, ${aus} Ausgaben. <button class="btn btn-ghost btn-sm" style="margin-left:8px;" onclick="clearCSVData()"><i data-lucide="trash-2"></i> Löschen</button></div></div>`;
      lucide.createIcons();
    } else {
      csvTransactions=[];
      $('csv-status').style.display='none';
    }
  }catch(e){console.info('Transaktionen nicht geladen:',e.message);}
  refreshReList();
  updateUploadSummary();
  updateSidebar();
}
function inPeriod(datum){
  if(!datum)return false;
  if(!datum.startsWith(String(selectedYear)))return false;
  if(selectedQuartal===0)return true;
  const m=parseInt(datum.slice(5,7));
  return{1:[1,2,3],2:[4,5,6],3:[7,8,9],4:[10,11,12]}[selectedQuartal].includes(m);
}
async function clearCSVData(){
  if(!confirm(`Alle gespeicherten CSV-Buchungen aus ${selectedYear} löschen?`))return;
  try{
    await DB.deleteAllTransactions(selectedYear);
    csvTransactions=[];
    $('csv-status').style.display='none';
    updateUploadSummary();
    toast('CSV-Daten gelöscht ✓');
  }catch(e){toast('Fehler: '+e.message);}
}

// ── SIDEBAR-STATS ──────────────────────────────────────────
function updateSidebar(){
  if(!aiResults.length){$('sb-einnahmen').textContent='–';$('sb-ausgaben').textContent='–';$('sb-gewinn').textContent='–';$('sb-zahllast').textContent='–';return;}
  let ein=0,aus=0,zl=0;
  aiResults.forEach(r=>{
    const cat=CATEGORIES[r.kategorie]||CATEGORIES.sonstiges;
    const netto=r.betrag_netto||0;const mwst=r.mwst_betrag||0;
    if(cat.type==='income'){ein+=netto;zl+=mwst;}
    else if(cat.type==='expense'){const f=cat.limitFactor||1;aus+=netto*f;zl-=mwst*f;}
  });
  $('sb-einnahmen').textContent=fmt(ein);
  $('sb-ausgaben').textContent=fmt(aus);
  $('sb-gewinn').textContent=fmt(ein-aus);
  $('sb-zahllast').textContent=fmt(Math.max(0,zl));
}

// ── RECHNUNGEN AUS DEM TOOL ────────────────────────────────
function refreshReList(){
  const el=$('re-list');
  const relevant=allDocs.filter(d=>d.typ==='rechnung'&&inPeriod(d.datum));
  $('re-count').textContent=`(${relevant.length})`;
  if(!relevant.length){el.innerHTML='<div style="color:var(--text3);font-size:11px;padding:8px 0;">Keine Rechnungen im gewählten Zeitraum.</div>';return;}
  // Init: alle angehakt die noch nicht explizit abgehakt wurden
  relevant.forEach(d=>{if(reChecked[d.id]===undefined)reChecked[d.id]=true;});
  el.innerHTML=relevant.map(d=>{
    const netto=d.positionen?.reduce((s,p)=>s+parseFloat(p.menge||1)*parseFloat(p.preis||0),0)||0;
    const brutto=d.tax==='de'?netto*1.19:netto;
    return`<label style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer;font-size:11px;">
      <input type="checkbox" ${reChecked[d.id]?'checked':''} onchange="reChecked['${d.id}']=this.checked;updateUploadSummary();" style="accent-color:var(--accent);width:14px;height:14px;flex-shrink:0;">
      <div style="flex:1;min-width:0;">
        <div style="color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${d.firma||d.kunde||'–'}</div>
        <div style="color:var(--text3);font-size:10px;">${d.nr||''} · ${fmtDate(d.datum)}</div>
      </div>
      <span style="font-weight:600;color:var(--green);flex-shrink:0;">${fmt(brutto)}</span>
    </label>`;
  }).join('');
  updateUploadSummary();
}
function selectAllRe(v){allDocs.filter(d=>d.typ==='rechnung'&&inPeriod(d.datum)).forEach(d=>reChecked[d.id]=v);refreshReList();}

// ── MANUELLE EINNAHMEN ─────────────────────────────────────
function addManualIncome(){
  const desc=$('mi-desc').value.trim(),amt=$('mi-amt').value.trim(),date=$('mi-date').value;
  if(!desc||!amt){toast('Beschreibung und Betrag erforderlich.');return;}
  manualIncomes.push({id:'m'+Date.now(),desc,datum:date,brutto:parseAmt(amt)});
  $('mi-desc').value='';$('mi-amt').value='';
  renderManualIncomes();updateUploadSummary();
}
function removeManualIncome(id){manualIncomes=manualIncomes.filter(x=>x.id!==id);renderManualIncomes();updateUploadSummary();}
function renderManualIncomes(){
  const wrap=$('manual-income-wrap');
  if(!manualIncomes.length){wrap.style.display='none';return;}
  wrap.style.display='block';
  $('manual-income-tbody').innerHTML=manualIncomes.map(x=>`
    <tr><td>${x.desc}</td><td>${fmtDate(x.datum)}</td>
    <td style="text-align:right;font-weight:600;color:var(--green);">${fmt(x.brutto)}</td>
    <td><button class="entry-del" onclick="removeManualIncome('${x.id}')"><i data-lucide="x"></i></button></td></tr>`).join('');
  lucide.createIcons();
}

// ── CSV UPLOAD ─────────────────────────────────────────────
function onCsvDrag(e,over){e.preventDefault();$('csv-zone').classList.toggle('drag',over);}
function onCsvDrop(e){e.preventDefault();$('csv-zone').classList.remove('drag');onCsvSelect(e.dataTransfer.files);}
function onCsvSelect(files){
  const f=files[0];if(!f)return;
  if(!f.name.toLowerCase().endsWith('.csv')){toast('Nur CSV-Dateien erlaubt.');return;}
  parseAndSaveCSV(f);
}

async function parseAndSaveCSV(file){
  const status=$('csv-status');
  status.style.display='block';
  status.innerHTML=`<div class="loading-bar show"><div class="spinner"></div> Lese CSV …</div>`;
  try{
    const text=await file.text();
    csvTransactions=parseCSV(text,file.name);
    if(!csvTransactions.length){status.innerHTML='<div class="hinweis warn"><i data-lucide="alert-triangle"></i><div>Keine Einträge erkannt. Bitte CSV-Format prüfen.</div></div>';lucide.createIcons();return;}
    const ein=csvTransactions.filter(t=>t.isEinnahme).length;
    const aus=csvTransactions.filter(t=>!t.isEinnahme).length;
    status.innerHTML=`<div class="hinweis ok"><i data-lucide="check-circle"></i><div><strong>${csvTransactions.length} Buchungen</strong> aus ${file.name} gelesen: ${ein} Eingänge, ${aus} Ausgaben. Werden in Schritt 2 mit Belegen abgeglichen.</div></div>`;
    lucide.createIcons();
    // In Supabase speichern
    try{
      await DB.saveTransactions(csvTransactions.map(t=>({...t,quellDatei:file.name})));
      toast('CSV gespeichert ✓');
    }catch(e){console.warn('CSV-Speicherung fehlgeschlagen:',e.message);}
    updateUploadSummary();
  }catch(e){
    status.innerHTML=`<div class="hinweis warn"><i data-lucide="alert-triangle"></i><div>Fehler: ${e.message}</div></div>`;
    lucide.createIcons();
  }
}

// ── CSV PARSER ─────────────────────────────────────────────
function parseCSV(text,filename=''){
  const lines=text.trim().split('\n').filter(l=>l.trim());
  if(lines.length<2)return[];
  const sep=lines[0].includes(';')?';':',';
  const headers=lines[0].split(sep).map(h=>h.trim().replace(/^["']|["']$/g,'').toLowerCase());
  const findCol=names=>{for(const n of names){const i=headers.indexOf(n);if(i>-1)return i;}return -1;};
  const dateCol =findCol(['datum','date','buchungstag','buchungsdatum','valuta','wertstellungsdatum','buchungsdat.']);
  const nameCol =findCol(['empfänger/zahlungspflichtiger','empfaenger/zahlungspflichtiger','empfänger','empfaenger','auftraggeber','beguenstigter','name','kontoinhaber']);
  const zweckCol=findCol(['verwendungszweck','beschreibung','description','buchungstext','transaktionsbeschreibung','text','betreff']);
  const amtCol  =findCol(['betrag','amount','umsatz','betrag eur','betrag (eur)','amount eur']);
  const results=[];
  for(let i=1;i<lines.length;i++){
    const parts=splitCSVLine(lines[i],sep);
    const col=idx=>idx>-1?(parts[idx]||'').trim().replace(/^["']|["']$/g,''):'';
    const datum=formatCSVDate(col(dateCol));
    const empf=col(nameCol);
    const zweck=col(zweckCol);
    const amtNum=parseCSVAmount(col(amtCol));
    if(amtNum===null)continue;
    const desc=empf&&zweck?`${empf} – ${zweck.slice(0,60)}`:(empf||zweck);
    if(!desc&&amtNum===0)continue;
    results.push({id:'csv'+i,datum,empfaenger:empf,verwendungszweck:zweck,beschreibung:desc,betrag:Math.abs(amtNum),isEinnahme:amtNum>0,quelle:'csv'});
  }
  return results;
}
function splitCSVLine(line,sep){
  const r=[];let cur='';let inQ=false;
  for(const c of line){if(c==='"')inQ=!inQ;else if(c===sep&&!inQ){r.push(cur);cur='';}else cur+=c;}
  r.push(cur);return r;
}
function parseCSVAmount(s){
  if(!s)return null;
  s=s.replace(/\s/g,'').replace(/€|EUR/gi,'');
  if(/^-?\d{1,3}(\.\d{3})*(,\d+)?$/.test(s))return parseFloat(s.replace(/\./g,'').replace(',','.'));
  const n=parseFloat(s.replace(/,(?=\d{3})/g,'').replace(',','.'));
  return isNaN(n)?null:n;
}
function formatCSVDate(s){
  if(!s)return'';
  const m1=s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
  if(m1)return`${m1[3]}-${m1[2].padStart(2,'0')}-${m1[1].padStart(2,'0')}`;
  const m2=s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2})$/);
  if(m2)return`20${m2[3]}-${m2[2].padStart(2,'0')}-${m2[1].padStart(2,'0')}`;
  if(/^\d{4}-\d{2}-\d{2}$/.test(s))return s;
  return s;
}

// ── BELEGE UPLOAD ──────────────────────────────────────────
function onBelegDrag(e,over){e.preventDefault();$('beleg-zone').classList.toggle('drag',over);}
function onBelegDrop(e){e.preventDefault();$('beleg-zone').classList.remove('drag');onBelegSelect(e.dataTransfer.files);}
function onBelegSelect(files){
  Array.from(files).forEach(f=>{
    if(belegFiles.find(b=>b.file.name===f.name&&b.file.size===f.size))return;
    belegFiles.push({file:f,status:'pending',result:null});
  });
  renderBelegList();updateUploadSummary();
}
function removeBelegFile(i){belegFiles.splice(i,1);renderBelegList();updateUploadSummary();}
function renderBelegList(){
  const wrap=$('beleg-list');
  if(!belegFiles.length){wrap.style.display='none';return;}
  wrap.style.display='flex';
  wrap.innerHTML=belegFiles.map((b,i)=>{
    const ext=b.file.name.split('.').pop().toLowerCase();
    const icon=ext==='pdf'?'FILE':'IMG';
    const st=b.status==='done'?`<span class="file-item-status ok">✓ Ausgelesen</span>`:
              b.status==='err'?`<span class="file-item-status err">Fehler</span>`:
              b.status==='loading'?`<span class="file-item-status loading">⟳ Lese …</span>`:
              `<span class="file-item-status">Ausstehend</span>`;
    return`<div class="file-item">
      <div class="file-item-icon">${icon}</div>
      <span class="file-item-name" title="${b.file.name}">${b.file.name}</span>
      <span class="file-item-size">${fmtSize(b.file.size)}</span>
      ${st}
      <button class="file-item-del" onclick="removeBelegFile(${i})"><i data-lucide="x"></i></button>
    </div>`;
  }).join('');
  lucide.createIcons();
}

function updateUploadSummary(){
  const reCount=allDocs.filter(d=>d.typ==='rechnung'&&inPeriod(d.datum)&&reChecked[d.id]).length;
  const csvCount=csvTransactions.filter(t=>inPeriod(t.datum)||!t.datum).length; // nur im Zeitraum
  const belegCount=belegFiles.length;
  const parts=[];
  if(reCount)parts.push(`${reCount} Rechnung${reCount>1?'en':''}`);
  if(csvCount)parts.push(`${csvCount} Bankbuchungen`);
  if(belegCount)parts.push(`${belegCount} Beleg${belegCount>1?'e':''}`);
  if(manualIncomes.length)parts.push(`${manualIncomes.length} manuelle Einnahmen`);
  const qLabel=selectedQuartal?` (Q${selectedQuartal} ${selectedYear})`:` (${selectedYear})`;
  $('upload-summary').textContent=parts.length?parts.join(' · ') + ' bereit'+qLabel:'Noch nichts hochgeladen';
}

// ── SEITE 2: HINTS ─────────────────────────────────────────
function updatePage2Hints(){
  const csvInPeriod=csvTransactions.filter(t=>inPeriod(t.datum)||!t.datum).length;
  if(csvInPeriod>0){
    $('ki-hint-csv').style.display='flex';
    $('ki-hint-nocsv').style.display='none';
    const qLabel=selectedQuartal?`Q${selectedQuartal} ${selectedYear}`:String(selectedYear);
    $('ki-hint-csv-text').textContent=`${csvInPeriod} Bankbuchungen für ${qLabel} geladen. KI kann Belege direkt zuordnen.`;
  } else {
    $('ki-hint-csv').style.display='none';
    $('ki-hint-nocsv').style.display='flex';
  }
  const pending=belegFiles.filter(b=>b.status==='pending');
  if(!pending.length){
    $('btn-read-belege').style.display='none';
    $('beleg-skip-hint').style.display='inline';
    $('btn-match').disabled=false;
    $('match-hint').style.display='none';
  } else {
    $('btn-read-belege').style.display='inline-flex';
    $('beleg-skip-hint').style.display='none';
  }
  renderBelegStatusList();
}

function renderBelegStatusList(){
  const el=$('beleg-status-list');
  if(!belegFiles.length){el.innerHTML='<div style="font-size:11px;color:var(--text3);">Keine Belege hochgeladen – du kannst Schritt 1 überspringen.</div>';return;}
  el.innerHTML=belegFiles.map(b=>`<div style="display:flex;align-items:center;gap:8px;font-size:11px;padding:4px 0;">
    <span style="color:${b.status==='done'?'var(--green)':b.status==='err'?'var(--red)':'var(--text3)'};">
      ${b.status==='done'?'✓':b.status==='err'?'✗':'○'}
    </span>
    <span style="color:var(--text2);flex:1;">${b.file.name}</span>
    <span style="color:var(--text3);">${fmtSize(b.file.size)}</span>
  </div>`).join('');
}

// ── BELEGE AUSLESEN (KI) ───────────────────────────────────
async function readBelege(){
  const pending=belegFiles.filter(b=>b.status==='pending');
  if(!pending.length){toast('Alle Belege bereits ausgelesen.');enableMatching();return;}
  $('beleg-loading').classList.add('show');
  $('btn-read-belege').disabled=true;
  for(let i=0;i<belegFiles.length;i++){
    const b=belegFiles[i];
    if(b.status!=='pending')continue;
    b.status='loading';
    renderBelegStatusList();renderBelegList();
    $('beleg-loading-text').textContent=`Lese ${b.file.name} …`;
    $('beleg-progress-bar').style.width=Math.round(i/belegFiles.length*100)+'%';
    try{
      const b64=await readFileAsBase64(b.file);
      const res=await fetch('/api/tax',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({mode:'vision',imageData:b64,imageType:b.file.type,filename:b.file.name})});
      if(!res.ok){const e=await res.json();throw new Error(e.error||'Fehler');}
      const data=await res.json();
      b.result=data.results||[];
      b.status='done';
      // Beleg in Storage speichern (optional – schlägt fehl wenn Policy nicht gesetzt)
      try{
        await DB.uploadReceipt(b.file,{
          beschreibung:b.result[0]?.beschreibung||b.file.name,
          datum:b.result[0]?.datum||null,
          betrag:b.result[0]?.betrag_brutto||null,
          kategorie:b.result[0]?.kategorie||null,
        });
        b.savedToStorage=true;
      }catch(se){
        // Storage-Fehler: nur warnen, KI-Ergebnis ist trotzdem nutzbar
        console.warn('Beleg-Storage (ignoriert):',se.message);
        b.savedToStorage=false;
      }
    }catch(e){b.status='err';b.error=e.message;toast(`Fehler bei ${b.file.name}: ${e.message}`);}
    renderBelegStatusList();renderBelegList();
  }
  $('beleg-progress-bar').style.width='100%';
  $('beleg-loading').classList.remove('show');
  $('btn-read-belege').disabled=false;
  enableMatching();
}

function enableMatching(){
  $('btn-match').disabled=false;
  $('match-hint').style.display='none';
  $('btn-read-belege').style.display='none';
  $('beleg-skip-hint').style.display='none';
}

function readFileAsBase64(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=e=>res(e.target.result.split(',')[1]);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}

// ── MATCHING & KATEGORISIERUNG (KI) ───────────────────────
async function runMatching(){
  $('match-loading').classList.add('show');
  $('btn-match').disabled=true;
  $('match-loading-text').textContent='KI kategorisiert und matcht …';

  // Alle Einträge zusammenbauen: CSV + Rechnungen + manuelle Einnahmen + Beleg-Ergebnisse
  const allEntries=buildAllEntries();
  if(!allEntries.length){
    $('match-loading').classList.remove('show');
    toast('Keine Einträge vorhanden.');
    return;
  }

  // CSV-Einträge direkt übernehmen (kein KI-Call), Rest zur KI
  // Datum-Filter anwenden: nur Einträge im gewählten Zeitraum
  const allFiltered=allEntries.filter(e=>!e.datum||inPeriod(e.datum)||e.quelle==='rechnung'||e.quelle==='manuell');
  const needsAI  =allFiltered.filter(e=>!e._skipAI);
  const skipAI   =allFiltered.filter(e=> e._skipAI);

  aiResults=[];

  // Vorkategorisierte CSV-Einträge direkt aufnehmen
  skipAI.forEach(e=>{
    const catKey=e.isEinnahme?'einnahmen_19':'sonstiges';
    const cat=CATEGORIES[catKey];
    const betrag=e.betrag||0;
    const netto=cat.vat?Math.round(betrag/( 1+cat.vat)*100)/100:betrag;
    aiResults.push({
      id:e.id, beschreibung:e.beschreibung, datum:e.datum,
      kategorie:catKey, kategorie_info:cat,
      betrag_brutto:betrag, betrag_netto:netto,
      mwst_satz:cat.vat, mwst_betrag:Math.round((betrag-netto)*100)/100,
      begruendung:'Aus CSV-Import', konfidenz:'mittel', unklar:false,
      _fromCSV:true, _isEinnahme:e.isEinnahme
    });
  });

  // Nur manuelle/Rechnungen/Beleg-Ergebnisse zur KI
  if(needsAI.length){
    const batchSize=8;
    for(let i=0;i<needsAI.length;i+=batchSize){
      const batch=needsAI.slice(i,i+batchSize).map(e=>({
        id:e.id,
        beschreibung:(e.beschreibung||'').slice(0,100),
        betrag:e.betrag, datum:e.datum||'', quelle:e.quelle||''
      }));
      $('match-progress-bar').style.width=Math.round(i/needsAI.length*100)+'%';
      $('match-loading-text').textContent=`KI analysiert ${i+1}–${Math.min(i+batchSize,needsAI.length)} / ${needsAI.length} …`;
      try{
        const res=await fetch('/api/tax',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({entries:batch,mode:'categorize'})});
        if(!res.ok){const e=await res.json();throw new Error(e.error||'API-Fehler '+res.status);}
        const data=await res.json();
        aiResults.push(...(data.results||[]).map(r=>({...r,kategorie_info:CATEGORIES[r.kategorie]||CATEGORIES.sonstiges})));
      }catch(e){
        toast('KI-Fehler: '+e.message);
        $('match-loading').classList.remove('show');
        $('btn-match').disabled=false;
        return;
      }
    }
  }

  $('match-progress-bar').style.width='100%';
  $('match-loading').classList.remove('show');
  $('btn-match').disabled=false;
  $('btn-skip-to-review').style.display='inline-flex';

  // Review-Badge
  const reviewCount=aiResults.filter(r=>r.unklar||r.konfidenz==='niedrig').length;
  const badge=$('badge-review');
  badge.textContent=reviewCount;
  badge.classList.toggle('show',reviewCount>0);

  updateSidebar();
  toast(`Analyse abgeschlossen: ${aiResults.length} Einträge, ${reviewCount} zur Prüfung`);
}

function buildAllEntries(){
  const entries=[];
  // 1. Rechnungen aus dem Tool → zur KI für MwSt-Bestätigung
  allDocs.filter(d=>d.typ==='rechnung'&&inPeriod(d.datum)&&reChecked[d.id]).forEach(d=>{
    const netto=d.positionen?.reduce((s,p)=>s+parseFloat(p.menge||1)*parseFloat(p.preis||0),0)||0;
    const brutto=d.tax==='de'?netto*1.19:netto;
    entries.push({id:d.id,beschreibung:`Rechnung ${d.nr||''} – ${d.firma||d.kunde||''}`,
      betrag:brutto,datum:d.datum,quelle:'rechnung',_skipAI:false});
  });
  // 2. Manuelle Einnahmen → zur KI
  manualIncomes.forEach(x=>entries.push({
    id:x.id,beschreibung:x.desc,betrag:x.brutto,datum:x.datum,quelle:'manuell',_skipAI:false
  }));
  // 3. Beleg-Ergebnisse (KI hat schon ausgelesen) → trotzdem zur KI für Kategorie
  belegFiles.filter(b=>b.status==='done'&&b.result?.length).forEach(b=>{
    b.result.forEach(r=>entries.push({
      id:'beleg_'+b.file.name+'_'+r.id,
      beschreibung:r.beschreibung||b.file.name,
      betrag:r.betrag_brutto||0,datum:r.datum||'',
      quelle:'beleg',_skipAI:false
    }));
  });
  // 4. CSV-Transaktionen → KEIN KI-Call, regelbasiert
  // Nur Buchungen im gewählten Zeitraum
  csvTransactions.filter(t=>inPeriod(t.datum)).forEach(t=>entries.push({...t,_skipAI:true}));
  return entries;
}

// ── REVIEW ─────────────────────────────────────────────────
function renderReview(){
  const list=$('review-list');
  if(!aiResults.length){
    list.innerHTML='<div style="padding:24px;text-align:center;color:var(--text3);font-size:12px;">Noch keine Analyse durchgeführt. Bitte zuerst Schritt 2 abschließen.</div>';
    $('review-empty').style.display='none';
    return;
  }

  // Sortierung nach Datum (neueste zuerst), dann nach isEinnahme
  const sorted=[...aiResults].sort((a,b)=>{
    const da=a.datum||'';const db2=b.datum||'';
    if(da>db2)return-1;if(da<db2)return 1;return 0;
  });
  // Index-Map: sorted[i] → Index in aiResults (für onchange)
  const idxMap=sorted.map(r=>aiResults.indexOf(r));

  const reviewCount=aiResults.filter(r=>r.unklar||r.konfidenz==='niedrig').length;
  $('review-empty').style.display=reviewCount?'none':'flex';
  const displayed=filterReview?sorted.filter(r=>r.unklar||r.konfidenz==='niedrig'):sorted;
  list.innerHTML=displayed.map((r,i)=>{
    const cat=CATEGORIES[r.kategorie]||CATEGORIES.sonstiges;
    const isIncome=cat.type==='income';
    const konfCls=r.unklar?'unklar':(r.konfidenz||'hoch');
    const realIdx=aiResults.indexOf(r);
    return`<div class="ai-row" id="air-${realIdx}">
      <div>
        <div class="ai-desc">${r.beschreibung||'–'}</div>
        <div style="font-size:10px;color:var(--text3);margin-top:2px;">${r.datum?fmtDate(r.datum):''}</div>
        <div class="ai-sub" id="air-reason-${realIdx}" style="display:${showReasons?'block':'none'};">${r.begruendung||''}</div>
        ${r.unklar?'<span style="font-size:9px;color:var(--orange);margin-top:2px;display:block;">⚠ Zur Prüfung</span>':''}
      </div>
      <div style="text-align:right;">
        <div class="ai-amt ${isIncome?'income':'expense'}">${isIncome?'+':'−'}${fmt(r.betrag_brutto||0)}</div>
        <div style="font-size:10px;color:var(--text3);">Netto: ${fmt(r.betrag_netto||0)}</div>
      </div>
      <select class="cat-select" onchange="aiResults[${realIdx}].kategorie=this.value;aiResults[${realIdx}].kategorie_info=CATEGORIES[this.value]||CATEGORIES.sonstiges;updateSidebar();">
        ${Object.entries(CATEGORIES).map(([k,v])=>`<option value="${k}" ${r.kategorie===k?'selected':''}>${v.label}</option>`).join('')}
      </select>
      <span class="konfidenz ${konfCls}">${r.unklar?'Prüfen':r.konfidenz||'–'}</span>
    </div>`;
  }).join('');
  lucide.createIcons();
}
function toggleReasons(){showReasons=!showReasons;renderReview();}
function toggleFilterReview(){filterReview=!filterReview;$('btn-filter-review').classList.toggle('active',filterReview);renderReview();}

// ── USTVA BERECHNUNG ───────────────────────────────────────
function buildUStVA(){
  if(!aiResults.length){
    $('ustv-kpi-grid').innerHTML='<div style="color:var(--text3);font-size:12px;padding:10px;">Noch keine Analyse. Bitte zuerst Schritte 1–3 durchführen.</div>';
    return;
  }
  const q=selectedQuartal;const year=selectedYear;
  const label=q?`Q${q} ${year}`:year;
  $('ustva-period-label').textContent=label;

  let ein19=0,ein7=0,ein0=0,aus19=0,aus7=0,aus0=0;
  let vor19=0,vor7=0;
  let einNetto=0,ausNetto=0;

  aiResults.forEach(r=>{
    const cat=CATEGORIES[r.kategorie]||CATEGORIES.sonstiges;
    if(cat.type==='private')return;
    const netto=r.betrag_netto||0;
    const mwst=r.mwst_betrag||0;
    const f=cat.limitFactor||1;
    if(cat.type==='income'){
      einNetto+=netto;
      if(r.mwst_satz===0.19){ein19+=netto;}
      else if(r.mwst_satz===0.07){ein7+=netto;}
      else{ein0+=netto;}
    } else {
      ausNetto+=netto*f;
      if(r.mwst_satz===0.19){aus19+=netto*f;vor19+=mwst*f;}
      else if(r.mwst_satz===0.07){aus7+=netto*f;vor7+=mwst*f;}
      else{aus0+=netto*f;}
    }
  });

  const ust19=Math.round(ein19*0.19*100)/100;
  const ust7=Math.round(ein7*0.07*100)/100;
  const vorsteuer=Math.round((vor19+vor7)*100)/100;
  const zahllast=Math.round((ust19+ust7-vorsteuer)*100)/100;
  const gewinn=Math.round((einNetto-ausNetto)*100)/100;

  $('ustv-kpi-grid').innerHTML=`
    <div class="ustv-kpi"><div class="ustv-kpi-label">Umsatz Netto</div><div class="ustv-kpi-val green">${fmt(einNetto)}</div></div>
    <div class="ustv-kpi"><div class="ustv-kpi-label">Ausgaben Netto</div><div class="ustv-kpi-val red">${fmt(ausNetto)}</div></div>
    <div class="ustv-kpi"><div class="ustv-kpi-label">Gewinn (EÜR)</div><div class="ustv-kpi-val accent">${fmt(gewinn)}</div></div>
    <div class="ustv-kpi"><div class="ustv-kpi-label">USt-Zahllast</div><div class="ustv-kpi-val ${zahllast>0?'red':'green'}">${fmt(Math.abs(zahllast))} ${zahllast<0?'(Erstattung)':''}</div></div>
  `;

  $('detail-table').querySelector('tbody').innerHTML=`
    <tr><th colspan="2">Umsatzsteuer</th></tr>
    <tr><td>Kz 81 – Umsätze 19%</td><td>${fmt(ein19)}</td></tr>
    <tr><td>Kz 86 – Umsätze 7%</td><td>${fmt(ein7)}</td></tr>
    <tr><td>Kz 35 – Steuer 19%</td><td>${fmt(ust19)}</td></tr>
    <tr><td>Kz 36 – Steuer 7%</td><td>${fmt(ust7)}</td></tr>
    <tr><th colspan="2">Vorsteuer</th></tr>
    <tr><td>Kz 66 – Vorsteuer gesamt</td><td>${fmt(vorsteuer)}</td></tr>
    <tr><th colspan="2">Ergebnis</th></tr>
    <tr><td><strong>Kz 83 – Zahllast</strong></td><td><strong>${fmt(Math.max(0,zahllast))}</strong></td></tr>
    ${zahllast<0?`<tr><td>Kz 83 – Erstattungsüberhang</td><td style="color:var(--green);">${fmt(Math.abs(zahllast))}</td></tr>`:''}
  `;

  $('euer-table').querySelector('tbody').innerHTML=`
    <tr><td>Betriebseinnahmen Netto</td><td style="color:var(--green);">${fmt(einNetto)}</td></tr>
    <tr><td>Betriebsausgaben Netto</td><td style="color:var(--red);">${fmt(ausNetto)}</td></tr>
    <tr><td><strong>Gewinn / Verlust</strong></td><td><strong style="color:${gewinn>=0?'var(--green)':'var(--red)'};">${fmt(gewinn)}</strong></td></tr>
    <tr><td style="color:var(--text3);">Nicht-abzugsfähig (Privat etc.)</td><td style="color:var(--text3);">${fmt(aiResults.filter(r=>CATEGORIES[r.kategorie]?.type==='private').reduce((s,r)=>s+r.betrag_brutto,0))}</td></tr>
  `;

  updateSidebar();
}

// ── EXPORT ─────────────────────────────────────────────────
function exportSummary(){
  const q=selectedQuartal,year=selectedYear;
  const label=q?`Q${q} ${year}`:year;
  let txt=`UStVA-Zusammenfassung VISO Media – ${label}\n${'─'.repeat(40)}\n`;
  aiResults.forEach(r=>{
    const cat=CATEGORIES[r.kategorie]||CATEGORIES.sonstiges;
    txt+=`${fmtDate(r.datum)} | ${r.beschreibung?.slice(0,40)||'–'} | ${cat.type==='income'?'+':'−'}${fmt(r.betrag_brutto||0)} | ${cat.label}\n`;
  });
  navigator.clipboard.writeText(txt).then(()=>toast('Zusammenfassung kopiert ✓')).catch(()=>toast('Fehler beim Kopieren'));
}

function exportElsterXML(){
  let ein19=0,ein7=0,vor=0;
  aiResults.forEach(r=>{
    const cat=CATEGORIES[r.kategorie]||CATEGORIES.sonstiges;
    if(cat.type==='income'){if(r.mwst_satz===0.19)ein19+=r.betrag_netto||0;if(r.mwst_satz===0.07)ein7+=r.betrag_netto||0;}
    else if(cat.type==='expense'){vor+=r.mwst_betrag||0;}
  });
  const ust19=Math.round(ein19*0.19*100)/100;
  const ust7=Math.round(ein7*0.07*100)/100;
  const zahllast=Math.max(0,Math.round((ust19+ust7-vor)*100)/100);
  const steuernr=$('elster-steuernr').value.trim().replace(/\D/g,'');
  const bl=$('elster-bundesland').value;
  const q=selectedQuartal,year=selectedYear;
  const [vy,vm,vt]=new Date().toISOString().split('T')[0].split('-');
  const xml=`<?xml version="1.0" encoding="UTF-8"?>
<Elster xmlns="http://www.elster.de/elsterxml/schema/v12">
  <TransferHeader><Verfahren>ElsterAnmeldung</Verfahren><DatenArt>UStVA</DatenArt>
    <Vorgang>send-Auth</Vorgang><Erstellungsdatum>${year}${String(q||1).padStart(2,'0')}01</Erstellungsdatum>
  </TransferHeader>
  <DatenTeil><Nutzdaten><Anmeldung art="UStVA" version="2024">
    <Zeitraum><Jahr>${year}</Jahr><Quartal>${q||1}</Quartal></Zeitraum>
    <Steuernummer>${steuernr}</Steuernummer><Bundesland>${bl}</Bundesland>
    <Kz81>${Math.round(ein19*100)/100}</Kz81>
    <Kz86>${Math.round(ein7*100)/100}</Kz86>
    <Kz35>${ust19}</Kz35><Kz36>${ust7}</Kz36>
    <Kz66>${Math.round(vor*100)/100}</Kz66>
    <Kz83>${zahllast}</Kz83>
  </Anmeldung></Nutzdaten></DatenTeil>
</Elster>`;
  const blob=new Blob([xml],{type:'application/xml'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`UStVA_${q?'Q'+q+'_':''}${year}_ELSTER.xml`;a.click();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
  toast('ELSTER XML heruntergeladen ✓');
}

// ── INIT ───────────────────────────────────────────────────
async function init(){
  const user=await getUser();
  if(!user){window.location.href='/';return;}
  $('nav-user').textContent=user.email||'';

  // Jahr-Select
  const ySel=$('sel-year');
  const curYear=new Date().getFullYear();
  ySel.innerHTML='';
  [curYear,curYear-1,curYear-2].forEach(y=>{
    const o=document.createElement('option');o.value=y;o.textContent=y;
    if(y===curYear)o.selected=true;ySel.appendChild(o);
  });
  selectedYear=curYear;

  // Aktuelles Quartal
  const curQ=Math.ceil((new Date().getMonth()+1)/3);
  setQuartal(curQ);

  // Rechnungen laden
  try{allDocs=await DB.getDocuments();}
  catch(e){console.error(e);toast('Fehler beim Laden der Rechnungen');}
  refreshReList();

  // Gespeicherte CSV-Transaktionen laden (alle des Jahres)
  try{
    const txs=await DB.getTransactions(curYear);
    if(txs.length){
      csvTransactions=txs.map(t=>({
        id:'tx'+t.id, datum:t.datum||'', empfaenger:t.empfaenger||'',
        verwendungszweck:t.verwendungszweck||'',
        beschreibung:t.beschreibung||(t.empfaenger||'')+(t.verwendungszweck?' – '+t.verwendungszweck:''),
        betrag:parseFloat(t.betrag)||0, isEinnahme:!!t.is_einnahme, quelle:'csv', _fromDB:true
      }));
      // CSV-Status anzeigen
      const ein=csvTransactions.filter(t=>t.isEinnahme).length;
      const aus=csvTransactions.filter(t=>!t.isEinnahme).length;
      const st=$('csv-status');
      st.style.display='block';
      st.innerHTML=`<div class="hinweis ok"><i data-lucide="check-circle"></i><div><strong>${csvTransactions.length} gespeicherte Buchungen</strong> aus ${curYear}: ${ein} Eingänge, ${aus} Ausgaben. <button class="btn btn-ghost btn-sm" style="margin-left:8px;" onclick="clearCSVData()"><i data-lucide="trash-2"></i> Löschen</button></div></div>`;
      lucide.createIcons();
    }
  }catch(e){console.info('Transaktionen nicht geladen (Tabelle fehlt noch?):',e.message);}

  // Manuelle Einnahmen aus DB? (Falls in Zukunft persistent)
  renderManualIncomes();
  updateUploadSummary();
  updateSidebar();
  $('loading-screen').style.display='none';
  lucide.createIcons();
}

async function doSignOut(){await signOut();}

init();
</script>
</body>
</html>
