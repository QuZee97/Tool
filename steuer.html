<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Steuertool – VISO Media</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23d4cc2e'/><text x='16' y='23' text-anchor='middle' font-size='20' font-family='Helvetica Neue,Arial,sans-serif' font-weight='700' fill='%23111'>V</text></svg>">
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<style>
:root{
  --bg:#1e1f22;--surface:#27282c;--surface2:#2f3035;--surface3:#383a40;
  --border:#3d3f45;--border2:#4a4c54;
  --text:#e2e3e8;--text2:#9a9ca5;--text3:#5c5f6b;
  --accent:#d4cc2e;--accent-bg:rgba(212,204,46,0.08);
  --red:#e05555;--red-bg:#2a1515;--green:#4ade80;--green-bg:#0f2a1a;
  --blue:#60a5fa;--blue-bg:#1a2a3f;--orange:#fb923c;--orange-bg:#2a1a0a;
  --radius:8px;--radius-sm:5px;--font:'Helvetica Neue',Arial,sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--font);font-size:13px;color:var(--text);background:var(--bg);min-height:100vh;display:flex;flex-direction:column;}

/* ── NAV ── */
#nav{height:52px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:4px;position:sticky;top:0;z-index:50;flex-shrink:0;}
.nav-logo{font-size:14px;font-weight:700;color:var(--text);letter-spacing:-.2px;margin-right:8px;}
.nav-logo span{color:var(--text2);font-weight:300;}
.nav-sep{width:1px;height:20px;background:var(--border);margin:0 6px;}
.nav-btn{height:32px;padding:0 10px;border:none;background:none;color:var(--text3);cursor:pointer;border-radius:var(--radius-sm);display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:500;font-family:var(--font);transition:background .15s,color .15s;white-space:nowrap;text-decoration:none;}
.nav-btn:hover{background:var(--surface3);color:var(--text);}
.nav-btn.active{background:var(--accent-bg);color:var(--accent);}
.nav-btn svg{width:14px;height:14px;stroke-width:1.8;flex-shrink:0;}
.nav-spacer{flex:1;}
.nav-icon-btn{width:32px;height:32px;padding:0;border:none;background:none;color:var(--text3);cursor:pointer;border-radius:var(--radius-sm);display:inline-flex;align-items:center;justify-content:center;transition:background .15s,color .15s;text-decoration:none;}
.nav-icon-btn:hover{background:var(--surface3);color:var(--text);}
.nav-icon-btn svg{width:15px;height:15px;stroke-width:1.8;}

/* ── LAYOUT ── */
#app{display:flex;flex:1;overflow:hidden;}
#sidebar{width:260px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;padding:20px 16px;}
#main{flex:1;overflow-y:auto;padding:28px 32px;}
#main>*{max-width:760px;}
#main::-webkit-scrollbar{width:5px;}
#main::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

/* ── SIDEBAR ── */
.sb-section{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.7px;margin:18px 0 8px;display:flex;align-items:center;gap:6px;}
.sb-section::after{content:'';flex:1;height:1px;background:var(--border);}
.sb-section:first-child{margin-top:0;}
.step-btn{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:transparent;color:var(--text2);font-family:var(--font);font-size:12px;text-align:left;cursor:pointer;display:flex;align-items:center;gap:8px;transition:.12s;margin-bottom:4px;}
.step-btn:hover{background:var(--surface2);border-color:var(--border2);}
.step-btn.active{background:var(--accent-bg);border-color:var(--accent);color:var(--accent);}
.step-btn.done{color:var(--green);border-color:var(--green-bg);}
.step-num{width:18px;height:18px;border-radius:50%;background:var(--surface2);font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.step-btn.active .step-num{background:var(--accent);color:#111;}
.step-btn.done .step-num{background:var(--green-bg);color:var(--green);}

.quartal-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:4px;}
.q-btn{padding:5px 8px;border:1px solid var(--border);border-radius:var(--radius-sm);background:transparent;color:var(--text3);font-family:var(--font);font-size:11px;cursor:pointer;text-align:center;transition:.12s;}
.q-btn:hover{border-color:var(--border2);color:var(--text2);}
.q-btn.active{background:var(--accent);color:#111;border-color:var(--accent);}
.year-select{width:100%;margin-bottom:8px;}
#sidebar select,#sidebar input{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:12px;padding:6px 9px;outline:none;font-family:var(--font);}
#sidebar select{cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%235c5f6b' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:26px;}
#sidebar select:focus,#sidebar input:focus{border-color:var(--accent);}
.sb-stat{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:6px;}
.sb-stat-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;}
.sb-stat-val{font-size:16px;font-weight:700;}
.sb-stat-val.green{color:var(--green);}
.sb-stat-val.red{color:var(--red);}
.sb-stat-val.accent{color:var(--accent);}
.sb-stat-val.blue{color:var(--blue);}

/* ── MAIN CONTENT ── */
.page{display:none;}
.page.active{display:block;}
.page-title{font-size:18px;font-weight:700;color:var(--text);margin-bottom:4px;}
.page-sub{font-size:12px;color:var(--text3);margin-bottom:24px;}

/* ── CARDS ── */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px;}
.card-title{font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px;}
.card-sub{font-size:11px;color:var(--text3);margin-bottom:16px;line-height:1.6;}

/* ── BUTTONS ── */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border:none;border-radius:var(--radius-sm);font-size:12px;font-weight:500;cursor:pointer;font-family:var(--font);transition:.15s;white-space:nowrap;}
.btn svg{width:13px;height:13px;stroke-width:2;}
.btn:hover{opacity:.85;}
.btn-primary{background:var(--accent);color:#111;}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border2);}
.btn-ghost:hover{background:var(--surface2);opacity:1;}
.btn-green{background:var(--green-bg);color:var(--green);border:1px solid var(--green);}
.btn-sm{padding:5px 10px;font-size:11px;}

/* ── IMPORT-BEREICH ── */
.import-zone{
  border:2px dashed var(--border2);border-radius:var(--radius);padding:28px 20px;
  text-align:center;cursor:pointer;transition:.15s;margin-bottom:12px;
  position:relative;
}
.import-zone:hover,.import-zone.drag{border-color:var(--accent);background:var(--accent-bg);}
.import-zone svg.upload-icon{width:28px;height:28px;stroke-width:1.2;color:var(--text3);margin-bottom:8px;}
.import-zone p{font-size:12px;color:var(--text3);line-height:1.7;}
.import-zone strong{color:var(--text2);}
.import-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}

/* Upload-Typ-Chips */
.upload-type-chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;}
.upload-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:10px;border:1px solid var(--border2);font-size:10px;font-weight:600;background:var(--surface2);color:var(--text3);}
.upload-chip.csv,.upload-chip.img,.upload-chip.pdf{background:var(--surface2);border-color:var(--border2);color:var(--text3);}

/* Datei-Queue */
.file-queue{display:flex;flex-direction:column;gap:6px;margin-bottom:10px;}

/* Belege-Liste */
.beleg-row{display:grid;grid-template-columns:32px 1fr auto auto auto;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border);font-size:12px;}
.beleg-row:last-child{border-bottom:none;}
.beleg-row:hover{background:var(--surface2);}
.beleg-icon{width:30px;height:30px;border-radius:var(--radius-sm);background:var(--surface3);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.beleg-icon svg{width:14px;height:14px;stroke-width:1.8;color:var(--text3);}
.beleg-name{font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.beleg-sub{font-size:10px;color:var(--text3);margin-top:1px;}
.beleg-date{font-size:11px;color:var(--text3);white-space:nowrap;}
.beleg-size{font-size:10px;color:var(--text3);white-space:nowrap;}
.beleg-actions{display:flex;gap:4px;}
.beleg-btn{width:26px;height:26px;border:none;background:transparent;color:var(--text3);cursor:pointer;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;transition:.12s;}
.beleg-btn:hover{background:var(--surface3);color:var(--text);}
.beleg-btn svg{width:13px;height:13px;stroke-width:1.8;}
.file-item{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:7px 10px;}
.file-item-icon{width:22px;height:22px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;flex-shrink:0;background:var(--surface3);color:var(--text3);}
.file-item-icon.csv,.file-item-icon.img,.file-item-icon.pdf{background:var(--surface3);color:var(--text3);}
.file-item-name{flex:1;font-size:11px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.file-item-size{font-size:10px;color:var(--text3);white-space:nowrap;}
.file-item-status{font-size:10px;white-space:nowrap;}
.file-item-status.ok{color:var(--green);}
.file-item-status.err{color:var(--red);}
.file-item-status.loading{color:var(--orange);}
.file-item-del{width:20px;height:20px;border:none;background:none;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:3px;flex-shrink:0;}
.file-item-del:hover{color:var(--red);background:var(--red-bg);}
.file-item-del svg{width:11px;height:11px;}

.freitext-area{width:100%;min-height:120px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:12px;padding:10px 12px;outline:none;font-family:var(--font);resize:vertical;line-height:1.6;}
.freitext-area:focus{border-color:var(--accent);}

/* ── EINNAHMEN-LISTE (aus Tool) ── */
.income-list{display:flex;flex-direction:column;gap:6px;max-height:280px;overflow-y:auto;margin-bottom:12px;}
.income-list::-webkit-scrollbar{width:4px;}
.income-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.income-row{display:flex;align-items:center;gap:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 12px;}
.income-check{width:15px;height:15px;accent-color:var(--accent);cursor:pointer;flex-shrink:0;}
.income-nr{font-size:10px;color:var(--text3);min-width:90px;font-weight:600;}
.income-firma{font-size:12px;color:var(--text);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.income-betrag{font-size:12px;font-weight:600;color:var(--green);white-space:nowrap;}
.income-date{font-size:10px;color:var(--text3);white-space:nowrap;}

/* ── ENTRY TABELLE (vor KI-Analyse) ── */
.entry-table-wrap{overflow-x:auto;margin-bottom:12px;}
table.entry-table{width:100%;border-collapse:collapse;font-size:12px;}
table.entry-table thead tr{background:var(--surface2);}
table.entry-table th{padding:7px 10px;text-align:left;font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;white-space:nowrap;}
table.entry-table td{padding:7px 10px;border-top:1px solid var(--border);}
table.entry-table tbody tr:hover{background:var(--surface2);}
.entry-betrag{text-align:right;font-weight:600;}
.entry-del{width:26px;height:26px;border:none;background:none;color:var(--text3);cursor:pointer;border-radius:3px;display:inline-flex;align-items:center;justify-content:center;}
.entry-del:hover{color:var(--red);background:var(--red-bg);}
.entry-del svg{width:12px;height:12px;}
.add-entry-row{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;}
.add-entry-row input,.add-entry-row select{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);}
.add-entry-row input:focus,.add-entry-row select:focus{border-color:var(--accent);}
.add-entry-row .inp-desc{flex:2;min-width:160px;}
.add-entry-row .inp-amt{width:100px;}
.add-entry-row .inp-date{width:130px;}

/* ── KI ANALYSE ── */
.ai-result-row{
  display:grid;grid-template-columns:1fr 100px 100px 110px auto 28px;
  align-items:start;gap:8px;
  padding:10px 12px;border-top:1px solid var(--border);
  transition:background .1s;
}
.ai-result-row:hover{background:var(--surface2);}
.ai-result-row:first-child{border-top:none;}
.ai-desc{font-size:12px;color:var(--text);}
.ai-sub{font-size:10px;color:var(--text3);margin-top:2px;line-height:1.5;}
.ai-amt{font-size:12px;font-weight:600;text-align:right;}
.ai-amt.income{color:var(--green);}
.ai-amt.expense{color:var(--red);}
.ai-netto{font-size:11px;color:var(--text3);text-align:right;}
.ai-kat-select{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:4px 6px;outline:none;font-family:var(--font);cursor:pointer;appearance:none;-webkit-appearance:none;}
.ai-kat-select:focus{border-color:var(--accent);}
.konfidenz{display:inline-flex;align-items:center;gap:4px;font-size:9px;padding:2px 6px;border-radius:10px;border:1px solid;white-space:nowrap;}
.konfidenz.hoch{background:var(--green-bg);border-color:var(--green);color:var(--green);}
.konfidenz.mittel{background:var(--orange-bg);border-color:var(--orange);color:var(--orange);}
.konfidenz.niedrig,.konfidenz.unklar{background:var(--red-bg);border-color:var(--red);color:var(--red);}
.review-flag{background:var(--orange-bg);border:1px solid var(--orange);color:var(--orange);font-size:10px;padding:2px 7px;border-radius:10px;display:inline-flex;align-items:center;gap:4px;}
.review-flag svg{width:11px;height:11px;}

/* ── USTVA ERGEBNIS ── */
.ustv-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
@media(max-width:700px){.ustv-grid{grid-template-columns:1fr;}}
.ustv-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;}
.ustv-card.highlight{border-color:var(--accent);background:var(--accent-bg);}
.ustv-card.danger{border-color:var(--red);background:var(--red-bg);}
.ustv-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px;}
.ustv-zeile{font-size:9px;color:var(--text3);margin-bottom:2px;}
.ustv-val{font-size:20px;font-weight:700;}
.ustv-val.accent{color:var(--accent);}
.ustv-val.green{color:var(--green);}
.ustv-val.red{color:var(--red);}
.ustv-val.blue{color:var(--blue);}
.ustv-sub{font-size:11px;color:var(--text3);margin-top:4px;}

.detail-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:12px;}
.detail-table th{padding:6px 10px;text-align:left;color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid var(--border);}
.detail-table td{padding:6px 10px;border-bottom:1px solid var(--border);color:var(--text2);}
.detail-table td.r{text-align:right;}
.detail-table tr.group-hd td{background:var(--surface2);color:var(--text);font-weight:600;font-size:11px;padding:8px 10px;}
.detail-table tr.total td{font-weight:700;color:var(--text);border-top:2px solid var(--border2);}

/* ── HINWEIS-BOX ── */
.hinweis{background:var(--blue-bg);border:1px solid var(--blue);border-radius:var(--radius-sm);padding:12px 14px;font-size:11px;color:var(--blue);line-height:1.7;margin-bottom:16px;display:flex;gap:10px;}
.hinweis svg{width:16px;height:16px;flex-shrink:0;margin-top:1px;}
.hinweis.warn{background:var(--orange-bg);border-color:var(--orange);color:var(--orange);}
.hinweis.ok{background:var(--green-bg);border-color:var(--green);color:var(--green);}

/* ── PROGRESS ── */
.progress-wrap{background:var(--surface2);border-radius:4px;height:6px;margin:8px 0;}
.progress-bar{height:100%;background:var(--accent);border-radius:4px;transition:width .3s;}

/* ── SPINNER ── */
.spinner{width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-overlay{display:none;align-items:center;gap:10px;padding:16px;background:var(--surface2);border-radius:var(--radius);margin:8px 0;font-size:12px;color:var(--text3);}
.loading-overlay.show{display:flex;}

/* ── TOAST ── */
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--surface3);color:var(--text);border:1px solid var(--border2);padding:9px 18px;border-radius:var(--radius);font-size:12px;opacity:0;transition:.25s;pointer-events:none;z-index:999;box-shadow:0 4px 20px rgba(0,0,0,.4);}
#toast.show{opacity:1;}

/* ── LOADING SCREEN ── */
#loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:100;}
.spinner-lg{width:32px;height:32px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
</style>
</head>
<body>

<div id="loading-screen">
  <div class="spinner-lg"></div>
  <span style="font-size:12px;color:var(--text3);">Lade Steuertool …</span>
</div>

<!-- NAV -->
<nav id="nav">
  <span class="nav-logo">VISO <span>Media</span></span>
  <div class="nav-sep"></div>
  <a class="nav-btn" href="/dashboard"><i data-lucide="layout-dashboard"></i> Dashboard</a>
  <a class="nav-btn" href="/tool"><i data-lucide="file-text"></i> Angebote & Rechnungen</a>
  <a class="nav-btn active" href="/steuer"><i data-lucide="calculator"></i> Steuer</a>
  <div class="nav-spacer"></div>
  <span style="font-size:11px;color:var(--text3);padding:0 6px;" id="nav-user"></span>
  <button class="nav-icon-btn" onclick="doSignOut()" title="Abmelden"><i data-lucide="log-out"></i></button>
</nav>

<div id="app">

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="sb-section">Zeitraum</div>
  <select id="sel-year" onchange="onPeriodChange()">
    <option value="2026">2026</option>
    <option value="2025">2025</option>
    <option value="2024">2024</option>
  </select>
  <div style="margin-top:8px;margin-bottom:4px;font-size:10px;color:var(--text3);">Quartal</div>
  <div class="quartal-grid">
    <button class="q-btn" id="q1" onclick="setQuartal(1)">Q1 Jan–Mär</button>
    <button class="q-btn active" id="q2" onclick="setQuartal(2)">Q2 Apr–Jun</button>
    <button class="q-btn" id="q3" onclick="setQuartal(3)">Q3 Jul–Sep</button>
    <button class="q-btn" id="q4" onclick="setQuartal(4)">Q4 Okt–Dez</button>
  </div>
  <button class="q-btn active" id="qjahr" onclick="setQuartal(0)" style="width:100%;margin-top:4px;">Ganzes Jahr</button>

  <div class="sb-section">Schritte</div>
  <button class="step-btn active" id="step-btn-1" onclick="goPage(1)">
    <span class="step-num">1</span> Rechnungen
  </button>
  <button class="step-btn" id="step-btn-2" onclick="goPage(2)">
    <span class="step-num">2</span> Import & Ausgaben
  </button>
  <button class="step-btn" id="step-btn-3" onclick="goPage(3)">
    <span class="step-num">3</span> KI-Analyse
  </button>
  <button class="step-btn" id="step-btn-4" onclick="goPage(4)">
    <span class="step-num">4</span> UStVA-Ergebnis
  </button>
  <button class="step-btn" id="step-btn-5" onclick="goPage(5)">
    <span class="step-num">5</span> Belege
  </button>

  <div class="sb-section">Zusammenfassung</div>
  <div class="sb-stat">
    <div class="sb-stat-label">Einnahmen Netto</div>
    <div class="sb-stat-val green" id="sb-einnahmen">0,00 €</div>
  </div>
  <div class="sb-stat">
    <div class="sb-stat-label">Ausgaben Netto</div>
    <div class="sb-stat-val red" id="sb-ausgaben">0,00 €</div>
  </div>
  <div class="sb-stat">
    <div class="sb-stat-label">Gewinn (EÜR)</div>
    <div class="sb-stat-val accent" id="sb-gewinn">0,00 €</div>
  </div>
  <div class="sb-stat">
    <div class="sb-stat-label">USt-Zahllast</div>
    <div class="sb-stat-val blue" id="sb-zahllast">0,00 €</div>
  </div>
</div>

<!-- MAIN -->
<div id="main">

  <!-- ── SEITE 1: EINNAHMEN ── -->
  <div class="page active" id="page-1">
    <div class="page-title">Einnahmen</div>
    <div class="page-sub">Wähle welche Rechnungen in diesen Zeitraum fallen. Oder füge manuelle Einnahmen hinzu.</div>

    <div class="hinweis"><i data-lucide="info"></i>
      <div>Rechnungen aus dem Dokumenten-Tool werden automatisch geladen. Der Filter rechts (Jahr/Quartal) grenzt den Zeitraum ein. Nur <strong>Rechnungen</strong> (nicht Angebote) werden berücksichtigt.</div>
    </div>

    <div class="card">
      <div class="card-title">Rechnungen aus dem Tool <span id="income-count" style="font-weight:400;color:var(--text3);font-size:11px;"></span></div>
      <div class="card-sub">Haken setzen = in die Auswertung aufnehmen</div>
      <div class="income-list" id="income-list">
        <div style="color:var(--text3);font-size:11px;padding:10px;">Lade Rechnungen …</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-ghost btn-sm" onclick="selectAllIncome(true)"><i data-lucide="check-square"></i> Alle</button>
        <button class="btn btn-ghost btn-sm" onclick="selectAllIncome(false)"><i data-lucide="square"></i> Keine</button>
        <span style="flex:1;"></span>
        <span style="font-size:11px;color:var(--text3);align-self:center;" id="income-sel-info"></span>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Manuelle Einnahmen</div>
      <div class="card-sub">Einnahmen die nicht als Rechnung erfasst sind (Bargeschäfte, Nebeneinnahmen, etc.)</div>
      <div class="entry-table-wrap" id="manual-income-wrap" style="display:none;">
        <table class="entry-table">
          <thead><tr><th>Beschreibung</th><th>Datum</th><th style="text-align:right;">Brutto</th><th></th></tr></thead>
          <tbody id="manual-income-tbody"></tbody>
        </table>
      </div>
      <div class="add-entry-row">
        <input class="inp-desc" id="mi-desc" type="text" placeholder="Beschreibung">
        <input class="inp-amt" id="mi-amt" type="text" placeholder="Brutto €">
        <input class="inp-date" id="mi-date" type="date">
        <button class="btn btn-ghost btn-sm" onclick="addManualIncome()"><i data-lucide="plus"></i> Hinzufügen</button>
      </div>
    </div>

    <div class="hinweis" style="background:var(--surface2);border-color:var(--border2);"><i data-lucide="upload"></i>
      <div>CSV-Kontoauszug hochladen? Das geht auf <strong>Schritt 2 → Datei-Upload</strong>. Einnahmen und Ausgaben werden automatisch getrennt.</div>
    </div>
    <button class="btn btn-primary" onclick="goPage(2)"><i data-lucide="arrow-right"></i> Weiter: Import & Ausgaben</button>
  </div>

  <!-- ── SEITE 2: AUSGABEN ── -->
  <div class="page" id="page-2">
    <div class="page-title">Import & Ausgaben</div>
    <div class="page-sub">Lade CSV-Kontoauszüge hoch – Einnahmen und Ausgaben werden automatisch erkannt und getrennt. Oder erfasse Ausgaben manuell.</div>

    <div class="hinweis warn"><i data-lucide="info"></i>
      <div><strong>CSV-Import:</strong> Einnahmen (positive Beträge) werden automatisch zu Einnahmen, Ausgaben (negative Beträge) zu Ausgaben. Nach dem Import siehst du alles in der KI-Analyse.</div>
    </div>

    <!-- Datei-Upload -->
    <div class="card">
      <div class="card-title">Datei-Upload</div>
      <div class="card-sub">Kontoauszug als CSV · Rechnung/Beleg als PDF oder Foto (JPG, PNG, HEIC) · KI erkennt Beträge automatisch</div>

      <div class="upload-type-chips">
        <span class="upload-chip csv"><i data-lucide="table-2"></i> CSV</span>
        <span class="upload-chip img"><i data-lucide="image"></i> JPG / PNG / HEIC</span>
        <span class="upload-chip pdf"><i data-lucide="file-text"></i> PDF</span>
      </div>

      <div class="import-zone" id="upload-zone" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
        <input type="file" id="file-input" multiple accept=".csv,.jpg,.jpeg,.png,.heic,.heif,.webp,.pdf" onchange="onFileSelect(this.files)">
        <i data-lucide="upload-cloud" class="upload-icon"></i>
        <p><strong>Dateien hier ablegen</strong> oder klicken zum Auswählen<br>
        CSV, JPG, PNG, HEIC, WEBP, PDF – mehrere Dateien gleichzeitig möglich</p>
      </div>

      <div class="file-queue" id="file-queue" style="display:none;"></div>

      <div class="loading-overlay" id="upload-loading"><div class="spinner"></div> <span id="upload-loading-text">KI analysiert Dateien …</span></div>

      <button class="btn btn-primary" id="btn-upload-analyze" style="display:none;margin-top:4px;" onclick="analyzeUploadedFiles()">
        <i data-lucide="sparkles"></i> Alle Dateien analysieren
      </button>
    </div>

    <div class="card">
      <div class="card-title">Freitext-Import (KI)</div>
      <div class="card-sub">Alternativ: Text aus Kontoauszügen oder E-Mail-Bestätigungen direkt einfügen</div>
      <textarea class="freitext-area" id="freitext-input" placeholder="Beispiel:&#10;15.01.2026 Adobe Creative Cloud 54,99 EUR&#10;22.01.2026 Zoom Pro Abo 15,99 USD&#10;03.02.2026 Bewirtung Kundenessen Restaurant Moritz 87,50 EUR&#10;..."></textarea>
      <div class="loading-overlay" id="freitext-loading"><div class="spinner"></div> KI analysiert Text …</div>
      <button class="btn btn-primary" style="margin-top:10px;" onclick="analyzeFreitext()"><i data-lucide="sparkles"></i> Aus Text extrahieren</button>
    </div>

    <div class="card">
      <div class="card-title">Ausgaben-Liste <span id="expense-count" style="font-weight:400;color:var(--text3);font-size:11px;"></span></div>
      <div class="card-sub">Manuell hinzugefügte oder aus dem Text extrahierte Ausgaben</div>
      <div class="entry-table-wrap">
        <table class="entry-table">
          <thead><tr><th>Beschreibung</th><th>Datum</th><th style="text-align:right;">Betrag</th><th></th></tr></thead>
          <tbody id="expense-tbody">
            <tr><td colspan="4" style="color:var(--text3);text-align:center;padding:16px;">Noch keine Ausgaben. Importiere Text oder füge manuell hinzu.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="add-entry-row">
        <input class="inp-desc" id="exp-desc" type="text" placeholder="Beschreibung (z.B. Adobe Creative Cloud)">
        <input class="inp-amt" id="exp-amt" type="text" placeholder="Betrag €">
        <input class="inp-date" id="exp-date" type="date">
        <button class="btn btn-ghost btn-sm" onclick="addExpense()"><i data-lucide="plus"></i> Hinzufügen</button>
      </div>
    </div>

    <div style="display:flex;gap:8px;">
      <button class="btn btn-ghost" onclick="goPage(1)"><i data-lucide="arrow-left"></i> Zurück</button>
      <button class="btn btn-primary" onclick="startAIAnalysis()"><i data-lucide="sparkles"></i> KI-Analyse starten</button>
    </div>
  </div>

  <!-- ── SEITE 3: KI-ANALYSE ── -->
  <div class="page" id="page-3">
    <div class="page-title">KI-Analyse</div>
    <div class="page-sub">Überprüfe und korrigiere die Kategorien. Rot markierte Einträge brauchen deine Aufmerksamkeit.</div>

    <div class="loading-overlay" id="ai-loading" style="margin-bottom:16px;">
      <div class="spinner"></div>
      <div>
        <div style="color:var(--text2);font-size:12px;">KI analysiert <span id="ai-progress-text">0</span> Einträge …</div>
        <div class="progress-wrap" style="width:200px;"><div class="progress-bar" id="ai-progress-bar" style="width:0%"></div></div>
      </div>
    </div>

    <div id="ai-results-wrap" style="display:none;">
      <div class="hinweis" id="ai-review-hint" style="display:none;"><i data-lucide="alert-circle"></i>
        <div><strong id="ai-review-count">0</strong> Einträge wurden zur Überprüfung markiert – bitte Kategorie prüfen und ggf. anpassen.</div>
      </div>

      <div class="card" style="padding:0;overflow:hidden;">
        <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;">
          <span style="font-size:12px;font-weight:600;">Alle Einträge</span>
          <span style="flex:1;"></span>
          <button class="btn btn-ghost btn-sm" onclick="expandAllReasons()"><i data-lucide="eye"></i> Begründungen</button>
        </div>
        <div id="ai-results-list"></div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:16px;">
      <button class="btn btn-ghost" onclick="goPage(2)"><i data-lucide="arrow-left"></i> Zurück</button>
      <button class="btn btn-primary" id="btn-to-ustva" onclick="buildUStVA()" style="display:none;"><i data-lucide="calculator"></i> UStVA berechnen</button>
    </div>
  </div>

  <!-- ── SEITE 4: USTVA-ERGEBNIS ── -->
  <div class="page" id="page-4">
    <div class="page-title">UStVA-Ergebnis</div>
    <div class="page-sub" id="ustva-period-label">Quartal / Jahr</div>

    <div class="hinweis warn"><i data-lucide="alert-triangle"></i>
      <div><strong>Kein Ersatz für Steuerberatung.</strong> Diese Berechnung ist eine Arbeitshilfe und muss von dir oder deinem Steuerberater geprüft werden, bevor du die offizielle UStVA einreichst. Alle Angaben ohne Gewähr.</div>
    </div>

    <div class="ustv-grid" id="ustv-kpi-grid"></div>

    <div class="card" style="padding:0;overflow:hidden;">
      <div style="padding:14px 16px;border-bottom:1px solid var(--border);font-size:12px;font-weight:600;">Detailauswertung</div>
      <table class="detail-table" id="detail-table"><tbody></tbody></table>
    </div>

    <div class="card">
      <div class="card-title">EÜR-Zusammenfassung</div>
      <div class="card-sub">Einnahmenüberschussrechnung – Basis für die Jahressteuererklärung</div>
      <table class="detail-table" id="euer-table"><tbody></tbody></table>
    </div>

    <div class="card" style="background:var(--accent-bg);border-color:var(--accent);">
      <div class="card-title">Für deinen Steuerberater</div>
      <div class="card-sub">Exportiere eine kompakte Zusammenfassung als Text zum Weiterschicken.</div>
      <button class="btn btn-primary" onclick="exportSummary()"><i data-lucide="copy"></i> Zusammenfassung kopieren</button>
      <button class="btn btn-ghost" style="margin-left:8px;" onclick="window.print()"><i data-lucide="printer"></i> Drucken</button>
    </div>

    <div class="card" style="background:var(--blue-bg,#1a2a3f);border-color:var(--blue);">
      <div class="card-title" style="color:var(--blue);">ELSTER XML erstellen</div>
      <div class="card-sub">Generiert eine UStVA-XML-Datei im ELSTER-Format. Diese kannst du direkt in <strong>Mein ELSTER</strong> oder in deinem Steuerberater-Tool importieren.</div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
        <div style="flex:1;min-width:180px;">
          <label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Steuernummer (für ELSTER)</label>
          <input id="elster-steuernr" type="text" placeholder="02 087 20105 8" style="background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);width:100%;">
        </div>
        <div style="flex:1;min-width:140px;">
          <label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Bundesland</label>
          <select id="elster-bundesland" style="background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);width:100%;-webkit-appearance:none;">
            <option value="26">Hessen</option>
            <option value="11">Berlin</option>
            <option value="91">Bayern</option>
            <option value="20">Hamburg</option>
            <option value="24">Bremen</option>
            <option value="21">Niedersachsen</option>
            <option value="28">Nordrhein-Westfalen</option>
            <option value="30">Rheinland-Pfalz</option>
            <option value="10">Brandenburg</option>
            <option value="40">Baden-Württemberg</option>
            <option value="31">Saarland</option>
            <option value="22">Sachsen-Anhalt</option>
            <option value="32">Sachsen</option>
            <option value="23">Schleswig-Holstein</option>
            <option value="21">Thüringen</option>
            <option value="13">Mecklenburg-Vorpommern</option>
          </select>
        </div>
      </div>
      <button class="btn" style="margin-top:12px;background:var(--blue);color:#fff;border:none;" onclick="exportElsterXML()">
        <i data-lucide="file-code-2"></i> ELSTER XML herunterladen
      </button>
      <p style="font-size:10px;color:var(--text3);margin-top:8px;line-height:1.5;">
        Das XML enthält die UStVA-Kennzahlen (Zeile 81, 86, 66, 83). Du kannst es in <strong>Mein ELSTER → Formulare → UStVA → Import</strong> hochladen oder deinem Steuerberater weiterschicken.
      </p>
    </div>

    <div style="display:flex;gap:8px;">
      <button class="btn btn-ghost" onclick="goPage(3)"><i data-lucide="arrow-left"></i> Zurück zur Analyse</button>
    </div>
  </div>

  <!-- ── SEITE 5: BELEGE ── -->
  <div class="page" id="page-5">
    <div class="page-title">Belege</div>
    <div class="page-sub">Alle hochgeladenen Belege, Rechnungen und Kontoauszüge – dauerhaft gespeichert und abrufbar.</div>

    <div class="hinweis"><i data-lucide="info"></i>
      <div>Einmalige Einrichtung: <strong>1)</strong> Supabase Dashboard → Storage → New Bucket → <code style="color:var(--accent);">receipts</code> → Private. <strong>2)</strong> Storage → Policies → receipts → "New Policy" → "Full Access" für authenticated users. <strong>3)</strong> SQL: <code style="color:var(--accent);font-size:10px;">create table if not exists receipts(id uuid primary key default gen_random_uuid(),user_id uuid,filename text,storage_path text,signed_url text,size_bytes bigint,mime_type text,datum date,beschreibung text,kategorie text,betrag numeric,created_at timestamptz default now());</code> + RLS policy.</div>
    </div>

    <!-- Upload neuer Beleg -->
    <div class="card">
      <div class="card-title">Beleg hochladen</div>
      <div class="card-sub">PDF, Foto, Screenshot oder CSV – wird dauerhaft gespeichert</div>
      <div class="import-zone" id="beleg-zone" ondragover="onBelegDragOver(event)" ondragleave="onBelegDragLeave(event)" ondrop="onBelegDrop(event)">
        <input type="file" id="beleg-input" multiple accept=".csv,.jpg,.jpeg,.png,.heic,.heif,.webp,.pdf" onchange="onBelegSelect(this.files)">
        <i data-lucide="upload-cloud" class="upload-icon"></i>
        <p><strong>Datei ablegen</strong> oder klicken · PDF, Foto, CSV</p>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
        <input id="beleg-desc" type="text" placeholder="Beschreibung (optional)" style="flex:2;min-width:160px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);">
        <input id="beleg-datum" type="date" style="flex:1;min-width:120px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);">
        <input id="beleg-betrag" type="text" placeholder="Betrag €" style="flex:1;min-width:80px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);">
      </div>
      <div id="beleg-pending-list" style="display:none;margin-top:8px;"></div>
      <button class="btn btn-primary" id="btn-beleg-upload" style="margin-top:10px;display:none;" onclick="uploadPendingBelege()">
        <i data-lucide="upload"></i> <span id="btn-beleg-txt">Hochladen</span>
      </button>
    </div>

    <!-- Beleg-Liste -->
    <div class="card" style="padding:0;overflow:hidden;">
      <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;">
        <span style="font-size:12px;font-weight:600;">Gespeicherte Belege</span>
        <span style="flex:1;"></span>
        <input id="beleg-search" type="text" placeholder="Suche …" oninput="renderBelege()" style="background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:4px 9px;outline:none;font-family:var(--font);width:160px;">
        <button class="btn btn-ghost btn-sm" onclick="loadBelege()"><i data-lucide="refresh-cw"></i></button>
      </div>
      <div id="beleg-list-wrap">
        <div style="padding:24px;text-align:center;color:var(--text3);font-size:12px;">Lade Belege …</div>
      </div>
    </div>

    <div style="margin-top:4px;">
      <button class="btn btn-ghost" onclick="goPage(4)"><i data-lucide="arrow-left"></i> Zurück zum Ergebnis</button>
    </div>
  </div>

</div><!-- /main -->
</div><!-- /app -->

<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="supabase.js"></script>
<script>
lucide.createIcons();

// ── STATE ─────────────────────────────────────────────────
let allDocs = [];
let selectedYear = new Date().getFullYear();
let selectedQuartal = 0; // 0=Jahr, 1-4=Quartal
let incomeItems = [];   // { id, nr, firma, betreff, datum, brutto, netto, tax, checked }
let manualIncomes = []; // { id, desc, datum, brutto }
let expenses = [];      // { id, desc, datum, betrag }
let aiResults = [];     // nach KI-Analyse
let showReasons = false;

const fmt = n => n.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+'\u00a0€';
const fmtDate = v=>{if(!v)return'–';try{const[y,m,d]=v.split('-');return`${d}.${m}.${y}`;}catch{return v;}};
const parseAmt = s=>{if(!s)return 0;s=String(s).trim();if(/^\d{1,3}(\.\d{3})*(,\d+)?$/.test(s)){return parseFloat(s.replace(/\./g,'').replace(',','.'));}return parseFloat(s.replace(',','.').replace(/[^\d.]/g,''))||0;};
const toast = msg=>{const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);};
const $ = id=>document.getElementById(id);

function parsePreis(s){return parseAmt(s);}

function docNetto(doc){
  if(!doc.positionen?.length)return 0;
  return doc.positionen.reduce((s,p)=>s+parsePreis(p.menge)*parsePreis(p.preis),0);
}
function docBrutto(doc){const n=docNetto(doc);return doc.tax==='de'?n*1.19:n;}

// ── ZEITRAUM ──────────────────────────────────────────────
function setQuartal(q){
  selectedQuartal=q;
  document.querySelectorAll('.q-btn').forEach(b=>b.classList.remove('active'));
  $(q===0?'qjahr':`q${q}`).classList.add('active');
  refreshIncomeList();
}
function onPeriodChange(){
  selectedYear=parseInt($('sel-year').value);
  refreshIncomeList();
}
function inPeriod(datum){
  if(!datum)return false;
  const [y,m]=datum.split('-').map(Number);
  if(y!==selectedYear)return false;
  if(selectedQuartal===0)return true;
  const qMap={1:[1,2,3],2:[4,5,6],3:[7,8,9],4:[10,11,12]};
  return qMap[selectedQuartal].includes(m);
}

// ── NAVIGATION ────────────────────────────────────────────
let currentPage=1;
function goPage(n){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  $(`page-${n}`).classList.add('active');
  document.querySelectorAll('.step-btn').forEach((b,i)=>b.classList.toggle('active',i+1===n));
  currentPage=n;
  if(n===1)refreshIncomeList();
  if(n===2)renderExpenses();
  if(n===5)loadBelege();
  updateSidebar();
}

// ── EINNAHMEN ─────────────────────────────────────────────
function refreshIncomeList(){
  const el=$('income-list');
  const relevant=allDocs.filter(d=>d.typ==='rechnung'&&inPeriod(d.datum));
  $('income-count').textContent=`(${relevant.length} im Zeitraum)`;

  if(!relevant.length){
    el.innerHTML='<div style="color:var(--text3);font-size:11px;padding:10px;">Keine Rechnungen im gewählten Zeitraum.</div>';
    incomeItems=[];updateSidebar();return;
  }

  // State mergen – neu hinzugekommene als checked markieren
  const existingIds=new Set(incomeItems.map(x=>x.id));
  relevant.forEach(d=>{
    if(!existingIds.has(d.id)){
      incomeItems.push({id:d.id,nr:d.nr,firma:d.firma,betreff:d.betreff,datum:d.datum,
        brutto:docBrutto(d),netto:docNetto(d),tax:d.tax,checked:true});
    }
  });
  // Nicht mehr im Zeitraum entfernen
  incomeItems=incomeItems.filter(x=>relevant.find(d=>d.id===x.id));

  el.innerHTML=incomeItems.map(item=>`
    <div class="income-row">
      <input type="checkbox" class="income-check" ${item.checked?'checked':''} onchange="toggleIncome('${item.id}',this.checked)">
      <span class="income-nr">${item.nr||'–'}</span>
      <span class="income-firma">${item.firma||'–'} · ${item.betreff||'–'}</span>
      <span class="income-date">${fmtDate(item.datum)}</span>
      <span class="income-betrag">${fmt(item.brutto)}</span>
    </div>`).join('');
  updateIncomeSelInfo();
  updateSidebar();
}
function toggleIncome(id,checked){
  const item=incomeItems.find(x=>x.id===id);
  if(item)item.checked=checked;
  updateIncomeSelInfo();updateSidebar();
}
function selectAllIncome(v){
  incomeItems.forEach(x=>x.checked=v);
  refreshIncomeList();
}
function updateIncomeSelInfo(){
  const sel=incomeItems.filter(x=>x.checked);
  const sum=sel.reduce((s,x)=>s+x.brutto,0);
  $('income-sel-info').textContent=`${sel.length} ausgewählt · ${fmt(sum)}`;
}

// ── MANUELLE EINNAHMEN ────────────────────────────────────
function addManualIncome(){
  const desc=$('mi-desc').value.trim(),amt=$('mi-amt').value.trim(),date=$('mi-date').value;
  if(!desc||!amt){toast('Beschreibung und Betrag erforderlich.');return;}
  manualIncomes.push({id:'m'+Date.now(),desc,datum:date,brutto:parseAmt(amt)});
  $('mi-desc').value='';$('mi-amt').value='';
  renderManualIncomes();updateSidebar();
}
function removeManualIncome(id){manualIncomes=manualIncomes.filter(x=>x.id!==id);renderManualIncomes();updateSidebar();}
function renderManualIncomes(){
  const wrap=$('manual-income-wrap');
  if(!manualIncomes.length){wrap.style.display='none';return;}
  wrap.style.display='block';
  $('manual-income-tbody').innerHTML=manualIncomes.map(x=>`
    <tr><td>${x.desc}</td><td>${fmtDate(x.datum)}</td>
    <td class="entry-betrag">${fmt(x.brutto)}</td>
    <td><button class="entry-del" onclick="removeManualIncome('${x.id}')"><i data-lucide="x"></i></button></td></tr>`).join('');
  lucide.createIcons();
}

// ── AUSGABEN ──────────────────────────────────────────────
function addExpense(){
  const desc=$('exp-desc').value.trim(),amt=$('exp-amt').value.trim(),date=$('exp-date').value;
  if(!desc||!amt){toast('Beschreibung und Betrag erforderlich.');return;}
  expenses.push({id:'e'+Date.now(),desc,datum:date,betrag:parseAmt(amt)});
  $('exp-desc').value='';$('exp-amt').value='';
  renderExpenses();
}
function removeExpense(id){expenses=expenses.filter(x=>x.id!==id);renderExpenses();}
function renderExpenses(){
  const tbody=$('expense-tbody');
  $('expense-count').textContent=`(${expenses.length} Einträge)`;
  if(!expenses.length){
    tbody.innerHTML='<tr><td colspan="4" style="color:var(--text3);text-align:center;padding:16px;">Noch keine Ausgaben.</td></tr>';
    return;
  }
  tbody.innerHTML=expenses.map(x=>`
    <tr><td>${x.desc}</td><td>${fmtDate(x.datum)}</td>
    <td class="entry-betrag">${fmt(x.betrag)}</td>
    <td><button class="entry-del" onclick="removeExpense('${x.id}')"><i data-lucide="x"></i></button></td></tr>`).join('');
  lucide.createIcons();
}

// ── DATEI-UPLOAD ──────────────────────────────────────────
let uploadQueue = []; // { file, type, status, results }

function getFileType(file){
  const name = file.name.toLowerCase();
  const mime = file.type;
  if(name.endsWith('.csv')) return 'csv';
  if(mime.startsWith('image/') || name.match(/\.(jpg|jpeg|png|heic|heif|webp)$/)) return 'img';
  if(mime === 'application/pdf' || name.endsWith('.pdf')) return 'pdf';
  return 'unknown';
}

function formatBytes(b){
  if(b<1024)return b+'B';
  if(b<1024*1024)return (b/1024).toFixed(0)+'KB';
  return (b/1024/1024).toFixed(1)+'MB';
}

function onDragOver(e){e.preventDefault();$('upload-zone').classList.add('drag');}
function onDragLeave(e){$('upload-zone').classList.remove('drag');}
function onDrop(e){
  e.preventDefault();$('upload-zone').classList.remove('drag');
  onFileSelect(e.dataTransfer.files);
}

function onFileSelect(files){
  if(!files||!files.length)return;
  Array.from(files).forEach(f=>{
    const type=getFileType(f);
    if(type==='unknown'){toast(`${f.name}: Format nicht unterstützt`);return;}
    // Prüfen ob schon in Queue
    if(uploadQueue.find(q=>q.file.name===f.name&&q.file.size===f.size))return;
    uploadQueue.push({file:f,type,status:'pending',results:[]});
  });
  renderFileQueue();
}

function renderFileQueue(){
  const wrap=$('file-queue');
  if(!uploadQueue.length){wrap.style.display='none';$('btn-upload-analyze').style.display='none';return;}
  wrap.style.display='flex';
  const pendingCount=uploadQueue.filter(q=>q.status==='pending').length;
  $('btn-upload-analyze').style.display=pendingCount?'inline-flex':'none';
  wrap.innerHTML=uploadQueue.map((q,i)=>{
    const typeCls=q.type;
    const typeLabel=q.type.toUpperCase();
    const statusHtml=q.status==='pending'?'<span class="file-item-status">Bereit</span>':
      q.status==='loading'?'<span class="file-item-status loading">⟳ Analyse …</span>':
      q.status==='done'?`<span class="file-item-status ok">✓ ${q.results.length} Einträge</span>`:
      `<span class="file-item-status err">✗ Fehler</span>`;
    return`<div class="file-item" id="fitem-${i}">
      <div class="file-item-icon ${typeCls}">${typeLabel}</div>
      <span class="file-item-name" title="${q.file.name}">${q.file.name}</span>
      <span class="file-item-size">${formatBytes(q.file.size)}</span>
      ${statusHtml}
      <button class="file-item-del" onclick="removeFromQueue(${i})" title="Entfernen"><i data-lucide="x"></i></button>
    </div>`;
  }).join('');
  lucide.createIcons();
}

function removeFromQueue(i){
  uploadQueue.splice(i,1);
  renderFileQueue();
}

// CSV parsen: erste Zeile = Header, dann Daten
function parseCSV(text){
  const lines=text.trim().split('\n').filter(l=>l.trim());
  if(lines.length<2)return[];
  // Trennzeichen erkennen: ; oder ,
  const sep=lines[0].includes(';')?';':',';
  const headers=lines[0].split(sep).map(h=>h.trim().replace(/^["']|["']$/g,'').toLowerCase());

  // Spalten-Mapping: flexible Header-Erkennung
  const findCol=(names)=>{for(const n of names){const i=headers.indexOf(n);if(i>-1)return i;}return -1;};
  const dateCol=findCol(['datum','date','buchungstag','buchungsdatum','valuta','wertstellungsdatum','buchungsdat.']);
  // Empfänger/Name-Spalte (wer hat das Geld bekommen / von wem kam es)
  const nameCol=findCol(['empfänger/zahlungspflichtiger','empfaenger/zahlungspflichtiger','empfänger','empfaenger','auftraggeber','beguenstigter','name','kontoinhaber']);
  // Verwendungszweck-Spalte (Buchungstext / Beschreibung)
  const zweckCol=findCol(['verwendungszweck','beschreibung','description','buchungstext','transaktionsbeschreibung','text','betreff','zahlungsreferenz']);
  const amtCol=findCol(['betrag','amount','umsatz','betrag eur','betrag (eur)','amount eur']);

  const results=[];
  for(let i=1;i<lines.length;i++){
    const parts=splitCSVLine(lines[i],sep);
    const datum=dateCol>-1?(parts[dateCol]||'').trim().replace(/^["']|["']$/g,''):'';
    const nameRaw=nameCol>-1?(parts[nameCol]||'').trim().replace(/^["']|["']$/g,''):'';
    const zweckRaw=zweckCol>-1?(parts[zweckCol]||'').trim().replace(/^["']|["']$/g,''):'';
    // Beschreibung: "Empfänger – Verwendungszweck" wenn beides vorhanden, sonst was da ist
    const desc=nameRaw&&zweckRaw ? `${nameRaw} – ${zweckRaw.slice(0,60)}` : (nameRaw||zweckRaw);
    const amtRaw=amtCol>-1?(parts[amtCol]||'').trim().replace(/^["']|["']$/g,''):'';
    if(!desc&&!amtRaw)continue;
    // Betrag parsen – DE-Format "1.234,56" oder EN "1234.56", auch negative "-54,99"
    const amtNum=parseCSVAmount(amtRaw);
    if(amtNum===null)continue;
    // Vorzeichen behalten: positiv = Einnahme (Gutschrift), negativ = Ausgabe (Lastschrift)
    results.push({id:'csv'+i, beschreibung:desc, empfaenger:nameRaw, verwendungszweck:zweckRaw, betrag:Math.abs(amtNum), isEinnahme: amtNum > 0, datum:formatCSVDate(datum), quelle:'csv'});
  }
  return results;
}

function splitCSVLine(line,sep){
  const result=[];let cur='';let inQuote=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"'){inQuote=!inQuote;}
    else if(c===sep&&!inQuote){result.push(cur);cur='';}
    else{cur+=c;}
  }
  result.push(cur);
  return result;
}

function parseCSVAmount(s){
  if(!s)return null;
  s=s.replace(/\s/g,'').replace(/€/g,'').replace(/EUR/gi,'');
  // DE-Format: "1.234,56" → "1234.56"
  if(/^\-?\d{1,3}(\.\d{3})*(,\d+)?$/.test(s)){return parseFloat(s.replace(/\./g,'').replace(',','.'));}
  // EN-Format: "-1,234.56" oder plain "54.99"
  const cleaned=s.replace(/,(?=\d{3})/g,'');
  const n=parseFloat(cleaned.replace(',','.'));
  return isNaN(n)?null:n;
}

function formatCSVDate(s){
  if(!s)return'';
  // DD.MM.YYYY → YYYY-MM-DD
  const m1=s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
  if(m1)return`${m1[3]}-${m1[2].padStart(2,'0')}-${m1[1].padStart(2,'0')}`;
  // DD.MM.YY
  const m2=s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2})$/);
  if(m2)return`20${m2[3]}-${m2[2].padStart(2,'0')}-${m2[1].padStart(2,'0')}`;
  // Already ISO
  if(/^\d{4}-\d{2}-\d{2}$/.test(s))return s;
  return s;
}

// Datei als base64 lesen
function readFileAsBase64(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=e=>{
      // e.target.result ist "data:image/jpeg;base64,XXXX" → wir wollen nur den base64-Teil
      const b64=e.target.result.split(',')[1];
      resolve(b64);
    };
    reader.onerror=reject;
    reader.readAsDataURL(file);
  });
}

// Alle pending Dateien analysieren
async function analyzeUploadedFiles(){
  const pending=uploadQueue.filter(q=>q.status==='pending');
  if(!pending.length){toast('Keine neuen Dateien.');return;}

  $('upload-loading').classList.add('show');
  $('btn-upload-analyze').style.display='none';

  for(let i=0;i<uploadQueue.length;i++){
    const q=uploadQueue[i];
    if(q.status!=='pending')continue;
    q.status='loading';
    $('upload-loading-text').textContent=`Analysiere ${q.file.name} …`;
    renderFileQueue();

    try{
      if(q.type==='csv'){
        // CSV: KEIN KI-Call – direkt parsen und nach Vorzeichen aufteilen
        const text=await q.file.text();
        const csvEntries=parseCSV(text);
        if(!csvEntries.length){q.status='err';q.error='Keine Einträge erkannt';continue;}
        $('upload-loading-text').textContent=`${csvEntries.length} Einträge aus ${q.file.name} gelesen …`;

        let addedIn=0, addedOut=0;
        csvEntries.forEach(e=>{
          if(e.isEinnahme){
            manualIncomes.push({
              id:'csv'+Date.now()+Math.random(),
              desc: e.beschreibung || e.empfaenger || q.file.name,
              datum: e.datum||'',
              brutto: e.betrag,
              _csv: e
            });
            addedIn++;
          } else {
            expenses.push({
              id:'csv'+Date.now()+Math.random(),
              desc: e.beschreibung || e.empfaenger || q.file.name,
              datum: e.datum||'',
              betrag: e.betrag,
              _csv: e
            });
            addedOut++;
          }
        });

        q.results=csvEntries.map(e=>({id:e.id, beschreibung:e.beschreibung, betrag_brutto:e.betrag, datum:e.datum}));
        q.status='done';

        const parts=[];
        if(addedOut)parts.push(`${addedOut} Ausgaben`);
        if(addedIn)parts.push(`${addedIn} Einnahmen`);
        toast(`${q.file.name}: ${parts.join(', ')} importiert ✓`);

        // Transaktionen dauerhaft in Supabase speichern
        try{
          const toSave=csvEntries.map(e=>({...e, quellDatei:q.file.name}));
          await DB.saveTransactions(toSave);
        }catch(dbErr){
          console.warn('Transaktionen konnten nicht gespeichert werden:',dbErr.message);
          toast('Hinweis: Transaktionen nicht in DB gespeichert – Tabelle noch nicht angelegt?');
        }

      }else{
        // Bild oder PDF: Vision API (KI liest Beleg aus)
        const b64=await readFileAsBase64(q.file);
        const res=await fetch('/api/tax',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({mode:'vision',imageData:b64,imageType:q.file.type,filename:q.file.name})});
        if(!res.ok){const e=await res.json();throw new Error(e.error||'Vision-Fehler');}
        const data=await res.json();
        q.results=data.results||[];
        q.status='done';

        // PDF/Bild-Ergebnisse: KI entscheidet Einnahme vs Ausgabe
        let addedIn=0, addedOut=0;
        q.results.forEach(r=>{
          const isIncome=r.kategorie_info?.type==='income';
          if(isIncome){
            manualIncomes.push({id:'up'+Date.now()+Math.random(),
              desc:r.beschreibung||q.file.name, datum:r.datum||'', brutto:r.betrag_brutto||0, _aiResult:r});
            addedIn++;
          } else {
            expenses.push({id:'up'+Date.now()+Math.random(),
              desc:r.beschreibung||q.file.name, datum:r.datum||'', betrag:r.betrag_brutto||0, _aiResult:r});
            addedOut++;
          }
        });
        const parts=[];
        if(addedOut)parts.push(`${addedOut} Ausgaben`);
        if(addedIn)parts.push(`${addedIn} Einnahmen`);
        if(parts.length)toast(`${q.file.name}: ${parts.join(', ')} erkannt ✓`);
        else toast(`${q.file.name}: Keine Einträge erkannt – bitte prüfen`);
      }


    }catch(e){
      q.status='err';q.error=e.message;
      toast(`Fehler bei ${q.file.name}: ${e.message}`);
    }
    renderFileQueue();
    renderExpenses();
    renderManualIncomes();
    updateSidebar();
  }

  $('upload-loading').classList.remove('show');
  renderFileQueue();
}

// ── FREITEXT ANALYSE ──────────────────────────────────────
async function analyzeFreitext(){
  const text=$('freitext-input').value.trim();
  if(!text){toast('Bitte erst Text einfügen.');return;}
  $('freitext-loading').classList.add('show');
  try{
    const res=await fetch('/api/tax',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({entries:[{id:'ft1',text}],mode:'freitext'})});
    if(!res.ok){const e=await res.json();throw new Error(e.error||'API-Fehler');}
    const data=await res.json();
    // Aus Freitext-Modus: KI gibt Ausgaben zurück – in expenses einfügen
    if(data.results?.length){
      data.results.forEach(r=>{
        if(r.kategorie_info?.type!=='income'){
          expenses.push({id:'ft'+Date.now()+Math.random(),desc:r.beschreibung||r.begruendung||'Import',datum:r.datum||'',betrag:r.betrag_brutto||0});
        }
      });
      renderExpenses();
      $('freitext-input').value='';
      toast(`${data.results.length} Einträge extrahiert ✓`);
    }else{toast('Keine Transaktionen gefunden.');}
  }catch(e){toast('Fehler: '+e.message);}
  $('freitext-loading').classList.remove('show');
}

// ── KI ANALYSE ────────────────────────────────────────────
async function startAIAnalysis(){
  const allEntries=buildAllEntries();
  if(!allEntries.length){toast('Keine Einträge für die Analyse vorhanden.');return;}
  goPage(3);
  $('ai-loading').classList.add('show');
  $('ai-results-wrap').style.display='none';
  $('btn-to-ustva').style.display='none';

  // CSV-Einträge brauchen KEINE KI – die werden regelbasiert vorkategorisiert
  // KI nur für: Rechnungen (Bestätigung), manuelle Einträge, PDF/Bild-Ergebnisse
  const needsAI   = allEntries.filter(e=>!e._skipAI);
  const skipAI    = allEntries.filter(e=> e._skipAI);

  aiResults=[];

  // Vorkategorisierte Einträge (CSV) direkt übernehmen
  skipAI.forEach(e=>{
    aiResults.push({
      id:e.id,
      beschreibung:e.beschreibung,
      kategorie: e.vorKategorie||'sonstiges',
      kategorie_info: window._categories?.[e.vorKategorie||'sonstiges']||{label:'Sonstiges',type:'expense',vat:0.19},
      betrag_brutto: e.betrag,
      betrag_netto:  e.mwst?Math.round(e.betrag/1.19*100)/100:e.betrag,
      mwst_satz: e.mwst||0,
      mwst_betrag: e.mwst?Math.round((e.betrag-e.betrag/1.19)*100)/100:0,
      datum:e.datum||'',
      begruendung:'Aus CSV – automatisch',
      konfidenz:'mittel',
      unklar:false,
      _fromCSV:true
    });
  });

  if(needsAI.length){
    $('ai-progress-text').textContent=needsAI.length;
    const batchSize=8;
    for(let i=0;i<needsAI.length;i+=batchSize){
      const batch=needsAI.slice(i,i+batchSize).map(e=>({
        id:e.id, beschreibung:(e.beschreibung||'').slice(0,80), betrag:e.betrag,
        datum:e.datum||'', quelle:e.quelle||''
      }));
      const pct=Math.round((i/needsAI.length)*100);
      $('ai-progress-bar').style.width=pct+'%';
      try{
        const res=await fetch('/api/tax',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({entries:batch,mode:'categorize'})});
        if(!res.ok){const e=await res.json();throw new Error(e.error||'API-Fehler');}
        const data=await res.json();
        if(data.categories) window._categories=data.categories;
        aiResults.push(...(data.results||[]));
      }catch(e){
        toast('KI-Fehler: '+e.message);
        $('ai-loading').classList.remove('show');return;
      }
    }
  } else {
    $('ai-progress-text').textContent='0 (alle aus CSV)';
  }

  $('ai-progress-bar').style.width='100%';
  $('ai-loading').classList.remove('show');
  renderAIResults();
}

function buildAllEntries(){
  const entries=[];
  // 1) Rechnungen aus dem Tool → KI bestätigt/kategorisiert
  incomeItems.filter(x=>x.checked).forEach(x=>entries.push({
    id:x.id,
    beschreibung:`Rechnung ${x.nr||''} – ${x.firma||''}: ${x.betreff||''}`,
    betrag:x.brutto, datum:x.datum, quelle:'rechnung',
    _skipAI:false  // KI soll MwSt-Satz bestätigen
  }));
  // 2) Einnahmen aus CSV → kein KI-Call nötig (Vorzeichen ist eindeutig)
  manualIncomes.forEach(x=>{
    const fromCSV=!!x._csv;
    entries.push({
      id:x.id, beschreibung:x.desc, betrag:x.brutto, datum:x.datum,
      quelle: fromCSV?'csv_einnahme':'manuell_einnahme',
      vorKategorie:'einnahmen_19', mwst:0.19,
      _skipAI: fromCSV  // CSV-Einnahmen regelbasiert, manuelle zur KI
    });
  });
  // 3) Ausgaben: CSV regelbasiert, manuelle/PDF zur KI
  expenses.forEach(x=>{
    const fromCSV=!!x._csv;
    entries.push({
      id:x.id, beschreibung:x.desc, betrag:x.betrag, datum:x.datum,
      quelle: fromCSV?'csv_ausgabe':'ausgabe',
      vorKategorie:'sonstiges', mwst:0.19,
      _skipAI: fromCSV
    });
  });
  return entries;
}

function renderAIResults(){
  $('ai-results-wrap').style.display='block';
  $('btn-to-ustva').style.display='inline-flex';
  const reviewItems=aiResults.filter(r=>r.unklar);
  if(reviewItems.length){
    $('ai-review-hint').style.display='flex';
    $('ai-review-count').textContent=reviewItems.length;
  }else{
    $('ai-review-hint').style.display='none';
  }

  // Kategorien-Optionen
  const catOptions=Object.entries(window._categories||{}).map(([k,v])=>
    `<option value="${k}">${v.label}</option>`).join('');

  $('ai-results-list').innerHTML=aiResults.map((r,i)=>{
    const isIncome=r.kategorie_info?.type==='income';
    const konfCls=r.unklar?'unklar':(r.konfidenz||'hoch');
    return`<div class="ai-result-row" id="air-${i}">
      <div>
        <div class="ai-desc">${r.beschreibung||r.id||'–'}</div>
        <div class="ai-sub" id="air-reason-${i}" style="display:${showReasons?'block':'none'};">${r.begruendung||''}</div>
        ${r.unklar?`<span class="review-flag"><i data-lucide="alert-triangle"></i> Prüfen</span>`:''}
      </div>
      <div>
        <div class="ai-amt ${isIncome?'income':'expense'}">${fmt(r.betrag_brutto||0)}</div>
        <div class="ai-netto">Netto: ${fmt(r.betrag_netto||0)}</div>
      </div>
      <div>
        <span class="konfidenz ${konfCls}">${r.unklar?'Prüfen':r.konfidenz||'–'}</span>
      </div>
      <div>
        <select class="ai-kat-select" onchange="updateAIKat(${i},this.value)">
          ${Object.entries(window._categories||{}).map(([k,v])=>`<option value="${k}"${k===r.kategorie?' selected':''}>${v.label}</option>`).join('')}
        </select>
      </div>
      <div class="ai-netto">${r.mwst_betrag?'MwSt: '+fmt(r.mwst_betrag):''}</div>
      <div></div>
    </div>`;
  }).join('');
  lucide.createIcons();
}

function updateAIKat(idx,kat){
  if(!aiResults[idx])return;
  aiResults[idx].kategorie=kat;
  // Netto/MwSt neu berechnen
  const cats=window._categories||{};
  const info=cats[kat]||cats.sonstiges;
  const brutto=aiResults[idx].betrag_brutto||0;
  const vat=info.vat||0;
  aiResults[idx].betrag_netto=vat>0?brutto/(1+vat):brutto;
  aiResults[idx].mwst_betrag=brutto-aiResults[idx].betrag_netto;
  aiResults[idx].kategorie_info=info;
  aiResults[idx].unklar=false;
  renderAIResults();
  updateSidebar();
}

function expandAllReasons(){
  showReasons=!showReasons;
  document.querySelectorAll('[id^="air-reason-"]').forEach(el=>el.style.display=showReasons?'block':'none');
}

// ── USTVA BERECHNEN ───────────────────────────────────────
function buildUStVA(){
  goPage(4);
  const cats=window._categories||{};
  const periodLabel=selectedQuartal===0?`${selectedYear}`:
    `Q${selectedQuartal} ${selectedYear} (${['','Jan–Mär','Apr–Jun','Jul–Sep','Okt–Dez'][selectedQuartal]})`;
  $('ustva-period-label').textContent=`Zeitraum: ${periodLabel}`;

  // Einnahmen gruppieren
  let ein19=0,ein7=0,ein0=0;
  let aus19=0,aus7=0,aus0=0,ausMwst19=0,ausMwst7=0;
  let bewirtung=0;

  aiResults.forEach(r=>{
    const info=r.kategorie_info||cats[r.kategorie]||cats.sonstiges;
    const netto=r.betrag_netto||0;
    const mwst=r.mwst_betrag||0;
    if(info.type==='income'){
      if(info.vat===0.19)ein19+=netto;
      else if(info.vat===0.07)ein7+=netto;
      else ein0+=netto;
    }else if(info.type==='expense'){
      const absetzbar=info.limitFactor?netto*info.limitFactor:netto;
      if(r.kategorie==='bewirtung')bewirtung+=netto;
      if(info.vat===0.19){aus19+=absetzbar;ausMwst19+=mwst*(info.limitFactor||1);}
      else if(info.vat===0.07){aus7+=absetzbar;ausMwst7+=mwst;}
      else aus0+=absetzbar;
    }
    // privat → ignorieren
  });

  const ustAuf=(ein19*0.19)+(ein7*0.07);
  const vorsteuer=ausMwst19+ausMwst7;
  const zahllast=ustAuf-vorsteuer;
  const totalEin=ein19+ein7+ein0+manualIncomes.reduce((s,x)=>s+x.brutto/(1.19),0);
  const totalAus=aus19+aus7+aus0;
  const gewinn=totalEin-totalAus;

  // KPI-Grid
  $('ustv-kpi-grid').innerHTML=`
    <div class="ustv-card">
      <div class="ustv-label">Umsatzsteuer auf Einnahmen</div>
      <div class="ustv-zeile">UStVA Zeile 81 (19%) + Zeile 86 (7%)</div>
      <div class="ustv-val accent">${fmt(ustAuf)}</div>
      <div class="ustv-sub">${fmt(ein19)} Netto @ 19% · ${fmt(ein7)} @ 7%</div>
    </div>
    <div class="ustv-card">
      <div class="ustv-label">Abziehbare Vorsteuer</div>
      <div class="ustv-zeile">UStVA Zeile 66</div>
      <div class="ustv-val blue">${fmt(vorsteuer)}</div>
      <div class="ustv-sub">${fmt(ausMwst19)} (19%) · ${fmt(ausMwst7)} (7%)</div>
    </div>
    <div class="ustv-card ${zahllast>0?'danger':''}">
      <div class="ustv-label">USt-Zahllast / Erstattung</div>
      <div class="ustv-zeile">Zeile 83 – fällig ans Finanzamt</div>
      <div class="ustv-val ${zahllast>0?'red':'green'}">${fmt(Math.abs(zahllast))}</div>
      <div class="ustv-sub">${zahllast>0?'→ Zahlbetrag ans Finanzamt':'→ Erstattung vom Finanzamt'}</div>
    </div>
    <div class="ustv-card highlight">
      <div class="ustv-label">Gewinn (EÜR)</div>
      <div class="ustv-zeile">Einnahmen – Betriebsausgaben Netto</div>
      <div class="ustv-val ${gewinn>=0?'green':'red'}">${fmt(gewinn)}</div>
      <div class="ustv-sub">${fmt(totalEin)} Einnahmen – ${fmt(totalAus)} Ausgaben</div>
    </div>`;

  // Detailtabelle
  const dtbody=$('detail-table').querySelector('tbody');
  dtbody.innerHTML=`
    <tr class="group-hd"><td colspan="3">EINNAHMEN</td></tr>
    <tr><td>19% Umsätze (Zeile 81)</td><td class="r">${fmt(ein19)}</td><td class="r">${fmt(ein19*0.19)}</td></tr>
    ${ein7?`<tr><td>7% Umsätze (Zeile 86)</td><td class="r">${fmt(ein7)}</td><td class="r">${fmt(ein7*0.07)}</td></tr>`:''}
    ${ein0?`<tr><td>Steuerfreie / Ausland-Umsätze</td><td class="r">${fmt(ein0)}</td><td class="r">–</td></tr>`:''}
    <tr class="total"><td>Gesamt Einnahmen</td><td class="r">${fmt(totalEin)}</td><td class="r">${fmt(ustAuf)}</td></tr>
    <tr class="group-hd"><td colspan="3">VORSTEUER (AUSGABEN)</td></tr>
    <tr><td>19% Vorsteuer (Zeile 66)</td><td class="r">${fmt(aus19)}</td><td class="r">${fmt(ausMwst19)}</td></tr>
    ${aus7?`<tr><td>7% Vorsteuer</td><td class="r">${fmt(aus7)}</td><td class="r">${fmt(ausMwst7)}</td></tr>`:''}
    ${aus0?`<tr><td>Ausgaben ohne Vorsteuer</td><td class="r">${fmt(aus0)}</td><td class="r">–</td></tr>`:''}
    ${bewirtung?`<tr><td style="color:var(--orange);">davon Bewirtung (70% absetzbar)</td><td class="r">${fmt(bewirtung)}</td><td class="r">–</td></tr>`:''}
    <tr class="total"><td>Gesamt Vorsteuer</td><td class="r">${fmt(totalAus)}</td><td class="r">${fmt(vorsteuer)}</td></tr>
    <tr class="group-hd"><td colspan="3">ERGEBNIS</td></tr>
    <tr class="total"><td>${zahllast>0?'Zahllast':'Erstattung'} (Zeile 83)</td><td class="r" colspan="2" style="color:${zahllast>0?'var(--red)':'var(--green)'}">${fmt(Math.abs(zahllast))}</td></tr>
  `;
  $('detail-table').querySelector('thead')?.remove();
  const dtHead=document.createElement('thead');
  dtHead.innerHTML='<tr><th>Position</th><th class="r">Netto</th><th class="r">MwSt</th></tr>';
  $('detail-table').prepend(dtHead);

  // EÜR
  const euerbody=$('euer-table').querySelector('tbody');
  euerbody.innerHTML=`
    <tr><td>Betriebseinnahmen Netto</td><td class="r">${fmt(totalEin)}</td></tr>
    <tr><td>Betriebsausgaben Netto</td><td class="r">− ${fmt(totalAus)}</td></tr>
    <tr class="total"><td>Gewinn / Verlust</td><td class="r" style="color:${gewinn>=0?'var(--green)':'var(--red)'}">${fmt(gewinn)}</td></tr>
  `;

  // Sidebar updaten
  updateSidebar(totalEin,totalAus,gewinn,zahllast);
}

// ── SIDEBAR STATS ─────────────────────────────────────────
function updateSidebar(ein,aus,gew,zahl){
  if(ein!==undefined){
    $('sb-einnahmen').textContent=fmt(ein);
    $('sb-ausgaben').textContent=fmt(aus||0);
    $('sb-gewinn').textContent=fmt(gew||0);
    $('sb-zahllast').textContent=fmt(zahl||0);
    return;
  }
  // Live-Schätzung aus aktuellen Daten
  const selIncome=incomeItems.filter(x=>x.checked).reduce((s,x)=>s+(x.netto||0),0)
    +manualIncomes.reduce((s,x)=>s+x.brutto/(1.19),0);
  const selExp=expenses.reduce((s,x)=>s+x.betrag/(1.19),0);
  $('sb-einnahmen').textContent=fmt(selIncome);
  $('sb-ausgaben').textContent=fmt(selExp);
  $('sb-gewinn').textContent=fmt(selIncome-selExp);
  $('sb-zahllast').textContent='–';
}

// ── EXPORT ────────────────────────────────────────────────
function exportSummary(){
  const period=$('ustva-period-label').textContent;
  const lines=[
    `VISO Media – Steuerauswertung`,
    period,``,
    `Einnahmen (Netto): ${$('sb-einnahmen').textContent}`,
    `Ausgaben (Netto): ${$('sb-ausgaben').textContent}`,
    `Gewinn: ${$('sb-gewinn').textContent}`,
    `USt-Zahllast: ${$('sb-zahllast').textContent}`,
    ``,`Erstellt: ${new Date().toLocaleDateString('de-DE')}`,
    `Hinweis: Unverbindliche Arbeitshilfe – bitte durch Steuerberater prüfen.`
  ];
  navigator.clipboard.writeText(lines.join('\n')).then(()=>toast('In Zwischenablage kopiert ✓'));
}

// ── ELSTER XML EXPORT ─────────────────────────────────────
function exportElsterXML(){
  // Werte aus der letzten buildUStVA()-Berechnung neu ermitteln
  const cats=window._categories||{};
  let ein19=0,ein7=0,ein0=0,aus19=0,aus7=0,ausMwst19=0,ausMwst7=0;
  aiResults.forEach(r=>{
    const info=r.kategorie_info||cats[r.kategorie]||cats.sonstiges;
    const netto=r.betrag_netto||0;
    const mwst=r.mwst_betrag||0;
    if(info.type==='income'){
      if(info.vat===0.19)ein19+=netto;
      else if(info.vat===0.07)ein7+=netto;
      else ein0+=netto;
    }else if(info.type==='expense'){
      const lf=info.limitFactor||1;
      if(info.vat===0.19){aus19+=netto*lf;ausMwst19+=mwst*lf;}
      else if(info.vat===0.07){aus7+=netto;ausMwst7+=mwst;}
    }
  });
  const ustAuf=(ein19*0.19)+(ein7*0.07);
  const vorsteuer=ausMwst19+ausMwst7;
  const zahllast=ustAuf-vorsteuer;

  // Zeitraum bestimmen
  const year=selectedYear;
  const q=selectedQuartal;
  // ELSTER Anmeldezeitraum: 41=Q1, 42=Q2, 43=Q3, 44=Q4, 45=Jahreserklärung
  const zeitraumMap={0:'45',1:'41',2:'42',3:'43',4:'44'};
  const zeitraum=zeitraumMap[q]||'42';

  const steuernr=($('elster-steuernr')?.value||'').replace(/[\s/]/g,'');
  const bundesland=$('elster-bundesland')?.value||'26';

  // Beträge auf Cent runden (ELSTER erwartet Eurocent als Integer oder Euro mit 2 Nachkomma)
  const r2=n=>Math.round(n*100)/100;
  const fmtE=n=>r2(n).toFixed(2);  // z.B. "1234.56"

  // Standard UStVA XML (Elster-Datenschnittstelle, vereinfachtes Format)
  const now=new Date();
  const erstellDatum=now.toISOString().slice(0,10);
  const erstellZeit=now.toTimeString().slice(0,8);

  const xml=`<?xml version="1.0" encoding="UTF-8"?>
<!-- ELSTER UStVA – erstellt von VISO Media Steuertool ${erstellDatum} -->
<!-- Zeitraum: ${q===0?year+' (Jahreserklärung)':`Q${q} ${year}`} -->
<!-- HINWEIS: Bitte vor der Einreichung durch einen Steuerberater prüfen! -->
<Elster xmlns="http://www.elster.de/elsterxml/schema/v12">
  <TransferHeader>
    <Verfahren>ElsterAnmeldung</Verfahren>
    <DatenArt>UStVA</DatenArt>
    <Vorgang>send-Auth</Vorgang>
    <ErstellungsDatum>${erstellDatum.replace(/-/g,'')}</ErstellungsDatum>
    <ErstellungsZeit>${erstellZeit.replace(/:/g,'')}</ErstellungsZeit>
    <Datei>
      <Verschluesselung>PKCS#7v1.5</Verschluesselung>
      <Kompression>GZIP</Kompression>
      <TransportSchluessel></TransportSchluessel>
    </Datei>
    <VersionClient>VISO-Media-Steuertool-1.0</VersionClient>
  </TransferHeader>
  <DatenTeil>
    <Nutzdatenblock>
      <NutzdatenHeader>
        <NutzdatenTicket>1</NutzdatenTicket>
        <Empfaenger id="F">
          <Bundesfinanzamtsnummer>${bundesland}</Bundesfinanzamtsnummer>
        </Empfaenger>
      </NutzdatenHeader>
      <Nutzdaten>
        <Anmeldungssteuern art="UStVA" version="202301">
          <DatenLieferant>VISO Media – David Stiehler</DatenLieferant>
          <Erstellungsdatum>${erstellDatum.replace(/-/g,'')}</Erstellungsdatum>
          <Steuerfall>
            <Steuernummer>${steuernr||'BITTE_EINTRAGEN'}</Steuernummer>
          </Steuerfall>
          <UStVA>
            <Jahr>${year}</Jahr>
            <Zeitraum>${zeitraum}</Zeitraum>
            <!-- ── EINNAHMEN / STEUER AUF UMSÄTZE ── -->
            <!-- Kz 81: Umsätze 19% -->
            <Kz81>${fmtE(ein19)}</Kz81>
            <!-- Kz 86: Umsätze 7% -->
            <Kz86>${fmtE(ein7)}</Kz86>
            <!-- Kz 35: Steuerfreie Umsätze §4 -->
            <Kz35>${fmtE(ein0)}</Kz35>
            <!-- Kz 36: Umsatzsteuer auf Kz81+86 -->
            <Kz36>${fmtE(ustAuf)}</Kz36>
            <!-- ── VORSTEUER ── -->
            <!-- Kz 66: Abziehbare Vorsteuerbeträge -->
            <Kz66>${fmtE(vorsteuer)}</Kz66>
            <!-- ── ERGEBNIS ── -->
            <!-- Kz 83: Verbleibende Umsatzsteuer-Vorauszahlung / Überschuss -->
            <Kz83>${fmtE(zahllast)}</Kz83>
          </UStVA>
        </Anmeldungssteuern>
      </Nutzdaten>
    </Nutzdatenblock>
  </DatenTeil>
</Elster>`;

  if(!steuernr){toast('Tipp: Steuernummer eintragen für vollständiges XML');}

  // Download
  const blob=new Blob([xml],{type:'application/xml'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const fname=`UStVA_${q===0?year:`Q${q}_${year}`}_ELSTER.xml`;
  a.href=url;a.download=fname;a.click();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
  toast(`${fname} heruntergeladen ✓`);
}

// ── INIT ──────────────────────────────────────────────────
async function init(){
  const user=await getUser();
  if(!user){window.location.href='/';return;}
  $('nav-user').textContent=user.email||'';

  // Kategorien vom Server laden (einmalig, dann cachen)
  // Wir nutzen einen kleinen Trick: api/tax mit leerem Aufruf gibt categories zurück
  // Stattdessen: Kategorien direkt hier definieren (identisch mit api/tax.js)
  window._categories={
    einnahmen_19:{label:'Einnahmen 19% MwSt.',type:'income',vat:0.19},
    einnahmen_7:{label:'Einnahmen 7% MwSt.',type:'income',vat:0.07},
    einnahmen_0:{label:'Einnahmen steuerfrei / Ausland',type:'income',vat:0},
    software:{label:'Software & Tools',type:'expense',vat:0.19},
    hardware:{label:'Hardware & Technik',type:'expense',vat:0.19},
    buero:{label:'Büro & Arbeitsmittel',type:'expense',vat:0.19},
    marketing:{label:'Marketing & Werbung',type:'expense',vat:0.19},
    reise:{label:'Reise & Fahrtkosten',type:'expense',vat:0.07},
    bewirtung:{label:'Bewirtung (70% absetzbar)',type:'expense',vat:0.19,limitFactor:0.7},
    telefon:{label:'Telefon & Internet',type:'expense',vat:0.19},
    weiterbildung:{label:'Weiterbildung & Kurse',type:'expense',vat:0.19},
    freelancer:{label:'Fremdleistungen / Freelancer',type:'expense',vat:0.19},
    versicherung:{label:'Versicherungen',type:'expense',vat:0},
    steuerberatung:{label:'Steuerberatung & Buchhaltung',type:'expense',vat:0.19},
    miete:{label:'Miete / Raumkosten',type:'expense',vat:0.19},
    sonstiges:{label:'Sonstiges',type:'expense',vat:0.19},
    privat:{label:'Privat (nicht absetzbar)',type:'private',vat:0},
  };

  // Jahr-Select befüllen
  const ySel=$('sel-year');
  const curYear=new Date().getFullYear();
  ySel.innerHTML='';
  [curYear,curYear-1,curYear-2].forEach(y=>{
    const o=document.createElement('option');o.value=y;o.textContent=y;
    if(y===curYear)o.selected=true;ySel.appendChild(o);
  });
  selectedYear=curYear;

  // Aktuelles Quartal vorselektieren
  const curQ=Math.ceil((new Date().getMonth()+1)/3);
  setQuartal(curQ);

  // Dokumente laden
  try{allDocs=await DB.getDocuments();}
  catch(e){console.error(e);toast('Fehler beim Laden der Rechnungen');}

  // Gespeicherte Transaktionen (CSV-Imports) laden und wiederherstellen
  try{
    const txs=await DB.getTransactions(curYear);
    txs.forEach(t=>{
      const entry={
        id:'tx'+t.id,
        desc: t.beschreibung||(t.empfaenger||'')+(t.verwendungszweck?' – '+t.verwendungszweck:''),
        datum: t.datum||'',
        _csv: t, // Referenz auf DB-Eintrag
        _fromDB: true
      };
      if(t.is_einnahme){
        entry.brutto=t.betrag||0;
        if(!manualIncomes.find(x=>x._csv?.id===t.id)) manualIncomes.push(entry);
      } else {
        entry.betrag=t.betrag||0;
        if(!expenses.find(x=>x._csv?.id===t.id)) expenses.push(entry);
      }
    });
    if(txs.length) toast(`${txs.length} Transaktionen geladen ✓`);
  }catch(e){
    // Tabelle noch nicht angelegt – kein Fehler zeigen, nur leise loggen
    console.info('Transaktionen nicht geladen (Tabelle fehlt?):', e.message);
  }

  refreshIncomeList();
  renderExpenses();
  renderManualIncomes();
  updateSidebar();
  $('loading-screen').style.display='none';
  lucide.createIcons();
}

// ── BELEGE ────────────────────────────────────────────────
let belegPending = []; // { file, name, size }
let allBelege = [];

function onBelegDragOver(e){
  e.preventDefault();
  $('beleg-zone').classList.add('drag');
}
function onBelegDragLeave(){
  $('beleg-zone').classList.remove('drag');
}
function onBelegDrop(e){
  e.preventDefault();
  $('beleg-zone').classList.remove('drag');
  onBelegSelect(e.dataTransfer.files);
}
function onBelegSelect(files){
  if(!files||!files.length)return;
  Array.from(files).forEach(f=>{
    if(!belegPending.find(p=>p.file.name===f.name&&p.file.size===f.size)){
      belegPending.push({file:f});
    }
  });
  renderPendingBelege();
  $('beleg-pending-list').style.display=belegPending.length?'block':'none';
  $('btn-beleg-upload').style.display=belegPending.length?'inline-flex':'none';
  $('btn-beleg-txt').textContent=`${belegPending.length} Datei${belegPending.length>1?'en':''} hochladen`;
}
function renderPendingBelege(){
  const wrap=$('beleg-pending-list');
  if(!belegPending.length){wrap.innerHTML='';return;}
  const fmtSize=b=>b<1024?b+' B':b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB';
  wrap.innerHTML=belegPending.map((p,i)=>`
    <div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--border);">
      <i data-lucide="file" style="width:13px;height:13px;color:var(--text3);flex-shrink:0;"></i>
      <span style="flex:1;font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.file.name}</span>
      <span style="font-size:10px;color:var(--text3);flex-shrink:0;">${fmtSize(p.file.size)}</span>
      <button onclick="belegPending.splice(${i},1);renderPendingBelege();if(!belegPending.length){$('beleg-pending-list').style.display='none';$('btn-beleg-upload').style.display='none';}" style="background:none;border:none;color:var(--text3);cursor:pointer;padding:2px;display:flex;align-items:center;"><i data-lucide="x" style="width:12px;height:12px;"></i></button>
    </div>`).join('');
  lucide.createIcons();
}
async function uploadPendingBelege(){
  if(!belegPending.length)return;
  const desc=$('beleg-desc').value.trim();
  const datum=$('beleg-datum').value||null;
  const betrag=parseAmt($('beleg-betrag').value)||null;
  const btn=$('btn-beleg-upload');
  btn.disabled=true;
  const origTxt=$('btn-beleg-txt').textContent;
  let ok=0,fail=0;
  for(let i=0;i<belegPending.length;i++){
    const p=belegPending[i];
    $('btn-beleg-txt').textContent=`Upload ${i+1}/${belegPending.length} …`;
    try{
      await DB.uploadReceipt(p.file,{beschreibung:desc||p.file.name,datum,betrag});
      ok++;
    }catch(e){fail++;toast(`Fehler: ${e.message}`);}
  }
  btn.disabled=false;
  belegPending=[];
  renderPendingBelege();
  $('beleg-pending-list').style.display='none';
  $('btn-beleg-upload').style.display='none';
  $('beleg-desc').value='';$('beleg-datum').value='';$('beleg-betrag').value='';
  if(ok)toast(`${ok} Beleg${ok>1?'e':''} hochgeladen ✓`);
  await loadBelege();
}
async function loadBelege(){
  $('beleg-list-wrap').innerHTML='<div style="padding:24px;text-align:center;color:var(--text3);font-size:12px;">Lade Belege …</div>';
  try{
    allBelege=await DB.getReceipts();
    renderBelege();
  }catch(e){
    $('beleg-list-wrap').innerHTML=`<div style="padding:24px;text-align:center;color:var(--red);font-size:12px;">Fehler: ${e.message}</div>`;
  }
}
function renderBelege(){
  const q=($('beleg-search')||{}).value?.toLowerCase().trim()||'';
  const list=q?allBelege.filter(b=>(b.beschreibung||'').toLowerCase().includes(q)||(b.filename||'').toLowerCase().includes(q)):allBelege;
  if(!list.length){
    $('beleg-list-wrap').innerHTML=`<div style="padding:24px;text-align:center;color:var(--text3);font-size:12px;">${q?'Keine Treffer.':'Noch keine Belege gespeichert.'}</div>`;
    return;
  }
  const fmtSize=b=>!b?'':b<1024?b+' B':b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB';
  const ext=n=>n?n.split('.').pop().toLowerCase():'';
  const extIcon=e=>{if(['jpg','jpeg','png','heic','heif','webp'].includes(e))return'image';if(e==='pdf')return'file-text';if(e==='csv')return'table';return'file';}
  $('beleg-list-wrap').innerHTML=list.map(b=>`
    <div class="beleg-row">
      <div class="beleg-icon"><i data-lucide="${extIcon(ext(b.filename))}" style="width:14px;height:14px;"></i></div>
      <div style="flex:1;min-width:0;">
        <div class="beleg-name">${b.beschreibung||b.filename}</div>
        <div class="beleg-sub">${b.filename}${b.kategorie?' · '+b.kategorie:''}${b.betrag?' · '+fmt(b.betrag):''}</div>
      </div>
      <div class="beleg-date">${b.datum?fmtDate(b.datum):''}</div>
      <div style="font-size:10px;color:var(--text3);min-width:48px;text-align:right;">${fmtSize(b.size_bytes)}</div>
      <div class="beleg-actions">
        ${b.signed_url?`<a href="${b.signed_url}" target="_blank" class="beleg-btn" title="Öffnen"><i data-lucide="external-link" style="width:12px;height:12px;"></i></a>`:''}
        ${b.signed_url?`<a href="${b.signed_url}" download="${b.filename}" class="beleg-btn" title="Download"><i data-lucide="download" style="width:12px;height:12px;"></i></a>`:''}
        <button class="beleg-btn" style="color:var(--red);" title="Löschen" onclick="deleteBelegConfirm('${b.id}','${b.storage_path}')"><i data-lucide="trash-2" style="width:12px;height:12px;"></i></button>
      </div>
    </div>`).join('');
  lucide.createIcons();
}
async function deleteBelegConfirm(id,path){
  if(!confirm('Beleg dauerhaft löschen?'))return;
  try{
    await DB.deleteReceipt(id,path);
    toast('Beleg gelöscht');
    await loadBelege();
  }catch(e){toast('Fehler: '+e.message);}
}

async function doSignOut(){await signOut();}

init();
</script>
</body>
</html>
