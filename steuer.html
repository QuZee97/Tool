<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Steuertool – VISO Media</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23d4cc2e'/><text x='16' y='23' text-anchor='middle' font-size='20' font-family='Helvetica Neue,Arial,sans-serif' font-weight='700' fill='%23111'>V</text></svg>">
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<style>
:root{
  --bg:#1e1f22;--surface:#27282c;--surface2:#2f3035;--surface3:#383a40;
  --border:#3d3f45;--border2:#4a4c54;
  --text:#e2e3e8;--text2:#9a9ca5;--text3:#5c5f6b;
  --accent:#d4cc2e;--accent-bg:rgba(212,204,46,0.08);
  --red:#e05555;--red-bg:rgba(224,85,85,0.1);
  --green:#4ade80;--green-bg:rgba(74,222,128,0.1);
  --blue:#60a5fa;--blue-bg:rgba(96,165,250,0.1);
  --orange:#fb923c;--orange-bg:rgba(251,146,60,0.1);
  --radius:8px;--radius-sm:5px;--font:'Helvetica Neue',Arial,sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--font);font-size:13px;color:var(--text);background:var(--bg);min-height:100vh;display:flex;flex-direction:column;}

/* NAV */
#nav{height:52px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:4px;position:sticky;top:0;z-index:50;flex-shrink:0;}
.nav-logo{font-size:14px;font-weight:700;color:var(--text);letter-spacing:-.2px;margin-right:8px;}
.nav-logo span{color:var(--text2);font-weight:300;}
.nav-sep{width:1px;height:20px;background:var(--border);margin:0 6px;}
.nav-btn{height:32px;padding:0 10px;border:none;background:none;color:var(--text3);cursor:pointer;border-radius:var(--radius-sm);display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:500;font-family:var(--font);transition:background .15s,color .15s;white-space:nowrap;text-decoration:none;}
.nav-btn:hover{background:var(--surface3);color:var(--text);}
.nav-btn.active{background:var(--accent-bg);color:var(--accent);}
.nav-btn svg{width:14px;height:14px;stroke-width:1.8;flex-shrink:0;}
.nav-spacer{flex:1;}
.nav-icon-btn{width:32px;height:32px;padding:0;border:none;background:none;color:var(--text3);cursor:pointer;border-radius:var(--radius-sm);display:inline-flex;align-items:center;justify-content:center;transition:background .15s,color .15s;}
.nav-icon-btn:hover{background:var(--surface3);color:var(--text);}
.nav-icon-btn svg{width:15px;height:15px;stroke-width:1.8;}

/* LAYOUT */
#app{display:flex;flex:1;overflow:hidden;height:calc(100vh - 52px);}
#sidebar{width:240px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;padding:20px 16px;position:sticky;top:52px;align-self:flex-start;height:100%;}
#main{flex:1;overflow-y:auto;padding:28px 32px;}
#main>*{max-width:760px;}
#main::-webkit-scrollbar{width:5px;}
#main::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

/* SIDEBAR */
.sb-section{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.7px;margin:18px 0 8px;display:flex;align-items:center;gap:6px;}
.sb-section::after{content:'';flex:1;height:1px;background:var(--border);}
.sb-section:first-child{margin-top:0;}
.step-btn{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:transparent;color:var(--text2);font-family:var(--font);font-size:12px;text-align:left;cursor:pointer;display:flex;align-items:center;gap:8px;transition:.12s;margin-bottom:4px;}
.step-btn:hover{background:var(--surface2);border-color:var(--border2);}
.step-btn.active{background:var(--accent-bg);border-color:var(--accent);color:var(--accent);}
.step-btn.done{border-color:var(--green);color:var(--green);background:var(--green-bg);}
.step-num{width:20px;height:20px;border-radius:50%;background:var(--surface2);font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.step-btn.active .step-num{background:var(--accent);color:#111;}
.step-btn.done .step-num{background:var(--green);color:#111;}
.step-badge{margin-left:auto;font-size:10px;font-weight:700;background:var(--orange-bg);color:var(--orange);border-radius:10px;padding:1px 6px;display:none;}
.step-badge.show{display:inline;}

.quartal-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:4px;}
.q-btn{padding:5px 8px;border:1px solid var(--border);border-radius:var(--radius-sm);background:transparent;color:var(--text3);font-family:var(--font);font-size:11px;cursor:pointer;text-align:center;transition:.12s;}
.q-btn:hover{border-color:var(--border2);color:var(--text2);}
.q-btn.active{background:var(--accent);color:#111;border-color:var(--accent);}
#sidebar select{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:12px;padding:6px 9px;outline:none;font-family:var(--font);cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%235c5f6b' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:26px;}
.sb-stat{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:6px;}
.sb-stat-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;}
.sb-stat-val{font-size:16px;font-weight:700;}
.sb-stat-val.green{color:var(--green);}
.sb-stat-val.red{color:var(--red);}
.sb-stat-val.accent{color:var(--accent);}
.sb-stat-val.blue{color:var(--blue);}

/* PAGES */
.page{display:none;}
.page.active{display:block;}
.page-title{font-size:18px;font-weight:700;margin-bottom:4px;}
.page-sub{font-size:12px;color:var(--text3);margin-bottom:20px;line-height:1.6;}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px;}
.card-title{font-size:13px;font-weight:600;margin-bottom:4px;}
.card-sub{font-size:11px;color:var(--text3);margin-bottom:14px;line-height:1.6;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border:none;border-radius:var(--radius-sm);font-size:12px;font-weight:500;cursor:pointer;font-family:var(--font);transition:.15s;white-space:nowrap;}
.btn svg{width:13px;height:13px;stroke-width:2;}
.btn:hover{opacity:.85;}
.btn-primary{background:var(--accent);color:#111;}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border2);}
.btn-ghost:hover{background:var(--surface2);opacity:1;}
.btn-red{background:var(--red-bg);color:var(--red);border:1px solid var(--red);}
.btn-green{background:var(--green-bg);color:var(--green);border:1px solid var(--green);}
.btn-sm{padding:5px 10px;font-size:11px;}
.btn-lg{padding:12px 20px;font-size:13px;}

/* HINWEIS */
.hinweis{display:flex;gap:10px;align-items:flex-start;background:var(--blue-bg);border:1px solid rgba(96,165,250,.2);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:16px;font-size:11px;color:var(--text2);line-height:1.6;}
.hinweis svg{width:14px;height:14px;color:var(--blue);flex-shrink:0;margin-top:1px;}
.hinweis.warn{background:var(--orange-bg);border-color:rgba(251,146,60,.2);}
.hinweis.warn svg{color:var(--orange);}
.hinweis.ok{background:var(--green-bg);border-color:rgba(74,222,128,.2);}
.hinweis.ok svg{color:var(--green);}

/* UPLOAD ZONE */
.upload-zone{border:2px dashed var(--border2);border-radius:var(--radius);padding:32px 20px;text-align:center;cursor:pointer;transition:.15s;position:relative;margin-bottom:12px;}
.upload-zone:hover,.upload-zone.drag{border-color:var(--accent);background:var(--accent-bg);}
.upload-zone svg.upload-icon{width:32px;height:32px;stroke-width:1.2;color:var(--text3);margin-bottom:10px;}
.upload-zone p{font-size:12px;color:var(--text3);line-height:1.7;}
.upload-zone strong{color:var(--text2);}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}

/* FILE LIST */
.file-list{display:flex;flex-direction:column;gap:4px;margin-bottom:12px;}
.file-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:11px;}
.file-item-icon{width:28px;height:28px;border-radius:5px;background:var(--surface3);color:var(--text3);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;flex-shrink:0;}
.file-item-name{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text2);}
.file-item-size{color:var(--text3);flex-shrink:0;}
.file-item-status{font-size:10px;color:var(--text3);flex-shrink:0;}
.file-item-status.ok{color:var(--green);}
.file-item-status.err{color:var(--red);}
.file-item-status.loading{color:var(--accent);}
.file-item-del{width:22px;height:22px;border:none;background:none;color:var(--text3);cursor:pointer;border-radius:3px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.file-item-del:hover{background:var(--red-bg);color:var(--red);}
.file-item-del svg{width:12px;height:12px;}

/* TRANSACTION LIST */
.tx-list{display:flex;flex-direction:column;}
.tx-row{display:grid;grid-template-columns:80px 1fr auto auto;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid var(--border);font-size:11px;}
.tx-row:last-child{border-bottom:none;}
.tx-row:hover{background:var(--surface2);}
.tx-date{color:var(--text3);font-size:10px;}
.tx-desc{color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.tx-sub{color:var(--text3);font-size:10px;margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.tx-amt{font-weight:600;font-size:12px;text-align:right;white-space:nowrap;}
.tx-amt.income{color:var(--green);}
.tx-amt.expense{color:var(--red);}
.tx-tag{font-size:9px;font-weight:600;padding:2px 6px;border-radius:8px;white-space:nowrap;}
.tx-tag.matched{background:var(--green-bg);color:var(--green);}
.tx-tag.unmatched{background:var(--orange-bg);color:var(--orange);}
.tx-tag.manual{background:var(--blue-bg);color:var(--blue);}

/* LEXOFFICE-STYLE REVIEW TABLE */
.lx-row{display:grid;grid-template-columns:68px minmax(0,1fr) 88px 56px 150px 70px 76px;align-items:center;gap:6px;padding:7px 14px;border-bottom:1px solid var(--border);font-size:11px;transition:background .1s;min-height:52px;}
.lx-row:hover{background:var(--surface2);}
.lx-row.unsicher{box-shadow:inset 3px 0 0 var(--orange);}
.lx-row.bestaetigt{box-shadow:inset 3px 0 0 var(--green);}
.lx-header{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;background:var(--surface2);padding:6px 14px;border-bottom:1px solid var(--border);display:grid;grid-template-columns:68px minmax(0,1fr) 88px 56px 150px 70px 76px;gap:6px;}
.lx-date{color:var(--text3);font-size:10px;white-space:nowrap;}
.lx-desc{min-width:0;overflow:hidden;}
.lx-desc-main{color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lx-desc-sub{color:var(--text3);font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:2px;}
.lx-amt{font-weight:600;font-size:12px;text-align:right;white-space:nowrap;}
.lx-amt.in{color:var(--green);}
.lx-amt.out{color:var(--red);}
.lx-thumb{display:flex;align-items:center;justify-content:center;width:56px;}
.lx-row-wrap{border-bottom:1px solid var(--border);}
.lx-row-wrap .lx-row{border-bottom:none;}
.reason-row{display:flex;align-items:flex-start;gap:8px;padding:6px 14px 8px 14px;background:var(--surface2);font-size:11px;color:var(--text3);line-height:1.5;}
.reason-btn{color:var(--text3);}
.reason-btn.has-grund{color:var(--text2);}
.reason-btn svg{transition:transform .15s;}
.ki-loading-inline{display:none;align-items:center;gap:8px;font-size:11px;color:var(--text3);padding:6px 0;}
.ki-loading-inline.show{display:flex;}

/* BELEG-THUMBNAIL */
.thumb-slot{width:40px;height:40px;border-radius:5px;border:2px dashed var(--border2);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;flex-shrink:0;transition:.15s;position:relative;background:var(--surface2);}
.thumb-slot:hover{border-color:var(--accent);background:var(--accent-bg);}
.thumb-slot.has-thumb{border-style:solid;border-color:var(--border);}
.thumb-slot.has-thumb:hover{border-color:var(--accent);}
.thumb-slot img{width:100%;height:100%;object-fit:cover;border-radius:2px;}
.thumb-slot .pdf-lbl{font-size:8px;font-weight:700;color:var(--text3);text-align:center;line-height:1.3;padding:2px;}
.thumb-slot .add-lbl{color:var(--text3);font-size:18px;line-height:1;}
.conf-dot{position:absolute;top:2px;right:2px;width:8px;height:8px;border-radius:50%;border:1.5px solid var(--surface);}
.conf-dot.hoch{background:var(--green);}
.conf-dot.mittel{background:var(--orange);}
.conf-dot.niedrig{background:var(--red);}

/* KONFIDENZ BADGE */
.konfidenz{font-size:9px;font-weight:700;padding:2px 7px;border-radius:8px;white-space:nowrap;}
.konfidenz.hoch{background:var(--green-bg);color:var(--green);}
.konfidenz.mittel{background:var(--orange-bg);color:var(--orange);}
.konfidenz.niedrig,.konfidenz.unklar{background:var(--red-bg);color:var(--red);}
.konfidenz.bestaetigt{background:var(--green-bg);color:var(--green);}

/* CAT SELECT */
.cat-select{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:10px;padding:3px 6px;outline:none;font-family:var(--font);width:100%;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:none;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal-box{background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius);max-width:700px;width:100%;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.5);}
.modal-head{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0;}
.modal-head h3{flex:1;font-size:14px;font-weight:600;margin:0;}
.modal-close{width:28px;height:28px;border:none;background:none;color:var(--text3);cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:20px;line-height:1;flex-shrink:0;}
.modal-close:hover{background:var(--surface2);color:var(--text);}
.modal-body{flex:1;overflow-y:auto;padding:20px;}
.modal-foot{padding:14px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;flex-shrink:0;}

/* PICKER GRID */
.picker-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;}
.picker-item{border:2px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;cursor:pointer;transition:.15s;}
.picker-item:hover{border-color:var(--accent);}
.picker-item.selected{border-color:var(--accent);background:var(--accent-bg);}
.picker-thumb{width:100%;height:72px;object-fit:cover;display:block;background:var(--surface2);}
.picker-pdf{height:72px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:var(--surface2);color:var(--text3);font-size:10px;font-weight:700;}
.picker-pdf svg{color:var(--text3);}
.picker-used{opacity:.5;cursor:not-allowed!important;}
.picker-name{padding:5px 7px 6px;font-size:10px;color:var(--text3);line-height:1.4;}
.picker-name-desc{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text2);}
.picker-name-date{font-size:9px;color:var(--text3);margin-top:1px;}

/* AI RESULT ROW (legacy, wird noch für nicht-CSV Einträge verwendet) */
.ai-row{display:grid;grid-template-columns:1fr auto 140px auto;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);font-size:11px;}
.ai-row:last-child{border-bottom:none;}
.ai-desc{color:var(--text2);font-size:12px;}
.ai-sub{color:var(--text3);font-size:10px;margin-top:2px;}
.ai-amt{font-weight:600;font-size:12px;white-space:nowrap;text-align:right;}
.ai-amt.income{color:var(--green);}
.ai-amt.expense{color:var(--red);}

/* USTVA GRID */
.ustv-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px;}
.ustv-kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;}
.ustv-kpi-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
.ustv-kpi-val{font-size:22px;font-weight:700;}
.ustv-kpi-val.green{color:var(--green);}
.ustv-kpi-val.red{color:var(--red);}
.ustv-kpi-val.accent{color:var(--accent);}
.ustv-kpi-val.blue{color:var(--blue);}
.detail-table{width:100%;border-collapse:collapse;font-size:11px;}
.detail-table th{padding:8px 14px;text-align:left;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);}
.detail-table td{padding:8px 14px;border-bottom:1px solid var(--border);color:var(--text2);}
.detail-table td:last-child{text-align:right;font-weight:600;color:var(--text);}
.detail-table tr:last-child td{border-bottom:none;}

/* PROGRESS */
.progress-wrap{height:4px;background:var(--surface3);border-radius:2px;overflow:hidden;margin-top:6px;}
.progress-bar{height:4px;background:var(--accent);border-radius:2px;transition:width .3s;}

/* SPINNER */
.spinner{width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0;}
.spinner-lg{width:32px;height:32px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-bar{display:none;align-items:center;gap:10px;padding:14px;background:var(--surface2);border-radius:var(--radius);margin:8px 0;font-size:12px;color:var(--text3);}
.loading-bar.show{display:flex;}

/* TOAST */
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--surface3);color:var(--text);border:1px solid var(--border2);padding:9px 18px;border-radius:var(--radius);font-size:12px;opacity:0;transition:.25s;pointer-events:none;z-index:999;box-shadow:0 4px 20px rgba(0,0,0,.4);}
#toast.show{opacity:1;}

/* LOADING SCREEN */
#loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:100;}

/* ENTRY TABLE */
.entry-table{width:100%;border-collapse:collapse;font-size:11px;}
.entry-table th{padding:7px 10px;text-align:left;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);}
.entry-table td{padding:7px 10px;border-bottom:1px solid var(--border);color:var(--text2);}
.entry-table tr:last-child td{border-bottom:none;}
.entry-del{width:22px;height:22px;border:none;background:none;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:background .12s,color .12s;flex-shrink:0;}
.entry-del:hover{background:var(--surface3);color:var(--text);}
.entry-del svg{width:12px;height:12px;}
/* Spezifische Action-Buttons */
.row-action-ok{color:var(--text3);}
.row-action-ok:hover{background:var(--green-bg)!important;color:var(--green)!important;}
.row-action-ok.ok-active{color:var(--green);background:var(--green-bg);}
.row-action-ok.ok-active:hover{background:var(--green-bg)!important;color:var(--green)!important;}
.row-action-unlink{color:var(--text3);}
.row-action-unlink:hover{background:var(--orange-bg)!important;color:var(--orange)!important;}
.row-action-info{color:var(--text3);}
.row-action-info.has-grund{color:var(--text2);}
.row-action-info:hover{background:var(--surface3)!important;color:var(--text)!important;}
</style>
</head>
<body>

<div id="loading-screen">
  <div class="spinner-lg"></div>
  <span style="font-size:12px;color:var(--text3);">Lade Steuertool …</span>
</div>

<nav id="nav">
  <span class="nav-logo">VISO <span>Media</span></span>
  <div class="nav-sep"></div>
  <a class="nav-btn" href="/dashboard"><i data-lucide="layout-dashboard"></i> Dashboard</a>
  <a class="nav-btn" href="/tool"><i data-lucide="file-text"></i> Angebote & Rechnungen</a>
  <a class="nav-btn active" href="/steuer"><i data-lucide="calculator"></i> Steuer</a>
  <div class="nav-spacer"></div>
  <span style="font-size:11px;color:var(--text3);padding:0 6px;" id="nav-user"></span>
  <button class="nav-icon-btn" onclick="openSettings()" title="Einstellungen"><i data-lucide="settings"></i></button>
  <button class="nav-icon-btn" onclick="doSignOut()" title="Abmelden"><i data-lucide="log-out"></i></button>
</nav>

<!-- ── EINSTELLUNGEN MODAL ─────────────────────────────────── -->
<div id="settings-overlay" onclick="if(event.target===this)closeSettings()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9000;align-items:center;justify-content:center;">
  <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:28px 32px;width:360px;max-width:90vw;">
    <div style="font-size:15px;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:8px;">
      <i data-lucide="settings" style="width:16px;height:16px;stroke-width:1.8;color:var(--text2)"></i>
      Einstellungen
    </div>
    <div style="font-size:11px;color:var(--text3);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;">Dein Name (für Privatentnahmen-Erkennung)</div>
    <div style="display:flex;gap:8px;margin-bottom:20px;">
      <input id="settings-vorname" placeholder="Vorname" style="flex:1;background:var(--surface3);border:1px solid var(--border);border-radius:6px;padding:8px 10px;color:var(--text);font-size:13px;">
      <input id="settings-nachname" placeholder="Nachname" style="flex:1;background:var(--surface3);border:1px solid var(--border);border-radius:6px;padding:8px 10px;color:var(--text);font-size:13px;">
    </div>
    <div style="font-size:11px;color:var(--text3);margin-bottom:18px;line-height:1.5;">Transaktionen an diesen Namen werden automatisch als <strong>Privatentnahme</strong> kategorisiert und in den Auswertungen herausgerechnet.</div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn btn-ghost" onclick="closeSettings()">Abbrechen</button>
      <button class="btn btn-primary" onclick="saveSettings()">Speichern</button>
    </div>
  </div>
</div>

<div id="app">

<div id="sidebar">
  <div class="sb-section">Zeitraum</div>
  <select id="sel-year" onchange="onPeriodChange()">
    <option value="2026">2026</option>
    <option value="2025">2025</option>
    <option value="2024">2024</option>
  </select>
  <div style="margin-top:8px;margin-bottom:4px;font-size:10px;color:var(--text3);">Quartal</div>
  <div class="quartal-grid">
    <button class="q-btn" id="q1" onclick="setQuartal(1)">Q1</button>
    <button class="q-btn" id="q2" onclick="setQuartal(2)">Q2</button>
    <button class="q-btn" id="q3" onclick="setQuartal(3)">Q3</button>
    <button class="q-btn" id="q4" onclick="setQuartal(4)">Q4</button>
  </div>
  <button class="q-btn" id="qjahr" onclick="setQuartal(0)" style="width:100%;margin-top:4px;">Ganzes Jahr</button>

  <div class="sb-section">Schritte</div>
  <button class="step-btn active" id="step-btn-1" onclick="goPage(1)">
    <span class="step-num">1</span> Upload
  </button>
  <button class="step-btn" id="step-btn-2" onclick="goPage(2)">
    <span class="step-num">2</span> Belege prüfen
  </button>
  <button class="step-btn" id="step-btn-3" onclick="goPage(3)">
    <span class="step-num">3</span> Review
    <span class="step-badge" id="badge-review">0</span>
  </button>
  <button class="step-btn" id="step-btn-4" onclick="goPage(4)">
    <span class="step-num">4</span> Ergebnis
  </button>

  <div class="sb-section">Übersicht</div>
  <div class="sb-stat">
    <div class="sb-stat-label">Einnahmen</div>
    <div class="sb-stat-val green" id="sb-einnahmen">–</div>
  </div>
  <div class="sb-stat">
    <div class="sb-stat-label">Ausgaben</div>
    <div class="sb-stat-val red" id="sb-ausgaben">–</div>
  </div>
  <div class="sb-stat">
    <div class="sb-stat-label">Gewinn (EÜR)</div>
    <div class="sb-stat-val accent" id="sb-gewinn">–</div>
  </div>
  <div class="sb-stat">
    <div class="sb-stat-label">USt-Zahllast</div>
    <div class="sb-stat-val blue" id="sb-zahllast">–</div>
  </div>
</div>

<div id="main">

<!-- ═══════════════════════════════════════════════════════
     SEITE 1: UPLOAD
     ═══════════════════════════════════════════════════════ -->
<div class="page active" id="page-1">
  <div class="page-title">Upload</div>
  <div class="page-sub">Lade alle Daten des Zeitraums auf einmal hoch. CSV-Kontoauszug deines Geschäftskontos + alle Belege (Fotos, PDFs, E-Mail-Anhänge). Die KI liest alles aus und ordnet zu.</div>

  <!-- CSV Upload -->
  <div class="card">
    <div class="card-title">Kontoauszug (CSV)</div>
    <div class="card-sub">CSV-Export deines Geschäftskontos – alle Buchungen des Zeitraums. Positiv = Gutschrift, Negativ = Lastschrift.</div>
    <div class="upload-zone" id="csv-zone" ondragover="onCsvDrag(event,true)" ondragleave="onCsvDrag(event,false)" ondrop="onCsvDrop(event)">
      <input type="file" id="csv-input" accept=".csv" onchange="onCsvSelect(this.files)">
      <i data-lucide="table-2" class="upload-icon"></i>
      <p><strong>CSV hier ablegen</strong> oder klicken<br>Unterstützt: Sparkasse, DKB, ING, Commerzbank, N26, Kontist …</p>
    </div>
    <div id="csv-status" style="display:none;"></div>
  </div>

  <!-- Belege Upload -->
  <div class="card">
    <div class="card-title">Belege & Rechnungen</div>
    <div class="card-sub">Alle Belege des Zeitraums – Fotos von Kassenbons, PDFs von Online-Rechnungen, E-Mail-Anhänge.</div>
    <div class="upload-zone" id="beleg-zone" ondragover="onBelegDrag(event,true)" ondragleave="onBelegDrag(event,false)" ondrop="onBelegDrop(event)">
      <input type="file" id="beleg-input" multiple accept=".pdf,.jpg,.jpeg,.png,.heic,.heif,.webp" onchange="onBelegSelect(this.files)">
      <i data-lucide="upload-cloud" class="upload-icon"></i>
      <p><strong>Dateien hier ablegen</strong> oder klicken<br>PDF · JPG · PNG · HEIC – mehrere auf einmal möglich</p>
    </div>
    <div class="file-list" id="beleg-list" style="display:none;"></div>
    <!-- KI Belege auslesen – direkt hier in Schritt 1 -->
    <div id="beleg-ki-wrap" style="margin-top:8px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <button class="btn btn-primary" id="btn-read-belege" onclick="readBelege()" style="display:none;"><i data-lucide="sparkles"></i> Belege mit KI auslesen</button>
      <span id="beleg-skip-hint" style="font-size:11px;color:var(--text3);display:none;">Keine neuen Belege zum Auslesen.</span>
      <div class="loading-bar" id="beleg-loading" style="margin:0;"><div class="spinner"></div><div><div id="beleg-loading-text">KI liest Belege aus …</div><div class="progress-wrap" style="width:180px;"><div class="progress-bar" id="beleg-progress-bar" style="width:0%"></div></div></div></div>
    </div>
  </div>

  <!-- Manuelle Einnahmen -->
  <div class="card">
    <div class="card-title">Manuelle Einnahmen <span style="font-weight:400;color:var(--text3);font-size:11px;">(Bargeschäfte, Nebeneinnahmen)</span></div>
    <div id="manual-income-wrap" style="display:none;margin-bottom:10px;">
      <table class="entry-table"><thead><tr><th>Beschreibung</th><th>Datum</th><th style="text-align:right;">Brutto</th><th></th></tr></thead>
      <tbody id="manual-income-tbody"></tbody></table>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <input id="mi-desc" type="text" placeholder="Beschreibung" style="flex:2;min-width:140px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);">
      <input id="mi-amt" type="text" placeholder="Brutto €" style="width:90px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);">
      <input id="mi-date" type="date" style="background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);">
      <button class="btn btn-ghost btn-sm" onclick="addManualIncome()"><i data-lucide="plus"></i> Hinzufügen</button>
    </div>
  </div>

  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:4px;">
    <button class="btn btn-primary btn-lg" onclick="goPage(2)"><i data-lucide="arrow-right"></i> Belege prüfen</button>
    <button class="btn btn-ghost btn-lg" onclick="goPage(3)"><i data-lucide="list"></i> Direkt zum Review</button>
    <span style="font-size:11px;color:var(--text3);" id="upload-summary"></span>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════
     SEITE 2: BELEGE PRÜFEN
     ═══════════════════════════════════════════════════════ -->
<div class="page" id="page-2">
  <div class="page-title">Belege prüfen</div>
  <div class="page-sub">Alle gespeicherten Belege im gewählten Zeitraum. Fehlende Daten ergänzen oder Belege löschen.</div>

  <div class="card" style="padding:0;overflow:hidden;">
    <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;">
      <span style="font-size:12px;font-weight:600;">Gespeicherte Belege</span>
      <span style="flex:1;"></span>
      <span id="beleg-uebersicht-count" style="font-size:11px;color:var(--text3);"></span>
      <button class="btn btn-ghost btn-sm" onclick="rematchAllBelege()" id="btn-rematch" title="Alle Belege erneut den Transaktionen zuordnen (auch bereits abgespeicherte)">
        <i data-lucide="git-merge"></i> Erneut zuordnen
      </button>
    </div>
    <div id="beleg-uebersicht-list">
      <div style="padding:24px;text-align:center;color:var(--text3);font-size:12px;">Lade …</div>
    </div>
  </div>

  <!-- Edit-Modal für einzelnen Beleg -->
  <div class="modal-overlay" id="modal-beleg-edit">
    <div class="modal-box" style="max-width:420px;">
      <div class="modal-head">
        <h3>Beleg bearbeiten</h3>
        <button class="modal-close" onclick="closeModal('modal-beleg-edit')">×</button>
      </div>
      <div class="modal-body" style="display:flex;flex-direction:column;gap:12px;">
        <input type="hidden" id="edit-beleg-id">
        <div>
          <label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Beschreibung / Händler</label>
          <input id="edit-beleg-desc" type="text" placeholder="z.B. Adobe Creative Cloud" style="width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:12px;padding:7px 10px;outline:none;font-family:var(--font);">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div>
            <label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Datum</label>
            <input id="edit-beleg-datum" type="date" style="width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:12px;padding:7px 10px;outline:none;font-family:var(--font);">
          </div>
          <div>
            <label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Betrag Brutto €</label>
            <input id="edit-beleg-betrag" type="number" step="0.01" min="0" placeholder="0.00" style="width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:12px;padding:7px 10px;outline:none;font-family:var(--font);">
          </div>
        </div>
        <div>
          <label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Kategorie</label>
          <select id="edit-beleg-kat" style="width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:12px;padding:7px 10px;outline:none;font-family:var(--font);appearance:none;"></select>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn btn-ghost btn-sm" onclick="closeModal('modal-beleg-edit')">Abbrechen</button>
        <button class="btn btn-primary btn-sm" onclick="saveBelegEdit()"><i data-lucide="save"></i> Speichern</button>
      </div>
    </div>
  </div>

  <div style="display:flex;gap:8px;margin-top:4px;">
    <button class="btn btn-ghost" onclick="goPage(1)"><i data-lucide="arrow-left"></i> Zurück</button>
    <button class="btn btn-primary" onclick="goPage(3)"><i data-lucide="arrow-right"></i> Weiter zum Review</button>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════
     SEITE 3: REVIEW
     ═══════════════════════════════════════════════════════ -->
<div class="page" id="page-3">
  <div class="page-title">Review</div>
  <div class="page-sub">Alle Bankbewegungen im Überblick. Belege werden automatisch zugeordnet. KI kategorisiert auf Knopfdruck und fügt Begründungen hinzu.</div>

  <!-- Alle Buchungen (auch ohne KI sofort sichtbar) -->
  <div class="card" style="padding:0;overflow:hidden;">
    <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <span style="font-size:12px;font-weight:600;">Buchungen</span>
      <span style="flex:1;"></span>
      <div class="ki-loading-inline" id="ki-review-loading">
        <div class="spinner" style="width:14px;height:14px;border-width:2px;"></div>
        <span id="ki-review-loading-text">KI analysiert …</span>
      </div>
      <button class="btn btn-primary btn-sm" id="btn-ki-review" onclick="runKIKategorisierung()"><i data-lucide="sparkles"></i> KI kategorisieren</button>
      <button class="btn btn-ghost btn-sm" id="btn-filter-review" onclick="toggleFilterReview()"><i data-lucide="alert-triangle"></i> Nur unsichere</button>
    </div>
    <div id="review-list"></div>
  </div>

  <div style="display:flex;gap:8px;margin-top:4px;">
    <button class="btn btn-ghost" onclick="goPage(2)"><i data-lucide="arrow-left"></i> Zurück</button>
    <button class="btn btn-primary" onclick="buildUStVA();goPage(4);"><i data-lucide="calculator"></i> Freigeben & Ergebnis berechnen</button>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════
     SEITE 4: ERGEBNIS
     ═══════════════════════════════════════════════════════ -->
<div class="page" id="page-4">
  <div class="page-title">UStVA-Ergebnis</div>
  <div class="page-sub" id="ustva-period-label"></div>

  <div class="hinweis warn"><i data-lucide="alert-triangle"></i>
    <div><strong>Kein Ersatz für Steuerberatung.</strong> Diese Berechnung ist eine Arbeitshilfe. Bitte von dir oder deinem Steuerberater prüfen lassen.</div>
  </div>

  <div class="ustv-grid" id="ustv-kpi-grid"></div>

  <div class="card" style="padding:0;overflow:hidden;">
    <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-size:12px;font-weight:600;">Detailauswertung</div>
    <table class="detail-table" id="detail-table"><tbody></tbody></table>
  </div>

  <div class="card">
    <div class="card-title">EÜR-Zusammenfassung</div>
    <table class="detail-table" id="euer-table"><tbody></tbody></table>
  </div>

  <div class="card" style="background:var(--accent-bg);border-color:var(--accent);">
    <div class="card-title">Export</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;">
      <button class="btn btn-primary" onclick="exportSummary()"><i data-lucide="copy"></i> Zusammenfassung kopieren</button>
      <button class="btn btn-ghost" onclick="window.print()"><i data-lucide="printer"></i> Drucken</button>
    </div>
  </div>

  <div class="card" style="background:var(--blue-bg);border-color:var(--blue);">
    <div class="card-title" style="color:var(--blue);">ELSTER XML</div>
    <div class="card-sub">UStVA-XML für ELSTER oder deinen Steuerberater.</div>
    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
      <div style="flex:1;min-width:160px;">
        <label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Steuernummer</label>
        <input id="elster-steuernr" type="text" placeholder="02 087 20105 8" style="background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);width:100%;">
      </div>
      <div style="flex:1;min-width:130px;">
        <label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Bundesland</label>
        <select id="elster-bundesland" style="background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text);font-size:11px;padding:6px 9px;outline:none;font-family:var(--font);width:100%;appearance:none;">
          <option value="26">Hessen</option><option value="11">Berlin</option><option value="91">Bayern</option>
          <option value="20">Hamburg</option><option value="21">Niedersachsen</option><option value="28">Nordrhein-Westfalen</option>
          <option value="40">Baden-Württemberg</option><option value="30">Rheinland-Pfalz</option><option value="10">Brandenburg</option>
          <option value="31">Saarland</option><option value="22">Sachsen-Anhalt</option><option value="32">Sachsen</option>
          <option value="23">Schleswig-Holstein</option><option value="13">Mecklenburg-Vorpommern</option>
        </select>
      </div>
    </div>
    <button class="btn" style="background:var(--blue);color:#fff;border:none;" onclick="exportElsterXML()"><i data-lucide="file-code-2"></i> ELSTER XML herunterladen</button>
  </div>

  <div style="margin-top:4px;">
    <button class="btn btn-ghost" onclick="goPage(3)"><i data-lucide="arrow-left"></i> Zurück</button>
  </div>
</div>

</div><!-- /main -->
</div><!-- /app -->

<div id="toast"></div>

<!-- ── BELEG-VOLLANSICHT MODAL ── -->
<div class="modal-overlay" id="modal-beleg">
  <div class="modal-box" style="max-width:940px;width:95vw;height:95vh;">
    <div class="modal-head">
      <h3 id="modal-beleg-title">Beleg</h3>
      <a id="modal-beleg-extlink" href="#" target="_blank" rel="noopener noreferrer" class="btn btn-ghost btn-sm" style="display:none;margin-right:4px;"><i data-lucide="external-link"></i> Im Browser öffnen</a>
      <button class="modal-close" onclick="closeModal('modal-beleg')">×</button>
    </div>
    <div class="modal-body" style="display:grid;grid-template-columns:1fr 240px;gap:0;padding:0;overflow:hidden;flex:1;min-height:0;">
      <!-- Linke Spalte: Beleg-Vorschau -->
      <div style="border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;">
        <img id="modal-beleg-img" src="" alt="" style="width:100%;height:100%;object-fit:contain;display:none;padding:16px;">
        <iframe id="modal-beleg-iframe" src="" style="display:none;flex:1;width:100%;height:100%;border:none;background:#fff;"></iframe>
        <div id="modal-beleg-pdf-fallback" style="display:none;flex:1;align-items:center;justify-content:center;flex-direction:column;gap:12px;background:var(--surface2);">
          <i data-lucide="file-text" style="width:40px;height:40px;color:var(--text3);stroke-width:1;"></i>
          <div style="color:var(--text3);font-size:12px;" id="modal-beleg-pdf-name"></div>
          <a id="modal-beleg-pdf-link" href="#" target="_blank" rel="noopener noreferrer" class="btn btn-ghost btn-sm"><i data-lucide="external-link"></i> Im Browser öffnen</a>
        </div>
      </div>
      <!-- Rechte Spalte: Metadaten -->
      <div style="padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:16px;">
        <div>
          <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;">Beleg-Details</div>
          <div id="modal-beleg-meta" style="font-size:11px;color:var(--text2);line-height:2.1;"></div>
        </div>
        <div>
          <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">Verknüpfte Transaktion</div>
          <div id="modal-beleg-tx" style="font-size:11px;color:var(--text2);"></div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-red btn-sm" id="modal-beleg-unlink" onclick="unlinkReceipt()"><i data-lucide="link-2-off"></i> Verknüpfung lösen</button>
      <button class="btn btn-ghost btn-sm" id="modal-beleg-change" onclick="openPickerFromModal()"><i data-lucide="refresh-cw"></i> Anderen Beleg wählen</button>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('modal-beleg')">Schließen</button>
    </div>
  </div>
</div>

<!-- ── BELEG-PICKER MODAL ── -->
<div class="modal-overlay" id="modal-picker">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Beleg zuordnen</h3>
      <button class="modal-close" onclick="closeModal('modal-picker')">×</button>
    </div>
    <div class="modal-body">
      <div class="hinweis" style="margin-bottom:14px;"><i data-lucide="info"></i><div>Wähle den passenden Beleg für diese Transaktion. Bereits zugeordnete Belege sind ausgegraut.</div></div>
      <div class="picker-grid" id="picker-grid"></div>
      <div id="picker-empty" style="display:none;text-align:center;color:var(--text3);font-size:12px;padding:30px 0;">Keine Belege verfügbar. Lade zuerst Belege hoch und lasse sie von der KI auslesen.</div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost btn-sm" onclick="closeModal('modal-picker')">Abbrechen</button>
      <button class="btn btn-primary btn-sm" id="picker-confirm" onclick="confirmPicker()" disabled><i data-lucide="link-2"></i> Zuordnen</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="supabase.js"></script>
<script>
lucide.createIcons();

// ── KATEGORIEN ─────────────────────────────────────────────
const CATEGORIES = {
  einnahmen_19:{label:'Einnahmen 19% MwSt.',type:'income',vat:0.19},
  einnahmen_7:{label:'Einnahmen 7% MwSt.',type:'income',vat:0.07},
  einnahmen_0:{label:'Einnahmen steuerfrei',type:'income',vat:0},
  software:{label:'Software & Tools',type:'expense',vat:0.19},
  hardware:{label:'Hardware & Technik',type:'expense',vat:0.19},
  buero:{label:'Büro & Arbeitsmittel',type:'expense',vat:0.19},
  marketing:{label:'Marketing & Werbung',type:'expense',vat:0.19},
  reise:{label:'Reise & Fahrtkosten',type:'expense',vat:0.07},
  bewirtung:{label:'Bewirtung (70%)',type:'expense',vat:0.19,limitFactor:0.7},
  telefon:{label:'Telefon & Internet',type:'expense',vat:0.19},
  weiterbildung:{label:'Weiterbildung',type:'expense',vat:0.19},
  freelancer:{label:'Fremdleistungen',type:'expense',vat:0.19},
  versicherung:{label:'Versicherungen',type:'expense',vat:0},
  steuerberatung:{label:'Steuerberatung',type:'expense',vat:0.19},
  miete:{label:'Miete / Raumkosten',type:'expense',vat:0.19},
  bankgebuehr:{label:'Bankgebühren',type:'expense',vat:0},
  sonstiges:{label:'Sonstiges',type:'expense',vat:0.19},
  privat:{label:'Privat (nicht absetzbar)',type:'private',vat:0},
  privatentnahme:{label:'Privatentnahme',type:'private',vat:0},
};

// ── STATE ──────────────────────────────────────────────────
let selectedYear    = new Date().getFullYear();
let selectedQuartal = 0;
let manualIncomes   = [];   // {id, desc, datum, brutto}
let csvTransactions = [];   // Rohdaten aus CSV (nach Import)
let belegFiles      = [];   // {file, status, result, thumbnail} – Session-only
let receipts        = [];   // Aus DB geladene Belege (mit thumbnail_data)
let matches         = [];   // Aus DB geladene Matches (persistent) – ersetzt aiResults
let aiResults       = [];   // Legacy-Alias → zeigt auf matches
let txRules         = [];   // Kategorisierungs-Regeln: [{empfaenger_key, kategorie, ...}]
let ownerName       = '';   // Vor- und Nachname des Unternehmers (für Privatentnahmen-Erkennung)
let filterReview    = false;
// Modal-State
let modalMatchIdx   = null; // welcher Match ist gerade im Modal
let pickerSelected  = null; // ausgewählter Receipt im Picker

// ── HELPERS ────────────────────────────────────────────────
const fmt    = n => n.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+'\u00a0€';
const fmtDate= v=>{if(!v)return'–';try{const[y,m,d]=v.split('-');return`${d}.${m}.${y}`;}catch{return v;}};
const parseAmt=s=>{if(!s)return 0;s=String(s).trim();if(/^\d{1,3}(\.\d{3})*(,\d+)?$/.test(s))return parseFloat(s.replace(/\./g,'').replace(',','.'));return parseFloat(s.replace(',','.').replace(/[^\d.-]/g,''))||0;};
const toast  = msg=>{const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);};
const $      = id=>document.getElementById(id);
const fmtSize= b=>b<1024?b+'B':b<1048576?(b/1024).toFixed(0)+'KB':(b/1048576).toFixed(1)+'MB';

// ── NAVIGATION ─────────────────────────────────────────────
let currentPage=1;
function goPage(n){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  $(`page-${n}`).classList.add('active');
  document.querySelectorAll('.step-btn').forEach((b,i)=>b.classList.toggle('active',i+1===n));
  currentPage=n;
  if(n===1) updateUploadSummary();
  if(n===2) renderBelegUebersicht();
  if(n===3) renderReview();
  if(n===4) buildUStVA();
  lucide.createIcons();
}

// ── ZEITRAUM ───────────────────────────────────────────────
async function setQuartal(q){
  selectedQuartal=q;
  localStorage.setItem('steuer_quartal',q);
  document.querySelectorAll('.q-btn').forEach(b=>b.classList.remove('active'));
  if(q===0)$('qjahr').classList.add('active');
  else $(`q${q}`).classList.add('active');
  updateUploadSummary();
  // Matches für neues Quartal laden, dann neue CSV-Einträge ergänzen
  await loadMatchesFromDB(selectedYear,q);
  if(csvTransactions.length) buildMatchesFromCSV();
  updateSidebar();
  if(currentPage===2)renderBelegUebersicht();
  if(currentPage===3)renderReview();
}
async function onPeriodChange(){
  selectedYear=parseInt($('sel-year').value);
  localStorage.setItem('steuer_year',selectedYear);
  // CSV + Matches für das neue Jahr nachladen
  await Promise.all([
    (async()=>{
      try{
        const txs=await DB.getTransactions(selectedYear);
        if(txs.length){
          csvTransactions=txs.map(t=>({
            id:'tx'+t.id, datum:t.datum||'', empfaenger:t.empfaenger||'',
            verwendungszweck:t.verwendungszweck||'',
            beschreibung:t.beschreibung||(t.empfaenger||'')+(t.verwendungszweck?' – '+t.verwendungszweck:''),
            betrag:parseFloat(t.betrag)||0, isEinnahme:!!t.is_einnahme, quelle:'csv', _fromDB:true
          }));
          const ein=csvTransactions.filter(t=>t.isEinnahme).length;
          const aus=csvTransactions.filter(t=>!t.isEinnahme).length;
          const st=$('csv-status');
          st.style.display='block';
          st.innerHTML=`<div class="hinweis ok"><i data-lucide="check-circle"></i><div><strong>${csvTransactions.length} Buchungen</strong> aus ${selectedYear}: ${ein} Eingänge, ${aus} Ausgaben. <button class="btn btn-ghost btn-sm" style="margin-left:8px;" onclick="clearCSVData()"><i data-lucide="trash-2"></i> Löschen</button></div></div>`;
          lucide.createIcons();
        } else {
          csvTransactions=[];
          $('csv-status').style.display='none';
        }
      }catch(e){console.info('CSV nicht geladen:',e.message);}
    })(),
    loadMatchesFromDB(selectedYear,selectedQuartal),
  ]);
  // ERST nach beiden Loads: neue CSV-Buchungen ohne Match hinzufügen
  if(csvTransactions.length) buildMatchesFromCSV();
  updateUploadSummary();
  updateSidebar();
  if(currentPage===3)renderReview();
}
function inPeriod(datum){
  if(!datum)return false;
  if(selectedQuartal===0){
    // Ganzes Jahr + 14 Tage Jahreswechsel-Puffer
    return datum>=`${selectedYear-1}-12-18`&&datum<=`${selectedYear+1}-01-14`;
  }
  // Quartal: nur exaktes Jahr
  if(!datum.startsWith(String(selectedYear)))return false;
  const m=parseInt(datum.slice(5,7));
  return{1:[1,2,3],2:[4,5,6],3:[7,8,9],4:[10,11,12]}[selectedQuartal].includes(m);
}

// Wie inPeriod, aber mit ±14 Tage Puffer an allen Grenzen
// (für Monatswechsel: Rechnung 31.03. → Transaktion 01.04.,
//  Jahreswechsel: Transaktion 27.12. → Rechnung 04.01.)
function inPeriodLoose(datum){
  if(!datum)return false;
  if(selectedQuartal===0){
    // Ganzes Jahr + großzügiger Jahreswechsel-Puffer (schon in inPeriod enthalten)
    return datum>=`${selectedYear-1}-12-18`&&datum<=`${selectedYear+1}-01-14`;
  }
  const qDates={
    1:[`${selectedYear}-01-01`,`${selectedYear}-03-31`],
    2:[`${selectedYear}-04-01`,`${selectedYear}-06-30`],
    3:[`${selectedYear}-07-01`,`${selectedYear}-09-30`],
    4:[`${selectedYear}-10-01`,`${selectedYear}-12-31`],
  };
  const [from,to]=qDates[selectedQuartal];
  const fromD=new Date(from); fromD.setDate(fromD.getDate()-14);
  const toD=new Date(to); toD.setDate(toD.getDate()+14);
  const d=new Date(datum);
  return d>=fromD&&d<=toD;
}
async function clearCSVData(){
  if(!confirm(`Alle gespeicherten CSV-Buchungen aus ${selectedYear} löschen?`))return;
  try{
    await DB.deleteAllTransactions(selectedYear);
    csvTransactions=[];
    $('csv-status').style.display='none';
    updateUploadSummary();
    toast('CSV-Daten gelöscht ✓');
  }catch(e){toast('Fehler: '+e.message);}
}

// ── SIDEBAR-STATS ──────────────────────────────────────────
function updateSidebar(){
  const src=matches.length?matches:aiResults;
  if(!src.length){$('sb-einnahmen').textContent='–';$('sb-ausgaben').textContent='–';$('sb-gewinn').textContent='–';$('sb-zahllast').textContent='–';return;}
  let ein=0,aus=0,zl=0;
  src.forEach(r=>{
    const cat=CATEGORIES[r.kategorie]||CATEGORIES.sonstiges;
    const netto=r.betrag_netto||0;const mwst=r.mwst_betrag||0;
    if(cat.type==='income'){ein+=netto;zl+=mwst;}
    else if(cat.type==='expense'){const f=cat.limitFactor||1;aus+=netto*f;zl-=mwst*f;}
  });
  $('sb-einnahmen').textContent=fmt(ein);
  $('sb-ausgaben').textContent=fmt(aus);
  $('sb-gewinn').textContent=fmt(ein-aus);
  $('sb-zahllast').textContent=fmt(Math.max(0,zl));
}

// ── MANUELLE EINNAHMEN ─────────────────────────────────────
function addManualIncome(){
  const desc=$('mi-desc').value.trim(),amt=$('mi-amt').value.trim(),date=$('mi-date').value;
  if(!desc||!amt){toast('Beschreibung und Betrag erforderlich.');return;}
  manualIncomes.push({id:'m'+Date.now(),desc,datum:date,brutto:parseAmt(amt)});
  $('mi-desc').value='';$('mi-amt').value='';
  renderManualIncomes();updateUploadSummary();
}
function removeManualIncome(id){manualIncomes=manualIncomes.filter(x=>x.id!==id);renderManualIncomes();updateUploadSummary();}
function renderManualIncomes(){
  const wrap=$('manual-income-wrap');
  if(!manualIncomes.length){wrap.style.display='none';return;}
  wrap.style.display='block';
  $('manual-income-tbody').innerHTML=manualIncomes.map(x=>`
    <tr><td>${x.desc}</td><td>${fmtDate(x.datum)}</td>
    <td style="text-align:right;font-weight:600;color:var(--green);">${fmt(x.brutto)}</td>
    <td><button class="entry-del" onclick="removeManualIncome('${x.id}')"><i data-lucide="x"></i></button></td></tr>`).join('');
  lucide.createIcons();
}

// ── CSV UPLOAD ─────────────────────────────────────────────
function onCsvDrag(e,over){e.preventDefault();$('csv-zone').classList.toggle('drag',over);}
function onCsvDrop(e){e.preventDefault();$('csv-zone').classList.remove('drag');onCsvSelect(e.dataTransfer.files);}
function onCsvSelect(files){
  const f=files[0];if(!f)return;
  if(!f.name.toLowerCase().endsWith('.csv')){toast('Nur CSV-Dateien erlaubt.');return;}
  parseAndSaveCSV(f);
}

async function parseAndSaveCSV(file){
  const status=$('csv-status');
  status.style.display='block';
  status.innerHTML=`<div class="loading-bar show"><div class="spinner"></div> Lese CSV …</div>`;
  try{
    const text=await file.text();
    const parsed=parseCSV(text,file.name);
    if(!parsed.length){status.innerHTML='<div class="hinweis warn"><i data-lucide="alert-triangle"></i><div>Keine Einträge erkannt. Bitte CSV-Format prüfen.</div></div>';lucide.createIcons();return;}
    // In DB speichern – gibt Zeilen mit echten DB-UUIDs zurück
    let savedRows=[];
    try{
      savedRows=await DB.saveTransactions(parsed.map(t=>({...t,quellDatei:file.name})));
      toast('CSV gespeichert ✓');
    }catch(e){console.warn('CSV-Speicherung fehlgeschlagen:',e.message);}
    // IDs aus DB übernehmen damit Matching konsistent ist
    if(savedRows.length){
      csvTransactions=savedRows.map(t=>({
        id:'tx'+t.id, _dbId:t.id,
        datum:t.datum||'', empfaenger:t.empfaenger||'',
        verwendungszweck:t.verwendungszweck||'',
        beschreibung:t.beschreibung||(t.empfaenger||'')+(t.verwendungszweck?' – '+t.verwendungszweck:''),
        betrag:parseFloat(t.betrag)||0, isEinnahme:!!t.is_einnahme, quelle:'csv'
      }));
    } else {
      // Fallback: ohne DB-IDs (Offline / Tabelle fehlt)
      csvTransactions=parsed;
    }
    const ein=csvTransactions.filter(t=>t.isEinnahme).length;
    const aus=csvTransactions.filter(t=>!t.isEinnahme).length;
    status.innerHTML=`<div class="hinweis ok"><i data-lucide="check-circle"></i><div><strong>${csvTransactions.length} Buchungen</strong> aus ${file.name}: ${ein} Eingänge, ${aus} Ausgaben. <button class="btn btn-ghost btn-sm" style="margin-left:8px;" onclick="clearCSVData()"><i data-lucide="trash-2"></i> Löschen</button></div></div>`;
    lucide.createIcons();
    updateUploadSummary();
    // Sofort Match-Objekte erstellen → Review zeigt Buchungen ohne KI-Klick
    buildMatchesFromCSV();
    if(currentPage===3)renderReview();
  }catch(e){
    status.innerHTML=`<div class="hinweis warn"><i data-lucide="alert-triangle"></i><div>Fehler: ${e.message}</div></div>`;
    lucide.createIcons();
  }
}

// ── CSV PARSER ─────────────────────────────────────────────
function parseCSV(text,filename=''){
  const lines=text.trim().split('\n').filter(l=>l.trim());
  if(lines.length<2)return[];
  const sep=lines[0].includes(';')?';':',';
  const headers=lines[0].split(sep).map(h=>h.trim().replace(/^["']|["']$/g,'').toLowerCase());
  const findCol=names=>{for(const n of names){const i=headers.indexOf(n);if(i>-1)return i;}return -1;};
  const dateCol =findCol(['datum','date','buchungstag','buchungsdatum','valuta','wertstellungsdatum','buchungsdat.']);
  const nameCol =findCol(['empfänger/zahlungspflichtiger','empfaenger/zahlungspflichtiger','empfänger','empfaenger','auftraggeber','beguenstigter','name','kontoinhaber']);
  const zweckCol=findCol(['verwendungszweck','beschreibung','description','buchungstext','transaktionsbeschreibung','text','betreff']);
  const amtCol  =findCol(['betrag','amount','umsatz','betrag eur','betrag (eur)','amount eur']);
  const results=[];
  for(let i=1;i<lines.length;i++){
    const parts=splitCSVLine(lines[i],sep);
    const col=idx=>idx>-1?(parts[idx]||'').trim().replace(/^["']|["']$/g,''):'';
    const datum=formatCSVDate(col(dateCol));
    const empf=col(nameCol);
    const zweck=col(zweckCol);
    const amtNum=parseCSVAmount(col(amtCol));
    if(amtNum===null)continue;
    const desc=empf&&zweck?`${empf} – ${zweck.slice(0,60)}`:(empf||zweck);
    if(!desc&&amtNum===0)continue;
    results.push({id:'csv'+i,datum,empfaenger:empf,verwendungszweck:zweck,beschreibung:desc,betrag:Math.abs(amtNum),isEinnahme:amtNum>0,quelle:'csv'});
  }
  return results;
}
function splitCSVLine(line,sep){
  const r=[];let cur='';let inQ=false;
  for(const c of line){if(c==='"')inQ=!inQ;else if(c===sep&&!inQ){r.push(cur);cur='';}else cur+=c;}
  r.push(cur);return r;
}
function parseCSVAmount(s){
  if(!s)return null;
  s=s.replace(/\s/g,'').replace(/€|EUR/gi,'');
  if(/^-?\d{1,3}(\.\d{3})*(,\d+)?$/.test(s))return parseFloat(s.replace(/\./g,'').replace(',','.'));
  const n=parseFloat(s.replace(/,(?=\d{3})/g,'').replace(',','.'));
  return isNaN(n)?null:n;
}
function formatCSVDate(s){
  if(!s)return'';
  const m1=s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
  if(m1)return`${m1[3]}-${m1[2].padStart(2,'0')}-${m1[1].padStart(2,'0')}`;
  const m2=s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2})$/);
  if(m2)return`20${m2[3]}-${m2[2].padStart(2,'0')}-${m2[1].padStart(2,'0')}`;
  if(/^\d{4}-\d{2}-\d{2}$/.test(s))return s;
  return s;
}

// ── BELEGE UPLOAD ──────────────────────────────────────────
function onBelegDrag(e,over){e.preventDefault();$('beleg-zone').classList.toggle('drag',over);}
function onBelegDrop(e){e.preventDefault();$('beleg-zone').classList.remove('drag');onBelegSelect(e.dataTransfer.files);}
function onBelegSelect(files){
  Array.from(files).forEach(f=>{
    if(belegFiles.find(b=>b.file.name===f.name&&b.file.size===f.size))return;
    belegFiles.push({file:f,status:'pending',result:null});
  });
  renderBelegList();updateUploadSummary();
}
function removeBelegFile(i){belegFiles.splice(i,1);renderBelegList();updateUploadSummary();}
function renderBelegList(){
  const wrap=$('beleg-list');
  const kiBtn=$('btn-read-belege');
  const skipHint=$('beleg-skip-hint');
  if(!belegFiles.length){
    wrap.style.display='none';
    if(kiBtn)kiBtn.style.display='none';
    if(skipHint)skipHint.style.display='none';
    return;
  }
  wrap.style.display='flex';
  wrap.innerHTML=belegFiles.map((b,i)=>{
    const ext=b.file.name.split('.').pop().toLowerCase();
    const icon=ext==='pdf'?'PDF':'IMG';
    const errMsg=b.error?` – ${b.error.slice(0,50)}`:'';
    const st=b.status==='done'
      ?`<span class="file-item-status ok">✓ Ausgelesen</span>`
      :b.status==='err'
        ?`<span class="file-item-status err" title="${b.error||''}">✗ Fehler${errMsg}</span>
          <button class="btn btn-ghost btn-sm" style="padding:3px 8px;font-size:10px;margin-left:4px;" onclick="retryBeleg(${i})" title="Erneut versuchen">
            <i data-lucide="rotate-ccw"></i> Retry
          </button>`
        :b.status==='loading'
          ?`<span class="file-item-status loading">⟳ Lese …</span>`
          :`<span class="file-item-status">Ausstehend</span>`;
    return`<div class="file-item" style="flex-wrap:wrap;gap:6px;">
      <div class="file-item-icon">${icon}</div>
      <span class="file-item-name" title="${b.file.name}">${b.file.name}</span>
      <span class="file-item-size">${fmtSize(b.file.size)}</span>
      <span style="display:flex;align-items:center;gap:4px;margin-left:auto;">${st}</span>
      <button class="file-item-del" onclick="removeBelegFile(${i})"><i data-lucide="x"></i></button>
    </div>`;
  }).join('');
  lucide.createIcons();
  // KI-Button: zeige wenn ausstehende ODER fehlgeschlagene Belege vorhanden
  const hasPending=belegFiles.some(b=>b.status==='pending'||b.status==='err');
  if(kiBtn){kiBtn.style.display=hasPending?'inline-flex':'none';}
  if(skipHint){skipHint.style.display=(!hasPending&&belegFiles.length)?'inline':'none';}
}

function updateUploadSummary(){
  const csvCount=csvTransactions.filter(t=>inPeriod(t.datum)||!t.datum).length;
  const belegCount=belegFiles.length;
  const parts=[];
  if(csvCount)parts.push(`${csvCount} Bankbuchungen`);
  if(belegCount)parts.push(`${belegCount} Beleg${belegCount>1?'e':''}`);
  if(manualIncomes.length)parts.push(`${manualIncomes.length} manuelle Einnahmen`);
  const qLabel=selectedQuartal?` (Q${selectedQuartal} ${selectedYear})`:` (${selectedYear})`;
  $('upload-summary').textContent=parts.length?parts.join(' · ') + ' bereit'+qLabel:'Noch nichts hochgeladen';
}

// ── SEITE 2: BELEGE ÜBERSICHT ──────────────────────────────
function renderBelegUebersicht(){
  const el=$('beleg-uebersicht-list');
  const cnt=$('beleg-uebersicht-count');
  // Belege aus DB + nicht-gespeicherte Session-Belege
  const allRecs=[...receipts];
  belegFiles.filter(b=>b.receiptRecord&&!receipts.find(r=>r.id===b.receiptRecord.id))
    .forEach(b=>allRecs.push({...b.receiptRecord,thumbnail_data:b.thumbnail||null}));
  // Thumbnail aus Session einmergen
  allRecs.forEach(r=>{
    if(!r.thumbnail_data){const bf=belegFiles.find(b=>b.receiptId===r.id&&b.thumbnail);if(bf)r.thumbnail_data=bf.thumbnail;}
  });
  // Nur Belege im gewählten Zeitraum (kein Datum → immer anzeigen)
  // inPeriodLoose: ±14 Tage Puffer an Quartal-/Jahresgrenzen (z.B. Beleg 04.01. bei Q4-Ansicht)
  const filtered=allRecs.filter(r=>!r.datum||inPeriodLoose(r.datum));
  cnt.textContent=filtered.length?`${filtered.length} Beleg${filtered.length>1?'e':''}` :'';
  if(!filtered.length){
    el.innerHTML=`<div style="padding:24px;text-align:center;color:var(--text3);font-size:12px;">${allRecs.length?'Keine Belege im gewählten Zeitraum.':'Keine Belege vorhanden. Lade Belege in Schritt 1 hoch und lasse sie von der KI auslesen.'}</div>`;
    return;
  }
  // Sortieren: neueste zuerst
  filtered.sort((a,b)=>((b.datum||'') < (a.datum||'') ? -1 : 1));
  el.innerHTML=filtered.map((rec,i)=>{
    const isPDF=rec.mime_type==='application/pdf'||(rec.filename||'').toLowerCase().endsWith('.pdf');
    const thumbHtml=rec.thumbnail_data
      ?`<img src="${rec.thumbnail_data}" style="width:36px;height:36px;object-fit:cover;border-radius:4px;flex-shrink:0;">`
      :`<div style="width:36px;height:36px;border-radius:4px;background:var(--surface3);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:9px;font-weight:700;color:var(--text3);">${isPDF?'PDF':'IMG'}</div>`;
    const missingData=!rec.datum||!rec.betrag||!rec.beschreibung;
    return`<div style="display:grid;grid-template-columns:36px 1fr auto;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid var(--border);font-size:11px;" class="${missingData?'lx-row unsicher':''}">
      ${thumbHtml}
      <div>
        <div style="color:var(--text2);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${rec.beschreibung||rec.filename||'–'}</div>
        <div style="color:var(--text3);font-size:10px;margin-top:2px;">
          ${rec.datum?fmtDate(rec.datum):'<span style="color:var(--orange);">Datum fehlt</span>'}
          ${rec.betrag?' · '+fmt(parseFloat(rec.betrag)):'<span style="color:var(--orange);"> · Betrag fehlt</span>'}
          ${rec.kategorie?' · '+(CATEGORIES[rec.kategorie]?.label||rec.kategorie):''}
        </div>
      </div>
      <div style="display:flex;gap:6px;flex-shrink:0;">
        <button class="btn btn-ghost btn-sm" onclick="openBelegEdit('${rec.id}')" title="Bearbeiten"><i data-lucide="pencil"></i></button>
        <button class="btn btn-red btn-sm" onclick="deleteBelegEntry('${rec.id}')" title="Löschen"><i data-lucide="trash-2"></i></button>
      </div>
    </div>`;
  }).join('');
  lucide.createIcons();
}

function openBelegEdit(id){
  // Beleg aus receipts oder Session suchen
  const rec=receipts.find(r=>r.id===id)||belegFiles.map(b=>b.receiptRecord).find(r=>r?.id===id);
  if(!rec)return;
  $('edit-beleg-id').value=id;
  $('edit-beleg-desc').value=rec.beschreibung||'';
  $('edit-beleg-datum').value=rec.datum||'';
  $('edit-beleg-betrag').value=rec.betrag||'';
  // Kategorie-Select befüllen
  const sel=$('edit-beleg-kat');
  sel.innerHTML=Object.entries(CATEGORIES).map(([k,v])=>`<option value="${k}"${rec.kategorie===k?' selected':''}>${v.label}</option>`).join('');
  $('modal-beleg-edit').classList.add('open');
  lucide.createIcons();
}

async function saveBelegEdit(){
  const id=$('edit-beleg-id').value;
  const changes={
    beschreibung:$('edit-beleg-desc').value.trim()||null,
    datum:$('edit-beleg-datum').value||null,
    betrag:parseFloat($('edit-beleg-betrag').value)||null,
    kategorie:$('edit-beleg-kat').value||null,
  };
  try{
    await DB.updateReceipt(id,changes);
    // Lokal aktualisieren
    const rec=receipts.find(r=>r.id===id);
    if(rec)Object.assign(rec,changes);
    closeModal('modal-beleg-edit');
    renderBelegUebersicht();
    toast('Beleg gespeichert ✓');
  }catch(e){toast('Fehler: '+e.message);}
}

async function deleteBelegEntry(id){
  if(!confirm('Beleg wirklich löschen?'))return;
  try{
    const rec=receipts.find(r=>r.id===id);
    await DB.deleteReceipt(id,rec?.storage_path||null);
    receipts=receipts.filter(r=>r.id!==id);
    // Aus matches entfernen
    matches.forEach(m=>{if(m.receipt_id===id){m.receipt_id=null;m.receipts=null;}});
    renderBelegUebersicht();
    toast('Beleg gelöscht ✓');
  }catch(e){toast('Fehler: '+e.message);}
}

// ── THUMBNAIL ERZEUGUNG ────────────────────────────────────
async function createThumbnail(file){
  if(file.type==='application/pdf')return null; // PDFs: kein Canvas-Thumbnail möglich
  return new Promise(resolve=>{
    const img=new Image();
    const url=URL.createObjectURL(file);
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      canvas.width=96;canvas.height=96;
      const ctx=canvas.getContext('2d');
      ctx.fillStyle='#27282c';ctx.fillRect(0,0,96,96);
      // Cover-Fit
      const scale=Math.max(96/img.width,96/img.height);
      const w=img.width*scale,h=img.height*scale;
      ctx.drawImage(img,(96-w)/2,(96-h)/2,w,h);
      URL.revokeObjectURL(url);
      resolve(canvas.toDataURL('image/jpeg',0.65));
    };
    img.onerror=()=>{URL.revokeObjectURL(url);resolve(null);};
    img.src=url;
  });
}

// ── RETRY EINZELNER BELEG ──────────────────────────────────
async function retryBeleg(idx){
  const b=belegFiles[idx];
  if(!b)return;
  b.status='pending';
  b.error=null;
  renderBelegList();
  await readBelege();
}

// ── BELEGE AUSLESEN (KI) ───────────────────────────────────
async function readBelege(){
  // Verarbeite pending UND fehlgeschlagene (err) Einträge
  const pending=belegFiles.filter(b=>b.status==='pending'||b.status==='err');
  if(!pending.length){toast('Alle Belege bereits ausgelesen.');return;}
  $('beleg-loading').classList.add('show');
  $('btn-read-belege').disabled=true;
  for(let i=0;i<belegFiles.length;i++){
    const b=belegFiles[i];
    if(b.status!=='pending'&&b.status!=='err')continue;
    b.error=null; // Fehler zurücksetzen für neuen Versuch
    b.status='loading';
    renderBelegList();
    $('beleg-loading-text').textContent=`Lese ${b.file.name} …`;
    $('beleg-progress-bar').style.width=Math.round(i/belegFiles.length*100)+'%';
    try{
      // Thumbnail erzeugen (vor dem API-Call, damit wir es speichern können)
      b.thumbnail=await createThumbnail(b.file);

      const b64=await readFileAsBase64(b.file);
      const res=await fetch('/api/tax',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({mode:'vision',imageData:b64,imageType:b.file.type,filename:b.file.name})});
      if(!res.ok){const e=await res.json();throw new Error(e.error||'Fehler');}
      const data=await res.json();
      b.result=data.results||[];
      b.status='done';
      console.log('[Vision] Ergebnis für',b.file.name,':',JSON.stringify(b.result).slice(0,300));

      // Beleg in DB speichern – Duplikat-Check: gleicher Dateiname + Größe
      try{
        const r0=b.result[0]||{};
        console.log('[Vision] r0:', JSON.stringify(r0).slice(0,300));
        // KI-Metadaten die wir in den Beleg-Record schreiben wollen
        const receiptMeta={
          beschreibung: r0.beschreibung||b.file.name,
          datum:        r0.datum||null,
          betrag:       r0.betrag_brutto||null,
          betrag_netto: r0.betrag_netto||null,
          mwst_satz:    r0.mwst_satz??null,
          mwst_betrag:  r0.mwst_betrag||null,
          kategorie:    r0.kategorie||null,
          thumbnail_data: b.thumbnail||null,  // direkt im Insert
        };
        // Existiert schon ein Beleg mit gleichem Namen und Größe?
        let uploadedReceipt=receipts.find(r=>r.filename===b.file.name&&r.size_bytes===b.file.size)||null;
        if(uploadedReceipt){
          console.info('Beleg bereits in DB, aktualisiere Metadaten:',b.file.name);
          // KI-Daten + Thumbnail nachträglich updaten
          const updates={...receiptMeta};
          if(uploadedReceipt.thumbnail_data)delete updates.thumbnail_data; // nicht überschreiben
          try{
            await DB.updateReceipt(uploadedReceipt.id,updates);
            Object.assign(uploadedReceipt,updates);
          }catch(_){}
        } else {
          // Noch nicht in DB: speichern (Storage-Upload versuchen, Fallback auf Meta-only)
          try{
            uploadedReceipt=await DB.uploadReceipt(b.file,receiptMeta);
          }catch(se){
            console.warn('Storage-Upload fehlgeschlagen, speichere nur Metadaten:',se.message);
            uploadedReceipt=await DB.saveReceiptMeta({
              filename:   b.file.name,
              size_bytes: b.file.size,
              mime_type:  b.file.type||'application/octet-stream',
              ...receiptMeta,
            });
          }
          // Lokal aufnehmen (thumbnail_data ist bereits im Record)
          if(uploadedReceipt){
            uploadedReceipt.thumbnail_data=uploadedReceipt.thumbnail_data||b.thumbnail||null;
            receipts.push({...uploadedReceipt});
            console.log('[Beleg] Gespeichert:',b.file.name,'ID:',uploadedReceipt.id,'thumb:',!!uploadedReceipt.thumbnail_data);
          }
        }
        b.receiptId=uploadedReceipt?.id||null;
        b.receiptRecord=uploadedReceipt?{...uploadedReceipt,thumbnail_data:uploadedReceipt.thumbnail_data||b.thumbnail||null}:null;
        b.savedToStorage=true;
      }catch(se){
        console.warn('Beleg-Speicherung fehlgeschlagen:',se.message);
        b.savedToStorage=false;
      }
    }catch(e){b.status='err';b.error=e.message;toast(`Fehler bei ${b.file.name}: ${e.message}`);}
    renderBelegList();
  }
  $('beleg-progress-bar').style.width='100%';
  $('beleg-loading').classList.remove('show');
  $('btn-read-belege').disabled=false;
  renderBelegList(); // KI-Button ausblenden (nichts mehr pending)
  // Client-seitiges Matching (kein API-Call): Beleg → Transaktion
  const matched=autoMatchBelege();
  if(matched){
    const matchedCount=belegFiles.filter(b=>b.status==='done'&&b.receiptId&&matches.some(m=>m.receipt_id===b.receiptId)).length;
    toast(`✓ Belege ausgelesen · ${matchedCount} automatisch zugeordnet`);
  } else {
    toast('✓ Belege ausgelesen');
  }
  if(currentPage===3)renderReview();
}


function readFileAsBase64(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=e=>res(e.target.result.split(',')[1]);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}

// ── BELEG-MATCHING (Client-seitig, kein API-Call) ──────────
function matchBelegToTransactions(belegResult,belegReceiptId,txList){
  // Gibt {transaction_id, score, konfidenz} zurück oder null
  if(!belegResult)return null;
  const bBetrag=parseFloat(belegResult.betrag_brutto)||0;
  if(!bBetrag)return null; // kein Betrag → kein Match möglich
  const bDatum=belegResult.datum||'';
  const bDate=bDatum?new Date(bDatum):null;
  // Kategorie-Hinweis: Einnahme oder Ausgabe?
  const bIsIncome=belegResult.kategorie&&CATEGORIES[belegResult.kategorie]?.type==='income';
  let best=null,bestScore=0;
  txList.forEach(tx=>{
    // Belege können Ausgaben ODER Einnahmen (Rechnungen) sein
    const tBetrag=parseFloat(tx.betrag)||0;
    const tDate=tx.datum?new Date(tx.datum):null;
    // Betrag-Match: ±max(2%, 0.50€)
    const betragstoleranz=Math.max(tBetrag*0.02,0.5);
    const betragsMatch=Math.abs(bBetrag-tBetrag)<=betragstoleranz;
    if(!betragsMatch)return;
    // Richtung: Beleg-Kategorie mit TX-Typ abgleichen (wenn bekannt)
    if(bIsIncome&&!tx.isEinnahme)return;
    if(!bIsIncome&&belegResult.kategorie&&CATEGORIES[belegResult.kategorie]?.type==='expense'&&tx.isEinnahme)return;
    // Datum-Match: ±14 Tage (Rechnungsdatum ≠ Buchungsdatum, Wochenenden, Zahlungsziel)
    let datumScore=0.5;
    if(bDate&&tDate){
      const diffDays=Math.abs((bDate-tDate)/(1000*60*60*24));
      if(diffDays<=1)datumScore=1;
      else if(diffDays<=3)datumScore=0.9;
      else if(diffDays<=7)datumScore=0.75;
      else if(diffDays<=10)datumScore=0.6;
      else if(diffDays<=14)datumScore=0.45;
      else return; // zu weit entfernt
    }
    // Empfänger-Match (optional, Bonus)
    let empfScore=0;
    if(belegResult.beschreibung&&tx.empfaenger){
      const bDesc=(belegResult.beschreibung||'').toLowerCase();
      const tEmpf=(tx.empfaenger||'').toLowerCase();
      const words=tEmpf.split(/\s+/).filter(w=>w.length>3);
      const matchWords=words.filter(w=>bDesc.includes(w));
      empfScore=words.length?matchWords.length/words.length*0.3:0;
    }
    const score=datumScore*0.7+empfScore;
    if(score>bestScore){bestScore=score;best=tx;}
  });
  if(!best)return null;
  const konfidenz=bestScore>=0.85?'hoch':bestScore>=0.65?'mittel':'niedrig';
  console.log('[Matching]',belegResult.beschreibung||'?','→',best.empfaenger||best.beschreibung||best.id,'Score:',bestScore.toFixed(2),'Konfidenz:',konfidenz);
  return{transaction_id:best.id,score:bestScore,konfidenz};
}

// ── MATCHES AUS CSV AUFBAUEN (kein KI-Call) ────────────────
function buildMatchesFromCSV(){
  // Dedupliziere matches zuerst (falls Race condition doppelte Einträge hinterlassen hat)
  const seen=new Map();
  matches.forEach(m=>{
    if(!seen.has(m.transaction_id)||m.id)seen.set(m.transaction_id,m);
  });
  matches=[...seen.values()];

  const existing=new Set(matches.map(m=>m.transaction_id));
  const ownerKey=ownerName?normalizeEmpf(ownerName):'';
  const newM=csvTransactions.filter(t=>!existing.has(t.id)).map(t=>{
    // Privatentnahme erkennen: Empfänger entspricht dem Unternehmer-Namen
    const empfKey=normalizeEmpf(t.empfaenger||t.beschreibung||'');
    const isPrivatentnahme=!t.isEinnahme&&ownerKey&&empfKey&&empfKey.includes(ownerKey);
    // Regel anwenden (nur wenn keine Privatentnahme)
    const rule=!isPrivatentnahme&&txRules.find(r=>r.empfaenger_key&&(empfKey===r.empfaenger_key||(r.empfaenger_key.length>=5&&empfKey.includes(r.empfaenger_key))));
    let kategorie,konfidenz,begruendung;
    if(isPrivatentnahme){
      kategorie='privatentnahme';konfidenz='hoch';
      begruendung=`Empfänger "${t.empfaenger}" entspricht dem Unternehmer-Namen → Privatentnahme`;
    }else if(rule){
      kategorie=rule.kategorie;konfidenz='hoch';
      begruendung=`Regel: ${rule.empfaenger_raw||rule.empfaenger_key} → ${CATEGORIES[rule.kategorie]?.label||rule.kategorie}`;
    }else{
      kategorie=t.isEinnahme?'einnahmen_19':'sonstiges';konfidenz=null;begruendung=null;
    }
    return{
      transaction_id:t.id,
      receipt_id:null,
      beschreibung:t.beschreibung||t.empfaenger||'',
      empfaenger:t.empfaenger||'',
      datum:t.datum||null,
      betrag_brutto:Math.abs(t.betrag),
      betrag_netto:Math.abs(t.betrag),
      mwst_satz:0,mwst_betrag:0,
      kategorie,konfidenz,
      unklar:false,bestaetigt:false,
      quelle:'csv',
      is_einnahme:t.isEinnahme,
      begruendung,
      receipts:null,
    };
  });
  if(!newM.length)return;
  matches=[...matches,...newM];
  // Im Hintergrund in DB speichern (upsert → kein Duplikat möglich)
  DB.saveMatches(newM.map(m=>({...m}))).then(saved=>{
    saved.forEach(s=>{
      const l=matches.find(m=>m.transaction_id===s.transaction_id);
      if(l){l.id=s.id;l.kategorie_info=CATEGORIES[l.kategorie]||CATEGORIES.sonstiges;}
    });
  }).catch(e=>console.warn('Match-Speicherung (CSV):',e.message));
}

// ── BELEGE AUTOMATISCH MATCHEN (kein KI-Call) ─────────────
function autoMatchBelege(){
  const belegsDone=belegFiles.filter(b=>b.status==='done'&&b.receiptId);
  let changed=false;
  belegsDone.forEach(b=>{
    if(!b.result?.length)return;
    b.result.forEach(r=>{
      const m=matchBelegToTransactions(r,b.receiptId,csvTransactions);
      if(!m)return;
      const existing=matches.find(mx=>mx.transaction_id===m.transaction_id);
      if(existing&&!existing.receipt_id){
        existing.receipt_id=b.receiptId;
        existing.receipts=b.receiptRecord||receipts.find(rx=>rx.id===b.receiptId)||null;
        existing.konfidenz=m.konfidenz;

        // KI-Daten vom Beleg in den Match integrieren
        // Betrag: Belegwert hat Vorrang (vom Bild extrahiert), CSV-Wert als Fallback
        const r0=b.result[0]||{};
        if(r0.betrag_brutto){existing.betrag_brutto=r0.betrag_brutto;}
        if(r0.betrag_netto){existing.betrag_netto=r0.betrag_netto;}
        else if(r0.betrag_brutto&&r0.mwst_satz){
          existing.betrag_netto=Math.round(r0.betrag_brutto/(1+r0.mwst_satz)*100)/100;
        }
        if(r0.mwst_satz!=null){existing.mwst_satz=r0.mwst_satz;}
        if(r0.mwst_betrag){existing.mwst_betrag=r0.mwst_betrag;}
        else if(existing.betrag_brutto&&existing.betrag_netto){
          existing.mwst_betrag=Math.round((existing.betrag_brutto-existing.betrag_netto)*100)/100;
        }
        // Kategorie vom Beleg übernehmen falls KI eine erkannt hat (und noch kein KI-Match besteht)
        if(r0.kategorie&&CATEGORIES[r0.kategorie]&&!existing.konfidenz){
          existing.kategorie=r0.kategorie;
          existing.kategorie_info=CATEGORIES[r0.kategorie];
        }

        // Begründung: Match-Grund + KI-Begründung vom Beleg zusammenführen
        const matchGrund=`Beleg "${b.file.name}" automatisch gematcht (${m.konfidenz})`;
        const kiGrund=r0.begruendung?` – ${r0.begruendung}`:'';
        const reverseCharge=r0.unklar?` ⚠ Reverse Charge/Unklar: bitte prüfen.`:'';
        existing.begruendung=matchGrund+kiGrund+reverseCharge;
        existing.unklar=!!r0.unklar;

        changed=true;
        if(existing.id){
          DB.updateMatch(existing.id,{
            receipt_id:   b.receiptId,
            konfidenz:    existing.konfidenz,
            betrag_brutto:existing.betrag_brutto,
            betrag_netto: existing.betrag_netto,
            mwst_satz:    existing.mwst_satz,
            mwst_betrag:  existing.mwst_betrag,
            kategorie:    existing.kategorie,
            begruendung:  existing.begruendung,
            unklar:       existing.unklar,
          }).catch(()=>{});
        }
      }
    });
  });
  return changed;
}

// ── ERNEUT ZUORDNEN (alle DB-Belege) ───────────────────────
// Matched alle gespeicherten Belege (mit KI-Daten) erneut gegen csvTransactions.
// Nützlich nach: Beleg-Entknüpfung im Review, Jahreswechsel, neuer CSV-Upload.
async function rematchAllBelege(){
  if(!csvTransactions.length){toast('Keine Transaktionen geladen – bitte zuerst CSV importieren.');return;}
  const btn=$('btn-rematch');
  if(btn){btn.disabled=true;btn.innerHTML='<i data-lucide="loader"></i> Läuft …';lucide.createIcons();}

  // Alle Belege mit nutzbaren KI-Daten (betrag + datum vorhanden)
  const allRecs=[...receipts];
  // Auch Session-Belege die noch nicht in receipts sind
  belegFiles.filter(b=>b.receiptRecord&&!allRecs.find(r=>r.id===b.receiptRecord.id))
    .forEach(b=>allRecs.push(b.receiptRecord));

  let matchedCount=0;
  for(const rec of allRecs){
    if(!rec?.id||!rec.betrag||!rec.datum)continue; // Ohne Betrag+Datum kein Match möglich
    // Beleg-Ergebnis wie bei autoMatchBelege aufbauen
    const belegResult={
      betrag_brutto: parseFloat(rec.betrag)||0,
      datum:         rec.datum||null,
      beschreibung:  rec.beschreibung||rec.filename||'',
      kategorie:     rec.kategorie||null,
    };
    const m=matchBelegToTransactions(belegResult,rec.id,csvTransactions);
    if(!m)continue;

    const existing=matches.find(mx=>mx.transaction_id===m.transaction_id);
    if(!existing)continue;
    if(existing.receipt_id&&existing.receipt_id!==rec.id)continue; // Schon anderer Beleg zugeordnet

    // Nur verknüpfen wenn noch kein Beleg (oder derselbe)
    if(!existing.receipt_id){
      existing.receipt_id=rec.id;
      existing.receipts=receipts.find(r=>r.id===rec.id)||null;
      existing.konfidenz=m.konfidenz;
      existing.begruendung=`Beleg "${rec.filename||rec.beschreibung}" zugeordnet (${m.konfidenz}) – Rematch.`;
      // KI-Daten vom Beleg übernehmen
      if(rec.betrag)existing.betrag_brutto=parseFloat(rec.betrag);
      if(rec.mwst_satz!=null)existing.mwst_satz=rec.mwst_satz;
      if(rec.betrag_netto)existing.betrag_netto=parseFloat(rec.betrag_netto);
      if(rec.mwst_betrag)existing.mwst_betrag=parseFloat(rec.mwst_betrag);
      if(rec.kategorie&&CATEGORIES[rec.kategorie]&&!existing.bestaetigt){
        existing.kategorie=rec.kategorie;
        existing.kategorie_info=CATEGORIES[rec.kategorie];
      }
      matchedCount++;
      if(existing.id){
        DB.updateMatch(existing.id,{
          receipt_id:   rec.id,
          konfidenz:    existing.konfidenz,
          begruendung:  existing.begruendung,
          betrag_brutto:existing.betrag_brutto,
          betrag_netto: existing.betrag_netto,
          mwst_satz:    existing.mwst_satz,
          mwst_betrag:  existing.mwst_betrag,
          kategorie:    existing.kategorie,
        }).catch(()=>{});
      }
    }
  }

  if(btn){btn.disabled=false;btn.innerHTML='<i data-lucide="git-merge"></i> Erneut zuordnen';lucide.createIcons();}
  if(matchedCount>0){
    toast(`✓ ${matchedCount} Beleg${matchedCount>1?'e':''} erneut zugeordnet`);
    renderBelegUebersicht();
    updateSidebar();
  } else {
    toast('Keine neuen Zuordnungen gefunden');
  }
}

// ── KATEGORISIERUNGS-REGELN ─────────────────────────────────
// Normalisiert einen Empfänger-String für Regelvergleich
function normalizeEmpf(s){return(s||'').toLowerCase().trim().replace(/\s+/g,' ');}

// Findet die passende Regel für eine Transaktion (Empfänger-Match)
function findRuleForMatch(m){
  if(!txRules.length)return null;
  const empf=normalizeEmpf(m.empfaenger||m.beschreibung||'');
  if(!empf)return null;
  // Exakter Key-Match zuerst
  let rule=txRules.find(r=>r.empfaenger_key&&empf===r.empfaenger_key);
  if(rule)return rule;
  // Teilstring-Match (Regel-Key kommt im Empfänger vor, mind. 5 Zeichen)
  rule=txRules.find(r=>r.empfaenger_key&&r.empfaenger_key.length>=5&&empf.includes(r.empfaenger_key));
  return rule||null;
}

// Wendet Regeln auf alle Matches an die noch keine Kategorie haben
// Gibt Anzahl der angewendeten Regeln zurück
function applyRulesToMatches(){
  if(!txRules.length)return 0;
  let count=0;
  matches.forEach(m=>{
    if(m.konfidenz||m.bestaetigt)return; // bereits kategorisiert/bestätigt
    const rule=findRuleForMatch(m);
    if(!rule)return;
    if(CATEGORIES[rule.kategorie]){
      m.kategorie=rule.kategorie;
      m.kategorie_info=CATEGORIES[rule.kategorie];
      m.konfidenz='hoch'; // Regel = höchste Konfidenz
      m.begruendung=`Regel: ${rule.empfaenger_raw||rule.empfaenger_key} → ${CATEGORIES[rule.kategorie].label}`;
      count++;
      if(m.id){
        DB.updateMatch(m.id,{
          kategorie:rule.kategorie,
          konfidenz:'hoch',
          begruendung:m.begruendung,
        }).catch(()=>{});
      }
    }
  });
  return count;
}

// ── KI KATEGORISIERUNG (Review-Button) ─────────────────────
async function runKIKategorisierung(){
  // Zuerst Regeln anwenden (schnell, kein KI-Call)
  const rulesApplied=applyRulesToMatches();
  if(rulesApplied>0)console.log('[Regeln]',rulesApplied,'Einträge per Regel kategorisiert');

  // Nur Einträge die noch keine KI-Kategorie haben
  const toKI=matches.filter(m=>!m.konfidenz&&inPeriod(m.datum));
  if(!toKI.length){toast('Alle Einträge bereits analysiert.');return;}

  $('ki-review-loading').classList.add('show');
  $('btn-ki-review').disabled=true;

  const batchSize=5;
  for(let i=0;i<toKI.length;i+=batchSize){
    const batch=toKI.slice(i,i+batchSize).map(e=>({
      id:e.transaction_id,
      beschreibung:(e.beschreibung||'').slice(0,120)+(e.is_einnahme!=null?` [${e.is_einnahme?'Gutschrift':'Lastschrift'}]`:''),
      betrag:e.betrag_brutto,datum:e.datum,quelle:e.quelle||'csv',
    }));
    $('ki-review-loading-text').textContent=`KI analysiert ${Math.min(i+batchSize,toKI.length)}/${toKI.length} …`;
    console.log('[KI] Sende Batch', i/batchSize+1, '– Einträge:', batch.map(e=>e.id+'|'+e.beschreibung.slice(0,40)));
    // Fetch-Hilfsfunktion mit einmaligem Retry bei 504
    const fetchWithRetry=async(url,opts)=>{
      let res=await fetch(url,opts);
      if(res.status===504||res.status===502){
        console.warn('[KI] Timeout/Bad Gateway – warte 3s und versuche nochmal...');
        await new Promise(r=>setTimeout(r,3000));
        res=await fetch(url,opts);
      }
      return res;
    };
    try{
      const res=await fetchWithRetry('/api/tax',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({entries:batch,mode:'categorize'})});
      if(!res.ok){const err=await res.json().catch(()=>({}));throw new Error(err.error||'API '+res.status);}
      const data=await res.json();
      console.log('[KI] Ergebnis:', (data.results||[]).map(r=>r.id+'→'+r.kategorie+'|'+r.konfidenz+'|'+(r.begruendung||'').slice(0,50)));
      (data.results||[]).forEach(ki=>{
        const match=matches.find(m=>m.transaction_id===ki.id);
        if(!match)return;
        // Konflikt-Check: Hat diese Transaktion eine gespeicherte Regel?
        const rule=findRuleForMatch(match);
        const defaultCatKey=match.is_einnahme?'einnahmen_19':'sonstiges';
        const catKey=ki.kategorie&&CATEGORIES[ki.kategorie]?ki.kategorie:defaultCatKey;
        const cat=CATEGORIES[catKey];
        const brutto=ki.betrag_brutto||match.betrag_brutto||0;
        const netto=ki.betrag_netto||(cat.vat?Math.round(brutto/(1+cat.vat)*100)/100:brutto);
        const mwst=ki.mwst_betrag||Math.round((brutto-netto)*100)/100;

        if(rule&&rule.kategorie!==catKey){
          // Konflikt: KI schlägt andere Kategorie vor als gespeicherte Regel
          // → Regel-Kategorie bleibt aktiv, aber als Konflikt zur Prüfung markieren
          match.kategorie=rule.kategorie; // Regel hat Vorrang
          match.kategorie_info=CATEGORIES[rule.kategorie];
          match.konfidenz='niedrig';
          match.unklar=true;
          const kiGrund=ki.begruendung||'';
          match.begruendung=`⚠ Konflikt: Regel → ${CATEGORIES[rule.kategorie]?.label}, KI → ${CATEGORIES[catKey]?.label||catKey}${kiGrund?' ('+kiGrund+')':''}. Bitte prüfen.`;
        } else {
          // Kein Konflikt – KI-Ergebnis übernehmen (oder Regel bestätigt)
          match.kategorie=rule?rule.kategorie:catKey;
          match.kategorie_info=CATEGORIES[match.kategorie]||cat;
          match.betrag_brutto=brutto;
          match.betrag_netto=netto;
          match.mwst_satz=ki.mwst_satz??cat.vat;
          match.mwst_betrag=mwst;
          match.konfidenz=rule?'hoch':(ki.konfidenz||'mittel');
          match.unklar=!!ki.unklar;
          match.is_einnahme=cat.type==='income'||(match.is_einnahme||false);
          const kiGrund=ki.begruendung||'';
          const regelHinweis=rule?` [Regel bestätigt: ${rule.empfaenger_raw||rule.empfaenger_key}]`:'';
          match.begruendung=match.begruendung
            ?(match.begruendung+(kiGrund?' – '+kiGrund:'')+regelHinweis)
            :kiGrund+regelHinweis||null;
        }
        // In DB speichern
        if(match.id){
          DB.updateMatch(match.id,{
            kategorie:match.kategorie,betrag_brutto:match.betrag_brutto,betrag_netto:match.betrag_netto,
            mwst_satz:match.mwst_satz,mwst_betrag:match.mwst_betrag,
            konfidenz:match.konfidenz,unklar:match.unklar,
            begruendung:match.begruendung,is_einnahme:match.is_einnahme,
          }).catch(()=>{});
        }
      });
    }catch(e){
      toast('KI-Fehler: '+e.message);
      break;
    }
  }

  $('ki-review-loading').classList.remove('show');
  $('btn-ki-review').disabled=false;
  const reviewCount=matches.filter(r=>r.unklar||r.konfidenz==='niedrig').length;
  $('badge-review').textContent=reviewCount;
  $('badge-review').classList.toggle('show',reviewCount>0);
  updateSidebar();
  renderReview();
  toast(`✓ KI-Analyse abgeschlossen · ${toKI.length} Einträge kategorisiert`);
}


// ── REVIEW – LEXOFFICE-STIL ────────────────────────────────
function getReceiptForMatch(m){
  // Liefert das Receipt-Objekt für einen Match (aus matches.receipts oder lokaler receipts-Liste)
  if(m.receipts)return m.receipts; // aus DB-Join
  if(m.receipt_id){return receipts.find(r=>r.id===m.receipt_id)||null;}
  return null;
}

function renderThumb(m,idx){
  const rec=getReceiptForMatch(m);
  if(rec){
    const isPDF=rec.mime_type==='application/pdf'||(rec.filename||'').toLowerCase().endsWith('.pdf');
    const confDot=m.unklar?'niedrig':(m.konfidenz||'hoch');
    // Immer Modal öffnen (Modal hat iframe-PDF-Viewer + "Im Browser öffnen"-Button)
    if(isPDF){
      return`<div class="thumb-slot has-thumb" onclick="openBelegModal(${idx})" title="${rec.filename||'PDF'}">
        <div class="pdf-lbl"><i data-lucide="file-text" style="width:14px;height:14px;margin-bottom:2px;"></i><br>${(rec.filename||'').replace(/\.[^.]+$/,'').slice(0,7)}</div>
        <div class="conf-dot ${confDot}"></div>
      </div>`;
    }
    if(rec.thumbnail_data){
      return`<div class="thumb-slot has-thumb" onclick="openBelegModal(${idx})" title="${rec.filename||'Beleg'}">
        <img src="${rec.thumbnail_data}" alt="Beleg">
        <div class="conf-dot ${confDot}"></div>
      </div>`;
    }
    return`<div class="thumb-slot has-thumb" onclick="openBelegModal(${idx})" title="${rec.filename||'Beleg'}">
      <div class="pdf-lbl"><i data-lucide="paperclip" style="width:14px;height:14px;margin-bottom:2px;"></i><br>${(rec.filename||'').slice(0,7)}</div>
      <div class="conf-dot ${confDot}"></div>
    </div>`;
  }
  // Kein Beleg → "+" Slot
  return`<div class="thumb-slot" onclick="openPicker(${idx})" title="Beleg zuordnen">
    <div class="add-lbl">+</div>
  </div>`;
}

function renderReview(){
  const list=$('review-list');

  // Zeige CSV-Buchungen: Transaktion im Quartal ODER Beleg im Quartal (±14 Tage Monatswechsel-Puffer)
  const displayed=matches.filter(m=>{
    if(inPeriod(m.datum))return true; // Transaktionsdatum im Quartal (Normalfall)
    // Zusätzlich: Beleg-Datum im Quartal (Monatswechsel-Toleranz)
    const rec=getReceiptForMatch(m);
    if(rec?.datum&&inPeriodLoose(rec.datum))return true;
    return false;
  });
  if(!displayed.length){
    list.innerHTML='<div style="padding:24px;text-align:center;color:var(--text3);font-size:12px;">Noch keine Buchungen im gewählten Zeitraum. Bitte CSV hochladen.</div>';
    return;
  }

  // Sortierung: älteste zuerst
  displayed.sort((a,b)=>{
    const da=a.datum||'',db2=b.datum||'';
    return da<db2?-1:da>db2?1:0;
  });

  const reviewCount=matches.filter(r=>inPeriod(r.datum)&&(r.unklar||r.konfidenz==='niedrig')).length;
  $('badge-review').textContent=reviewCount;
  $('badge-review').classList.toggle('show',reviewCount>0);

  const filtered=filterReview?displayed.filter(r=>r.unklar||r.konfidenz==='niedrig'):displayed;

  list.innerHTML=`
    <div class="lx-header">
      <span>Datum</span><span>Buchung</span><span style="text-align:right">Betrag</span>
      <span style="text-align:center">Beleg</span><span>Kategorie</span><span>Status</span><span style="width:72px"></span>
    </div>
    ${filtered.map(r=>{
      const realIdx=matches.indexOf(r);
      const cat=CATEGORIES[r.kategorie]||CATEGORIES.sonstiges;
      const isIncome=r.is_einnahme||(cat.type==='income');
      const rowCls=r.bestaetigt?'bestaetigt':r.unklar?'unsicher':'';
      // Status-Badge: leer wenn noch keine KI, sonst konfidenz
      const statusLbl=r.bestaetigt
        ?'<span class="konfidenz bestaetigt">✓ OK</span>'
        :r.unklar
          ?'<span class="konfidenz unklar">⚠ Prüfen</span>'
          :r.konfidenz
            ?`<span class="konfidenz ${r.konfidenz}">${r.konfidenz}</span>`
            :'<span class="konfidenz" style="color:var(--text3)">–</span>';
      const hasGrund=!!r.begruendung;
      const hasReceipt=!!r.receipt_id;
      return`<div class="lx-row-wrap">
        <div class="lx-row ${rowCls}" id="lxr-${realIdx}">
          <div class="lx-date">${r.datum?fmtDate(r.datum):'–'}</div>
          <div class="lx-desc">
            <div class="lx-desc-main" title="${(r.beschreibung||'').replace(/"/g,'&quot;')}">${r.beschreibung||'–'}</div>
          </div>
          <div class="lx-amt ${isIncome?'in':'out'}">${isIncome?'+':'−'}${fmt(r.betrag_brutto||0)}</div>
          <div class="lx-thumb">${renderThumb(r,realIdx)}</div>
          <select class="cat-select" onchange="onCatChange(${realIdx},this.value)">
            ${Object.entries(CATEGORIES).map(([k,v])=>`<option value="${k}"${r.kategorie===k?' selected':''}>${v.label}</option>`).join('')}
          </select>
          <div>${statusLbl}</div>
          <div style="display:flex;align-items:center;gap:2px;justify-content:flex-end;">
            <button class="entry-del row-action-ok${r.bestaetigt?' ok-active':''}" onclick="onConfirmToggle(${realIdx})" title="${r.bestaetigt?'Bestätigung aufheben':'Als OK markieren'}">
              <i data-lucide="${r.bestaetigt?'check-circle':'check'}"></i>
            </button>
            ${hasReceipt
              ?`<button class="entry-del row-action-unlink" onclick="onUnlinkReceipt(${realIdx})" title="Beleg-Zuordnung aufheben"><i data-lucide="unlink"></i></button>`
              :`<span style="width:22px;display:inline-block;"></span>`}
            <button class="entry-del row-action-info${hasGrund?' has-grund':''}" onclick="toggleReason(${realIdx})" title="${hasGrund?'Begründung anzeigen':'Keine Begründung'}">
              <i data-lucide="chevron-down"></i>
            </button>
          </div>
        </div>
        ${hasGrund?`<div class="reason-row" id="reason-${realIdx}" style="display:none;">
          <i data-lucide="info" style="width:13px;height:13px;flex-shrink:0;color:var(--text3)"></i>
          <span>${r.begruendung}</span>
        </div>`:''}
      </div>`;
    }).join('')}`;
  lucide.createIcons();
}

function toggleReason(idx){
  const el=$(`reason-${idx}`);
  if(el)el.style.display=el.style.display==='none'?'flex':'none';
}

async function onCatChange(idx,newCat){
  matches[idx].kategorie=newCat;
  matches[idx].kategorie_info=CATEGORIES[newCat]||CATEGORIES.sonstiges;
  matches[idx]._localEdit=true; // Schützt vor Überschreiben beim nächsten loadMatchesFromDB
  updateSidebar();
  // In DB speichern
  if(matches[idx].id){
    try{await DB.updateMatch(matches[idx].id,{kategorie:newCat});}
    catch(e){console.warn('Kategorie-Update fehlgeschlagen:',e.message);}
  }
}

async function onConfirmToggle(idx){
  const m=matches[idx];
  m.bestaetigt=!m.bestaetigt;
  m.unklar=false; // Konflikt aufgelöst durch manuelle Bestätigung

  if(m.id){
    try{await DB.updateMatch(m.id,{bestaetigt:m.bestaetigt,unklar:false});}
    catch(e){console.warn('Bestätigung fehlgeschlagen:',e.message);}
  }

  // Beim Bestätigen: Kategorie als Regel für diesen Empfänger speichern
  if(m.bestaetigt&&m.kategorie&&m.empfaenger){
    const empfKey=normalizeEmpf(m.empfaenger);
    const existingRule=txRules.find(r=>r.empfaenger_key===empfKey);
    if(!existingRule||existingRule.kategorie!==m.kategorie){
      try{
        const saved=await DB.saveRule(m.empfaenger,m.kategorie,m.beschreibung);
        if(existingRule){
          // Bestehende Regel aktualisieren
          Object.assign(existingRule,saved);
        } else {
          txRules.push(saved);
        }
        console.log('[Regel] Gespeichert:',m.empfaenger,'→',m.kategorie);
      }catch(e){console.warn('Regel-Speicherung fehlgeschlagen:',e.message);}
    }
  }

  renderReview();
}

async function onUnlinkReceipt(idx){
  const m=matches[idx];
  if(!m.receipt_id)return;
  m.receipt_id=null;
  m.receipts=null;
  // Konfidenz auf null zurücksetzen damit KI neu kategorisieren kann
  // (aber Begründung zum Kontext behalten)
  if(m.id){
    try{await DB.updateMatch(m.id,{receipt_id:null,begruendung:null,konfidenz:null,unklar:false,bestaetigt:false});}
    catch(e){console.warn('Unlink fehlgeschlagen:',e.message);}
  }
  m.begruendung=null;
  m.konfidenz=null;
  m.unklar=false;
  m.bestaetigt=false;
  renderReview();
  toast('Beleg-Zuordnung aufgehoben');
}

function toggleFilterReview(){filterReview=!filterReview;$('btn-filter-review').classList.toggle('active',filterReview);renderReview();}

// ── BELEG-MODAL ────────────────────────────────────────────
function openBelegModal(matchIdx){
  modalMatchIdx=matchIdx;
  const m=matches[matchIdx];
  const rec=getReceiptForMatch(m);
  if(!rec){openPicker(matchIdx);return;}
  $('modal-beleg-title').textContent=rec.filename||'Beleg';

  const img=$('modal-beleg-img');
  const iframe=$('modal-beleg-iframe');
  const fallback=$('modal-beleg-pdf-fallback');
  const extLink=$('modal-beleg-extlink');
  const isPDF=rec.mime_type==='application/pdf'||(rec.filename||'').toLowerCase().endsWith('.pdf');

  // Alle Viewer ausblenden
  img.style.display='none';
  iframe.style.display='none';
  fallback.style.display='none';
  extLink.style.display='none';

  if(isPDF&&rec.signed_url){
    extLink.href=rec.signed_url;
    extLink.style.display='inline-flex';
    // Lade-Overlay statt srcdoc (srcdoc hat Vorrang über src → weißer Block)
    fallback.style.display='flex';
    fallback.style.flexDirection='column';
    $('modal-beleg-pdf-name').textContent='PDF wird geladen …';
    $('modal-beleg-pdf-link').style.display='none';
    iframe.style.display='none';
    // srcdoc-Attribut vollständig entfernen, damit src funktioniert
    iframe.removeAttribute('srcdoc');
    // Alten Blob-URL freigeben
    if(iframe._blobUrl){URL.revokeObjectURL(iframe._blobUrl);iframe._blobUrl=null;}
    fetch(rec.signed_url)
      .then(r=>{if(!r.ok)throw new Error('HTTP '+r.status);return r.blob();})
      .then(blob=>{
        // Explicit application/pdf MIME type damit Browser es als PDF erkennt
        const pdfBlob=new Blob([blob],{type:'application/pdf'});
        const blobUrl=URL.createObjectURL(pdfBlob);
        iframe._blobUrl=blobUrl;
        iframe.src=blobUrl;
        iframe.style.display='block';
        fallback.style.display='none';
      })
      .catch(()=>{
        fallback.style.display='flex';
        $('modal-beleg-pdf-name').textContent=rec.filename||'PDF';
        $('modal-beleg-pdf-link').style.display='';
        $('modal-beleg-pdf-link').href=rec.signed_url;
      });
  } else if(isPDF&&!rec.signed_url){
    // Kein signed_url → Fallback
    fallback.style.display='flex';
    $('modal-beleg-pdf-name').textContent=rec.filename||'PDF (kein Link verfügbar)';
    $('modal-beleg-pdf-link').href='#';
  } else {
    // Bild
    img.style.display='block';
    img.src=rec.signed_url||rec.thumbnail_data||'';
    if(rec.signed_url){extLink.href=rec.signed_url;extLink.style.display='inline-flex';}
  }

  $('modal-beleg-meta').innerHTML=`
    <div><span style="color:var(--text3);">Datum:</span> ${fmtDate(rec.datum||'')}</div>
    <div><span style="color:var(--text3);">Betrag:</span> ${rec.betrag?fmt(parseFloat(rec.betrag)):'–'}</div>
    <div><span style="color:var(--text3);">Beschreibung:</span> ${rec.beschreibung||rec.filename||'–'}</div>
    <div><span style="color:var(--text3);">Kategorie:</span> ${CATEGORIES[rec.kategorie]?.label||rec.kategorie||'–'}</div>
  `;
  $('modal-beleg-tx').innerHTML=`
    <div style="background:var(--surface2);border-radius:5px;padding:8px 10px;">
      <div style="color:var(--text2);">${m.beschreibung||'–'}</div>
      <div style="color:var(--text3);font-size:10px;margin-top:3px;">${fmtDate(m.datum||'')} · ${m.is_einnahme?'+':'−'}${fmt(m.betrag_brutto||0)}</div>
    </div>
  `;
  $('modal-beleg').classList.add('open');
  lucide.createIcons();
}

function openPickerFromModal(){
  closeModal('modal-beleg');
  openPicker(modalMatchIdx);
}

async function unlinkReceipt(){
  if(modalMatchIdx===null)return;
  const m=matches[modalMatchIdx];
  if(!confirm('Verknüpfung zum Beleg lösen?'))return;
  m.receipt_id=null;m.receipts=null;
  if(m.id){
    try{await DB.updateMatch(m.id,{receipt_id:null});}
    catch(e){console.warn('Unlink fehlgeschlagen:',e.message);}
  }
  closeModal('modal-beleg');
  renderReview();
  toast('Verknüpfung gelöst ✓');
}

function closeModal(id){
  $(`${id}`).classList.remove('open');
  // iframe src leeren und Blob-URL freigeben
  if(id==='modal-beleg'){
    const f=$('modal-beleg-iframe');
    if(f){
      if(f._blobUrl){URL.revokeObjectURL(f._blobUrl);f._blobUrl=null;}
      f.src='about:blank';
    }
  }
}

// ── BELEG-PICKER ───────────────────────────────────────────
// Gibt {desc, datum} aus Beleg-Metadaten zurück
function fmtBelegParts(rec){
  const raw=(rec.beschreibung||rec.filename||'').replace(/\.[^.]+$/,'');
  const desc=raw.slice(0,22).replace(/[_-]/g,' ').trim()||'Beleg';
  let datumStr='';
  if(rec.datum){
    try{const[y,m,d]=rec.datum.split('-');datumStr=`${d}.${m}.${y.slice(2)}`;}catch{}
  }
  return{desc,datumStr};
}
// Compat: immer noch gebraucht in confirmPicker etc.
function fmtBelegLabel(rec){
  const{desc,datumStr}=fmtBelegParts(rec);
  return datumStr?`${desc} · ${datumStr}`:desc;
}

function openPicker(matchIdx){
  modalMatchIdx=matchIdx;
  pickerSelected=null;
  $('picker-confirm').disabled=true;
  // Alle verfügbaren Belege: aus DB + Session (mit Thumbnail mergen)
  const allReceipts=[...receipts];
  belegFiles.filter(b=>b.status==='done'&&b.receiptRecord&&!receipts.find(r=>r.id===b.receiptRecord.id))
    .forEach(b=>allReceipts.push({...b.receiptRecord,thumbnail_data:b.thumbnail||b.receiptRecord?.thumbnail_data||null}));
  // Thumbnail aus Session über receipts einmergen falls DB-Record kein Thumbnail hat
  allReceipts.forEach(rec=>{
    if(!rec.thumbnail_data){
      const bf=belegFiles.find(b=>b.receiptId===rec.id&&b.thumbnail);
      if(bf)rec.thumbnail_data=bf.thumbnail;
    }
  });

  const grid=$('picker-grid');
  const empty=$('picker-empty');
  if(!allReceipts.length){
    grid.innerHTML='';empty.style.display='block';
    $('modal-picker').classList.add('open');lucide.createIcons();return;
  }
  empty.style.display='none';

  // Bereits zugeordnete receipt_ids (außer dem aktuellen Match)
  const usedIds=new Set(matches.filter((m,i)=>i!==matchIdx&&m.receipt_id).map(m=>m.receipt_id));

  grid.innerHTML=allReceipts.map(rec=>{
    const isPDF=rec.mime_type==='application/pdf'||(rec.filename||'').toLowerCase().endsWith('.pdf');
    const used=usedIds.has(rec.id);
    const{desc,datumStr}=fmtBelegParts(rec);
    // Thumbnail-Bereich: Bild, PDF-Label oder "kein Thumbnail"-Platzhalter
    let thumbHtml;
    if(rec.thumbnail_data){
      thumbHtml=`<img class="picker-thumb" src="${rec.thumbnail_data}" alt="${desc}">`;
    } else if(isPDF){
      thumbHtml=`<div class="picker-pdf"><i data-lucide="file-text" style="width:22px;height:22px;margin-bottom:3px;"></i><span>PDF</span></div>`;
    } else {
      thumbHtml=`<div class="picker-pdf"><i data-lucide="image" style="width:22px;height:22px;margin-bottom:3px;"></i><span>Bild</span></div>`;
    }
    return`<div class="picker-item${used?' picker-used':''}"
        onclick="${used?'':'pickReceipt(this,\''+rec.id+'\')'}"
        data-id="${rec.id}"
        title="${rec.filename||''}"
        ${used?'style="opacity:.45;cursor:not-allowed;"':''}>
      ${thumbHtml}
      <div class="picker-name">
        <div class="picker-name-desc">${desc}</div>
        ${datumStr?`<div class="picker-name-date">${datumStr}</div>`:''}
      </div>
    </div>`;
  }).join('');
  $('modal-picker').classList.add('open');
  lucide.createIcons();
}

function pickReceipt(el,receiptId){
  document.querySelectorAll('.picker-item').forEach(e=>e.classList.remove('selected'));
  el.closest('.picker-item').classList.add('selected');
  pickerSelected=receiptId;
  $('picker-confirm').disabled=false;
}

async function confirmPicker(){
  if(!pickerSelected||modalMatchIdx===null)return;
  const rec=receipts.find(r=>r.id===pickerSelected)||
    belegFiles.map(b=>b.receiptRecord).find(r=>r?.id===pickerSelected);
  if(!rec)return;
  matches[modalMatchIdx].receipt_id=pickerSelected;
  matches[modalMatchIdx].receipts=rec;
  // In DB speichern
  if(matches[modalMatchIdx].id){
    try{await DB.updateMatch(matches[modalMatchIdx].id,{receipt_id:pickerSelected});}
    catch(e){console.warn('Picker-Update fehlgeschlagen:',e.message);}
  }
  closeModal('modal-picker');
  renderReview();
  toast('Beleg zugeordnet ✓');
}

// ── USTVA BERECHNUNG ───────────────────────────────────────
function buildUStVA(){
  const src=matches.length?matches:aiResults;
  if(!src.length){
    $('ustv-kpi-grid').innerHTML='<div style="color:var(--text3);font-size:12px;padding:10px;">Noch keine Analyse. Bitte zuerst Schritte 1–3 durchführen.</div>';
    return;
  }
  const q=selectedQuartal;const year=selectedYear;
  const label=q?`Q${q} ${year}`:year;
  $('ustva-period-label').textContent=label;

  let ein19=0,ein7=0,ein0=0,aus19=0,aus7=0,aus0=0;
  let vor19=0,vor7=0;
  let einNetto=0,ausNetto=0;

  src.forEach(r=>{
    const cat=CATEGORIES[r.kategorie]||CATEGORIES.sonstiges;
    if(cat.type==='private')return;
    const netto=r.betrag_netto||0;
    const mwst=r.mwst_betrag||0;
    const f=cat.limitFactor||1;
    if(cat.type==='income'){
      einNetto+=netto;
      if(r.mwst_satz===0.19){ein19+=netto;}
      else if(r.mwst_satz===0.07){ein7+=netto;}
      else{ein0+=netto;}
    } else {
      ausNetto+=netto*f;
      if(r.mwst_satz===0.19){aus19+=netto*f;vor19+=mwst*f;}
      else if(r.mwst_satz===0.07){aus7+=netto*f;vor7+=mwst*f;}
      else{aus0+=netto*f;}
    }
  });

  const ust19=Math.round(ein19*0.19*100)/100;
  const ust7=Math.round(ein7*0.07*100)/100;
  const vorsteuer=Math.round((vor19+vor7)*100)/100;
  const zahllast=Math.round((ust19+ust7-vorsteuer)*100)/100;
  const gewinn=Math.round((einNetto-ausNetto)*100)/100;

  $('ustv-kpi-grid').innerHTML=`
    <div class="ustv-kpi"><div class="ustv-kpi-label">Umsatz Netto</div><div class="ustv-kpi-val green">${fmt(einNetto)}</div></div>
    <div class="ustv-kpi"><div class="ustv-kpi-label">Ausgaben Netto</div><div class="ustv-kpi-val red">${fmt(ausNetto)}</div></div>
    <div class="ustv-kpi"><div class="ustv-kpi-label">Gewinn (EÜR)</div><div class="ustv-kpi-val accent">${fmt(gewinn)}</div></div>
    <div class="ustv-kpi"><div class="ustv-kpi-label">USt-Zahllast</div><div class="ustv-kpi-val ${zahllast>0?'red':'green'}">${fmt(Math.abs(zahllast))} ${zahllast<0?'(Erstattung)':''}</div></div>
  `;

  $('detail-table').querySelector('tbody').innerHTML=`
    <tr><th colspan="2">Umsatzsteuer</th></tr>
    <tr><td>Kz 81 – Umsätze 19%</td><td>${fmt(ein19)}</td></tr>
    <tr><td>Kz 86 – Umsätze 7%</td><td>${fmt(ein7)}</td></tr>
    <tr><td>Kz 35 – Steuer 19%</td><td>${fmt(ust19)}</td></tr>
    <tr><td>Kz 36 – Steuer 7%</td><td>${fmt(ust7)}</td></tr>
    <tr><th colspan="2">Vorsteuer</th></tr>
    <tr><td>Kz 66 – Vorsteuer gesamt</td><td>${fmt(vorsteuer)}</td></tr>
    <tr><th colspan="2">Ergebnis</th></tr>
    <tr><td><strong>Kz 83 – Zahllast</strong></td><td><strong>${fmt(Math.max(0,zahllast))}</strong></td></tr>
    ${zahllast<0?`<tr><td>Kz 83 – Erstattungsüberhang</td><td style="color:var(--green);">${fmt(Math.abs(zahllast))}</td></tr>`:''}
  `;

  $('euer-table').querySelector('tbody').innerHTML=`
    <tr><td>Betriebseinnahmen Netto</td><td style="color:var(--green);">${fmt(einNetto)}</td></tr>
    <tr><td>Betriebsausgaben Netto</td><td style="color:var(--red);">${fmt(ausNetto)}</td></tr>
    <tr><td><strong>Gewinn / Verlust</strong></td><td><strong style="color:${gewinn>=0?'var(--green)':'var(--red)'};">${fmt(gewinn)}</strong></td></tr>
    <tr><td style="color:var(--text3);">Nicht-abzugsfähig (Privat etc.)</td><td style="color:var(--text3);">${fmt(src.filter(r=>CATEGORIES[r.kategorie]?.type==='private').reduce((s,r)=>s+(r.betrag_brutto||0),0))}</td></tr>
  `;

  updateSidebar();
}

// ── EXPORT ─────────────────────────────────────────────────
function exportSummary(){
  const q=selectedQuartal,year=selectedYear;
  const label=q?`Q${q} ${year}`:year;
  let txt=`UStVA-Zusammenfassung VISO Media – ${label}\n${'─'.repeat(40)}\n`;
  const src=matches.length?matches:aiResults;
  src.forEach(r=>{
    const cat=CATEGORIES[r.kategorie]||CATEGORIES.sonstiges;
    txt+=`${fmtDate(r.datum)} | ${r.beschreibung?.slice(0,40)||'–'} | ${cat.type==='income'?'+':'−'}${fmt(r.betrag_brutto||0)} | ${cat.label}\n`;
  });
  navigator.clipboard.writeText(txt).then(()=>toast('Zusammenfassung kopiert ✓')).catch(()=>toast('Fehler beim Kopieren'));
}

function exportElsterXML(){
  let ein19=0,ein7=0,vor=0;
  const src=matches.length?matches:aiResults;
  src.forEach(r=>{
    const cat=CATEGORIES[r.kategorie]||CATEGORIES.sonstiges;
    if(cat.type==='income'){if(r.mwst_satz===0.19)ein19+=r.betrag_netto||0;if(r.mwst_satz===0.07)ein7+=r.betrag_netto||0;}
    else if(cat.type==='expense'){vor+=r.mwst_betrag||0;}
  });
  const ust19=Math.round(ein19*0.19*100)/100;
  const ust7=Math.round(ein7*0.07*100)/100;
  const zahllast=Math.max(0,Math.round((ust19+ust7-vor)*100)/100);
  const steuernr=$('elster-steuernr').value.trim().replace(/\D/g,'');
  const bl=$('elster-bundesland').value;
  const q=selectedQuartal,year=selectedYear;
  const [vy,vm,vt]=new Date().toISOString().split('T')[0].split('-');
  const xml=`<?xml version="1.0" encoding="UTF-8"?>
<Elster xmlns="http://www.elster.de/elsterxml/schema/v12">
  <TransferHeader><Verfahren>ElsterAnmeldung</Verfahren><DatenArt>UStVA</DatenArt>
    <Vorgang>send-Auth</Vorgang><Erstellungsdatum>${year}${String(q||1).padStart(2,'0')}01</Erstellungsdatum>
  </TransferHeader>
  <DatenTeil><Nutzdaten><Anmeldung art="UStVA" version="2024">
    <Zeitraum><Jahr>${year}</Jahr><Quartal>${q||1}</Quartal></Zeitraum>
    <Steuernummer>${steuernr}</Steuernummer><Bundesland>${bl}</Bundesland>
    <Kz81>${Math.round(ein19*100)/100}</Kz81>
    <Kz86>${Math.round(ein7*100)/100}</Kz86>
    <Kz35>${ust19}</Kz35><Kz36>${ust7}</Kz36>
    <Kz66>${Math.round(vor*100)/100}</Kz66>
    <Kz83>${zahllast}</Kz83>
  </Anmeldung></Nutzdaten></DatenTeil>
</Elster>`;
  const blob=new Blob([xml],{type:'application/xml'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`UStVA_${q?'Q'+q+'_':''}${year}_ELSTER.xml`;a.click();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
  toast('ELSTER XML heruntergeladen ✓');
}

// ── MATCHES AUS DB LADEN ───────────────────────────────────
async function loadMatchesFromDB(year,quartal){
  try{
    const dbMatches=await DB.getMatches(year,quartal||0);
    // Lokale Änderungen preservieren: wenn ein Match lokal bereits bestaetigt/geändert wurde
    // und die DB-Version noch den alten Stand hat → lokale Version bevorzugen
    const localByTxId=new Map(matches.map(m=>[m.transaction_id,m]));
    matches=dbMatches.map(m=>{
      const local=localByTxId.get(m.transaction_id);
      // Lokale Version hat Vorrang wenn: sie bestaetigt ist ODER eine manuell gesetzte Kategorie hat
      // (erkennbar daran dass local.bestaetigt=true oder local._localEdit=true)
      if(local&&(local.bestaetigt||local._localEdit)){
        // DB-Werte als Basis, aber lokale Änderungen drüber legen
        return{
          ...m,
          id:m.id||local.id,
          kategorie:       local.kategorie||m.kategorie,
          kategorie_info:  CATEGORIES[local.kategorie||m.kategorie]||CATEGORIES.sonstiges,
          konfidenz:       local.konfidenz||m.konfidenz,
          unklar:          !!local.unklar,
          bestaetigt:      !!local.bestaetigt,
          begruendung:     local.begruendung||m.begruendung,
          betrag_netto:    local.betrag_netto||m.betrag_netto,
          mwst_satz:       local.mwst_satz??m.mwst_satz,
          mwst_betrag:     local.mwst_betrag||m.mwst_betrag,
          receipt_id:      local.receipt_id||m.receipt_id,
          receipts:        local.receipts||m.receipts||null,
          is_einnahme:     !!m.is_einnahme,
          _localEdit:      false, // Reset nach Merge
        };
      }
      return{
        ...m,
        is_einnahme:!!m.is_einnahme,
        unklar:!!m.unklar,
        bestaetigt:!!m.bestaetigt,
        kategorie_info:CATEGORIES[m.kategorie]||CATEGORIES.sonstiges,
        receipts:m.receipts||null,
      };
    });
    aiResults=matches;
    const reviewCount=matches.filter(r=>r.unklar||r.konfidenz==='niedrig').length;
    $('badge-review').textContent=reviewCount;
    $('badge-review').classList.toggle('show',reviewCount>0);
    updateSidebar();
  }catch(e){
    console.info('Matches nicht geladen (Tabelle fehlt noch?):',e.message);
  }
}

// ── BELEGE AUS DB LADEN ────────────────────────────────────
async function loadReceiptsFromDB(){
  try{
    receipts=await DB.getReceipts();
  }catch(e){console.info('Receipts nicht geladen:',e.message);}
}

// ── INIT ───────────────────────────────────────────────────
async function init(){
  const user=await getUser();
  if(!user){window.location.href='/';return;}
  $('nav-user').textContent=user.email||'';
  // Owner-Name für Privatentnahmen-Erkennung laden
  const meta=user.user_metadata||{};
  ownerName=[meta.vorname||'',meta.nachname||''].filter(Boolean).join(' ');

  // Jahr-Select – Vorauswahl aus localStorage (Zeitraum beim Reload beibehalten)
  const savedYear=parseInt(localStorage.getItem('steuer_year'))||new Date().getFullYear();
  const savedQ=parseInt(localStorage.getItem('steuer_quartal')||'0');
  const ySel=$('sel-year');
  const curYear=new Date().getFullYear();
  ySel.innerHTML='';
  [curYear,curYear-1,curYear-2].forEach(y=>{
    const o=document.createElement('option');o.value=y;o.textContent=y;
    if(y===savedYear)o.selected=true;ySel.appendChild(o);
  });
  selectedYear=savedYear;
  selectedQuartal=savedQ;

  // Quartal-Buttons setzen
  document.querySelectorAll('.q-btn').forEach(b=>b.classList.remove('active'));
  if(savedQ===0)$('qjahr').classList.add('active');
  else $(`q${savedQ}`)?.classList.add('active');

  // CSV + Matches + Belege + Regeln parallel laden
  await Promise.all([
    (async()=>{
      try{
        const txs=await DB.getTransactions(savedYear);
        if(txs.length){
          csvTransactions=txs.map(t=>({
            id:'tx'+t.id,
            _dbId: t.id,
            datum:t.datum||'', empfaenger:t.empfaenger||'',
            verwendungszweck:t.verwendungszweck||'',
            beschreibung:t.beschreibung||(t.empfaenger||'')+(t.verwendungszweck?' – '+t.verwendungszweck:''),
            betrag:parseFloat(t.betrag)||0, isEinnahme:!!t.is_einnahme, quelle:'csv', _fromDB:true
          }));
          const ein=csvTransactions.filter(t=>t.isEinnahme).length;
          const aus=csvTransactions.filter(t=>!t.isEinnahme).length;
          const st=$('csv-status');
          st.style.display='block';
          st.innerHTML=`<div class="hinweis ok"><i data-lucide="check-circle"></i><div><strong>${csvTransactions.length} Buchungen</strong> aus ${savedYear}: ${ein} Eingänge, ${aus} Ausgaben. <button class="btn btn-ghost btn-sm" style="margin-left:8px;" onclick="clearCSVData()"><i data-lucide="trash-2"></i> Löschen</button></div></div>`;
        }
      }catch(e){console.info('CSV nicht geladen:',e.message);}
    })(),
    loadMatchesFromDB(savedYear,savedQ),
    loadReceiptsFromDB(),
    (async()=>{ try{ txRules=await DB.getRules(); }catch(e){ console.info('Regeln nicht geladen:',e.message); txRules=[]; } })(),
  ]);

  // ERST nach beiden Loads: neue CSV-Buchungen ohne Match hinzufügen (kein Doppeleintrag)
  if(csvTransactions.length) buildMatchesFromCSV();

  renderManualIncomes();
  updateUploadSummary();
  updateSidebar();
  $('loading-screen').style.display='none';
  lucide.createIcons();
}

async function doSignOut(){await signOut();}

// ── EINSTELLUNGEN ───────────────────────────────────────────
function openSettings(){
  $('settings-vorname').value=ownerName.split(' ')[0]||'';
  $('settings-nachname').value=ownerName.split(' ').slice(1).join(' ')||'';
  const ov=$('settings-overlay');
  ov.style.display='flex';
  lucide.createIcons();
}
function closeSettings(){$('settings-overlay').style.display='none';}
async function saveSettings(){
  const v=$('settings-vorname').value.trim();
  const n=$('settings-nachname').value.trim();
  try{
    await DB.saveUserProfile(v,n);
    ownerName=[v,n].filter(Boolean).join(' ');
    toast('Einstellungen gespeichert ✓');
    closeSettings();
    // Matches neu aufbauen damit Privatentnahmen sofort greifen
    if(csvTransactions.length){buildMatchesFromCSV();if(currentPage===3)renderReview();}
  }catch(e){toast('Fehler: '+e.message);}
}

init();
</script>
</body>
</html>
